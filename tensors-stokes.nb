(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    660348,      16827]
NotebookOptionsPosition[    609596,      16166]
NotebookOutlinePosition[    610063,      16184]
CellTagsIndexPosition[    610020,      16181]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Tensors", "Title",
 CellChangeTimes->{{3.910691012265693*^9, 
  3.910691014560964*^9}},ExpressionUUID->"c6eaf04e-5dd5-4fa8-8343-\
b8a0adf0f543"],

Cell[TextData[{
 "This notebook seeks to add a key functionality missing from Mathematica - \
the ability to consistently and unambiguously manipulate tensors. It\
\[CloseCurlyQuote]s motivated by all the multivariate calculus of the \
previous problems. There have been many instances where we need to take \
directional derivatives of high-order tensors, and doing this correctly every \
time is difficult without a little extra scaffolding to keep track of ",
 StyleBox["what the dimensions actually mean",
  FontSlant->"Italic"],
 "."
}], "Text",
 CellChangeTimes->{{3.9106910161904287`*^9, 3.910691026534402*^9}, {
  3.950670994095601*^9, 
  3.9506710947530518`*^9}},ExpressionUUID->"51853c45-fdd6-48d2-a8bf-\
19abede64a62"],

Cell[BoxData[
 RowBox[{"SetOptions", "[", 
  RowBox[{
   RowBox[{"EvaluationNotebook", "[", "]"}], ",", 
   RowBox[{"CellEpilog", ":>", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{
      RowBox[{"NextCell", "[", 
       RowBox[{"CellStyle", "->", "\"\<Input\>\""}], "]"}], ",", "All", ",", 
      "Cell"}], "]"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.907159865987494*^9, 3.907159865991525*^9}, {
  3.908720560007636*^9, 3.908720568507069*^9}, {3.908978545839183*^9, 
  3.9089785470660152`*^9}, {3.908978658540711*^9, 3.908978659472054*^9}, {
  3.908978745033798*^9, 3.908978749754356*^9}},
 CellLabel->"In[49]:=",ExpressionUUID->"54c3bc48-6d32-47a6-b000-3708fa8050da"],

Cell[BoxData[
 RowBox[{
  RowBox[{"enumerate", "[", "l_", "]"}], ":=", 
  RowBox[{"MapIndexed", "[", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"#2", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", "#1"}], "}"}], "&"}], ")"}], 
    ",", "l"}], "]"}]}]], "Input",
 CellLabel->"In[50]:=",ExpressionUUID->"ba8fb7a7-a42e-417e-ae8d-70df1a2a678e"],

Cell[CellGroupData[{

Cell["Rules for tensors", "Chapter",
 CellChangeTimes->{{3.9077664274198933`*^9, 
  3.90776642955873*^9}},ExpressionUUID->"11b3a1c5-fdce-4466-a82d-\
e301c5a953ca"],

Cell["\<\
Tensor objects contain a multidimensional array, basis and dimension \
information, organised into \[OpenCurlyDoubleQuote]input-output\
\[CloseCurlyDoubleQuote] space (similar to covariant/contravariant etc.). \
This extra structure will allow us to avoid many simple mistakes when \
performing operations on these tensors.\
\>", "Text",
 CellChangeTimes->{{3.907415812561461*^9, 3.9074158729581003`*^9}, {
   3.90741607653909*^9, 3.907416094119701*^9}, {3.907636772778043*^9, 
   3.9076369878816032`*^9}, {3.907637031808587*^9, 3.90763718321449*^9}, {
   3.907672096652648*^9, 3.9076721216540327`*^9}, {3.907672454269085*^9, 
   3.907672490155546*^9}, 3.907720807629915*^9, {3.907756538486381*^9, 
   3.907756558017432*^9}},ExpressionUUID->"7ba65c4f-a04e-41aa-800a-\
3d68ae21e13a"],

Cell["tensor[array, bases, arity]", "Text",
 CellChangeTimes->{{3.950671453890995*^9, 
  3.9506714735472813`*^9}},ExpressionUUID->"a9789e02-6695-4f4c-8da8-\
7fa3b2c9b5f3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"testT", "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"x", " ", "y"}], ",", "0", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<y\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "3", ",", "\"\<+\>\""}], "}"}]}], "}"}], 
     ",", "1"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907888115870275*^9, 3.9078881410454206`*^9}, {
   3.907888171473973*^9, 3.907888206196925*^9}, {3.9083959537692137`*^9, 
   3.908395959589992*^9}, {3.913989648288603*^9, 3.913989656843505*^9}, 
   3.913999938690255*^9, {3.9140040902895184`*^9, 3.914004091072708*^9}, {
   3.914281636293908*^9, 3.914281659386042*^9}},
 CellLabel->"In[52]:=",ExpressionUUID->"15db0f28-36e5-442e-a3c0-3b68aa4f7b90"],

Cell[TextData[{
 "A basis is an ordered triple ",
 Cell[BoxData[
  FormBox[
   RowBox[{"(", 
    RowBox[{"name", ",", " ", "dim", ",", " ", "space"}], ")"}], 
   TraditionalForm]],ExpressionUUID->"984bf3fc-6e0e-4d35-afc2-a0933692f37a"],
 ", where\n- name is an object that labels the vector space (e.g. \
\[OpenCurlyDoubleQuote]xy\[CloseCurlyDoubleQuote] or \
{\[OpenCurlyDoubleQuote]nx\[CloseCurlyDoubleQuote],2})\n- dim labels the \
size/dimension of the vector space\n- space (\[OpenCurlyDoubleQuote]+\
\[CloseCurlyDoubleQuote] or \[OpenCurlyDoubleQuote]-\[CloseCurlyDoubleQuote]) \
which indicates whether the associated numerical vector lies in the original \
vector space, or in the dual space. Numerical dot products can only be \
performed between a vector and its dual. We use the metric tensor of the \
space to switch between them."
}], "Text",
 CellChangeTimes->{{3.907756561543628*^9, 3.907756650882727*^9}, {
  3.907756779788249*^9, 3.907756850283485*^9}, {3.950671336515108*^9, 
  3.950671339641614*^9}},ExpressionUUID->"0931edf4-abbd-4fd9-b0f5-\
a876e02f0dd5"],

Cell["\<\
These definitions show how Mathematica patterns can give an \
\[OpenCurlyDoubleQuote]object-oriented\[CloseCurlyDoubleQuote]-like approach \
to defining methods for different kinds of objects.\
\>", "Text",
 CellChangeTimes->{{3.9506713658264847`*^9, 
  3.950671398194108*^9}},ExpressionUUID->"b57a2df7-22e0-40ea-a85f-\
f54565ec6558"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"basis", "/:", 
    RowBox[{"dual", "[", 
     RowBox[{"basis", "[", 
      RowBox[{"name_", ",", "dim_", ",", "space_"}], "]"}], "]"}], ":=", 
    RowBox[{"basis", "[", 
     RowBox[{"name", ",", "dim", ",", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"space", "==", "\"\<vec\>\""}], ",", "\"\<dual\>\"", ",", 
        "\"\<vec\>\""}], "]"}]}], "]"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"dual", "[", 
    RowBox[{"{", 
     RowBox[{"name_", ",", "dim_", ",", "space_"}], "}"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{"name", ",", "dim", ",", 
     RowBox[{"Which", "[", 
      RowBox[{
       RowBox[{"space", "==", "\"\<+\>\""}], ",", "\"\<-\>\"", ",", 
       RowBox[{"space", "==", "\"\<-\>\""}], ",", "\"\<+\>\""}], "]"}]}], 
    "}"}]}]}]], "Input",
 CellChangeTimes->{{3.907673966201705*^9, 3.90767403133166*^9}, {
  3.90771687414438*^9, 3.9077168946814632`*^9}, {3.908102940592833*^9, 
  3.908102972517348*^9}},
 CellLabel->"In[51]:=",ExpressionUUID->"16c0bc3a-8e04-4850-83dc-c4233f529981"],

Cell["\<\
First we need methods to just access the relevant basis data of a tensor \
object\
\>", "Text",
 CellChangeTimes->{{3.950671429058077*^9, 3.950671445842465*^9}, 
   3.950671497618966*^9},ExpressionUUID->"5f45dd4a-e3dd-45c5-a460-\
4bfaa5fd4133"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"getArr", "[", "t_tensor", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getDims", "[", "t_tensor", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "2", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getSlots", "[", "t_tensor", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "3", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"getNumDims", "[", "t_tensor", "]"}], ":=", 
   RowBox[{"Length", "[", 
    RowBox[{"getDims", "[", "t", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"getInDims", "[", "t_tensor", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{";;", 
     RowBox[{"getSlots", "[", "t", "]"}]}], "]"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getOutDims", "[", "t_tensor", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{
     RowBox[{
      RowBox[{"getSlots", "[", "t", "]"}], "+", "1"}], ";;"}], "]"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getDimShapes", "[", "t_tensor", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{";;", ",", "2"}], "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.913990189793486*^9, 3.913990209364303*^9}, {
   3.913998808493441*^9, 3.913998839855482*^9}, 3.913998886822322*^9, {
   3.913999939819277*^9, 3.913999940802479*^9}, 3.914024307380413*^9},
 CellLabel->"In[54]:=",ExpressionUUID->"53ae447e-bb21-45e3-b0d8-db043541951b"],

Cell["\<\
We\[CloseCurlyQuote]ll have similar methods for tensor operators, which don\
\[CloseCurlyQuote]t necessarily store the full array, but some more efficient \
routine for calculating it (e.g. an FFT type operator).\
\>", "Text",
 CellChangeTimes->{{3.9506715093074017`*^9, 
  3.9506715494674273`*^9}},ExpressionUUID->"3f78eae5-715e-4870-9371-\
aefefe5689b8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"getFunc", "[", "t_tensorop", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getDims", "[", "t_tensorop", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "2", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getSlots", "[", "t_tensorop", "]"}], ":=", 
   RowBox[{"t", "[", 
    RowBox[{"[", "3", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"getNumDims", "[", "t_tensorop", "]"}], ":=", 
   RowBox[{"Length", "[", 
    RowBox[{"getDims", "[", "t", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"getInDims", "[", "t_tensorop", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{";;", 
     RowBox[{"getSlots", "[", "t", "]"}]}], "]"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getOutDims", "[", "t_tensorop", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{
     RowBox[{
      RowBox[{"getSlots", "[", "t", "]"}], "+", "1"}], ";;"}], "]"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getDimShapes", "[", "t_tensorop", "]"}], ":=", 
  RowBox[{
   RowBox[{"getDims", "[", "t", "]"}], "[", 
   RowBox[{"[", 
    RowBox[{";;", ",", "2"}], "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.914024320930504*^9, 3.9140243350693703`*^9}, {
  3.914024401747207*^9, 3.914024408946164*^9}},
 CellLabel->"In[61]:=",ExpressionUUID->"841373e2-27a2-4eb0-a117-2e488c5c0ffd"],

Cell[CellGroupData[{

Cell["Symbolic rules for tensors", "Subsection",
 CellChangeTimes->{{3.950671561306945*^9, 
  3.950671566858918*^9}},ExpressionUUID->"b5930f48-7416-4eb0-96c7-\
211200554e6d"],

Cell[CellGroupData[{

Cell["+ : Add tensors", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756448675464*^9}, {
  3.90775747373559*^9, 
  3.907757474367462*^9}},ExpressionUUID->"c806f52f-ff07-4371-a770-\
4da294c2dbb7"],

Cell[BoxData[{
 RowBox[{"tensor", "/:", 
  RowBox[{"Plus", "[", 
   RowBox[{
    RowBox[{"tensor", "[", 
     RowBox[{"a1_", ",", "d1_", ",", "s1_"}], "]"}], ",", 
    RowBox[{"tensor", "[", 
     RowBox[{"a2_", ",", "d2_", ",", "s2_"}], "]"}]}], "]"}], ":=", 
  RowBox[{"If", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"d1", "===", "d2"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"s1", "===", "s2"}], ",", "\[IndentingNewLine]", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"a1", "+", "a2"}], ",", "d1", ",", "s1"}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"tensor", "::", "pluss"}], ",", "s1", ",", "s2"}], "]"}]}], 
     "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"tensor", "::", "plusd"}], ",", "d1", ",", "d2"}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensor", "::", "pluss"}], "=", 
   "\"\<(+) Incompatible arities `1`,`2`\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensor", "::", "plusd"}], "=", 
   "\"\<(+) Incompatible spaces `1`,`2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, 
   3.907672253866226*^9, {3.907672406426845*^9, 3.907672406631881*^9}, {
   3.913989668551638*^9, 3.913989834317216*^9}, {3.913989964568718*^9, 
   3.9139899685448093`*^9}, {3.913999945871933*^9, 3.913999952763496*^9}},
 CellLabel->"In[68]:=",ExpressionUUID->"95b063e2-a55d-42c4-b9fa-95b15a13872c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"0", ",", "1"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", "0"}], 
   "]"}], "+", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", "0"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.950671589013236*^9, 3.9506716326676207`*^9}},
 CellLabel->"In[79]:=",ExpressionUUID->"892f1ab5-dd76-49b3-a12f-6883a6233b93"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"0", ",", "1"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", "0"}], 
   "]"}], "+", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\"\<y\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", "1"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.9506716407902727`*^9, 3.950671646147512*^9}},
 CellLabel->"In[81]:=",ExpressionUUID->"fc1717a9-ec1e-4007-be58-5be041360baf"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\[Cross]: Scalar multiply tensors", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756452056719*^9}, {
  3.90775750472759*^9, 
  3.907757545125795*^9}},ExpressionUUID->"247b04f1-364a-4cb3-89e4-\
742a66e1b12a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"tensor", "/:", 
   RowBox[{"Times", "[", 
    RowBox[{
     RowBox[{"scalar_", "?", "isScalar"}], ",", 
     RowBox[{"tensor", "[", 
      RowBox[{"arr_", ",", "dims_", ",", "slots_"}], "]"}]}], "]"}], ":=", 
   RowBox[{"Which", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Not", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "[", "scalar", "]"}], "===", "tensor"}], "||", 
        RowBox[{
         RowBox[{"Head", "[", "scalar", "]"}], "===", "List"}], "||", 
        RowBox[{
         RowBox[{"Head", "[", "scalar", "]"}], "===", "SparseArray"}]}], 
       "]"}], "||", 
      RowBox[{"NumericQ", "[", "scalar", "]"}]}], ",", "\[IndentingNewLine]", 
     
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{"scalar", " ", "arr"}], ",", "dims", ",", "slots"}], "]"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"And", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Head", "[", "scalar", "]"}], "===", "tensor"}], ",", 
       RowBox[{
        RowBox[{"scalar", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "===", 
        RowBox[{"{", "}"}]}]}], "]"}], ",", "\[IndentingNewLine]", 
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"scalar", "[", 
         RowBox[{"[", "1", "]"}], "]"}], " ", "arr"}], ",", "dims", ",", 
       "slots"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"isScalar", "[", "f_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Not", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Head", "[", "f", "]"}], "===", "tensor"}], "||", 
      RowBox[{
       RowBox[{"Head", "[", "f", "]"}], "===", "List"}], "||", 
      RowBox[{
       RowBox[{"Head", "[", "f", "]"}], "===", "SparseArray"}]}], "]"}], "||", 
    RowBox[{"NumericQ", "[", "f", "]"}], "||", 
    RowBox[{"And", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Head", "[", "f", "]"}], "===", "tensor"}], ",", 
      RowBox[{
       RowBox[{"f", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "===", 
       RowBox[{"{", "}"}]}]}], "]"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
  3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
  3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
  3.907672253866226*^9, 3.907672271419718*^9}, {3.907672622688484*^9, 
  3.907672640278449*^9}, {3.907672683813832*^9, 3.90767275834617*^9}, {
  3.907672883568267*^9, 3.907672886641341*^9}, {3.907672959103633*^9, 
  3.9076730652232037`*^9}, {3.907673265429119*^9, 3.9076732794778843`*^9}, {
  3.90838226936394*^9, 3.908382344348973*^9}, {3.913990030627519*^9, 
  3.9139900310065002`*^9}, {3.913990066046753*^9, 3.913990152833399*^9}, {
  3.913990236835702*^9, 3.913990256147438*^9}, {3.913999958569137*^9, 
  3.9139999642787867`*^9}},
 CellLabel->"In[82]:=",ExpressionUUID->"8ce8e460-f80a-4ab2-a765-0e516e937bca"],

Cell[BoxData[
 RowBox[{"4", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"0", ",", "1"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", "0"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.950671659573217*^9, 3.9506716621886387`*^9}},
 CellLabel->"In[84]:=",ExpressionUUID->"59747450-e202-4dce-9590-0457e5691eef"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
TensorContract : contract a tensor in matching (dualized) indices in \
input-output space\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756454365618*^9}, {
   3.907757503171634*^9, 3.907757528445844*^9}, {3.908478692895848*^9, 
   3.9084786996370373`*^9}, 
   3.913999967572259*^9},ExpressionUUID->"21806d49-ab7a-4fee-ad72-\
82974c605789"],

Cell[BoxData[
 RowBox[{"tensor", "/:", 
  RowBox[{"TensorContract", "[", 
   RowBox[{
    RowBox[{"tensor", "[", 
     RowBox[{"a_", ",", "d_", ",", "s_"}], "]"}], ",", "pairs__"}], "]"}], ":=", 
  RowBox[{"If", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"contractiblePairs", "[", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"d", "[", 
          RowBox[{"[", 
           RowBox[{"p", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"d", "[", 
          RowBox[{"[", 
           RowBox[{"p", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"p", ",", "pairs"}], "}"}]}], "]"}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"TensorContract", "[", 
       RowBox[{"a", ",", "pairs"}], "]"}], ",", 
      RowBox[{"dropInds", "[", 
       RowBox[{"d", ",", "pairs"}], "]"}], ",", 
      RowBox[{"s", "-", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"e", "<=", "s"}], ",", "1", ",", "0"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"e", ",", 
           RowBox[{"Flatten", "[", "pairs", "]"}]}], "}"}]}], "]"}]}]}], 
     "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"tensor", "::", "contract"}], ",", "d", ",", "pairs"}], "]"}]}],
    "]"}]}]], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.907672302961557*^9}, {3.907672434605021*^9, 
   3.907672434819155*^9}, {3.907711060218543*^9, 3.90771108401433*^9}, {
   3.907711130245205*^9, 3.907711131683394*^9}, {3.907711169384416*^9, 
   3.907711363464756*^9}, {3.907711393520155*^9, 3.90771162868978*^9}, {
   3.907713738738134*^9, 3.907713739374165*^9}, 3.907715242385741*^9, {
   3.907715340235523*^9, 3.907715341636847*^9}, {3.907715977294313*^9, 
   3.9077160912457857`*^9}, {3.907717072397374*^9, 3.907717072672962*^9}, 
   3.907723163597812*^9, {3.907800456300733*^9, 3.907800458546795*^9}, 
   3.907888261171179*^9, {3.908478644741373*^9, 3.908478645288102*^9}, {
   3.913990297887366*^9, 3.913990301311005*^9}, 3.913990655450351*^9, {
   3.913990705926962*^9, 3.913990708138929*^9}, {3.913995261143319*^9, 
   3.913995286246172*^9}, {3.913995326658899*^9, 3.91399536672768*^9}, {
   3.913996432664625*^9, 3.913996434363728*^9}, 3.913996661507721*^9, {
   3.913999974003365*^9, 3.91399997741815*^9}},
 CellLabel->"In[91]:=",ExpressionUUID->"18fe28f2-da44-4f19-95a2-793b3ef1d738"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"contractiblePair", "[", 
   RowBox[{"b1_", ",", "b2_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{"b1", "[", 
      RowBox[{"[", "1", "]"}], "]"}], "==", 
     RowBox[{"b2", "[", 
      RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "&&", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"b1", "[", 
      RowBox[{"[", "2", "]"}], "]"}], "==", 
     RowBox[{"b2", "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "&&", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"b1", "[", 
      RowBox[{"[", "3", "]"}], "]"}], "!=", 
     RowBox[{"b2", "[", 
      RowBox[{"[", "3", "]"}], "]"}]}], ")"}]}]}], "\n", 
 RowBox[{
  RowBox[{"contractiblePairs", "[", "dimPairs__", "]"}], ":=", 
  RowBox[{"And", "@@", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"contractiblePair", "@@", "p"}], ",", 
     RowBox[{"{", 
      RowBox[{"p", ",", "dimPairs"}], "}"}]}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"dropInds", "[", 
   RowBox[{"dims_", ",", "pairs__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"Select", "[", 
    RowBox[{
     RowBox[{"enumerate", "[", "dims", "]"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "di"}], "}"}], ",", 
         RowBox[{"Not", "[", 
          RowBox[{"MemberQ", "[", 
           RowBox[{
            RowBox[{"Flatten", "[", "pairs", "]"}], ",", "i"}], "]"}], 
          "]"}]}], "]"}], "@@", "#"}], "&"}]}], "]"}], "[", 
   RowBox[{"[", 
    RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tens", "::", "contract"}], "=", 
   "\"\<(:) Incompatible Contraction `2` of dims `1`\>\""}], ";"}]}], "Input",\

 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.907672302961557*^9}, {3.907672434605021*^9, 
   3.907672434819155*^9}, {3.907711060218543*^9, 3.90771108401433*^9}, {
   3.907711130245205*^9, 3.907711131683394*^9}, {3.907711169384416*^9, 
   3.907711363464756*^9}, {3.907711393520155*^9, 3.90771162868978*^9}, {
   3.907713738738134*^9, 3.907713739374165*^9}, 3.907715242385741*^9, {
   3.907715340235523*^9, 3.907715341636847*^9}, {3.907715977294313*^9, 
   3.9077160912457857`*^9}, {3.907717072397374*^9, 3.907717072672962*^9}, 
   3.907723163597812*^9, {3.907800456300733*^9, 3.907800458546795*^9}, 
   3.907888261171179*^9, {3.908396986031205*^9, 3.908397017910125*^9}, {
   3.913995522180488*^9, 3.913995661832398*^9}, {3.9139963575941772`*^9, 
   3.913996391582784*^9}},
 CellLabel->"In[92]:=",ExpressionUUID->"b77c839d-ab95-44c0-ab8a-20f1daf5810b"],

Cell[BoxData[
 RowBox[{"TensorContract", "[", 
  RowBox[{
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"0", ",", "1"}], "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}]}], "}"}], 
     ",", "1"}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.950671672919265*^9, 3.950671761332676*^9}},
 CellLabel->"In[97]:=",ExpressionUUID->"defc2de5-843d-4003-b800-2950a7c4048a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
\[Transpose]: Permute the dimensions of a tensor (including its bookkeeping \
dims)\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756483302883*^9}, {
  3.913999986518972*^9, 
  3.913999996674397*^9}},ExpressionUUID->"c35e4632-a609-44c1-8338-\
76fd7edb3c09"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "/:", 
   RowBox[{"Transpose", "[", 
    RowBox[{"t_tensor", ",", "perm_"}], "]"}], ":=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Transpose", "[", 
      RowBox[{
       RowBox[{"getArr", "[", "t", "]"}], ",", "perm"}], "]"}], ",", 
     RowBox[{"Permute", "[", 
      RowBox[{
       RowBox[{"getDims", "[", "t", "]"}], ",", "perm"}], "]"}], ",", 
     RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.907672328674151*^9}, 3.907758759537342*^9, {
   3.90839716624127*^9, 3.908397177078466*^9}, {3.913998484283574*^9, 
   3.913998551709639*^9}, {3.913999986527288*^9, 3.913999986530137*^9}},
 CellLabel->"In[98]:=",ExpressionUUID->"985883f7-f1cf-437d-abec-db29939503ae"],

Cell[BoxData[
 RowBox[{"Transpose", "[", 
  RowBox[{
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "0"}], "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}]}], "}"}], 
     ",", "1"}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "1"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.950671793229286*^9, 3.950671819917041*^9}, {
  3.9506718996191893`*^9, 3.950671900829442*^9}},
 CellLabel->
  "In[100]:=",ExpressionUUID->"e7e9cd6b-fef2-415c-a139-2734c57965b4"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
iso: move dimensions to/from input/output space, while preserving dimension \
order. E.g. turn vector into dual vector/2-0 tensor to 1-1 tensor to 0-2 \
tensor etc.\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756466992125*^9}, {
  3.913999986546648*^9, 
  3.913999996740595*^9}},ExpressionUUID->"6b9fc686-53e8-4e05-af94-\
9d219cc9b09f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"iso", "[", 
   RowBox[{"t_tensor", ",", "s_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"getArr", "[", "t", "]"}], ",", 
    RowBox[{"getDims", "[", "t", "]"}], ",", "s"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
  3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
  3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
  3.907672253866226*^9, 3.9076723304375553`*^9}, {3.913998580048674*^9, 
  3.913998600985688*^9}, {3.9139999866012487`*^9, 3.913999986602737*^9}},
 CellLabel->
  "In[101]:=",ExpressionUUID->"489309fb-38ac-4590-8862-1d93d412f75b"],

Cell[BoxData[
 RowBox[{"iso", "[", 
  RowBox[{
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}], ",", "1"}], "]"}]], "Input",
 CellChangeTimes->{{3.950671941873763*^9, 3.950671955733313*^9}},
 CellLabel->
  "In[102]:=",ExpressionUUID->"0af2bd34-44ae-44c2-a3bc-0c41dd3d012b"]
}, Open  ]],

Cell[TextData[{
 "The first object is a vector, while the second object is a \
\[OpenCurlyDoubleQuote]co-dual vector\[CloseCurlyDoubleQuote], which eats a \
vector in the dual space ",
 Cell[BoxData[
  FormBox[
   RowBox[{"{", 
    RowBox[{"x", ",", "2", ",", "\"\<-\>\""}], "}"}], TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "59e38a77-4316-4e41-aabe-03564bc9d573"],
 " and returns a number."
}], "Text",
 CellChangeTimes->{{3.950671962053372*^9, 
  3.950672008963409*^9}},ExpressionUUID->"c8b0e505-1196-4d32-9779-\
e229a25b01d2"],

Cell[CellGroupData[{

Cell["\<\
\[TensorProduct]: Take tensor products (preserving order of input and output)\
\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756471737318*^9}, {
  3.907757593976156*^9, 3.90775761994699*^9}, {3.913999986663104*^9, 
  3.913999996790578*^9}},ExpressionUUID->"4609aaa4-f233-4a0a-bb52-\
3c3dc85af540"],

Cell[BoxData[
 RowBox[{"tensor", "/:", 
  RowBox[{"TensorProduct", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "i1", ",", "o1", ",", "s1", ",", "n1", ",", "i2", ",", "o2", ",", "s2", 
      ",", "n2", ",", "perm"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i1", ",", "o1", ",", "s1", ",", "n1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"i2", ",", "o2", ",", "s2", ",", "n2"}], "}"}]}], "}"}], "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"get", "[", "t", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"t", ",", 
          RowBox[{"{", 
           RowBox[{"t1", ",", "t2"}], "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"get", ",", 
          RowBox[{"{", 
           RowBox[{
           "getInDims", ",", "getOutDims", ",", "getSlots", ",", 
            "getNumDims"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"perm", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"Range", "[", "s1", "]"}], ",", 
        RowBox[{
         RowBox[{"Range", "[", 
          RowBox[{"n1", "-", "s1"}], "]"}], "+", "s1", "+", "s2"}], ",", 
        RowBox[{
         RowBox[{"Range", "[", "s2", "]"}], "+", "s1"}], ",", 
        RowBox[{
         RowBox[{"Range", "[", 
          RowBox[{"n2", "-", "s2"}], "]"}], "+", "n1", "+", "s2"}]}], "]"}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"getArr", "[", "t1", "]"}], "\[TensorProduct]", 
         RowBox[{"getArr", "[", "t2", "]"}]}], ",", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"getDims", "[", "t1", "]"}], ",", 
          RowBox[{"getDims", "[", "t2", "]"}]}], "]"}], ",", 
        RowBox[{"s1", "+", "s2"}]}], "]"}], "//", 
      RowBox[{
       RowBox[{"Transpose", "[", 
        RowBox[{"#", ",", "perm"}], "]"}], "&"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.906749748606353*^9, 3.906749967366679*^9}, {
   3.906750076170949*^9, 3.906750091314396*^9}, 3.90711626624684*^9, {
   3.907120144986701*^9, 3.907120149193596*^9}, {3.907151462419403*^9, 
   3.907151479704419*^9}, {3.907152162674019*^9, 3.907152247666147*^9}, {
   3.907152301522622*^9, 3.907152393246809*^9}, 3.907152434195131*^9, {
   3.907152487719488*^9, 3.907152489596426*^9}, {3.907152543118981*^9, 
   3.907152678149186*^9}, {3.907152721528104*^9, 3.907152728889992*^9}, {
   3.907152777854985*^9, 3.907152845401612*^9}, {3.907153404243396*^9, 
   3.907153431789019*^9}, {3.907153558707147*^9, 3.90715366585646*^9}, {
   3.907153695993595*^9, 3.907153811850315*^9}, {3.907153844027598*^9, 
   3.907153847008173*^9}, {3.907153893356254*^9, 3.907153921053306*^9}, {
   3.907154169088458*^9, 3.90715418151775*^9}, {3.90715812713282*^9, 
   3.907158359819521*^9}, {3.907158444263076*^9, 3.907158457769324*^9}, {
   3.90715849989463*^9, 3.907158692454077*^9}, {3.907159074123996*^9, 
   3.907159096531789*^9}, {3.907159164090744*^9, 3.907159168160136*^9}, {
   3.907159526393098*^9, 3.90715953249902*^9}, {3.907166285512565*^9, 
   3.907166311776767*^9}, {3.907166488506247*^9, 3.907166490596196*^9}, {
   3.907167191765736*^9, 3.907167204149375*^9}, {3.907202787293882*^9, 
   3.907202810022846*^9}, 3.907203487738818*^9, {3.907415746755478*^9, 
   3.907415765119956*^9}, 3.907415795178411*^9, 3.90741634949291*^9, {
   3.907719758713616*^9, 3.90771991321104*^9}, {3.90776732419094*^9, 
   3.907767325389983*^9}, {3.907767404684523*^9, 3.907767405097447*^9}, {
   3.907768990078254*^9, 3.907769010760263*^9}, {3.907769067884709*^9, 
   3.907769081174941*^9}, {3.907769123888576*^9, 3.907769150925384*^9}, {
   3.907891655377926*^9, 3.907891661194309*^9}, {3.9083979843516006`*^9, 
   3.90839798588694*^9}, {3.908398322786236*^9, 3.908398393934125*^9}, {
   3.91399998667336*^9, 3.913999986680722*^9}, {3.914003867117243*^9, 
   3.914003871647673*^9}, {3.914004172400888*^9, 3.914004504246025*^9}, {
   3.914004544839815*^9, 3.9140045463202877`*^9}, {3.914004602408252*^9, 
   3.914004606967873*^9}, {3.914004646897081*^9, 3.91400468194748*^9}},
 CellLabel->
  "In[109]:=",ExpressionUUID->"0202d96c-3929-4236-a745-86c7c4196c45"]
}, Open  ]],

Cell["\<\
This is where it really starts getting fun. We can overload all the nice \
notation Mathematica uses to make the \[TensorProduct] operator mean tensor \
product for our tensor objects. We can take the tensor product of a vector \
and its dual vector to define a projection operator\
\>", "Text",
 CellChangeTimes->{{3.950672017539361*^9, 3.950672095492464*^9}, {
  3.9506722929439077`*^9, 3.950672303348971*^9}, {3.950672425021624*^9, 
  3.950672445934371*^9}},ExpressionUUID->"ab3b26fd-3622-4c02-900d-\
67ce319a7983"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
    "1"}], "]"}], "\[TensorProduct]", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.950672322703602*^9, 3.950672324407773*^9}},
 CellLabel->
  "In[111]:=",ExpressionUUID->"69116e60-33f4-4c89-a2c5-e2615964804c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}], "\[TensorProduct]", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
    "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.950672348094235*^9, 3.950672350999674*^9}},
 CellLabel->
  "In[112]:=",ExpressionUUID->"6f3cef9d-a4ea-40b0-9456-ccc2bbd58c1b"],

Cell["\<\
Notice that we flipped the order, but we get the same output. Why is this? \
Because the ordering keeps all input dimensions before all output dimensions, \
and otherwise goes left to right.\
\>", "Text",
 CellChangeTimes->{{3.950672355133649*^9, 
  3.9506724011095343`*^9}},ExpressionUUID->"9d4dbd7e-bd80-4e4b-9763-\
1b489fe6a404"],

Cell[CellGroupData[{

Cell[". : Left-compose tensors with matching input-output spaces", \
"ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.9077564557612543`*^9}, {
  3.907757537404871*^9, 3.907757547128302*^9}, {3.913999986471148*^9, 
  3.913999996648425*^9}, {3.914378939970416*^9, 
  3.914378943650444*^9}},ExpressionUUID->"b8c79a89-c8d5-46ff-afa9-\
4079f07c8a57"],

Cell[BoxData[
 RowBox[{
  RowBox[{"TensorProdContract", "[", 
   RowBox[{"A_", ",", "B_", ",", "dims_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Transpose", "[", 
        RowBox[{"#", ",", 
         RowBox[{"RotateRight", "@", 
          RowBox[{"Range", "@", 
           RowBox[{"ArrayDepth", "[", "#", "]"}]}]}]}], "]"}], "&"}], "@", 
      RowBox[{"Flatten", "[", 
       RowBox[{"A", ",", 
        RowBox[{"List", "@", 
         RowBox[{
          RowBox[{"Transpose", "[", "dims", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "All"}], "]"}], "]"}]}]}], "]"}]}], ".", 
     RowBox[{"Flatten", "[", 
      RowBox[{"B", ",", 
       RowBox[{"List", "@", 
        RowBox[{
         RowBox[{"Transpose", "[", "dims", "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "All"}], "]"}], "]"}]}]}], "]"}]}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{3.911390412481082*^9},
 CellLabel->
  "In[113]:=",ExpressionUUID->"4f7b240c-8070-4eac-a56c-c386ccb5a338"],

Cell[BoxData[{
 RowBox[{"tensor", "/:", 
  RowBox[{"Dot", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"i1", ",", "o1", ",", "i2", ",", "o2", ",", "s1", ",", "s2"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i1", ",", "o1", ",", "s1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"i2", ",", "o2", ",", "s2"}], "}"}]}], "}"}], "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"get", "[", "t", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"t", ",", 
          RowBox[{"{", 
           RowBox[{"t1", ",", "t2"}], "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"get", ",", 
          RowBox[{"{", 
           RowBox[{"getInDims", ",", "getOutDims", ",", "getSlots"}], "}"}]}],
          "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "o1", "]"}], "==", "s2"}], "&&", 
        RowBox[{"contractiblePairs", "@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"o1", ",", "i2"}], "}"}], "\[Transpose]"}], ")"}]}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"s2", "==", "0"}], ",", 
         RowBox[{"t1", "\[TensorProduct]", "t2"}], ",", "\[IndentingNewLine]", 
         RowBox[{"tensor", "[", 
          RowBox[{
           RowBox[{"TensorProdContract", "[", 
            RowBox[{
             RowBox[{"getArr", "[", "t1", "]"}], ",", 
             RowBox[{"getArr", "[", "t2", "]"}], ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"Range", "[", "s2", "]"}], "+", "s1"}], ",", 
                RowBox[{"Range", "[", "s2", "]"}]}], "}"}], 
              "\[Transpose]"}]}], "]"}], ",", "\[IndentingNewLine]", 
           RowBox[{"Join", "[", 
            RowBox[{"i1", ",", "o2"}], "]"}], ",", "s1"}], "]"}]}], "]"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"tensor", "::", "dot"}], ",", 
         RowBox[{"{", 
          RowBox[{"i1", ",", "o1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"i2", ",", "o2"}], "}"}]}], "]"}]}], "]"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensor", "::", "dot"}], "=", 
   "\"\<(.) Incompatible Contraction `1` with `2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.90767226495068*^9}, {3.907672419952404*^9, 
   3.907672420083069*^9}, {3.907673687131363*^9, 3.907673781561283*^9}, {
   3.907713136059516*^9, 3.9077131385936604`*^9}, {3.907716263646322*^9, 
   3.907716304868898*^9}, {3.907716355200255*^9, 3.907716356736556*^9}, {
   3.907717728778864*^9, 3.907717814807884*^9}, {3.907722768145527*^9, 
   3.90772277264531*^9}, 3.907722870881987*^9, {3.907723204407166*^9, 
   3.907723206891835*^9}, {3.907775096317631*^9, 3.907775134384741*^9}, {
   3.907775305180152*^9, 3.907775312535729*^9}, {3.907776099788756*^9, 
   3.907776122229355*^9}, {3.907888017991217*^9, 3.907888024414515*^9}, {
   3.907888594312314*^9, 3.907888595019957*^9}, 3.907888732210315*^9, {
   3.908396040304098*^9, 3.90839612307782*^9}, {3.908397147071259*^9, 
   3.908397152422577*^9}, {3.908478735759414*^9, 3.908478763189942*^9}, {
   3.908478841214872*^9, 3.9084788727284193`*^9}, {3.913996463065974*^9, 
   3.913996502596289*^9}, {3.91399657765428*^9, 3.913996582522409*^9}, {
   3.913996772023965*^9, 3.913997004924499*^9}, {3.913997148184025*^9, 
   3.913997192028514*^9}, {3.9139972384280653`*^9, 3.913997274659555*^9}, 
   3.913997314809173*^9, 3.913997353889107*^9, {3.91399738997057*^9, 
   3.913997477167941*^9}, {3.913997516408454*^9, 3.913997580956914*^9}, {
   3.913997686774105*^9, 3.913997699113749*^9}, {3.913997762703188*^9, 
   3.913997813809366*^9}, {3.913998052406001*^9, 3.913998161035513*^9}, {
   3.913998208643481*^9, 3.913998218340476*^9}, {3.913999986480522*^9, 
   3.9139999864906597`*^9}, {3.91400693516453*^9, 3.914006959321848*^9}},
 CellLabel->
  "In[114]:=",ExpressionUUID->"91145917-5bbb-45c5-8d54-e529613ada85"]
}, Open  ]],

Cell["\<\
And now we actually start doing the thing that tensors are for - linear \
operators via tensor contraction. We\[CloseCurlyQuote]ll overload the . \
notation to do this\
\>", "Text",
 CellChangeTimes->{{3.950672456382237*^9, 
  3.950672483757689*^9}},ExpressionUUID->"86934ce1-431a-4826-bd02-\
ccaa94d75f94"],

Cell["\<\
Putting a vector into its corresponding dual vector will return the scalar 1\
\>", "Text",
 CellChangeTimes->{{3.950672133716651*^9, 
  3.9506721473974857`*^9}},ExpressionUUID->"4fc37b44-cc76-4393-924d-\
b93923c9a444"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}], ".", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
    "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.950672100478511*^9, 3.950672122036294*^9}},
 CellLabel->
  "In[116]:=",ExpressionUUID->"6a711267-79f4-4b06-9edf-986dc528f0b4"],

Cell["\<\
Switching the order will instead create a 2-tensor. Understanding the arity \
of the tensors is important here\
\>", "Text",
 CellChangeTimes->{{3.950672149821824*^9, 3.9506722446611547`*^9}, {
  3.95067248995996*^9, 
  3.950672493037756*^9}},ExpressionUUID->"64af2cab-c347-4045-a873-\
f6e845197187"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
    "1"}], "]"}], ".", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.950672127940247*^9, 3.950672129020878*^9}},
 CellLabel->
  "In[117]:=",ExpressionUUID->"8974940e-65ac-4104-8156-f0e171028ecd"],

Cell["We can check that our projection operator behaves correctly", "Text",
 CellChangeTimes->{{3.9506725010814323`*^9, 
  3.9506725122653437`*^9}},ExpressionUUID->"1a296220-10e9-448d-91c1-\
5af5efe20800"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}], ".", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
      "1"}], "]"}], "\[TensorProduct]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
      "0"}], "]"}]}], ")"}]}]], "Input",
 CellChangeTimes->{{3.95067252638488*^9, 3.95067253778204*^9}},
 CellLabel->
  "In[118]:=",ExpressionUUID->"0e42a38c-40a4-49c3-a10e-fe01e55f0021"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(", 
   RowBox[{
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
      "0"}], "]"}], ".", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "}"}], ",", 
      "1"}], "]"}]}], ")"}], "\[TensorProduct]", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9506725440142*^9, 3.950672549247912*^9}},
 CellLabel->
  "In[119]:=",ExpressionUUID->"9a7ecf83-3855-4ac6-8336-3cb2426718ab"],

Cell["\<\
Notice how different those two operations were numerically (in the top, we \
create a projection matrix, then we contract it against a appropriate vector, \
whereas in the bottom, we contract a vector with its dual to get a scalar 1, \
which we multiply our outer vector by), but of course they are defined to be \
equivalent mathematically.\
\>", "Text",
 CellChangeTimes->{{3.9506725600862837`*^9, 
  3.950672632119031*^9}},ExpressionUUID->"ec3d1919-1f0b-44de-a24c-\
b90748241073"],

Cell[CellGroupData[{

Cell["adjoint: take adjoint: switch input-output dimensions", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.9077565240312843`*^9}, {
  3.9079432243398113`*^9, 
  3.90794322523705*^9}},ExpressionUUID->"65b1896c-316a-46cd-b051-\
f46e42f8dc53"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"adjoint", "[", "t_tensor", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"perm", ",", "n", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n", ",", "s"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"getNumDims", "[", "t", "]"}], ",", 
         RowBox[{"getSlots", "[", "t", "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"perm", "=", 
       RowBox[{"RotateRight", "[", 
        RowBox[{
         RowBox[{"Range", "[", "n", "]"}], ",", "s"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"getArr", "[", "t", "]"}], ",", "perm"}], "]"}], ",", 
        RowBox[{"Permute", "[", 
         RowBox[{
          RowBox[{"getDims", "[", "t", "]"}], ",", "perm"}], "]"}], ",", 
        RowBox[{"n", "-", "s"}]}], "]"}]}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
  3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
  3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
  3.907672253866226*^9, 3.9076723304375553`*^9}, {3.907717985057308*^9, 
  3.907717985928586*^9}, {3.907718498129917*^9, 3.90771850456847*^9}, {
  3.907890055755906*^9, 3.907890058097739*^9}, {3.907890094819516*^9, 
  3.907890195864214*^9}, {3.913998637965161*^9, 3.913998677161044*^9}, {
  3.913998710696855*^9, 3.913998786511754*^9}, {3.913999668001206*^9, 
  3.913999753770379*^9}, {3.91399978992647*^9, 3.913999823453769*^9}, {
  3.91399998660538*^9, 3.913999986607557*^9}, {3.914001425839258*^9, 
  3.9140014265665903`*^9}, {3.914001462690608*^9, 3.914001485030951*^9}},
 CellLabel->
  "In[120]:=",ExpressionUUID->"12363023-cc94-432f-9148-e1d11db7247d"]
}, Open  ]],

Cell["\<\
Note that this adjoint is a bit different to other choices and definitions of \
adjoint. Here it means nothing more than switching the input-output \
dimensions. We aren\[CloseCurlyQuote]t doing any sneaky changes between \
vector bases and their duals.\
\>", "Text",
 CellChangeTimes->{{3.950672641439086*^9, 
  3.950672706421269*^9}},ExpressionUUID->"48ca36b3-0391-4312-9bad-\
a196e759b9fd"],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    RowBox[{"(", ")"}], 
    RowBox[{"-", "1"}]], TraditionalForm]],ExpressionUUID->
  "b4359f3d-1733-4dab-98db-e1d9bed0043f"],
 ": Invert a vector-to-vector tensor"
}], "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756458987772*^9}, {
  3.907757526969451*^9, 3.907757538684328*^9}, {3.913999986626103*^9, 
  3.913999996767166*^9}},ExpressionUUID->"53b922d2-125f-4a6d-8435-\
660836c3d4da"],

Cell[BoxData[{
 RowBox[{"tensor", "/:", 
  RowBox[{"Inverse", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"a", ",", "d", ",", "i", ",", "o", ",", "s", ",", "n"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"a", ",", "d", ",", "i", ",", "o", ",", "s", ",", "n"}], "}"}],
       "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"get", "[", "t", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"get", ",", 
          RowBox[{"{", 
           RowBox[{
           "getArr", ",", "getDims", ",", "getInDims", ",", "getOutDims", ",",
             "getSlots", ",", "getNumDims"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"And", "[", 
        RowBox[{
         RowBox[{"s", "==", "1"}], ",", 
         RowBox[{"n", "==", "2"}], ",", 
         RowBox[{
          RowBox[{"i", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}], "==", 
          RowBox[{"o", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"tensor", "[", 
        RowBox[{
         RowBox[{"Inverse", "[", "a", "]"}], ",", 
         RowBox[{"dual", "/@", 
          RowBox[{"Join", "[", 
           RowBox[{"o", ",", "i"}], "]"}]}], ",", "1"}], "]"}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"tensor", "::", "inv"}], ",", "i", ",", "o"}], "]"}]}], 
      "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensor", "::", "inv"}], "=", 
   "\"\<(inv) Incompatible Inverse of dims `1`, `2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.9076722796951*^9}, {3.907672446215972*^9, 
   3.907672446516434*^9}, {3.907710766560808*^9, 3.907710770389073*^9}, {
   3.907718703236058*^9, 3.907718708186845*^9}, 3.907891510226568*^9, {
   3.908397305765516*^9, 3.908397320296867*^9}, {3.913999986635458*^9, 
   3.913999986642818*^9}, {3.914001529688387*^9, 3.914001642514615*^9}, {
   3.914001695769645*^9, 3.914001733539795*^9}},
 CellLabel->
  "In[121]:=",ExpressionUUID->"9974d3f9-6557-40d9-b39a-d840789cff83"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
toShape: Convenience function to calculate desired transpose and isomorphism \
for given final dimensions\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756471737318*^9}, {
  3.907757593976156*^9, 3.90775761994699*^9}, {3.9084115815432243`*^9, 
  3.908411613684448*^9}},ExpressionUUID->"bde73839-5d6e-4158-83dc-\
2924dc0624dd"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{"toShape", "[", 
    RowBox[{"t_tens", ",", "order_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dims1", ",", "dims2", ",", "perm", ",", "s"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d1", "=", 
       RowBox[{"getDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dims2", "=", 
       RowBox[{"Join", "@@", "order"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"s", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"order", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"perm", "=", 
       RowBox[{"FindPermutation", "[", 
        RowBox[{"dims1", ",", "dims2"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"iso", "[", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"tensor", "[", 
           RowBox[{"t", ",", "dims"}], "]"}], ",", "perm"}], "]"}], ",", 
        "s"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.9139999866832037`*^9, 3.913999986684983*^9}, {
   3.914004872763928*^9, 3.914004884711294*^9}, 3.914004945242391*^9},
 CellLabel->"In[38]:=",ExpressionUUID->"0c6b95eb-3ee6-44fc-a525-61fc1abdd305"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
contractOne: Convenience function for contracting a single dimension of a \
tensor\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756471737318*^9}, {
  3.907757593976156*^9, 3.90775761994699*^9}, {3.9084115815432243`*^9, 
  3.908411613684448*^9}, {3.908412906963353*^9, 3.908412925265785*^9}, {
  3.913999986704508*^9, 3.913999996813191*^9}, {3.950672747639831*^9, 
  3.950672751335538*^9}},ExpressionUUID->"c6167a36-5e0d-40cb-92fa-\
11df0d13c09f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"permutationSwitch", "[", 
   RowBox[{"a_", ",", "b_", ",", "n_"}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"a", "==", "b"}], ",", 
    RowBox[{"Range", "[", "n", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"PermutationList", "[", 
     RowBox[{
      RowBox[{"Cycles", "[", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"a", ",", "b"}], "}"}], "}"}], "]"}], ",", "n"}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.910810712345295*^9, 3.910810713013959*^9}},
 CellLabel->
  "In[123]:=",ExpressionUUID->"fba344d6-b732-4614-9f7a-a39cbe1eb669"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractOne", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor", ",", "i_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", "=", 
      RowBox[{"getNumDims", "[", "t1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"s", "=", 
      RowBox[{"getSlots", "[", "t1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"t1", "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"permutationSwitch", "[", 
              RowBox[{"i", ",", "n", ",", "n"}], "]"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"iso", "[", 
           RowBox[{"#", ",", 
            RowBox[{"n", "-", "1"}]}], "]"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"#", ".", "t2"}], "&"}]}], "//", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"#", ",", 
          RowBox[{"permutationSwitch", "[", 
           RowBox[{"i", ",", "n", ",", "n"}], "]"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "s"}], "]"}], "&"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9084129278953657`*^9, 3.908412987792101*^9}, {
   3.90841301804798*^9, 3.908413079810834*^9}, {3.908413137589224*^9, 
   3.9084133852208*^9}, {3.908413575747829*^9, 3.908413613413368*^9}, {
   3.908413677870894*^9, 3.908413717485882*^9}, {3.910810725471829*^9, 
   3.910810777888925*^9}, 3.910810813402042*^9, {3.913999986713945*^9, 
   3.913999986715848*^9}, {3.9140049687748833`*^9, 3.914004982479257*^9}},
 CellLabel->
  "In[124]:=",ExpressionUUID->"b6b04c4a-0ea4-444d-8478-c2e5a85938ae"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractOnes", "[", 
   RowBox[{"t1_tensor", ",", " ", "ts_", ",", " ", "is_"}], "]"}], ":=", 
  RowBox[{"Which", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Length", "[", "ts", "]"}], "==", "0"}], ",", 
    "\[IndentingNewLine]", "t1", ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Length", "[", "ts", "]"}], "==", "1"}], ",", 
    RowBox[{"contractOne", "[", 
     RowBox[{"t1", ",", 
      RowBox[{"ts", "[", 
       RowBox[{"[", "1", "]"}], "]"}], ",", 
      RowBox[{"is", "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Length", "[", "ts", "]"}], ">", "1"}], ",", 
    RowBox[{"contractOnes", "[", 
     RowBox[{
      RowBox[{"contractOne", "[", 
       RowBox[{"t1", ",", 
        RowBox[{"ts", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"is", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", 
      RowBox[{"ts", "[", 
       RowBox[{"[", 
        RowBox[{"2", ";;"}], "]"}], "]"}], ",", 
      RowBox[{"is", "[", 
       RowBox[{"[", 
        RowBox[{"2", ";;"}], "]"}], "]"}]}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.910862144435117*^9, 3.91086223720123*^9}, {
   3.91086232425127*^9, 3.9108623296797075`*^9}, {3.910862365767033*^9, 
   3.910862387294893*^9}, {3.911770126114318*^9, 3.911770136145083*^9}, {
   3.9117703632479153`*^9, 3.9117703698539753`*^9}, 3.913999986718894*^9},
 CellLabel->
  "In[125]:=",ExpressionUUID->"637478d3-f56e-427a-86bf-273f6ef8de66"]
}, Open  ]],

Cell["\<\
Often we\[CloseCurlyQuote]ll have a big tensor object, and we want to apply a \
transform over a single dimension. Right now we\[CloseCurlyQuote]d have to \
either take the full tensor product, then define the appropriate contraction \
(this is an inefficient approach that Mathematica uses for its tensors), or \
we could take our tensor, permute the indices and arities to put the \
contraction dimension at the rear, compose that with our transform operator, \
then transform everything back. This is more efficient, and we can implement \
it quickly above.\
\>", "Text",
 CellChangeTimes->{{3.950672761295218*^9, 
  3.950672903916484*^9}},ExpressionUUID->"5b293b61-0f4c-4a7a-a13b-\
734ab6752273"],

Cell[CellGroupData[{

Cell["\<\
pointwise: Apply local function to pointwise values of tensor components. \
Keep dims same\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907756439616569*^9, 3.907756471737318*^9}, {
  3.907757593976156*^9, 3.90775761994699*^9}, {3.9084115815432243`*^9, 
  3.908411613684448*^9}, {3.908412906963353*^9, 3.908412925265785*^9}, {
  3.908446347367627*^9, 3.9084463683048477`*^9}, {3.908449229780074*^9, 
  3.908449255326048*^9}, {3.913999986768067*^9, 
  3.913999996858008*^9}},ExpressionUUID->"cbfd1bb8-f22d-4745-8283-\
813f358b2b0e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"pointwise", "[", 
   RowBox[{"func_", ",", "t_tensor"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"func", "[", 
     RowBox[{"getArr", "[", "t", "]"}], "]"}], ",", 
    RowBox[{"getDims", "[", "t", "]"}], ",", 
    RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.90844909661987*^9, 3.908449152644052*^9}, {
  3.913999986777508*^9, 3.913999986778986*^9}, {3.914005227012392*^9, 
  3.914005237783616*^9}},
 CellLabel->
  "In[127]:=",ExpressionUUID->"7c66ab43-43fc-491f-9ad0-8b38d282975b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
sparse: Put the array in sparse format (important for efficient contraction \
with other sparse tensors)\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}, {3.908468614421708*^9, 3.908468641928378*^9}, {
  3.913999986797797*^9, 
  3.9139999968815*^9}},ExpressionUUID->"a232dc43-db31-4da9-9b4a-f0675478a5a7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"sparse", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"SparseArray", "[", 
     RowBox[{"getArr", "[", "t", "]"}], "]"}], ",", 
    RowBox[{"getDims", "[", "t", "]"}], ",", 
    RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.908467901760326*^9, 3.908467917177204*^9}, {
  3.913999986807013*^9, 3.913999986808441*^9}, {3.914005243931826*^9, 
  3.914005257861755*^9}, {3.9506729201319*^9, 3.950672922453614*^9}},
 CellLabel->
  "In[130]:=",ExpressionUUID->"e4e17f3a-554b-4741-a3e6-e2b36dd0547e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["dense: Opposite of sparse, in case mostly full array", "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}, {3.908468614421708*^9, 3.908468641928378*^9}, {
  3.90850824812779*^9, 
  3.908508264191016*^9}},ExpressionUUID->"010a95c7-0b51-40f2-8a75-\
df46b76adafe"],

Cell[BoxData[
 RowBox[{
  RowBox[{"dense", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Normal", "[", 
     RowBox[{"getArr", "[", "t", "]"}], "]"}], ",", 
    RowBox[{"getDims", "[", "t", "]"}], ",", 
    RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9084958455235643`*^9, 3.908495856513079*^9}, {
  3.908495906133758*^9, 3.908495912682426*^9}, {3.913999986810672*^9, 
  3.913999986811864*^9}, {3.914005265921101*^9, 3.914005269294312*^9}},
 CellLabel->
  "In[131]:=",ExpressionUUID->"08e195bb-e017-45fb-af3a-4c7a7e2a27d4"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
flip: Switch all vectors to their dual, maintaining coefficients. Only valid \
for orthonormal bases\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}, {3.908468614421708*^9, 3.908468641928378*^9}, {
  3.90850824812779*^9, 3.908508264191016*^9}, {3.908568502091885*^9, 
  3.908568522248776*^9}},ExpressionUUID->"8669f0eb-473e-4a43-9da0-\
fc420f5b1a64"],

Cell[BoxData[
 RowBox[{
  RowBox[{"flip", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"getArr", "[", "t", "]"}], ",", 
    RowBox[{"dual", "/@", 
     RowBox[{"getDims", "[", "t", "]"}]}], ",", 
    RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9139999868146877`*^9, 3.913999986816135*^9}, {
  3.914005276876575*^9, 3.914005294416696*^9}},
 CellLabel->
  "In[132]:=",ExpressionUUID->"4cc9d3ef-f237-4bbe-89ef-e2ea45279d59"]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Systems of tensors", "Chapter",
 CellChangeTimes->{{3.910691287913536*^9, 3.910691291063047*^9}, {
  3.913999986833622*^9, 
  3.913999996904132*^9}},ExpressionUUID->"23cd2ae5-36b9-4253-a5d6-\
81d5a38d8390"],

Cell["\<\
We want to be able to convert the systems of symbolic tensors into \
\[OpenCurlyDoubleQuote]flattened\[CloseCurlyDoubleQuote] matrices and vectors \
that we can then use standard linear algebra routines to solve.\
\>", "Text",
 CellChangeTimes->{{3.907759189267467*^9, 3.907759198534301*^9}, {
  3.907759317224411*^9, 3.90775934536982*^9}, {3.913999986858863*^9, 
  3.913999996925078*^9}},ExpressionUUID->"33bb27f1-f492-43dd-b4d7-\
d5203cf0ffd1"],

Cell[CellGroupData[{

Cell["\<\
flattenTensor, flattenTensors: convert an output-only tensor to a flattened \
vector (and concatenate if list of such tensors)\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907759363083555*^9, 3.907759397522738*^9}, {
  3.907759474938169*^9, 3.907759501810771*^9}, {3.907759976564056*^9, 
  3.9077599903288937`*^9}, {3.913999986883353*^9, 
  3.913999996971291*^9}},ExpressionUUID->"1f967315-7adc-44f9-b79b-\
f271382a6842"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"transformTensorToVector", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"getSlots", "[", "t", "]"}], "==", "0"}], ",", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"getArr", "[", "t", "]"}], ",", 
      RowBox[{"Times", "@@", 
       RowBox[{"getDimShapes", "[", "t", "]"}]}]}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"transformTensorToVector", "::", "flatten"}], ",", 
      RowBox[{"getDims", "[", "t", "]"}], ",", 
      RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"transformTensorToVector", "::", "flatten"}], " ", "=", " ", 
   "\"\<Attempting to flatten linear operator of dimensions `1`, slots \
`2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.907759553158907*^9, 3.907759627965026*^9}, {
  3.907759659891843*^9, 3.907759713740258*^9}, {3.9077597640261497`*^9, 
  3.907759785310672*^9}, {3.908570507852067*^9, 3.908570518982417*^9}, {
  3.913999986916429*^9, 3.913999986918771*^9}, {3.91400531862014*^9, 
  3.914005325879724*^9}, {3.914005390237826*^9, 3.914005415265764*^9}, {
  3.914005466118168*^9, 3.914005474345995*^9}, {3.914005540862398*^9, 
  3.914005575494035*^9}, {3.914005606004765*^9, 3.9140056070871763`*^9}, {
  3.9142805067361193`*^9, 3.9142805452947893`*^9}},
 CellLabel->
  "In[133]:=",ExpressionUUID->"f8f8b370-985c-4efe-a3df-0be747b46286"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformTensorsToVector", "[", "ts__", "]"}], ":=", 
  RowBox[{"Join", "@@", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"transformTensorToVector", "[", "t", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"t", ",", "ts"}], "}"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.907759808860383*^9, 3.907759917553041*^9}, {
  3.907759951661416*^9, 3.90775995262848*^9}, {3.9140055786305428`*^9, 
  3.914005594574518*^9}},
 CellLabel->
  "In[135]:=",ExpressionUUID->"b94e7325-b489-4c77-a532-4e42c874b743"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
partitionVec: convert a numerical vector back into association of tensor \
objects using the dimension information and ordering of each tensor\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907759363083555*^9, 3.907759397522738*^9}, {
  3.907759474938169*^9, 3.907759499056304*^9}, {3.907759996401737*^9, 
  3.907760059070616*^9}, {3.913999986937198*^9, 
  3.913999997018611*^9}},ExpressionUUID->"7226d879-d035-4dfd-9288-\
e267c23332cd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformVectorToTensors", "[", 
   RowBox[{"vec_", ",", "dims_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "varNames", ",", "varDims", ",", "dimNames", ",", "shapes", ",", "sizes",
       ",", "strides", ",", "subArrs", ",", "tensors"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"varNames", "=", 
      RowBox[{"Keys", "[", "dims", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"varDims", "=", 
      RowBox[{"Values", "[", "dims", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dimNames", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"d", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "1"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"d", ",", "varDims"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"shapes", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"d", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "2"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"d", ",", "varDims"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"sizes", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Times", "@@", "##"}], "&"}], "/@", "shapes"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"strides", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"FoldList", "[", 
           RowBox[{"Plus", ",", "0", ",", "sizes"}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"i", ";;", 
            RowBox[{"i", "+", "1"}]}], "]"}], "]"}], "+", 
         RowBox[{"{", 
          RowBox[{"1", ",", "0"}], "}"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "sizes", "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"subArrs", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"stride", ",", "shape"}], "}"}], ",", 
          RowBox[{"ArrayReshape", "[", 
           RowBox[{
            RowBox[{"vec", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"stride", "[", 
                RowBox[{"[", "1", "]"}], "]"}], ";;", 
               RowBox[{"stride", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "]"}], ",", 
            "shape"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"strides", ",", "shapes"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tensors", "=", 
      RowBox[{"Association", "[", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"v", ",", "a", ",", "d"}], "}"}], ",", 
           RowBox[{"v", "->", 
            RowBox[{"tensor", "[", 
             RowBox[{"a", ",", "d", ",", "0"}], "]"}]}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"varNames", ",", "subArrs", ",", "varDims"}], "}"}]}], 
        "]"}], "]"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.908573765324266*^9, 3.908573766634354*^9}, {
   3.913999986971672*^9, 3.913999997030154*^9}, {3.9140055327926493`*^9, 
   3.914005560762953*^9}, 3.914005734404449*^9, {3.914018136448022*^9, 
   3.914018138616709*^9}},
 CellLabel->
  "In[136]:=",ExpressionUUID->"3cc515e9-2e89-4e77-a7a4-1b2441034827"]
}, Open  ]],

Cell[CellGroupData[{

Cell["tensorToMatrix: convert general tensor to a matrix", "ItemNumbered",
 CellChangeTimes->{{3.907759363083555*^9, 3.907759397522738*^9}, {
  3.907759474938169*^9, 3.907759499056304*^9}, {3.907759996401737*^9, 
  3.907760022618107*^9}, {3.907760351535562*^9, 3.907760352909562*^9}, {
  3.907761764388616*^9, 3.907761764392156*^9}, {3.9139999869950857`*^9, 
  3.913999997070447*^9}},ExpressionUUID->"794b3135-1d4e-4fd2-bb7e-\
ea88c8088510"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformTensorToMatrix", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"ArrayReshape", "[", 
   RowBox[{
    RowBox[{"getArr", "[", "t", "]"}], ",", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Times", "@@", 
        RowBox[{"##", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "&"}], ")"}], "/@", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"getInDims", "[", "t", "]"}], ",", 
       RowBox[{"getOutDims", "[", "t", "]"}]}], "}"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.913999987026831*^9, 3.913999997078538*^9}, {
  3.914006080169022*^9, 3.914006135650153*^9}},
 CellLabel->
  "In[137]:=",ExpressionUUID->"75376685-d169-438f-9c29-d8ac9c5b5d9e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
tensorToMatrixSystem: convert 2 dimensional array of tensors into single \
matrix. Combine tensors in a single row along their columns, then combine \
each row along the rows.\
\>", "ItemNumbered",
 CellChangeTimes->{{3.907759363083555*^9, 3.907759397522738*^9}, {
  3.907759474938169*^9, 3.907759499056304*^9}, {3.907759996401737*^9, 
  3.907760022618107*^9}, {3.907760351535562*^9, 3.907760352909562*^9}, {
  3.907761765770966*^9, 3.90776181628046*^9}, {3.9139999870475893`*^9, 
  3.913999997142091*^9}},ExpressionUUID->"c611872b-9dbf-4449-875c-\
f2357ce0a9d8"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"transformTensorsToMatrixSystem", "[", "ops_", "]"}], ":=", 
   RowBox[{"Join", "@@", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{"##", ",", "2"}], "]"}], "&"}], "@@", "#"}], "&"}], ")"}], 
      "/@", 
      RowBox[{"(", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"transformTensorToMatrix", "[", "#", "]"}], 
           "\[Transpose]"}], "&"}], ",", "ops", ",", 
         RowBox[{"{", "2", "}"}]}], "]"}], ")"}]}], ")"}]}]}], ";"}]], "Input",\

 CellChangeTimes->{{3.907200295896158*^9, 3.907200349637412*^9}, {
   3.9072004370878057`*^9, 3.9072004374275*^9}, {3.907326419326726*^9, 
   3.907326481013198*^9}, {3.907326542703182*^9, 3.907326646917351*^9}, 
   3.907327023236549*^9, 3.907327153908765*^9, 3.907327229832382*^9, 
   3.9074168163342867`*^9, 3.907759491333806*^9, {3.907760014270714*^9, 
   3.907760019664077*^9}, {3.9077604360288363`*^9, 3.907760457406545*^9}, 
   3.907761279883967*^9, {3.907761365922615*^9, 3.907761400016532*^9}, {
   3.9077614641748877`*^9, 3.9077614655312634`*^9}, {3.907761518759818*^9, 
   3.907761527378355*^9}, {3.907761820014333*^9, 3.907761823080768*^9}, {
   3.908571308278788*^9, 3.908571312288694*^9}, {3.913999987103901*^9, 
   3.9139999971542797`*^9}, {3.914006167766583*^9, 3.914006186271092*^9}},
 CellLabel->
  "In[138]:=",ExpressionUUID->"9141e0e9-0a4f-432b-8223-8bc5927eba45"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Specific tensors", "Chapter",
 CellChangeTimes->{{3.910691217889071*^9, 3.910691222814912*^9}, {
  3.91069129553001*^9, 3.910691303326082*^9}, {3.913999987125263*^9, 
  3.9139999971712637`*^9}},ExpressionUUID->"25460260-283f-442d-8e7e-\
6bce2630c320"],

Cell["\<\
Here we\[CloseCurlyQuote]re going to define functions that construct some \
standard tensors, as well as tensors that perform operations relevant for \
ultraspherical polynomials.\
\>", "Text",
 CellChangeTimes->{{3.9506730478888702`*^9, 
  3.950673075225046*^9}},ExpressionUUID->"5e236c9c-e5ed-4cb0-b98b-\
0f7abe03773c"],

Cell[CellGroupData[{

Cell["Ultraspherical operator matrices", "Subsection",
 CellChangeTimes->{{3.910689356580768*^9, 3.910689357706352*^9}, 
   3.910691322116852*^9},ExpressionUUID->"c3ac774a-51f8-4afd-881f-\
6525c0b69498"],

Cell["\<\
Sparse matrices for ultraspherical polynomials for differentiation, \
projection, and multiplication by x (Jacobi matrix), and FFT-based transforms \
from grid to coefficient space for Chebyshev polynomials\
\>", "Text",
 CellChangeTimes->{{3.9074158947609653`*^9, 3.907415932945819*^9}, {
  3.907415963289102*^9, 
  3.907415981364208*^9}},ExpressionUUID->"a27cbc06-d8db-47a9-8446-\
2e79b3dfb1ee"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ops", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ops", "[", "\"\<D\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"m", ",", "NN"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"m", "==", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Band", "[", 
           RowBox[{"{", 
            RowBox[{"1", ",", "2"}], "}"}], "]"}], "->", 
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", 
            RowBox[{"NN", "-", "1"}]}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Band", "[", 
           RowBox[{"{", 
            RowBox[{"1", ",", "2"}], "}"}], "]"}], "->", 
          RowBox[{"2", " ", "m"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}]}], "\[IndentingNewLine]", 
      "]"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ops", "[", "\"\<I\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"m", ",", "NN"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"m", "==", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}], "->", "1"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"2", ",", "2"}], "}"}], "]"}], "->", 
            FractionBox["1", "2"]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"1", ",", "3"}], "}"}], "]"}], "->", 
            FractionBox[
             RowBox[{"-", "1"}], "2"]}]}], "}"}], ",", "\[IndentingNewLine]", 
         
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"1", ",", "1"}], "}"}], "]"}], "->", 
            FractionBox["m", 
             RowBox[{"m", "+", 
              RowBox[{"Range", "[", 
               RowBox[{"0", ",", 
                RowBox[{"NN", "-", "1"}]}], "]"}]}]]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"1", ",", "3"}], "}"}], "]"}], "->", 
            FractionBox[
             RowBox[{"-", "m"}], 
             RowBox[{"m", "+", 
              RowBox[{"Range", "[", 
               RowBox[{"2", ",", 
                RowBox[{"NN", "-", "1"}]}], "]"}]}]]}]}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}]}], "]"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"ops", "[", "\"\<X\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"m", ",", "NN"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"m", "==", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"1", ",", "2"}], "}"}], "]"}], "->", 
            FractionBox["1", "2"]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"3", ",", "2"}], "}"}], "]"}], "->", 
            FractionBox["1", "2"]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"2", ",", "1"}], "}"}], "->", "1"}]}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"1", ",", "2"}], "}"}], "]"}], "->", 
            FractionBox[
             RowBox[{
              RowBox[{"2", "m"}], "-", "1", "+", 
              RowBox[{"Range", "[", 
               RowBox[{"1", ",", 
                RowBox[{"NN", "-", "1"}]}], "]"}]}], 
             RowBox[{"2", 
              RowBox[{"(", 
               RowBox[{"m", "+", 
                RowBox[{"Range", "[", 
                 RowBox[{"1", ",", 
                  RowBox[{"NN", "-", "1"}]}], "]"}]}], ")"}]}]]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Band", "[", 
             RowBox[{"{", 
              RowBox[{"2", ",", "1"}], "}"}], "]"}], "->", 
            FractionBox[
             RowBox[{"1", "+", 
              RowBox[{"Range", "[", 
               RowBox[{"0", ",", 
                RowBox[{"NN", "-", "2"}]}], "]"}]}], 
             RowBox[{"2", 
              RowBox[{"(", 
               RowBox[{"m", "+", 
                RowBox[{"Range", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"NN", "-", "2"}]}], "]"}]}], ")"}]}]]}]}], "}"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"polyFam", "[", "m_", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"m", "==", "0"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"n", ",", "x"}], "}"}], ",", 
      RowBox[{"ChebyshevT", "[", 
       RowBox[{"n", ",", "x"}], "]"}]}], "]"}], ",", 
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"n", ",", "x"}], "}"}], ",", 
      RowBox[{"GegenbauerC", "[", 
       RowBox[{"n", ",", "m", ",", "x"}], "]"}]}], "]"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"coeffToPoly", "[", 
   RowBox[{"m_", ",", "cs_", ",", "x_"}], "]"}], ":=", 
  RowBox[{"Total", "[", 
   RowBox[{"MapThread", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"i", ",", "ci"}], "}"}], " ", ",", 
       RowBox[{"ci", " ", 
        RowBox[{
         RowBox[{"polyFam", "[", "m", "]"}], "[", 
         RowBox[{"i", ",", "x"}], "]"}]}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Range", "[", 
        RowBox[{"0", ",", 
         RowBox[{
          RowBox[{"Length", "[", "cs", "]"}], "-", "1"}]}], "]"}], ",", 
       "cs"}], "}"}]}], "]"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"coeff2DtoPoly", "[", 
   RowBox[{"mx_", ",", "my_", ",", "cs_", ",", "x_", ",", "y_"}], "]"}], ":=", 
  RowBox[{"Total", "[", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i", ",", "j", ",", "c"}], "}"}], ",", 
        RowBox[{"c", " ", 
         RowBox[{
          RowBox[{"polyFam", "[", "mx", "]"}], "[", 
          RowBox[{"i", ",", "x"}], "]"}], 
         RowBox[{
          RowBox[{"polyFam", "[", "my", "]"}], "[", 
          RowBox[{"j", ",", "y"}], "]"}]}]}], "]"}], "@@", "tuple"}], ",", 
     RowBox[{"{", 
      RowBox[{"tuple", ",", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"i", "-", "1"}], ",", 
             RowBox[{"j", "-", "1"}], ",", 
             RowBox[{"cs", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{
              RowBox[{"Dimensions", "[", "cs", "]"}], "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", 
             RowBox[{
              RowBox[{"Dimensions", "[", "cs", "]"}], "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}], ",", "1"}], 
        "]"}]}], "}"}]}], "]"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"G2C", "[", "g_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"arr", ",", "dim", ",", "Ns"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"arr", "=", "g"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Ns", "=", 
      RowBox[{"Dimensions", "[", "arr", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dim", "=", 
      RowBox[{"Length", "[", "Ns", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"arr", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Times", "@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             FractionBox["2", 
              RowBox[{"Sqrt", "[", "#", "]"}]], "&"}], ")"}], "/@", "Ns"}], 
          ")"}]}], ")"}], 
       RowBox[{"FourierDCT", "[", "g", "]"}]}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{
      RowBox[{"arr", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"arr", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "/", "2"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"dim", "==", "2"}], ",", 
       RowBox[{
        RowBox[{"arr", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "1"}], "]"}], "]"}], "=", 
        RowBox[{
         RowBox[{"arr", "[", 
          RowBox[{"[", 
           RowBox[{";;", ",", "1"}], "]"}], "]"}], "/", "2"}]}]}], "]"}], ";",
      "\[IndentingNewLine]", "arr"}]}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"C2G", "[", "c_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"arr", ",", "dim", ",", "Ns"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"arr", "=", "c"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Ns", "=", 
      RowBox[{"Dimensions", "[", "arr", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dim", "=", 
      RowBox[{"Length", "[", "Ns", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"dim", "==", "2"}], ",", 
       RowBox[{
        RowBox[{"arr", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "1"}], "]"}], "]"}], "=", 
        RowBox[{"2", 
         RowBox[{"arr", "[", 
          RowBox[{"[", 
           RowBox[{";;", ",", "1"}], "]"}], "]"}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"arr", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "=", 
      RowBox[{"2", 
       RowBox[{"arr", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FourierDCT", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Times", "@@", 
         RowBox[{"(", 
          FractionBox[
           RowBox[{"Sqrt", "[", "Ns", "]"}], "2"], ")"}]}], "arr"}], ",", 
       "3"}], "]"}]}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.906134691204138*^9, 3.906134693460145*^9}, 
   3.906553897668821*^9, {3.9068943442681007`*^9, 3.906894345024124*^9}, 
   3.907116243768728*^9, 3.907415951422198*^9, {3.907416002618894*^9, 
   3.907416024364451*^9}, {3.913839085514662*^9, 3.913839216946428*^9}},
 CellLabel->
  "In[139]:=",ExpressionUUID->"19c8849e-ca79-4174-a1a9-9234067314e8"],

Cell["General sparse vector and matrix construction", "Text",
 CellChangeTimes->{{3.907416028130836*^9, 
  3.9074160390622463`*^9}},ExpressionUUID->"5e0aac2e-0cc3-419d-8db4-\
8b8c593bdbfc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ei", "[", 
   RowBox[{"NN_", ",", "i_"}], "]"}], ":=", 
  RowBox[{"UnitVector", "[", 
   RowBox[{"NN", ",", 
    RowBox[{"i", "+", "1"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"eij", "[", 
   RowBox[{"Nx_", ",", "Ny_", ",", "i_", ",", "j_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"ei", "[", 
    RowBox[{"Nx", ",", "i"}], "]"}], "\[TensorProduct]", 
   RowBox[{"ei", "[", 
    RowBox[{"Ny", ",", "j"}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sp", "[", "arr_", "]"}], ":=", 
   RowBox[{"SparseArray", "[", "arr", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"outer", "[", 
    RowBox[{"L1_", ",", "L2_"}], "]"}], ":=", 
   RowBox[{"KroneckerProduct", "[", 
    RowBox[{"L1", ",", "L2"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"stp", "[", 
   RowBox[{"dims_", ",", "inds_"}], "]"}], ":=", 
  RowBox[{"TensorProduct", "@@", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"sp", "[", 
        RowBox[{"ei", "[", "##", "]"}], "]"}], "&"}], "@@", "pair"}], ",", 
     RowBox[{"{", 
      RowBox[{"pair", ",", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"dims", ",", "inds"}], "}"}], "\[Transpose]"}]}], "}"}]}], 
    "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.9139966745906677`*^9, 3.913996681910759*^9}},
 CellLabel->
  "In[148]:=",ExpressionUUID->"8bbb0fab-33d7-43e5-b2b1-91b66f628712"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Example tensors", "Subsection",
 CellChangeTimes->{{3.9077576436131153`*^9, 3.907757645643656*^9}, 
   3.913838700945997*^9, {3.913999987152123*^9, 
   3.913999997193886*^9}},ExpressionUUID->"a31e258a-553b-4472-9d4f-\
84ad26b4b920"],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"I", ":", " ", "V"}], "->", "V"}], TraditionalForm]],
  ExpressionUUID->"572f3584-82d0-4834-a7cb-03ac70e09837"],
 ": Identity tensor for vector space ",
 Cell[BoxData[
  FormBox["V", TraditionalForm]],ExpressionUUID->
  "1423e5a2-1c8c-439b-988d-40a56deeac57"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757775704094*^9}, {
  3.913999987176409*^9, 
  3.913999997216418*^9}},ExpressionUUID->"622a8c88-e4c9-453d-8436-\
080c1d2c6883"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"id", "[", "d_", "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"sp", "[", 
     RowBox[{"IdentityMatrix", "[", 
      RowBox[{"d", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "]"}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"dual", "[", "d", "]"}], ",", "d"}], "}"}], ",", "1"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"id", "[", 
    RowBox[{"n_", ",", "d_"}], "]"}], ":=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"sp", "[", 
      RowBox[{"IdentityMatrix", "[", "n", "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<+\>\""}], "}"}]}], "}"}], ",", "1"}],
     "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.9083950233071213`*^9, 3.908395033348469*^9}, 
   3.913999987186274*^9, {3.914006238915017*^9, 3.91400624342874*^9}, {
   3.914066355633896*^9, 3.91406637281566*^9}, {3.914066898403818*^9, 
   3.9140668995989923`*^9}},
 CellLabel->
  "In[153]:=",ExpressionUUID->"0706ee6e-8b4f-433e-a74c-2591fb719819"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"0", ":", " ", 
     SubscriptBox["V", "1"]}], "->", 
    SubscriptBox["V", "2"]}], TraditionalForm]],ExpressionUUID->
  "3c4a7bc1-835a-43e7-acb0-5020928a6c81"],
 ": Zero mapping from vector space ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["V", "1"], TraditionalForm]],ExpressionUUID->
  "8f935fd9-7405-4af0-b185-fc55ddda99db"],
 " to ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["V", "2"], TraditionalForm]],ExpressionUUID->
  "ef475369-0f03-4723-ab79-3a337d74f690"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757775704094*^9}, {
  3.911862426111908*^9, 
  3.911862446052055*^9}},ExpressionUUID->"10f47d50-959a-492d-b5b6-\
30a7e6f170b5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"zeros", "[", 
   RowBox[{"dims1_", ",", "dims2_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"SparseArray", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"dims1", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "2"}], "]"}], "]"}], ",", 
        RowBox[{"dims2", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}]}], "]"}], ",", 
    RowBox[{"Join", "[", 
     RowBox[{"dims1", ",", "dims2"}], "]"}], ",", 
    RowBox[{"Length", "[", "dims1", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9083950233071213`*^9, 3.908395033348469*^9}, {
   3.911862448718436*^9, 3.911862464282776*^9}, {3.911862506133116*^9, 
   3.9118625441843767`*^9}, 3.911862773095882*^9, 3.913999987188903*^9, {
   3.914006264960294*^9, 3.91400627035334*^9}, {3.914006351027842*^9, 
   3.914006423827562*^9}},
 CellLabel->
  "In[155]:=",ExpressionUUID->"7e739273-d004-43d5-a6d3-0910138394f0"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubscriptBox["e", "i"], ":", "\[DoubleStruckCapitalR]"}], "->", "V"}], 
   TraditionalForm]],ExpressionUUID->"74c3865e-0374-46a6-a5a2-f86e186d54c1"],
 ": A basis vector in a vector space ",
 Cell[BoxData[
  FormBox["V", TraditionalForm]],ExpressionUUID->
  "d8fd3689-72b0-4354-8433-87106e496db4"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776115964*^9}, {
  3.907757806774226*^9, 3.907757809285568*^9}, {3.90775787549159*^9, 
  3.907757877433741*^9}, {3.907757907801794*^9, 
  3.90775793010356*^9}},ExpressionUUID->"f7a6b15c-3de6-4713-af1e-\
bfb893449589"],

Cell[BoxData[
 RowBox[{
  RowBox[{"vec", "[", 
   RowBox[{"n_", ",", "i_", ",", "name_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"stp", "[", 
     RowBox[{
      RowBox[{"{", "n", "}"}], ",", 
      RowBox[{"{", "i", "}"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"name", ",", "n", ",", "\"\<+\>\""}], "}"}], "}"}], ",", "0"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.906749748606353*^9, 3.906749967366679*^9}, {
   3.906750076170949*^9, 3.906750091314396*^9}, 3.90711626624684*^9, {
   3.907120144986701*^9, 3.907120149193596*^9}, {3.907151462419403*^9, 
   3.907151479704419*^9}, {3.907152162674019*^9, 3.907152247666147*^9}, {
   3.907152301522622*^9, 3.907152393246809*^9}, 3.907152434195131*^9, {
   3.907152487719488*^9, 3.907152489596426*^9}, {3.907152543118981*^9, 
   3.907152678149186*^9}, {3.907152721528104*^9, 3.907152728889992*^9}, {
   3.907152777854985*^9, 3.907152845401612*^9}, {3.907153404243396*^9, 
   3.907153431789019*^9}, {3.907153558707147*^9, 3.90715366585646*^9}, {
   3.907153695993595*^9, 3.907153811850315*^9}, {3.907153844027598*^9, 
   3.907153847008173*^9}, {3.907153893356254*^9, 3.907153921053306*^9}, {
   3.907154169088458*^9, 3.90715418151775*^9}, {3.90715812713282*^9, 
   3.907158359819521*^9}, {3.907158444263076*^9, 3.907158457769324*^9}, {
   3.90715849989463*^9, 3.907158692454077*^9}, {3.907159074123996*^9, 
   3.907159096531789*^9}, {3.907159164090744*^9, 3.907159168160136*^9}, {
   3.907159526393098*^9, 3.90715953249902*^9}, {3.907166285512565*^9, 
   3.907166311776767*^9}, {3.907166488506247*^9, 3.907166490596196*^9}, {
   3.907167191765736*^9, 3.907167204149375*^9}, {3.907202787293882*^9, 
   3.907202810022846*^9}, 3.907203487738818*^9, {3.907415746755478*^9, 
   3.907415765119956*^9}, 3.907415795178411*^9, {3.90741634949291*^9, 
   3.907416352110074*^9}, {3.907416684923846*^9, 3.907416725032059*^9}, {
   3.907435780657455*^9, 3.907435783396004*^9}, {3.907435877082427*^9, 
   3.907435879277463*^9}, {3.907435930770785*^9, 3.907435953308937*^9}, {
   3.907672009259465*^9, 3.907672009993836*^9}, 3.907711659262487*^9, {
   3.907716693642574*^9, 3.9077166939121532`*^9}, {3.907716745219555*^9, 
   3.907716764789792*^9}, {3.9077207922632093`*^9, 3.907720795132254*^9}, 
   3.907757766870981*^9, 3.907757935473808*^9, {3.908395067594453*^9, 
   3.908395071909622*^9}, 3.913999987191411*^9, {3.914006487201329*^9, 
   3.914006518175658*^9}},
 CellLabel->
  "In[156]:=",ExpressionUUID->"087db718-5caf-403e-8561-12eb93d6ffe7"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SuperscriptBox["\[Omega]", "i"], ":", "V"}], "->", 
    "\[DoubleStruckCapitalR]"}], TraditionalForm]],ExpressionUUID->
  "5f462d1d-c858-46e0-94a4-776b8647196a"],
 ": A dual basis functional of a vector space ",
 Cell[BoxData[
  FormBox["V", TraditionalForm]],ExpressionUUID->
  "ab2136d0-d2bb-420f-a4cc-14aeb08648c5"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776115964*^9}, {
  3.907757806774226*^9, 3.907757809285568*^9}, {3.90775787549159*^9, 
  3.907757877433741*^9}, {3.907757907801794*^9, 3.90775793010356*^9}, {
  3.90841471177417*^9, 3.908414737353699*^9}, {3.908414828095905*^9, 
  3.908414846989545*^9}},ExpressionUUID->"92072a9b-81be-4cf4-9eea-\
a28d63ab4107"],

Cell[BoxData[
 RowBox[{
  RowBox[{"covec", "[", 
   RowBox[{"n_", ",", "i_", ",", "name_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"stp", "[", 
     RowBox[{
      RowBox[{"{", "n", "}"}], ",", 
      RowBox[{"{", "i", "}"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"name", ",", "n", ",", "\"\<-\>\""}], "}"}], "}"}], ",", "1"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.906749748606353*^9, 3.906749967366679*^9}, {
   3.906750076170949*^9, 3.906750091314396*^9}, 3.90711626624684*^9, {
   3.907120144986701*^9, 3.907120149193596*^9}, {3.907151462419403*^9, 
   3.907151479704419*^9}, {3.907152162674019*^9, 3.907152247666147*^9}, {
   3.907152301522622*^9, 3.907152393246809*^9}, 3.907152434195131*^9, {
   3.907152487719488*^9, 3.907152489596426*^9}, {3.907152543118981*^9, 
   3.907152678149186*^9}, {3.907152721528104*^9, 3.907152728889992*^9}, {
   3.907152777854985*^9, 3.907152845401612*^9}, {3.907153404243396*^9, 
   3.907153431789019*^9}, {3.907153558707147*^9, 3.90715366585646*^9}, {
   3.907153695993595*^9, 3.907153811850315*^9}, {3.907153844027598*^9, 
   3.907153847008173*^9}, {3.907153893356254*^9, 3.907153921053306*^9}, {
   3.907154169088458*^9, 3.90715418151775*^9}, {3.90715812713282*^9, 
   3.907158359819521*^9}, {3.907158444263076*^9, 3.907158457769324*^9}, {
   3.90715849989463*^9, 3.907158692454077*^9}, {3.907159074123996*^9, 
   3.907159096531789*^9}, {3.907159164090744*^9, 3.907159168160136*^9}, {
   3.907159526393098*^9, 3.90715953249902*^9}, {3.907166285512565*^9, 
   3.907166311776767*^9}, {3.907166488506247*^9, 3.907166490596196*^9}, {
   3.907167191765736*^9, 3.907167204149375*^9}, {3.907202787293882*^9, 
   3.907202810022846*^9}, 3.907203487738818*^9, {3.907415746755478*^9, 
   3.907415765119956*^9}, 3.907415795178411*^9, {3.90741634949291*^9, 
   3.907416352110074*^9}, {3.907416684923846*^9, 3.907416725032059*^9}, {
   3.907435780657455*^9, 3.907435783396004*^9}, {3.907435877082427*^9, 
   3.907435879277463*^9}, {3.907435930770785*^9, 3.907435953308937*^9}, {
   3.907672009259465*^9, 3.907672009993836*^9}, 3.907711659262487*^9, {
   3.907716693642574*^9, 3.9077166939121532`*^9}, {3.907716745219555*^9, 
   3.907716764789792*^9}, {3.9077207922632093`*^9, 3.907720795132254*^9}, 
   3.907757766870981*^9, 3.907757935473808*^9, {3.908395067594453*^9, 
   3.908395071909622*^9}, {3.908414849580104*^9, 3.908414856722199*^9}, 
   3.91399998719394*^9, {3.914006523452373*^9, 3.914006536734608*^9}},
 CellLabel->
  "In[157]:=",ExpressionUUID->"7c53fbef-bfab-4824-8458-390108d8a107"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"I", ":", "V"}], "->", 
    SuperscriptBox["V", "*"]}], TraditionalForm]],ExpressionUUID->
  "3c25baae-f457-4a13-a913-73863a0f9e52"],
 ": A canonical mapping from vector space ",
 Cell[BoxData[
  FormBox["V", TraditionalForm]],ExpressionUUID->
  "3c518e3a-d021-46b5-9487-7acee30926b7"],
 " to its dual (only valid for orthonormal bases)"
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776115964*^9}, {
  3.907757806774226*^9, 3.907757809285568*^9}, {3.90775787549159*^9, 
  3.907757877433741*^9}, {3.907757907801794*^9, 3.90775793010356*^9}, {
  3.90841471177417*^9, 3.908414737353699*^9}, {3.908414828095905*^9, 
  3.908414846989545*^9}, {3.90847552452088*^9, 
  3.908475558850006*^9}},ExpressionUUID->"7411d23d-8314-4bfd-b9b5-\
549f89ec5a7f"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"orthonormalMetric", "[", "d_", "]"}], ":=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"SparseArray", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Band", "[", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1"}], "}"}], "]"}], "->", "1"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"d", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", 
         RowBox[{"d", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"d", ",", "d"}], "}"}], ",", "1"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.908472832186308*^9, 3.908472930574258*^9}, {
   3.908493528550657*^9, 3.908493539476074*^9}, 3.9139999871966558`*^9, {
   3.914007011007739*^9, 3.914007013383198*^9}},
 CellLabel->
  "In[158]:=",ExpressionUUID->"5db70b1e-b780-4098-8eb7-940aaa8f5237"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"\[CapitalPi]", ":", 
     RowBox[{"\[LeftAngleBracket]", 
      RowBox[{
       SubscriptBox["e", "i"], ":", 
       RowBox[{"i", "\[Element]", 
        RowBox[{"{", 
         RowBox[{"0", ",", "...", " ", ",", 
          RowBox[{"n", "-", "1"}]}], "}"}]}]}], "\[RightAngleBracket]"}]}], 
    " ", "->", " ", 
    RowBox[{"\[LeftAngleBracket]", 
     RowBox[{
      SubscriptBox["e", "i"], ":", 
      RowBox[{"i", "\[Element]", "modes", "\[Subset]", 
       RowBox[{"{", 
        RowBox[{"0", ",", "...", " ", ",", 
         RowBox[{"n", "-", "1"}]}], "}"}]}]}], "\[RightAngleBracket]"}]}], 
   TraditionalForm]],ExpressionUUID->"e892f88b-6cd0-497d-8038-ec0c3f0838dd"],
 ": A projection operator to a subspace spanned by a subset of basis vectors. \
This has different input-output dimension."
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776431715*^9}, {
  3.90775795870087*^9, 3.907758084665579*^9}, {3.907758126278782*^9, 
  3.9077582041214542`*^9}, {3.907758330673334*^9, 
  3.907758340607036*^9}},ExpressionUUID->"af1d2587-49d6-475d-b431-\
cb278899d104"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"filter", "[", 
    RowBox[{"dim_", ",", "modes_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"id", "[", "dim", "]"}], "/.", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{"a_", ",", "d_", ",", "s_"}], "]"}], ":>", 
     RowBox[{"(", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"a", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "modes"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"dual", "[", "dim", "]"}], ",", 
          RowBox[{"ReplacePart", "[", 
           RowBox[{"dim", ",", 
            RowBox[{"2", "->", 
             RowBox[{"Length", "[", 
              RowBox[{"a", "[", 
               RowBox[{"[", "modes", "]"}], "]"}], "]"}]}]}], "]"}]}], "}"}], 
        ",", "1"}], "]"}], ")"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"filter", "[", 
    RowBox[{"n_", ",", "dim_", ",", "modes_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"id", "[", 
     RowBox[{"n", ",", "dim"}], "]"}], "/.", "    ", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{"a_", ",", "d_", ",", "s_"}], "]"}], ":>", 
     RowBox[{"(", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"a", "[", 
         RowBox[{"[", 
          RowBox[{";;", ",", "modes"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"dim", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"dim", ",", 
            RowBox[{"Length", "[", 
             RowBox[{"a", "[", 
              RowBox[{"[", "modes", "]"}], "]"}], "]"}], ",", "\"\<+\>\""}], 
           "}"}]}], "}"}], ",", "1"}], "]"}], ")"}]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.907721314785328*^9, 3.90772132135742*^9}, 
   3.907721356786838*^9, {3.908395092400663*^9, 3.908395102341597*^9}, {
   3.908398890633412*^9, 3.908398898039605*^9}, {3.913999987199698*^9, 
   3.913999987201529*^9}, {3.914007036409493*^9, 3.914007068416679*^9}, {
   3.914066421410049*^9, 3.914066461675514*^9}, {3.914066520506229*^9, 
   3.914066557960194*^9}, {3.9140669080843973`*^9, 3.914066909504925*^9}},
 CellLabel->
  "In[159]:=",ExpressionUUID->"48a701a6-838c-49b1-b9f6-8ccb868e515b"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{
      SuperscriptBox["\[CapitalPi]", "*"], ":", 
      SubscriptBox["V", "n"]}], "->", 
     RowBox[{
      SubscriptBox["V", 
       RowBox[{"<", "n"}]], "->", 
      SubscriptBox["V", "n"]}]}], "=", 
    RowBox[{"\[CapitalPi]", "\[SmallCircle]", 
     SubscriptBox["I", 
      RowBox[{"+", 
       RowBox[{"->", "-"}]}]], "\[SmallCircle]", "\[CapitalPi]"}]}], 
   TraditionalForm]],ExpressionUUID->"a42bf9c0-2c4d-4658-a7fa-28a023d23f0b"],
 ": The projection operator then projected back into the original space by \
composing with the adjoint. This preserves the vector spaces, but is clearly \
not invertible."
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776588911*^9}, {
  3.9077582097543592`*^9, 3.907758369305085*^9}, {3.908398471251523*^9, 
  3.908398504956134*^9}},ExpressionUUID->"2926e7ba-6640-46fd-b3db-\
2ef77405c0e1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"proj", "[", 
    RowBox[{"dim_", ",", "modes_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"filter", "[", 
     RowBox[{"dim", ",", "modes"}], "]"}], ".", 
    RowBox[{"adjoint", "[", 
     RowBox[{"flip", "[", 
      RowBox[{"filter", "[", 
       RowBox[{"dim", ",", "modes"}], "]"}], "]"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"proj", "[", 
    RowBox[{"n_", ",", "dim_", ",", "modes_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"filter", "[", 
     RowBox[{"n", ",", "dim", ",", "modes"}], "]"}], ".", 
    RowBox[{"adjoint", "[", 
     RowBox[{"flip", "[", 
      RowBox[{"filter", "[", 
       RowBox[{"n", ",", "dim", ",", "modes"}], "]"}], "]"}], "]"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.907721314785328*^9, 3.90772132135742*^9}, 
   3.907721356786838*^9, {3.90839536735414*^9, 3.908395369281348*^9}, {
   3.908398563876128*^9, 3.908398662561281*^9}, {3.908398702227591*^9, 
   3.908398735347094*^9}, {3.908398767321354*^9, 3.908398768207825*^9}, {
   3.908398836378957*^9, 3.908398864927286*^9}, 3.913999987204405*^9, {
   3.914007168429165*^9, 3.914007223645379*^9}, {3.914007268702172*^9, 
   3.914007326111746*^9}, {3.914066738142485*^9, 3.914066749957406*^9}, {
   3.9140669208921967`*^9, 3.914066921046509*^9}},
 CellLabel->
  "In[161]:=",ExpressionUUID->"2d836afb-10fa-49f7-91d6-d147a8e53cfa"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "shift ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SuperscriptBox["I", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"d", "+", "1"}], ",", "d"}], ")"}]], ":", 
     SuperscriptBox["P", 
      RowBox[{"(", "d", ")"}]]}], "->", 
    SuperscriptBox["P", 
     RowBox[{"(", 
      RowBox[{"d", "+", "1"}], ")"}]]}], TraditionalForm]],ExpressionUUID->
  "5b553e7b-fdcc-4e71-9bfe-c0890773f941"],
 ": The identity/shift operator that maps a vector in ultraspherical space of \
index ",
 Cell[BoxData[
  FormBox["d", TraditionalForm]],ExpressionUUID->
  "bc962960-e9be-40ca-9aad-b0829cb93291"],
 " to the next-highest degree ",
 Cell[BoxData[
  FormBox[
   RowBox[{"d", "+", "1"}], TraditionalForm]],ExpressionUUID->
  "f4ad661a-caeb-40c0-866e-92062eca75bf"],
 ". And the operator that composes multiple of these shifts."
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757776733396*^9}, {
  3.907758391162612*^9, 3.907758452937508*^9}, {3.9077585532171*^9, 
  3.90775863306183*^9}},ExpressionUUID->"9e658c87-875c-4502-8a72-\
945d5242358b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"shift", "[", 
    RowBox[{"n_", ",", "d_"}], "]"}], ":=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"ops", "[", "\"\<I\>\"", "]"}], "[", 
       RowBox[{
        RowBox[{"d", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ",", "n"}], "]"}], "\[Transpose]"}], 
     ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"d", "+", 
          RowBox[{"{", 
           RowBox[{"0", ",", "1"}], "}"}]}], ",", "n", ",", "\"\<+\>\""}], 
        "}"}]}], "}"}], ",", "1"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.908399114253977*^9, 3.908399147308778*^9}, 
   3.913999987207115*^9, {3.914007431189964*^9, 3.914007436503482*^9}},
 CellLabel->
  "In[163]:=",ExpressionUUID->"b84867c7-85ff-46a2-b096-11f9becbd5f5"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "shifts ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SuperscriptBox["I", 
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["d", "o"], ",", 
        SubscriptBox["d", "i"]}], ")"}]], ":", 
     SuperscriptBox["P", 
      RowBox[{"(", 
       SubscriptBox["d", "i"], ")"}]]}], "->", 
    SuperscriptBox["P", 
     RowBox[{"(", 
      SubscriptBox["d", "o"], ")"}]]}], TraditionalForm]],ExpressionUUID->
  "299f3033-7df1-40a4-b74d-a56c1e061a2f"],
 ": The composition of multiple shift operators. Also allow inverse shifts to \
lower degrees"
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.9077577783076906`*^9}, {
  3.907758634964281*^9, 
  3.907758688733046*^9}},ExpressionUUID->"d9dc7360-272e-4611-a0ed-\
1fc9a5f61dbd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"shifts", "[", 
   RowBox[{"n_", ",", "di_", ",", "do_"}], "]"}], ":=", 
  RowBox[{"Which", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"di", "[", 
      RowBox[{"[", "2", "]"}], "]"}], "<", 
     RowBox[{"do", "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Dot", "@@", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"shift", "[", 
        RowBox[{"n", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"di", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", "k"}], "}"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", 
         RowBox[{"di", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"do", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "-", "1"}]}], "}"}]}], "]"}]}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"di", "[", 
      RowBox[{"[", "2", "]"}], "]"}], ">", 
     RowBox[{"do", "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Inverse", "[", 
     RowBox[{"Dot", "@@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"shift", "[", 
         RowBox[{"n", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"di", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", "k"}], "}"}]}], "]"}], ",", 
        
        RowBox[{"{", 
         RowBox[{"k", ",", 
          RowBox[{"do", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", 
          RowBox[{
           RowBox[{"di", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "-", "1"}]}], "}"}]}], "]"}]}], 
     "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"di", "[", 
      RowBox[{"[", "2", "]"}], "]"}], "==", 
     RowBox[{"do", "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"id", "[", 
     RowBox[{"n", ",", "do"}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.907758694980012*^9, 3.9077587036380033`*^9}, {
  3.907758779186089*^9, 3.907758780320113*^9}, {3.908399170714713*^9, 
  3.908399210730253*^9}},
 CellLabel->
  "In[164]:=",ExpressionUUID->"4371c52d-8dad-47ad-a4c5-517c78286743"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "diff ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SuperscriptBox["D", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"d", "+", "1"}], ",", "d"}], ")"}]], ":", 
     SuperscriptBox["P", 
      RowBox[{"(", "d", ")"}]]}], "->", 
    SuperscriptBox["P", 
     RowBox[{"(", 
      RowBox[{"d", "+", "1"}], ")"}]]}], TraditionalForm]],ExpressionUUID->
  "016c6cbe-ce02-4286-9d05-0dd117649582"],
 ": The derivative operator as expressed for ultraspherical polynomials of \
index ",
 Cell[BoxData[
  FormBox["d", TraditionalForm]],ExpressionUUID->
  "34a79dad-78a6-4d9f-a9cb-b2a09454aa8c"],
 " to index ",
 Cell[BoxData[
  FormBox[
   RowBox[{"d", "+", "1"}], TraditionalForm]],ExpressionUUID->
  "d01e2fe1-ac75-4923-b8ca-9cfe2700888c"],
 "."
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758966054591*^9, 
  3.907758966057909*^9}},ExpressionUUID->"24864900-16ad-4477-b5f2-\
4b8747e06860"],

Cell[BoxData[
 RowBox[{
  RowBox[{"diff", "[", 
   RowBox[{"n_", ",", "d_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ops", "[", "\"\<D\>\"", "]"}], "[", 
      RowBox[{
       RowBox[{"d", "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", "n"}], "]"}], "\[Transpose]"}], 
    ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"d", "+", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1"}], "}"}]}], ",", "n", ",", "\"\<+\>\""}], 
       "}"}]}], "}"}], ",", "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.907758893602127*^9, 3.907758909779662*^9}, {
   3.908399296696439*^9, 3.9083993024682617`*^9}, {3.908418384099777*^9, 
   3.908418386506144*^9}, 3.913999987209687*^9, {3.914007529235183*^9, 
   3.914007533674959*^9}},
 CellLabel->
  "In[165]:=",ExpressionUUID->"371b1b87-3275-47a4-8cee-00b179605d24"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "diffN ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SuperscriptBox["D", "n"], ":"}], TraditionalForm]],ExpressionUUID->
  "e2ceb41d-5d11-4025-b4c1-cd32f08c5986"],
 " The n-times derivative operator from index ",
 Cell[BoxData[
  FormBox["d", TraditionalForm]],ExpressionUUID->
  "c3c5c523-6bb7-4f10-92e0-4a17c63f4806"],
 " to index ",
 Cell[BoxData[
  FormBox[
   RowBox[{"d", "+", "n"}], TraditionalForm]],ExpressionUUID->
  "cf1026a4-c48c-4076-b0fe-b4a77d7abe02"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759018795225*^9}},ExpressionUUID->"d788940c-31e1-40d1-9f66-\
72f58efc1df6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"diffN", "[", 
    RowBox[{"N_", ",", "n_", ",", "di_"}], "]"}], ":=", 
   RowBox[{"Dot", "@@", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"diff", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"di", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "k"}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", 
        RowBox[{"di", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ",", 
        RowBox[{
         RowBox[{"di", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "+", "N", "-", "1"}]}], "}"}]}], 
     "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.906749748606353*^9, 3.906749967366679*^9}, {
   3.906750076170949*^9, 3.906750091314396*^9}, 3.90711626624684*^9, {
   3.907120144986701*^9, 3.907120149193596*^9}, {3.907151462419403*^9, 
   3.907151479704419*^9}, {3.907152162674019*^9, 3.907152247666147*^9}, {
   3.907152301522622*^9, 3.907152393246809*^9}, 3.907152434195131*^9, {
   3.907152487719488*^9, 3.907152489596426*^9}, {3.907152543118981*^9, 
   3.907152678149186*^9}, {3.907152721528104*^9, 3.907152728889992*^9}, {
   3.907152777854985*^9, 3.907152845401612*^9}, {3.907153404243396*^9, 
   3.907153431789019*^9}, {3.907153558707147*^9, 3.90715366585646*^9}, {
   3.907153695993595*^9, 3.907153811850315*^9}, {3.907153844027598*^9, 
   3.907153847008173*^9}, {3.907153893356254*^9, 3.907153921053306*^9}, {
   3.907154169088458*^9, 3.90715418151775*^9}, {3.90715812713282*^9, 
   3.907158359819521*^9}, {3.907158444263076*^9, 3.907158457769324*^9}, {
   3.90715849989463*^9, 3.907158692454077*^9}, {3.907159074123996*^9, 
   3.907159096531789*^9}, {3.907159164090744*^9, 3.907159168160136*^9}, {
   3.907159526393098*^9, 3.90715953249902*^9}, {3.907166285512565*^9, 
   3.907166311776767*^9}, {3.907166488506247*^9, 3.907166490596196*^9}, {
   3.907167191765736*^9, 3.907167204149375*^9}, {3.907202787293882*^9, 
   3.907202810022846*^9}, 3.907203487738818*^9, {3.907415746755478*^9, 
   3.907415765119956*^9}, 3.907415795178411*^9, {3.90741634949291*^9, 
   3.907416352110074*^9}, {3.907416684923846*^9, 3.907416725032059*^9}, {
   3.907435780657455*^9, 3.907435783396004*^9}, {3.907435877082427*^9, 
   3.907435879277463*^9}, {3.907435930770785*^9, 3.907435953308937*^9}, {
   3.907672009259465*^9, 3.907672009993836*^9}, 3.907711659262487*^9, {
   3.907720012812776*^9, 3.907720016241485*^9}, {3.907720058364807*^9, 
   3.9077200869782248`*^9}, {3.907721069490827*^9, 3.907721096244615*^9}, 
   3.90775888725712*^9, {3.907758924586278*^9, 3.907758949813118*^9}, {
   3.908399308763406*^9, 3.908399310361411*^9}, {3.908399346791284*^9, 
   3.908399347395881*^9}},
 CellLabel->
  "In[166]:=",ExpressionUUID->"0838ca9a-571c-4a17-a026-df034c0989cb"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "interp ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubscriptBox["B", 
      RowBox[{"(", "x", ")"}]], ":", 
     SuperscriptBox["P", 
      RowBox[{"(", "d", ")"}]]}], "->", "\[DoubleStruckCapitalR]"}], 
   TraditionalForm]],ExpressionUUID->"d1d156e7-a44e-4af4-8012-c640c8ad74c8"],
 ": The interpolation operator at point ",
 Cell[BoxData[
  FormBox["x", TraditionalForm]],ExpressionUUID->
  "cca3e007-2440-4259-a5db-628d38d156bf"],
 " for the space of coefficients of ultraspherical polynomials of index ",
 Cell[BoxData[
  FormBox["d", TraditionalForm]],ExpressionUUID->
  "febbce3c-0ca5-418a-bba6-7eb497f32694"]
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}},ExpressionUUID->"d56a7eaf-7523-4287-a201-\
ae21a98d13ba"],

Cell[BoxData[
 RowBox[{
  RowBox[{"interp", "[", 
   RowBox[{"n_", ",", "d_", ",", "x_"}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"d", "[", 
      RowBox[{"[", "2", "]"}], "]"}], "==", "0"}], ",", "\[IndentingNewLine]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Cos", "[", 
         RowBox[{"i", " ", 
          RowBox[{"ArcCos", "[", "x", "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "0", ",", 
          RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], "}"}], ",", "1"}], 
     "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          FractionBox[
           RowBox[{"Pochhammer", "[", 
            RowBox[{
             RowBox[{"2", "a"}], ",", "i"}], "]"}], 
           RowBox[{"Factorial", "[", "i", "]"}]], 
          RowBox[{"Hypergeometric2F1", "[", 
           RowBox[{
            RowBox[{"-", "i"}], ",", 
            RowBox[{
             RowBox[{"2", "a"}], "+", "i"}], ",", 
            RowBox[{"a", "+", 
             FractionBox["1", "2"]}], ",", 
            FractionBox[
             RowBox[{"1", "-", "x"}], "2"]}], "]"}]}], "/.", 
         RowBox[{"a", "->", 
          RowBox[{"d", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "0", ",", 
          RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], "}"}], ",", "1"}], 
     "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.906749748606353*^9, 3.906749967366679*^9}, {
   3.906750076170949*^9, 3.906750091314396*^9}, 3.90711626624684*^9, {
   3.907120144986701*^9, 3.907120149193596*^9}, {3.907151462419403*^9, 
   3.907151479704419*^9}, {3.907152162674019*^9, 3.907152247666147*^9}, {
   3.907152301522622*^9, 3.907152393246809*^9}, 3.907152434195131*^9, {
   3.907152487719488*^9, 3.907152489596426*^9}, {3.907152543118981*^9, 
   3.907152678149186*^9}, {3.907152721528104*^9, 3.907152728889992*^9}, {
   3.907152777854985*^9, 3.907152845401612*^9}, {3.907153404243396*^9, 
   3.907153431789019*^9}, {3.907153558707147*^9, 3.90715366585646*^9}, {
   3.907153695993595*^9, 3.907153811850315*^9}, {3.907153844027598*^9, 
   3.907153847008173*^9}, {3.907153893356254*^9, 3.907153921053306*^9}, {
   3.907154169088458*^9, 3.90715418151775*^9}, {3.90715812713282*^9, 
   3.907158359819521*^9}, {3.907158444263076*^9, 3.907158457769324*^9}, {
   3.90715849989463*^9, 3.907158692454077*^9}, {3.907159074123996*^9, 
   3.907159096531789*^9}, {3.907159164090744*^9, 3.907159168160136*^9}, {
   3.907159526393098*^9, 3.90715953249902*^9}, {3.907166285512565*^9, 
   3.907166311776767*^9}, {3.907166488506247*^9, 3.907166490596196*^9}, {
   3.907167191765736*^9, 3.907167204149375*^9}, {3.907202787293882*^9, 
   3.907202810022846*^9}, 3.907203487738818*^9, {3.907415746755478*^9, 
   3.907415765119956*^9}, 3.907415795178411*^9, {3.90741634949291*^9, 
   3.907416352110074*^9}, {3.907416684923846*^9, 3.907416725032059*^9}, {
   3.907435780657455*^9, 3.907435783396004*^9}, {3.907435877082427*^9, 
   3.907435879277463*^9}, {3.907435930770785*^9, 3.907435953308937*^9}, {
   3.907672009259465*^9, 3.907672009993836*^9}, 3.907711659262487*^9, {
   3.907720012812776*^9, 3.907720016241485*^9}, {3.907720058364807*^9, 
   3.9077200869782248`*^9}, 3.907758609153214*^9, {3.9077591175631533`*^9, 
   3.907759138982163*^9}, {3.908399357386125*^9, 3.908399374388146*^9}, {
   3.9139999872134047`*^9, 3.913999987215646*^9}, {3.914009423789436*^9, 
   3.914009442722474*^9}},
 CellLabel->
  "In[167]:=",ExpressionUUID->"4db253c8-3d6e-4f1d-9413-f595ba7199dd"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "grid to coeff ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{"\[ScriptCapitalF]", ":", 
     SubscriptBox["V", "g"]}], "->", 
    SubscriptBox["V", "c"]}], TraditionalForm]],ExpressionUUID->
  "8b5940ae-0e2d-4a1d-b0b4-a5f35ee8219f"],
 ": The grid to Chebyshev coefficient operator that converts values at the \
Gauss-Jacobi(?) points to the Chebyshev coefficients"
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 
  3.908399665996926*^9}},ExpressionUUID->"5bbb41ae-32f6-44ff-85f6-\
d321c9933e0b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"GtoC", "[", 
   RowBox[{"n_", ",", "name_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"G2C", "[", 
       RowBox[{"ei", "[", 
        RowBox[{"n", ",", "i"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "0", ",", 
        RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"name", ",", 
          RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<-\>\""}], "}"}], 
      ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"name", ",", "0"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
       "}"}]}], "}"}], ",", "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.908400053310483*^9, 3.908400214446458*^9}, 
   3.9139999872181807`*^9, {3.914009448202914*^9, 3.914009464618498*^9}, {
   3.9140098162738323`*^9, 3.91400982932237*^9}, {3.914009957853325*^9, 
   3.9140099622222023`*^9}},
 CellLabel->
  "In[168]:=",ExpressionUUID->"cb9dddf1-2c96-432f-af45-7bb40c9e000c"]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "coeff to grid ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SuperscriptBox["\[ScriptCapitalF]", 
      RowBox[{"-", "1"}]], ":", 
     SubscriptBox["V", "c"]}], "->", 
    SubscriptBox["V", "g"]}], TraditionalForm]],ExpressionUUID->
  "8945bfa9-b1b7-4131-a9b8-b2ea7efeaea1"],
 ": The Chebyshev coefficient to grid operator that converts the Chebyshev \
coefficients to values at the Gauss-Jacobi(?) points"
}], "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}},ExpressionUUID->"6734b151-7121-43bb-8d80-\
d54a4747ec1e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"CtoG", "[", 
   RowBox[{"n_", ",", "name_"}], "]"}], ":=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"C2G", "[", 
       RowBox[{"ei", "[", 
        RowBox[{"n", ",", "i"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "0", ",", 
        RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"name", ",", "0"}], "}"}], ",", "n", ",", "\"\<-\>\""}], 
       "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"name", ",", 
          RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], "}"}]}], 
     "}"}], ",", "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.908400301056476*^9, 3.908400308240033*^9}, 
   3.9139999872207317`*^9, {3.914009456520446*^9, 3.914009466791269*^9}, {
   3.914009967245529*^9, 3.914009979457081*^9}},
 CellLabel->
  "In[169]:=",ExpressionUUID->"a1da5e31-9f6d-4934-ad20-0360a5cb2a17"]
}, Open  ]],

Cell[CellGroupData[{

Cell["general Ultraspherical transform", "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}, {3.914068053618992*^9, 
  3.914068080698634*^9}},ExpressionUUID->"2ee49d0b-038e-44f6-8be3-\
5cde5c2a40b5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalTransform", "[", 
   RowBox[{"n_", ",", "name_", ",", "i_", ",", "o_"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"Which", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"i", "==", "o"}], ",", 
    RowBox[{"id", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"name", ",", "i"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
      "}"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"i", ">=", "0"}], "&&", 
     RowBox[{"o", ">=", "0"}]}], ",", 
    RowBox[{"shifts", "[", 
     RowBox[{"n", ",", 
      RowBox[{"{", 
       RowBox[{"name", ",", "i"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"name", ",", "o"}], "}"}]}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"i", "<", "0"}], ",", 
    RowBox[{
     RowBox[{"GtoC", "[", 
      RowBox[{"n", ",", "name"}], "]"}], ".", 
     RowBox[{"shifts", "[", 
      RowBox[{"n", ",", 
       RowBox[{"{", 
        RowBox[{"name", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"name", ",", "o"}], "}"}]}], "]"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"o", "<", "0"}], ",", 
    RowBox[{
     RowBox[{"shifts", "[", 
      RowBox[{"n", ",", 
       RowBox[{"{", 
        RowBox[{"name", ",", "i"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"name", ",", "0"}], "}"}]}], "]"}], ".", 
     RowBox[{"CtoG", "[", 
      RowBox[{"n", ",", "name"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.914068093335857*^9, 3.914068531789309*^9}, {
  3.914068627427282*^9, 3.91406863118704*^9}, {3.914069438944903*^9, 
  3.914069440495504*^9}},
 CellLabel->
  "In[170]:=",ExpressionUUID->"45032a8d-9620-4c8a-b02a-a37751a20771"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalTransform", "[", 
   RowBox[{"di_", ",", "do_"}], "]"}], ":=", 
  RowBox[{"ultrasphericalTransform", "[", 
   RowBox[{
    RowBox[{"di", "[", 
     RowBox[{"[", "2", "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "2"}], "]"}], "]"}], ",", 
    RowBox[{"do", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "2"}], "]"}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.914068616429628*^9, 3.914068670923436*^9}},
 CellLabel->
  "In[171]:=",ExpressionUUID->"139d428c-a6f0-48c0-992b-dc47a4d05e17"]
}, Open  ]],

Cell[CellGroupData[{

Cell["general Ultraspherical derivative", "ItemNumbered",
 CellChangeTimes->{{3.907757746075592*^9, 3.907757762737218*^9}, {
  3.907758812359776*^9, 3.907758914019143*^9}, {3.907758975037168*^9, 
  3.907759113106065*^9}, {3.908399538421533*^9, 3.9083996047035637`*^9}, {
  3.908399655576859*^9, 3.908399665996926*^9}, {3.908400260711368*^9, 
  3.9084002933251963`*^9}, {3.914068053618992*^9, 3.914068080698634*^9}, {
  3.914069409884935*^9, 
  3.914069411040808*^9}},ExpressionUUID->"163ff97b-32ff-4db9-ac87-\
677226fd2f09"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalDerivative", "[", 
   RowBox[{"n_", ",", "name_", ",", "i_"}], "]"}], ":=", 
  RowBox[{"Which", "[", 
   RowBox[{
    RowBox[{"i", ">=", "0"}], ",", 
    RowBox[{"diff", "[", 
     RowBox[{"n", ",", 
      RowBox[{"{", 
       RowBox[{"name", ",", "i"}], "}"}]}], "]"}], ",", 
    RowBox[{"i", "<", "0"}], ",", 
    RowBox[{
     RowBox[{"GtoC", "[", 
      RowBox[{"n", ",", "name"}], "]"}], ".", 
     RowBox[{"diff", "[", 
      RowBox[{"n", ",", 
       RowBox[{"{", 
        RowBox[{"name", ",", "0"}], "}"}]}], "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.914068093335857*^9, 3.914068531789309*^9}, {
  3.914068627427282*^9, 3.91406863118704*^9}, {3.9140694134107*^9, 
  3.914069435830292*^9}, {3.914069477369085*^9, 3.914069560855994*^9}, {
  3.914069624224435*^9, 3.91406967143347*^9}, {3.914069771761838*^9, 
  3.914069805089547*^9}},
 CellLabel->
  "In[172]:=",ExpressionUUID->"772e3a16-54dd-48d7-8b8a-ae79e130e662"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalDerivative", "[", "di_", "]"}], ":=", 
  RowBox[{"ultrasphericalDerivative", "[", 
   RowBox[{
    RowBox[{"di", "[", 
     RowBox[{"[", "2", "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "2"}], "]"}], "]"}]}], "]"}]}]], "Input",
 CellLabel->
  "In[173]:=",ExpressionUUID->"ba6bea37-7f2b-4ca1-9353-b8794e82c5c4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalDerivative", "[", 
   RowBox[{"n_", ",", "name_", ",", "i_", ",", "o_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"ultrasphericalDerivative", "[", 
    RowBox[{"n", ",", "name", ",", "i"}], "]"}], ".", 
   RowBox[{"ultrasphericalTransform", "[", 
    RowBox[{"n", ",", "name", ",", 
     RowBox[{"Max", "[", 
      RowBox[{
       RowBox[{"i", "+", "1"}], ",", "1"}], "]"}], ",", "o"}], 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.914069812380879*^9, 3.914069875694878*^9}},
 CellLabel->
  "In[174]:=",ExpressionUUID->"cfceb139-9845-4c9b-bfd4-4074c4f4e33d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ultrasphericalDerivative", "[", 
   RowBox[{"di_", ",", "do_"}], "]"}], ":=", 
  RowBox[{"ultrasphericalDerivative", "[", 
   RowBox[{
    RowBox[{"di", "[", 
     RowBox[{"[", "2", "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
    RowBox[{"di", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "2"}], "]"}], "]"}], ",", 
    RowBox[{"do", "[", 
     RowBox[{"[", 
      RowBox[{"1", ",", "2"}], "]"}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9140701981417522`*^9, 3.914070199311433*^9}, {
  3.914070239990843*^9, 3.914070241617662*^9}},
 CellLabel->
  "In[175]:=",ExpressionUUID->"4a953ab4-eb0f-444e-a68b-350c8d60ca33"]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor calculus", "Chapter",
 CellChangeTimes->{{3.9106914303425293`*^9, 
  3.910691435021212*^9}},ExpressionUUID->"809365ce-c9c9-4f47-b089-\
df929c1ad113"],

Cell["\<\
Now we want to implement some rules needed for doing symbol calculations of \
higher-order tensors.\
\>", "Text",
 CellChangeTimes->{{3.9506731452811213`*^9, 
  3.950673182817947*^9}},ExpressionUUID->"daaff92b-a738-4e77-8105-\
070ecaf7979b"],

Cell[CellGroupData[{

Cell["Jacobian, Connection coefficients, Gradients ", "Subsection",
 CellChangeTimes->{{3.910971415384862*^9, 3.910971418537765*^9}, {
  3.910990872349921*^9, 
  3.910990885329892*^9}},ExpressionUUID->"721c12b9-7371-4e61-8acf-\
d34ff49ab51d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"coordList", "=", 
   RowBox[{"<|", 
    RowBox[{"\"\<xy\>\"", "->", 
     RowBox[{"{", 
      RowBox[{"x", ",", "y"}], "}"}]}], "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{"\"\<XY\>\"", "->", 
      RowBox[{"{", 
       RowBox[{"X", ",", "Y"}], "}"}]}], "*)"}], "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.908047232970007*^9, 3.908047251944469*^9}, {
   3.908101862012278*^9, 3.9081018690742893`*^9}, {3.9081372609483256`*^9, 
   3.908137264894729*^9}, 3.908137442451391*^9, {3.908220408757819*^9, 
   3.908220409401431*^9}, {3.908382714295988*^9, 3.908382719809327*^9}, 
   3.910694998089573*^9, {3.910971566633137*^9, 3.910971568573932*^9}, 
   3.91176376586688*^9, {3.911764118627665*^9, 3.911764124148288*^9}},
 CellLabel->
  "In[179]:=",ExpressionUUID->"0cd359fd-fd2f-4621-a238-18f7c0502b4b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"basesList", "=", 
   RowBox[{"<|", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"\"\<xy+\>\"", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"\"\<xy-\>\"", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"\"\<XY+\>\"", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"\"\<XY-\>\"", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}]}]}], 
    "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.908047571716378*^9, 3.908047573616018*^9}, {
   3.908047732585051*^9, 3.9080477393664093`*^9}, {3.9080477910185966`*^9, 
   3.908047836702396*^9}, {3.908101671570074*^9, 3.908101724053056*^9}, {
   3.908137269852055*^9, 3.908137278809469*^9}, {3.908137447281948*^9, 
   3.908137447816881*^9}, {3.908220412269333*^9, 3.908220412566951*^9}, {
   3.908382727320896*^9, 3.9083827359406643`*^9}, 3.910695004698668*^9, {
   3.910971516590438*^9, 3.910971521321608*^9}, {3.911763176010517*^9, 
   3.911763182431734*^9}},
 CellLabel->
  "In[180]:=",ExpressionUUID->"879150d2-73ee-478d-b986-6cc96ab5aca9"],

Cell["\<\
To transpose slots to desired positions, while preserving order of \
unspecified switches.\
\>", "Text",
 CellChangeTimes->{{3.9142658517637463`*^9, 
  3.914265879308344*^9}},ExpressionUUID->"b7515fa3-50df-447b-8eac-\
8e8f008d3272"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcMultiPermutation", "[", 
   RowBox[{"pairs_", ",", "n_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "posPairs", ",", "sources", ",", "targets", ",", "unspecified", ",", 
      "permutation", ",", "source", ",", "target"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"pairs", "==", 
       RowBox[{"{", "}"}]}], ",", 
      RowBox[{"Range", "[", "n", "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"posPairs", "=", 
        RowBox[{"pairs", "/.", 
         RowBox[{
          RowBox[{"a_Integer", "/;", 
           RowBox[{"a", "<", "0"}]}], ":>", 
          RowBox[{"n", "+", "1", "+", "a"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"sources", ",", "targets"}], "}"}], "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"posPairs", "/.", 
           RowBox[{"Rule", "->", "List"}]}], ")"}], "\[Transpose]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"unspecified", "=", 
        RowBox[{"Select", "[", 
         RowBox[{
          RowBox[{"Range", "[", "n", "]"}], ",", 
          RowBox[{
           RowBox[{"Not", "[", 
            RowBox[{"MemberQ", "[", 
             RowBox[{"targets", ",", "#"}], "]"}], "]"}], "&"}]}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"permutation", "=", "unspecified"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"source", ",", "target"}], "}"}], "=", 
           RowBox[{"List", "@@", "pair"}]}], ";", 
          RowBox[{"permutation", "=", 
           RowBox[{"Insert", "[", 
            RowBox[{"permutation", ",", "target", ",", "source"}], "]"}]}]}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"pair", ",", 
           RowBox[{"SortBy", "[", 
            RowBox[{"posPairs", ",", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "&"}]}], "]"}]}], "}"}]}], 
        "]"}], ";", "\[IndentingNewLine]", "permutation"}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.911867252606528*^9, 3.911867281100248*^9}, {
  3.911867314265682*^9, 3.911867327180139*^9}, {3.911867482116673*^9, 
  3.911867490631988*^9}, {3.91186789686486*^9, 3.911867987146639*^9}, {
  3.911868018458617*^9, 3.911868172652958*^9}, {3.9118682145189123`*^9, 
  3.911868244289528*^9}, {3.911868276249626*^9, 3.911868400329665*^9}, {
  3.911868622794821*^9, 3.91186863379522*^9}, {3.911868719426239*^9, 
  3.9118687277117167`*^9}, {3.91186877200023*^9, 3.911868869661169*^9}, {
  3.911868979421119*^9, 3.911869151471827*^9}, {3.914380284095924*^9, 
  3.914380299435427*^9}},
 CellLabel->
  "In[181]:=",ExpressionUUID->"50c725b3-a0fa-455c-9e87-7bf718b5477c"],

Cell["\<\
Given a coordinate system and a choice of basis, we create symbolic Jacobian \
tensor\
\>", "Text",
 CellChangeTimes->{{3.950673852801159*^9, 
  3.9506738790502853`*^9}},ExpressionUUID->"2c22d19b-ff50-4624-b4a9-\
cbc57de09d3f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"createJacobianS", "[", 
   RowBox[{"coords_", ",", "basis_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"Vc", ",", "Vb", ",", "arr", ",", "ds"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"Vb", ",", "Vc"}], "}"}], "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"basesList", "[", "basis", "]"}], ",", 
        RowBox[{"basesList", "[", 
         RowBox[{"coords", "<>", "\"\<+\>\""}], "]"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"arr", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"jac", "[", 
           RowBox[{"basis", ",", 
            RowBox[{"coords", "<>", "\"\<+\>\""}]}], "]"}], "[", 
          RowBox[{"i", ",", "j"}], "]"}], "@@", 
         RowBox[{"coordList", "[", "coords", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Vc", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", 
          RowBox[{"Vb", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ds", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"dual", "[", "Vb", "]"}], ",", "Vc"}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tensor", "[", 
      RowBox[{"arr", ",", "ds", ",", "1"}], "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.90821677516174*^9, 3.908216776251791*^9}, {
   3.90821867349865*^9, 3.908218673665429*^9}, {3.908219697629338*^9, 
   3.908219776421349*^9}, {3.908219811950753*^9, 3.908219812022714*^9}, {
   3.908220106687737*^9, 3.908220156497792*^9}, {3.908220419067575*^9, 
   3.908220424655957*^9}, {3.908327191826147*^9, 3.908327197711143*^9}, {
   3.908327230438332*^9, 3.908327233954401*^9}, {3.9083281874182577`*^9, 
   3.908328188537083*^9}, {3.908375926263431*^9, 3.908375969164674*^9}, {
   3.908376021755891*^9, 3.908376022433578*^9}, {3.908376063926948*^9, 
   3.908376065352843*^9}, {3.908376474489376*^9, 3.908376512463969*^9}, {
   3.908377035053754*^9, 3.90837703661261*^9}, {3.908377122484041*^9, 
   3.908377151680861*^9}, {3.908377184691729*^9, 3.908377186357081*^9}, {
   3.9083772643576*^9, 3.908377267761128*^9}, 3.9139999872237577`*^9, {
   3.914010937838713*^9, 3.91401095045382*^9}, {3.914265411134364*^9, 
   3.914265432828683*^9}},
 CellLabel->
  "In[182]:=",ExpressionUUID->"ba410ddf-7108-4a7f-8413-bbe5552d42e6"],

Cell["\<\
Given a coordinate system, a basis for the direction derivatives, and the \
basis that we are differentiating, we create a connection tensor to track all \
the directional derivatives.\
\>", "Text",
 CellChangeTimes->{{3.950673881385497*^9, 
  3.950673923801526*^9}},ExpressionUUID->"fb9c61a8-74ca-4ae0-96ba-\
c5141e336610"],

Cell[BoxData[
 RowBox[{
  RowBox[{"createConnectionS", "[", 
   RowBox[{"coords_", ",", "diffBasis_", ",", "tensorBasis_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"Vd", ",", "Vt", ",", "arr", ",", "ds"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"Vd", ",", "Vt"}], "}"}], "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"basesList", "[", "diffBasis", "]"}], ",", 
        RowBox[{"basesList", "[", "tensorBasis", "]"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"arr", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"conn", "[", 
           RowBox[{"diffBasis", ",", "tensorBasis"}], "]"}], "[", 
          RowBox[{"i", ",", "j", ",", "k"}], "]"}], "@@", 
         RowBox[{"coordList", "[", "coords", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Vt", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", 
          RowBox[{"Vd", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", 
          RowBox[{"Vt", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ds", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"dual", "[", "Vt", "]"}], ",", 
        RowBox[{"dual", "[", "Vd", "]"}], ",", "Vt"}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tensor", "[", 
      RowBox[{"arr", ",", "ds", ",", "3"}], "]"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGAQA2IQLRfbsIpJ7q3jtpaXm0B0UF9VtQyQTlpl1wGiHzxb
OAlE/zFVWAqigzwMNoLoh91uW0F08n32XSDavm7fARB9Vq/oGoiu+ix6C0Q3
nNB+DKK3TUgG080Bb+NlgfQNQf4EEH3W7pWxHJDm2e1tAqIdnLJmhwHpp3nl
YHqDgMcCEO1i+HcpiM542rQdRGfypewF0X+cQm6BaemI+yB6zlv5D11A+tHp
BjB99czLHyBaqEXhJ4g2YH39B0QraR79C6L7/0QJdQNpd1kRERCtq3LREkSv
EEyyBdE6zunnYjTfOm4qhdDbbnFpJQFpi1cPtEH0lhD/zHtA2v/bl2wQHVtz
vRlE61x+BqYBHqKlUA==
  "],
 CellLabel->
  "In[195]:=",ExpressionUUID->"a236f225-e1ba-4984-992b-dabd391f4063"],

Cell["\<\
Given a tensor and a connection tensor corresponding to the basis in slot i, \
we contract the tensor with the connection tensor, and permute to put the \
added basis at the start\
\>", "Text",
 CellChangeTimes->{{3.950673928201333*^9, 
  3.950673989324259*^9}},ExpressionUUID->"ab66ba09-1151-41c3-8911-\
c65db94ea8af"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractConnectionS", "[", 
   RowBox[{"t_tensor", ",", "c_tensor", ",", "i_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "n", ",", "s", ",", "prod", ",", "con", ",", "trans", ",", "isom"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"s", "=", 
      RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"prod", "=", 
      RowBox[{"c", "\[TensorProduct]", "t"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"con", "=", 
      RowBox[{"TensorContract", "[", 
       RowBox[{"prod", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"1", ",", 
           RowBox[{"3", "+", "i"}]}], "}"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"trans", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"con", ",", 
        RowBox[{"calcMultiPermutation", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", "->", 
            RowBox[{"i", "+", "1"}]}], "}"}], ",", 
          RowBox[{"n", "+", "1"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iso", "[", 
      RowBox[{"trans", ",", 
       RowBox[{"s", "+", "1"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.908132843329458*^9, 3.9081328869679*^9}, {
   3.9081330624222345`*^9, 3.908133153676367*^9}, {3.908134082640014*^9, 
   3.908134109327335*^9}, {3.908134162314646*^9, 3.908134167166794*^9}, {
   3.908135326917379*^9, 3.908135356171262*^9}, {3.908135396813397*^9, 
   3.908135426093162*^9}, {3.9081355941668386`*^9, 3.908135697067325*^9}, {
   3.9084465907125263`*^9, 3.90844659718775*^9}, {3.9140110358949413`*^9, 
   3.91401107938545*^9}, {3.914011182653853*^9, 3.914011194420639*^9}, {
   3.914011248879651*^9, 3.914011253873563*^9}, {3.9140129163134937`*^9, 
   3.914012960948168*^9}, 3.914265497691008*^9, {3.914265828269958*^9, 
   3.91426584143604*^9}},
 CellLabel->
  "In[196]:=",ExpressionUUID->"2d9c4f47-8202-4eb6-9477-542ba5646b21"],

Cell["\<\
Combine these operations to calculate a symbolic gradient for any symbolic \
tensor.\
\>", "Text",
 CellChangeTimes->{{3.950674001422662*^9, 
  3.950674025183506*^9}},ExpressionUUID->"da88134f-0788-4b29-a599-\
db3e65b1e97f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGradS", "[", 
   RowBox[{"t_tensor", ",", "coords_", ",", "diffBasis_"}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "cdim", ",", "Vc", ",", "jac", ",", "dims", ",", "connections", ",", 
      "diff", ",", "n", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"dims", "=", 
      RowBox[{"getDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"n", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"s", "=", 
      RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Vc", "=", 
      RowBox[{"basesList", "[", 
       RowBox[{"coords", "<>", "\"\<+\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"jac", "=", 
      RowBox[{"createJacobianS", "[", 
       RowBox[{"coords", ",", "diffBasis"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"connections", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"createConnectionS", "[", 
         RowBox[{"coords", ",", "diffBasis", ",", 
          RowBox[{
           RowBox[{"b", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "<>", 
           RowBox[{"b", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"b", ",", "dims"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"diff", "=", 
      RowBox[{
       RowBox[{"jac", ".", 
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"tensor", "[", 
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"Grad", "[", 
               RowBox[{
                RowBox[{"getArr", "[", "t", "]"}], ",", 
                RowBox[{"coordList", "[", "coords", "]"}]}], "]"}], ",", 
              RowBox[{"RotateLeft", "[", 
               RowBox[{
                RowBox[{"Range", "[", 
                 RowBox[{
                  RowBox[{"Length", "[", "dims", "]"}], "+", "1"}], "]"}], 
                ",", "1"}], "]"}]}], "]"}], ",", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"dual", "[", "Vc", "]"}], "}"}], ",", "dims"}], 
             "]"}]}], "]"}], ",", "1"}], "]"}]}], "//", 
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{"#", ",", 
          RowBox[{"s", "+", "1"}]}], "]"}], "&"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"diff", "+", 
      RowBox[{"Sum", "[", 
       RowBox[{
        RowBox[{"contractConnectionS", "[", 
         RowBox[{"t", ",", 
          RowBox[{"connections", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", "i"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}]}], "]"}]}]}]}], "\[IndentingNewLine]",
    "]"}]}]], "Input",
 CellChangeTimes->{{3.907891841884126*^9, 3.907891920595614*^9}, {
   3.907892038981921*^9, 3.9078920739367037`*^9}, {3.907892116468437*^9, 
   3.907892117887327*^9}, {3.907943107266185*^9, 3.907943111852206*^9}, {
   3.9079431488930483`*^9, 3.907943155264151*^9}, {3.90794328322614*^9, 
   3.907943337415303*^9}, {3.908048063663985*^9, 3.908048064587264*^9}, {
   3.908103388216329*^9, 3.908103475950265*^9}, {3.908103538677782*^9, 
   3.908103566831036*^9}, {3.908103625134952*^9, 3.908103638654443*^9}, {
   3.908103775097924*^9, 3.908103924117555*^9}, {3.908103974308749*^9, 
   3.908104076746672*^9}, {3.908104182803101*^9, 3.908104281695757*^9}, {
   3.908104382648065*^9, 3.908104438991321*^9}, {3.908104634123754*^9, 
   3.908104759284809*^9}, {3.908104879330376*^9, 3.908104905787234*^9}, {
   3.90810494163862*^9, 3.908104969026074*^9}, {3.908105045612626*^9, 
   3.908105069763248*^9}, {3.908105249748594*^9, 3.908105274719706*^9}, {
   3.908105320413431*^9, 3.908105321696488*^9}, {3.908105472606982*^9, 
   3.908105505964259*^9}, {3.908105739392542*^9, 3.908105777448684*^9}, {
   3.90813269670012*^9, 3.908132700053073*^9}, {3.908134351956029*^9, 
   3.908134413790415*^9}, {3.908134508594964*^9, 3.908134508872282*^9}, {
   3.908134954716988*^9, 3.908134969349731*^9}, {3.908135105721735*^9, 
   3.90813510645853*^9}, {3.908135316524731*^9, 3.908135318021246*^9}, {
   3.90813536937232*^9, 3.908135392310493*^9}, {3.908135458255582*^9, 
   3.9081354671310472`*^9}, {3.908135591783094*^9, 3.908135592143978*^9}, {
   3.908135971542886*^9, 3.908135972092883*^9}, {3.908137394923925*^9, 
   3.908137415370277*^9}, {3.908137458398984*^9, 3.908137500772458*^9}, {
   3.908327484815307*^9, 3.908327559432638*^9}, {3.908328117806119*^9, 
   3.9083281700155487`*^9}, {3.908328342726609*^9, 3.908328345569199*^9}, {
   3.908328630247284*^9, 3.908328630784814*^9}, {3.908328673032003*^9, 
   3.908328677168442*^9}, {3.908328710629874*^9, 3.9083287131755857`*^9}, {
   3.908328950946719*^9, 3.908328987211088*^9}, {3.908329044332096*^9, 
   3.908329094712051*^9}, {3.908329343729213*^9, 3.908329346566062*^9}, {
   3.908329582882681*^9, 3.908329601437356*^9}, {3.9083576936076813`*^9, 
   3.908357697497637*^9}, {3.90837556053372*^9, 3.908375572725819*^9}, {
   3.908375661083406*^9, 3.908375678949028*^9}, {3.908375711309935*^9, 
   3.90837575640704*^9}, {3.908375834688314*^9, 3.908375838518436*^9}, {
   3.908375892294563*^9, 3.908375898144023*^9}, {3.908375998684311*^9, 
   3.908376004392967*^9}, {3.908376112296569*^9, 3.908376127055825*^9}, {
   3.9083763257832108`*^9, 3.908376330415378*^9}, 3.908376427373621*^9, 
   3.908376569131449*^9, {3.908376627347782*^9, 3.908376646415254*^9}, {
   3.908377169557765*^9, 3.908377182171807*^9}, {3.9083773361514482`*^9, 
   3.908377380040986*^9}, {3.908377509466136*^9, 3.908377526175837*^9}, {
   3.908377556354946*^9, 3.9083775693908*^9}, {3.908499821530287*^9, 
   3.908499821765733*^9}, {3.913999987236995*^9, 3.9139999872440643`*^9}, {
   3.914011265813281*^9, 3.914011275947206*^9}, {3.914011320589248*^9, 
   3.914011326572238*^9}, {3.914011362993184*^9, 3.914011502454706*^9}, {
   3.9140116101504908`*^9, 3.914011610544045*^9}, {3.914011664838585*^9, 
   3.914011681322897*^9}, {3.914012320764892*^9, 3.914012320959462*^9}, {
   3.914012606155497*^9, 3.914012662942781*^9}, {3.914012719445352*^9, 
   3.914012721119667*^9}, {3.914012771505999*^9, 3.914012795535424*^9}, {
   3.914012826041128*^9, 3.914012827604958*^9}, {3.914012860134303*^9, 
   3.914012869007584*^9}, 3.914012966792108*^9, {3.914265491317712*^9, 
   3.91426552627099*^9}, 3.914266087876988*^9},
 CellLabel->
  "In[197]:=",ExpressionUUID->"630e263a-62ac-40c3-af96-14cd31a4b728"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Transformation tensors", "Subsection",
 CellChangeTimes->{{3.910961367178672*^9, 3.910961370979964*^9}, {
  3.910972746623457*^9, 3.910972752917669*^9}, {3.913999987270527*^9, 
  3.913999997241654*^9}},ExpressionUUID->"2eff3394-3006-479e-bf69-\
86a6097936f9"],

Cell["\<\
Symbolic tensor list.
For each quantity, I\[CloseCurlyQuote]ll store three variants:
1. Just a symbolic version with components
2. A \[OpenCurlyDoubleQuote]simplest\[CloseCurlyDoubleQuote] expansion in \
terms of the highest level expansion
3. A \[OpenCurlyDoubleQuote]full\[CloseCurlyDoubleQuote] expansion in terms \
of derivatives of coordinates (and the det function)\
\>", "Text",
 CellChangeTimes->{{3.910961384635518*^9, 3.910961395999955*^9}, {
  3.910988437860405*^9, 3.910988504110358*^9}, {3.913999987292103*^9, 
  3.9139999972626057`*^9}},ExpressionUUID->"6f7777b9-2749-47af-a5fe-\
f6aa1735deed"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"rules", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"STs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910961679595211*^9, 3.9109616796939087`*^9}},
 CellLabel->
  "In[198]:=",ExpressionUUID->"7e284ead-293c-4444-b7e0-fe7872be2285"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<jac\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"jac", "[", 
      RowBox[{"a_", ",", "a_"}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], "->", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"KroneckerDelta", "[", 
       RowBox[{"i", ",", "j"}], "]"}], "&"}], ")"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<connX\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"conn", "[", 
      RowBox[{"x_", ",", "\"\<XY+\>\""}], "]"}], "[", 
     RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], "->", 
    RowBox[{"(", 
     RowBox[{"0", "&"}], ")"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<todet\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      SuperscriptBox["Y", 
       TagBox[
        RowBox[{"(", 
         RowBox[{"0", ",", "1"}], ")"}],
        Derivative],
       MultilineFunction->None], "[", 
      RowBox[{"x", ",", "y"}], "]"}], " ", 
     RowBox[{
      SuperscriptBox["X", 
       TagBox[
        RowBox[{"(", 
         RowBox[{"1", ",", "0"}], ")"}],
        Derivative],
       MultilineFunction->None], "[", 
      RowBox[{"x", ",", "y"}], "]"}]}], "->", 
    RowBox[{
     RowBox[{"det", "[", 
      RowBox[{"x", ",", "y"}], "]"}], "+", 
     RowBox[{
      RowBox[{
       SuperscriptBox["X", 
        TagBox[
         RowBox[{"(", 
          RowBox[{"0", ",", "1"}], ")"}],
         Derivative],
        MultilineFunction->None], "[", 
       RowBox[{"x", ",", "y"}], "]"}], " ", 
      RowBox[{
       SuperscriptBox["Y", 
        TagBox[
         RowBox[{"(", 
          RowBox[{"1", ",", "0"}], ")"}],
         Derivative],
        MultilineFunction->None], "[", 
       RowBox[{"x", ",", "y"}], "]"}]}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<todetJ\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"J", "[", 
       RowBox[{"1", ",", "1"}], "]"}], "[", 
      RowBox[{"x", ",", "y"}], "]"}], " ", 
     RowBox[{
      RowBox[{"J", "[", 
       RowBox[{"2", ",", "2"}], "]"}], "[", 
      RowBox[{"x", ",", "y"}], "]"}]}], "->", 
    RowBox[{
     RowBox[{"det", "[", 
      RowBox[{"x", ",", "y"}], "]"}], "+", 
     RowBox[{
      RowBox[{
       RowBox[{"J", "[", 
        RowBox[{"1", ",", "2"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], " ", 
      RowBox[{
       RowBox[{"J", "[", 
        RowBox[{"2", ",", "1"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}]}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<det\>\"", "]"}], "=", 
   RowBox[{"det", "->", 
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"x", ",", "y"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"-", 
         RowBox[{
          RowBox[{"J", "[", 
           RowBox[{"1", ",", "2"}], "]"}], "[", 
          RowBox[{"x", ",", "y"}], "]"}]}], " ", 
        RowBox[{
         RowBox[{"J", "[", 
          RowBox[{"2", ",", "1"}], "]"}], "[", 
         RowBox[{"x", ",", "y"}], "]"}]}], "+", 
       RowBox[{
        RowBox[{
         RowBox[{"J", "[", 
          RowBox[{"1", ",", "1"}], "]"}], "[", 
         RowBox[{"x", ",", "y"}], "]"}], " ", 
        RowBox[{
         RowBox[{"J", "[", 
          RowBox[{"2", ",", "2"}], "]"}], "[", 
         RowBox[{"x", ",", "y"}], "]"}]}]}]}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<gradX\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"jac", "[", 
      RowBox[{"\"\<XY+\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], "\[RuleDelayed]", 
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"xx", ",", "yy"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"STs", "[", "K", "]"}], "\[LeftDoubleBracket]", 
        RowBox[{"1", ",", "i", ",", "j"}], "\[RightDoubleBracket]"}], "/.", 
       "\[VeryThinSpace]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"x", "\[Rule]", "xx"}], ",", 
         RowBox[{"y", "\[Rule]", "yy"}]}], "}"}]}]}], "]"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.9109615946095*^9, 3.910961606145654*^9}, {
   3.9109616676458263`*^9, 3.910961680940657*^9}, 3.910989804905587*^9, {
   3.910989949228759*^9, 3.910990012514079*^9}, {3.911040393750303*^9, 
   3.911040410026144*^9}, 3.9117633328768187`*^9, {3.911763401273544*^9, 
   3.9117634018056707`*^9}, {3.914265914784118*^9, 3.91426591508609*^9}},
 CellLabel->
  "In[200]:=",ExpressionUUID->"b3d6455a-c0bf-4633-979f-0f385a7ed93d"],

Cell["The coordinate vectors", "Text",
 CellChangeTimes->{{3.950674077239937*^9, 
  3.95067408011208*^9}},ExpressionUUID->"5d93bcca-aafd-4b38-8038-\
9f3e67723d7a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "X", "]"}], "=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"X", "[", 
       RowBox[{"x", ",", "y"}], "]"}], ",", 
      RowBox[{"Y", "[", 
       RowBox[{"x", ",", "y"}], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
    "0"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.910961326418912*^9, 3.9109613421557493`*^9}, {
   3.91096140574297*^9, 3.910961438890842*^9}, {3.910961474872308*^9, 
   3.91096148515101*^9}, 3.911763492666388*^9, 3.913999987300535*^9, {
   3.914012463318587*^9, 3.9140124686622667`*^9}, 3.950674039409788*^9},
 CellLabel->
  "In[207]:=",ExpressionUUID->"6733593c-cd00-4656-989c-6abbe135f51a"],

Cell["The Jacobian", "Text",
 CellChangeTimes->{{3.950674081936006*^9, 
  3.95067408335988*^9}},ExpressionUUID->"56b81e5c-519b-4dd3-b357-\
7780cac746b5"],

Cell[BoxData[
 RowBox[{"calcGradS", "[", 
  RowBox[{
   RowBox[{"STs", "[", "X", "]"}], ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.950674064237926*^9, 3.950674066056162*^9}},
 CellLabel->
  "In[210]:=",ExpressionUUID->"ab562252-c3c0-46d2-b533-45efa087c6eb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "Jf", "]"}], "=", 
  RowBox[{
   RowBox[{
    RowBox[{"calcGradS", "[", 
     RowBox[{
      RowBox[{"STs", "[", "X", "]"}], ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}],
      "]"}], "/.", 
    RowBox[{"rules", "[", "\"\<jac\>\"", "]"}]}], "/.", 
   RowBox[{"rules", "[", "\"\<connX\>\"", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.9109614693304358`*^9, 3.910961578734418*^9}, {
   3.9109616998666487`*^9, 3.910961719784588*^9}, {3.910963115952469*^9, 
   3.910963130022784*^9}, {3.910975645786757*^9, 3.910975646984961*^9}, {
   3.910988234446566*^9, 3.910988245791414*^9}, {3.9109885135578127`*^9, 
   3.910988551695575*^9}, {3.911763333998344*^9, 3.911763334989296*^9}, {
   3.91176344375698*^9, 3.9117634454636507`*^9}, 3.913999987303481*^9, {
   3.914012481790784*^9, 3.914012496045556*^9}, {3.914265564873228*^9, 
   3.914265568817876*^9}, {3.914265922100412*^9, 3.91426592236366*^9}, 
   3.914266096384935*^9, 3.950674041179278*^9},
 CellLabel->
  "In[211]:=",ExpressionUUID->"a3d3d1e7-6962-41da-94ce-6bcc5832fd8a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "J0", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"calcGradS", "[", 
      RowBox[{
       RowBox[{"STs", "[", "X", "]"}], ",", "\"\<xy\>\"", ",", 
       "\"\<xy+\>\""}], "]"}], "/.", 
     RowBox[{"rules", "[", "\"\<jac\>\"", "]"}]}], "/.", 
    RowBox[{"rules", "[", "\"\<connX\>\"", "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "J", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"J", "[", 
         RowBox[{"i", ",", "j"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"getDims", "[", 
      RowBox[{"STs", "[", "Jf", "]"}], "]"}], ",", 
     RowBox[{"getSlots", "[", 
      RowBox[{"STs", "[", "Jf", "]"}], "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.9109614693304358`*^9, 3.910961578734418*^9}, {
   3.9109616998666487`*^9, 3.910961719784588*^9}, {3.910963115952469*^9, 
   3.910963130022784*^9}, {3.910975645786757*^9, 3.910975646984961*^9}, {
   3.910988234446566*^9, 3.910988245791414*^9}, {3.9109885135578127`*^9, 
   3.910988551695575*^9}, {3.911763333998344*^9, 3.911763334989296*^9}, {
   3.91176344375698*^9, 3.9117634454636507`*^9}, 3.913999987303481*^9, {
   3.914012481790784*^9, 3.914012496045556*^9}, {3.914265564873228*^9, 
   3.914265568817876*^9}, {3.914265922100412*^9, 3.91426592236366*^9}},
 CellLabel->
  "In[212]:=",ExpressionUUID->"e7fc1d4b-ecff-43ef-a71a-82b7d4596570"],

Cell["\<\
The pullback operator, given by the inverse of the Jacobian (which we can \
invert because we are mapping between spaces of the same dimension)\
\>", "Text",
 CellChangeTimes->{{3.950674091760257*^9, 
  3.950674166999497*^9}},ExpressionUUID->"4fbff1b5-45ca-4281-9d84-\
4599bbee3491"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "Kf", "]"}], "=", 
  RowBox[{
   RowBox[{"Inverse", "[", 
    RowBox[{"STs", "[", "Jf", "]"}], "]"}], "//", "Simplify"}]}]], "Input",
 CellChangeTimes->{{3.910961724455882*^9, 3.910961769384456*^9}, {
   3.91096186258124*^9, 3.910961887323592*^9}, {3.910963353226652*^9, 
   3.910963355380368*^9}, {3.9109756505954*^9, 3.910975657797887*^9}, {
   3.9109885623805*^9, 3.910988582157635*^9}, {3.910989930988223*^9, 
   3.910989931084525*^9}, {3.910990056000825*^9, 3.910990057407926*^9}, 
   3.913999987306407*^9, {3.914013189896618*^9, 3.914013193793769*^9}, {
   3.914013697854168*^9, 3.914013701542666*^9}, {3.914265555077458*^9, 
   3.914265556468252*^9}, {3.914266123963238*^9, 3.914266125376251*^9}, 
   3.950674172360085*^9},
 CellLabel->
  "In[215]:=",ExpressionUUID->"ce9deb63-7767-41bb-8b06-1af30f30fd71"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "K0", "]"}], "=", 
   RowBox[{
    RowBox[{"Inverse", "[", 
     RowBox[{"STs", "[", "J", "]"}], "]"}], "/.", 
    RowBox[{"rules", "[", "\"\<todetJ\>\"", "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"STs", "[", "K", "]"}], "=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"K", "[", 
        RowBox[{"i", ",", "j"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "2"}], "}"}]}], "]"}], ",", 
    RowBox[{"getDims", "[", 
     RowBox[{"STs", "[", "Kf", "]"}], "]"}], ",", 
    RowBox[{"getSlots", "[", 
     RowBox[{"STs", "[", "Kf", "]"}], "]"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.910961724455882*^9, 3.910961769384456*^9}, {
   3.91096186258124*^9, 3.910961887323592*^9}, {3.910963353226652*^9, 
   3.910963355380368*^9}, {3.9109756505954*^9, 3.910975657797887*^9}, {
   3.9109885623805*^9, 3.910988582157635*^9}, {3.910989930988223*^9, 
   3.910989931084525*^9}, {3.910990056000825*^9, 3.910990057407926*^9}, 
   3.913999987306407*^9, {3.914013189896618*^9, 3.914013193793769*^9}, {
   3.914013697854168*^9, 3.914013701542666*^9}, 3.914265555077458*^9, 
   3.9506741755081463`*^9},
 CellLabel->
  "In[216]:=",ExpressionUUID->"b8fca20b-ca8d-4def-954b-e2efe8c8e68e"],

Cell["\<\
We need to contract tensors expressed in standard Cartesian basis\
\>", "Text",
 CellChangeTimes->{{3.9506741808324947`*^9, 
  3.950674198527932*^9}},ExpressionUUID->"80dfb0e1-119f-4dd4-ab7f-\
2551e3421c5f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "I", "]"}], "=", 
  RowBox[{
   RowBox[{"orthonormalMetric", "[", 
    RowBox[{"{", 
     RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "]"}], "//", 
   "Normal"}]}]], "Input",
 CellChangeTimes->{{3.91096190074923*^9, 3.910961932516531*^9}, {
   3.911763504936611*^9, 3.911763506024805*^9}, 3.913999987308845*^9, {
   3.914013026302271*^9, 3.9140130270457287`*^9}, 3.914013066436595*^9, 
   3.9506743206940517`*^9},
 CellLabel->
  "In[223]:=",ExpressionUUID->"02c4b812-474b-4e38-8086-b659dc1a4b50"],

Cell["\<\
We transform the identity to calculate the pullback of the metric tensor to \
our remapped space\
\>", "Text",
 CellChangeTimes->{{3.9506742022965813`*^9, 
  3.9506742186481524`*^9}},ExpressionUUID->"db859df2-59ca-45cc-994c-\
411928ae6836"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "Gf", "]"}], "=", 
   RowBox[{
    RowBox[{"STs", "[", "Jf", "]"}], ".", 
    RowBox[{"STs", "[", "I", "]"}], ".", 
    RowBox[{"adjoint", "[", 
     RowBox[{"STs", "[", "Jf", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "G0", "]"}], "=", 
   RowBox[{
    RowBox[{"STs", "[", "J", "]"}], ".", 
    RowBox[{"STs", "[", "I", "]"}], ".", 
    RowBox[{"adjoint", "[", 
     RowBox[{"STs", "[", "J", "]"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "G", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"G", "[", 
         RowBox[{"i", ",", "j"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"getDims", "[", 
      RowBox[{"STs", "[", "Gf", "]"}], "]"}], ",", 
     RowBox[{"getSlots", "[", 
      RowBox[{"STs", "[", "Gf", "]"}], "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910961963849666*^9, 3.910961999757361*^9}, {
   3.910962036242564*^9, 3.910962042352074*^9}, {3.910963379098281*^9, 
   3.910963400340846*^9}, 3.9109634441671543`*^9, 3.910975664174017*^9, {
   3.91098861953543*^9, 3.91098863250395*^9}, 3.91399998731221*^9, {
   3.914013201130187*^9, 3.9140132083996477`*^9}, {3.914013707633542*^9, 
   3.914013714350951*^9}},
 CellLabel->
  "In[219]:=",ExpressionUUID->"7893c068-4589-49ae-a555-ddd60b0c0ccd"],

Cell[BoxData[
 RowBox[{"STs", "[", "G", "]"}]], "Input",
 CellChangeTimes->{{3.950674314505556*^9, 3.950674317047833*^9}},
 CellLabel->
  "In[224]:=",ExpressionUUID->"688b90ce-44f8-4e62-99e5-4f28193ac3e3"],

Cell["\<\
We calculate the inverse of this metric to contract the duals\
\>", "Text",
 CellChangeTimes->{{3.9506742951518993`*^9, 
  3.950674312143758*^9}},ExpressionUUID->"0bb27577-2b7d-497a-9f9f-\
b5b8d4e9601d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "Hf", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"adjoint", "[", 
      RowBox[{"STs", "[", "Kf", "]"}], "]"}], ".", 
     RowBox[{"flip", "[", 
      RowBox[{"STs", "[", "I", "]"}], "]"}], ".", 
     RowBox[{"STs", "[", "Kf", "]"}]}], "//", "Simplify"}]}], ";"}]], "Input",\

 CellChangeTimes->{{3.910962085799116*^9, 3.910962086838522*^9}, {
   3.910962168137307*^9, 3.910962226379806*^9}, {3.9109634041913443`*^9, 
   3.910963448691689*^9}, 3.910975669263036*^9, {3.910988654802054*^9, 
   3.910988679429768*^9}, 3.91399998731527*^9, 3.914013116413777*^9, {
   3.914013677282791*^9, 3.914013679810854*^9}},
 CellLabel->
  "In[225]:=",ExpressionUUID->"51d3376b-b4fc-4ead-8464-69c2032ce865"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "H0", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"adjoint", "[", 
      RowBox[{"STs", "[", "K", "]"}], "]"}], ".", 
     RowBox[{"flip", "[", 
      RowBox[{"STs", "[", "I", "]"}], "]"}], ".", 
     RowBox[{"STs", "[", "K", "]"}]}], "//", "Simplify"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914013683429702*^9, 3.914013684793353*^9}},
 CellLabel->
  "In[226]:=",ExpressionUUID->"22066e38-2a7c-4aab-bd1b-accf0792f8c1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "H", "]"}], "=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"H", "[", 
        RowBox[{"i", ",", "j"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "2"}], "}"}]}], "]"}], ",", 
    RowBox[{"getDims", "[", 
     RowBox[{"STs", "[", "Hf", "]"}], "]"}], ",", 
    RowBox[{"getSlots", "[", 
     RowBox[{"STs", "[", "Hf", "]"}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.910962085799116*^9, 3.910962086838522*^9}, {
   3.910962168137307*^9, 3.910962226379806*^9}, {3.9109634041913443`*^9, 
   3.910963448691689*^9}, 3.910975669263036*^9, {3.910988654802054*^9, 
   3.910988679429768*^9}, 3.91399998731527*^9, {3.914013116413777*^9, 
   3.914013126647681*^9}, {3.914013218534691*^9, 3.914013228501152*^9}, {
   3.9140161382035723`*^9, 3.914016143149517*^9}, 3.9506743286604033`*^9},
 CellLabel->
  "In[227]:=",ExpressionUUID->"622f1570-3719-4ae7-919d-8b93e0d0ff84"],

Cell["\<\
We can finally calculate connection tensors for the different bases\
\>", "Text",
 CellChangeTimes->{{3.95067433316789*^9, 
  3.950674350152215*^9}},ExpressionUUID->"e473dc8e-4e8c-4079-b6f1-\
f8a03f09eff5"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"dense", "[", 
             RowBox[{"covec", "[", 
              RowBox[{"2", ",", 
               RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], "]"}], 
            "\[TensorProduct]", "\[IndentingNewLine]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"calcGradS", "[", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"vec", "[", 
                   RowBox[{"2", ",", 
                    RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], ".", 
                  
                  RowBox[{"STs", "[", "Jf", "]"}]}], ")"}], ",", "\"\<xy\>\"",
                 ",", "\"\<xy+\>\""}], "]"}], ".", 
              RowBox[{"STs", "[", "Kf", "]"}]}], ")"}]}], ")"}], ")"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", "2"}], "}"}]}], "]"}], "/.", 
       RowBox[{"rules", "[", "\"\<jac\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<connX\>\"", "]"}]}], "//", 
     RowBox[{
      RowBox[{"iso", "[", 
       RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "//", "Simplify"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.9109622556341467`*^9, 3.910962279437101*^9}, {
   3.910962314336744*^9, 3.910962321633676*^9}, {3.910962360464214*^9, 
   3.910962392015261*^9}, {3.910962476530122*^9, 3.910962532111208*^9}, {
   3.910963427325875*^9, 3.910963453223083*^9}, {3.910963514309432*^9, 
   3.910963556779483*^9}, {3.9109785242650623`*^9, 3.910978524492491*^9}, {
   3.91098869420224*^9, 3.9109887076248093`*^9}, {3.911763336813356*^9, 
   3.911763337867756*^9}, {3.911763541606447*^9, 3.911763547729311*^9}, 
   3.913999987331613*^9, 3.914013241432252*^9, {3.914266148270225*^9, 
   3.914266174036395*^9}},
 CellLabel->
  "In[228]:=",ExpressionUUID->"cf69b482-1552-428b-ab3a-63be92312012"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "\[CapitalGamma]0", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"dense", "[", 
             RowBox[{"covec", "[", 
              RowBox[{"2", ",", 
               RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], "]"}], 
            "\[TensorProduct]", "\[IndentingNewLine]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"calcGradS", "[", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"vec", "[", 
                   RowBox[{"2", ",", 
                    RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], ".", 
                  
                  RowBox[{"STs", "[", "J", "]"}]}], ")"}], ",", "\"\<xy\>\"", 
                ",", "\"\<xy+\>\""}], "]"}], ".", 
              RowBox[{"STs", "[", "K", "]"}]}], ")"}]}], ")"}], ")"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", "2"}], "}"}]}], "]"}], "/.", 
       RowBox[{"rules", "[", "\"\<jac\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<connX\>\"", "]"}]}], "//", 
     RowBox[{
      RowBox[{"iso", "[", 
       RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "//", "Simplify"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.9109622556341467`*^9, 3.910962279437101*^9}, {
   3.910962314336744*^9, 3.910962321633676*^9}, {3.910962360464214*^9, 
   3.910962392015261*^9}, {3.910962476530122*^9, 3.910962532111208*^9}, {
   3.910963427325875*^9, 3.910963453223083*^9}, {3.910963514309432*^9, 
   3.910963556779483*^9}, {3.9109785242650623`*^9, 3.910978524492491*^9}, {
   3.91098869420224*^9, 3.9109887076248093`*^9}, {3.911763336813356*^9, 
   3.911763337867756*^9}, {3.911763541606447*^9, 3.911763547729311*^9}, 
   3.913999987331613*^9, {3.914013241432252*^9, 3.914013274520628*^9}, {
   3.914013417954562*^9, 3.914013419806436*^9}, 3.914013538646936*^9, {
   3.914266176500575*^9, 3.914266189005965*^9}},
 CellLabel->
  "In[229]:=",ExpressionUUID->"8ba1f839-8a3b-48a9-91f5-68e4808f99f2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "\[CapitalGamma]", "]"}], "=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"\[CapitalGamma]", "[", 
        RowBox[{"i", ",", "j", ",", "k"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", "2"}], "}"}]}], "]"}], ",", 
    RowBox[{"getDims", "[", 
     RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "]"}], ",", 
    RowBox[{"getSlots", "[", 
     RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "]"}]}], "]"}]}]], "Input",\

 CellChangeTimes->{{3.9109622556341467`*^9, 3.910962279437101*^9}, {
   3.910962314336744*^9, 3.910962321633676*^9}, {3.910962360464214*^9, 
   3.910962392015261*^9}, {3.910962476530122*^9, 3.910962532111208*^9}, {
   3.910963427325875*^9, 3.910963453223083*^9}, {3.910963514309432*^9, 
   3.910963556779483*^9}, {3.9109785242650623`*^9, 3.910978524492491*^9}, {
   3.91098869420224*^9, 3.9109887076248093`*^9}, {3.911763336813356*^9, 
   3.911763337867756*^9}, {3.911763541606447*^9, 3.911763547729311*^9}, 
   3.913999987331613*^9, {3.914013241432252*^9, 3.914013274520628*^9}, 
   3.914013417954562*^9, {3.914266202822102*^9, 3.914266204340333*^9}, 
   3.950674356546414*^9},
 CellLabel->
  "In[230]:=",ExpressionUUID->"174e8818-5691-4a63-a3cc-b3f1fa32bed1"],

Cell["\<\
If we want to measure changes of our tangent vectors expressed in Cartesian \
components, we need to change our definitions slightly\
\>", "Text",
 CellChangeTimes->{{3.9506743642004967`*^9, 
  3.950674432536532*^9}},ExpressionUUID->"b2eef85b-0c42-4e2e-a773-\
4c94b254f251"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "\[CapitalGamma]Xf", "]"}], "=", 
   RowBox[{
    RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{"adjoint", "[", 
        RowBox[{"STs", "[", "Kf", "]"}], "]"}], ",", "2"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.910980943582579*^9, 3.91098095022521*^9}, {
   3.9109809804906673`*^9, 3.91098099333572*^9}, {3.9109810578597116`*^9, 
   3.910981096266713*^9}, 3.910981218982333*^9, 3.91098670706907*^9, {
   3.910988761527361*^9, 3.910988771826319*^9}, 3.91098977698072*^9, 
   3.9139999873357687`*^9, {3.914013314483345*^9, 3.914013339104234*^9}, {
   3.9506743812662287`*^9, 3.950674383322981*^9}},
 CellLabel->
  "In[232]:=",ExpressionUUID->"b6ceabbf-4064-4570-9429-3b5c411e0920"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "\[CapitalGamma]X0", "]"}], "=", 
   RowBox[{
    RowBox[{"STs", "[", "\[CapitalGamma]", "]"}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{"adjoint", "[", 
        RowBox[{"STs", "[", "K", "]"}], "]"}], ",", "2"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.910980943582579*^9, 3.91098095022521*^9}, {
   3.9109809804906673`*^9, 3.91098099333572*^9}, {3.9109810578597116`*^9, 
   3.910981096266713*^9}, 3.910981218982333*^9, 3.91098670706907*^9, {
   3.910988761527361*^9, 3.910988771826319*^9}, 3.91098977698072*^9, 
   3.9139999873357687`*^9, {3.914013314483345*^9, 3.914013342256027*^9}},
 CellLabel->
  "In[233]:=",ExpressionUUID->"10fd71f3-3b7a-45f9-ab7e-eda2aef52e7f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"STs", "[", "\[CapitalGamma]X", "]"}], "=", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"\[CapitalGamma]X", "[", 
        RowBox[{"i", ",", "j", ",", "k"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", "2"}], "}"}]}], "]"}], ",", 
    RowBox[{"getDims", "[", 
     RowBox[{"STs", "[", "\[CapitalGamma]Xf", "]"}], "]"}], ",", 
    RowBox[{"getSlots", "[", 
     RowBox[{"STs", "[", "\[CapitalGamma]Xf", "]"}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.910980943582579*^9, 3.91098095022521*^9}, {
   3.9109809804906673`*^9, 3.91098099333572*^9}, {3.9109810578597116`*^9, 
   3.910981096266713*^9}, 3.910981218982333*^9, 3.91098670706907*^9, {
   3.910988761527361*^9, 3.910988771826319*^9}, 3.91098977698072*^9, 
   3.9139999873357687`*^9, {3.914013314483345*^9, 3.914013342256027*^9}, 
   3.950674385483306*^9},
 CellLabel->
  "In[234]:=",ExpressionUUID->"fc97719e-c453-4c3d-85e3-5d8d10e173f4"],

Cell["\<\
Now we\[CloseCurlyQuote]ll create some rules that can expand out the \
definitions of the symbolic tensors from above\
\>", "Text",
 CellChangeTimes->{{3.950674465752038*^9, 
  3.950674498544467*^9}},ExpressionUUID->"9bcf551a-5e39-440c-a5bf-\
111a4e2c2a21"],

Cell[BoxData[
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{"rules", "[", 
     RowBox[{"tensor", "<>", "type"}], "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"ToExpression", "[", "tensor", "]"}], "[", 
       RowBox[{"i_", ",", "j_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "exp", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "i", ",", "j"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], "/.", 
     RowBox[{"{", 
      RowBox[{"exp", "->", 
       RowBox[{"ToExpression", "[", 
        RowBox[{"tensor", "<>", "type"}], "]"}]}], "}"}]}]}], ",", 
   RowBox[{"{", 
    RowBox[{"tensor", ",", 
     RowBox[{"{", 
      RowBox[{
      "\"\<J\>\"", ",", "\"\<K\>\"", ",", "\"\<G\>\"", ",", "\"\<H\>\""}], 
      "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"type", ",", 
     RowBox[{"{", 
      RowBox[{"\"\<f\>\"", ",", "\"\<0\>\""}], "}"}]}], "}"}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.91098912251544*^9, 3.910989338661927*^9}, {
  3.9109895323870497`*^9, 3.910989639372551*^9}, {3.913999987339154*^9, 
  3.913999997276082*^9}},
 CellLabel->
  "In[235]:=",ExpressionUUID->"0dfd653d-81db-4c44-92a3-22ad0938448d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"rules", "[", 
      RowBox[{"tensor", "<>", "type"}], "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ToExpression", "[", "tensor", "]"}], "[", 
        RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":>", 
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"xx", ",", "yy"}], "}"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"STs", "[", "exp", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "i", ",", "j", ",", "k"}], "]"}], "]"}], "/.", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "->", "xx"}], ",", 
            RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], "/.", 
      RowBox[{"{", 
       RowBox[{"exp", "->", 
        RowBox[{"ToExpression", "[", 
         RowBox[{"tensor", "<>", "type"}], "]"}]}], "}"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{"tensor", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<\[CapitalGamma]\>\"", ",", "\"\<\[CapitalGamma]X\>\""}], 
       "}"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"type", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<f\>\"", ",", "\"\<0\>\""}], "}"}]}], "}"}]}], "]"}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.910989668820682*^9, 3.910989688208686*^9}, {
  3.913999987348117*^9, 3.913999997283087*^9}},
 CellLabel->
  "In[236]:=",ExpressionUUID->"3dcf22dc-92f5-4b04-88de-95a08b116bd5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}], "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"jac", "[", 
        RowBox[{"\"\<XY+\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "K", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "i", ",", "j"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"jac", "[", 
        RowBox[{"\"\<xy+\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_"}], "]"}], "->", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"KroneckerDelta", "[", 
         RowBox[{"i", ",", "j"}], "]"}], "&"}], ")"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"jac", "[", 
        RowBox[{"\"\<xy-\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_"}], "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "H", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "i", ",", "j"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<conns\>\"", "]"}], "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<xy+\>\"", ",", "\"\<XY+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], "->", 
      RowBox[{"(", 
       RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<xy+\>\"", ",", "\"\<XY-\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], "->", 
      RowBox[{"(", 
       RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<XY+\>\"", ",", "\"\<XY+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], "->", 
      RowBox[{"(", 
       RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<XY+\>\"", ",", "\"\<XY-\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], "->", 
      RowBox[{"(", 
       RowBox[{"0", "&"}], ")"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<xy+\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "\[CapitalGamma]", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "i", ",", "j", ",", "k"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<xy+\>\"", ",", "\"\<xy-\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{
           RowBox[{"STs", "[", "\[CapitalGamma]", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "k", ",", "j", ",", "i"}], "]"}], "]"}]}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<XY+\>\"", ",", "\"\<xy+\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "\[CapitalGamma]X", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "i", ",", "j", ",", "k"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"conn", "[", 
        RowBox[{"\"\<XY+\>\"", ",", "\"\<xy-\>\""}], "]"}], "[", 
       RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":>", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{
           RowBox[{"STs", "[", "\[CapitalGamma]X", "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "k", ",", "j", ",", "i"}], "]"}], "]"}]}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.91097277641757*^9, 3.910972846378252*^9}, {
  3.91176333942758*^9, 3.911763404628005*^9}, {3.9142662201740503`*^9, 
  3.914266229659162*^9}, {3.950675048023011*^9, 3.9506751027050867`*^9}},
 CellLabel->
  "In[275]:=",ExpressionUUID->"cfa30ac3-ec75-4a16-ab2b-d5cb33213e70"],

Cell["Now let\[CloseCurlyQuote]s look at some example symbolic tensors", \
"Text",
 CellChangeTimes->{{3.9506745066241903`*^9, 
  3.950674512800704*^9}},ExpressionUUID->"7df4d0b3-f520-4d58-bb93-\
797263d41f93"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "ux", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"u", "[", 
         RowBox[{"\"\<xy+\>\"", ",", "1"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{
        RowBox[{"u", "[", 
         RowBox[{"\"\<xy+\>\"", ",", "2"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "UX", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"U", "[", 
         RowBox[{"\"\<XY+\>\"", ",", "1"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{
        RowBox[{"U", "[", 
         RowBox[{"\"\<XY+\>\"", ",", "2"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "p", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"p", "[", 
      RowBox[{"x", ",", "y"}], "]"}], ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910973438259313*^9, 3.910973470819776*^9}, {
   3.910974068798858*^9, 3.9109740700251513`*^9}, {3.910991437415002*^9, 
   3.910991462482415*^9}, {3.911763347517963*^9, 3.911763348193802*^9}, {
   3.911763399952421*^9, 3.911763400527328*^9}, 3.91176350713907*^9, 
   3.91176354973925*^9, {3.913999987357586*^9, 3.913999987361117*^9}, {
   3.914013573433042*^9, 3.91401358820193*^9}},
 CellLabel->
  "In[239]:=",ExpressionUUID->"02056c2a-fbf7-41f9-9a8e-1b701b58be3c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Bundle Transformation operators", "Subsection",
 CellChangeTimes->{{3.914434927539654*^9, 
  3.914434933793991*^9}},ExpressionUUID->"c21fac60-9b40-4b15-8581-\
e9750c9032ab"],

Cell["\<\
Next we want some convenience operators to abbreviate the transforms we want \
to make between different vector fields\
\>", "Text",
 CellChangeTimes->{{3.950674531696918*^9, 
  3.950674562337572*^9}},ExpressionUUID->"4db4b55a-ff6a-4a01-a7a1-\
e9f7233b29cd"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"convertDimToString", "[", "dim_", "]"}], ":=", 
   RowBox[{
    RowBox[{"dim", "[", 
     RowBox[{"[", "1", "]"}], "]"}], "<>", 
    RowBox[{"dim", "[", 
     RowBox[{"[", "3", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"convertStringToDim", "[", "string_", "]"}], ":=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"StringTake", "[", 
     RowBox[{"string", ",", "2"}], "]"}], ",", "2", ",", 
    RowBox[{"StringTake", "[", 
     RowBox[{"string", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}]}], "}"}]}]}], "Input",
 CellChangeTimes->{{3.914033915324918*^9, 3.914033990320442*^9}, {
  3.914034181770423*^9, 3.914034182037466*^9}},
 CellLabel->
  "In[244]:=",ExpressionUUID->"f786fdf2-6a5b-4613-b04b-7406acc15c85"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"basisOrder", "=", 
   RowBox[{"<|", 
    RowBox[{
     RowBox[{"\"\<xy-\>\"", "->", "0"}], ",", 
     RowBox[{"\"\<XY-\>\"", "->", "1"}], ",", 
     RowBox[{"\"\<XY+\>\"", "->", "2"}], ",", 
     RowBox[{"\"\<xy+\>\"", "->", "3"}]}], "|>"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"intToBasis", "=", 
   RowBox[{"basisOrder", "//", 
    RowBox[{
     RowBox[{"AssociationThread", "[", 
      RowBox[{
       RowBox[{"Values", "[", "#", "]"}], ",", 
       RowBox[{"Keys", "[", "#", "]"}]}], "]"}], "&"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914033893273896*^9, 3.914033900621971*^9}, {
  3.914034023098666*^9, 3.914034091055307*^9}, {3.91403416780703*^9, 
  3.91403416901217*^9}},
 CellLabel->
  "In[246]:=",ExpressionUUID->"1678bb38-bafc-42d4-9ffc-9ddcf0d1dde9"],

Cell["\<\
Create a dictionary to store all the transforms between bases\
\>", "Text",
 CellChangeTimes->{{3.950674575824717*^9, 
  3.950674587240453*^9}},ExpressionUUID->"8a7b2264-5154-4d1b-adbd-\
66cb642d40e8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"IdS", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"IdS", "[", 
      RowBox[{"{", 
       RowBox[{"i", ",", "i"}], "}"}], "]"}], "=", 
     RowBox[{"id", "[", 
      RowBox[{
       RowBox[{"intToBasis", "[", "i", "]"}], "//", "convertStringToDim"}], 
      "]"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", 
      RowBox[{"Keys", "[", "intToBasis", "]"}]}], "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"0", ",", "1"}], "}"}], "]"}], "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{
     RowBox[{"STs", "[", "K", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"1", ",", "2"}], "}"}], "]"}], "=", 
   RowBox[{"flip", "[", 
    RowBox[{"STs", "[", "I", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"2", ",", "3"}], "}"}], "]"}], "=", 
   RowBox[{"STs", "[", "K", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"3", ",", "2"}], "}"}], "]"}], "=", 
   RowBox[{"STs", "[", "J", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"2", ",", "1"}], "}"}], "]"}], "=", 
   RowBox[{"STs", "[", "I", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], "]"}], "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{
     RowBox[{"STs", "[", "J", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"3", ",", "0"}], "}"}], "]"}], "=", 
   RowBox[{"STs", "[", "G", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IdS", "[", 
    RowBox[{"{", 
     RowBox[{"0", ",", "3"}], "}"}], "]"}], "=", 
   RowBox[{"STs", "[", "H", "]"}]}], ";"}], "\n", 
 RowBox[{"Do", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"IdS", "[", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"i", "+", "2"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"IdS", "[", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"i", "+", "1"}]}], "}"}], "]"}], ".", 
      RowBox[{"IdS", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "1"}], ",", 
         RowBox[{"i", "+", "2"}]}], "}"}], "]"}]}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"IdS", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"i", "+", "2"}], ",", "i"}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"IdS", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "2"}], ",", 
         RowBox[{"i", "+", "1"}]}], "}"}], "]"}], ".", 
      RowBox[{"IdS", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "1"}], ",", "i"}], "}"}], "]"}]}]}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{"i", ",", "0", ",", "1"}], "}"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.914034066253605*^9, 3.9140340749400253`*^9}, {
   3.914034177591407*^9, 3.914034186550076*^9}, 3.914417535662088*^9, {
   3.914435072940073*^9, 3.914435130714448*^9}, {3.914435209853917*^9, 
   3.914435210125895*^9}, {3.9144352540044394`*^9, 3.914435267253003*^9}, {
   3.914435300204599*^9, 3.914435331251234*^9}, {3.914436723224986*^9, 
   3.914436782475726*^9}, 3.914436821784964*^9},
 CellLabel->
  "In[248]:=",ExpressionUUID->"7af0c93c-78ad-4f32-997f-ba502ba44b15"],

Cell["Test that everything has the right dimensions", "Text",
 CellChangeTimes->{{3.914436905629703*^9, 
  3.914436911526136*^9}},ExpressionUUID->"a59eba20-6246-4438-91a9-\
f0960355c054"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"IdS", "[", 
        RowBox[{"{", 
         RowBox[{"i", ",", "j"}], "}"}], "]"}], "[", 
       RowBox[{"[", "2", "]"}], "]"}], "==", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"convertStringToDim", "/@", 
         RowBox[{"intToBasis", "/@", 
          RowBox[{"{", 
           RowBox[{"i", ",", "j"}], "}"}]}]}], "//", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"dual", "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
           RowBox[{"#", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "&"}]}], ")"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "0", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "0", ",", "3"}], "}"}]}], "]"}], "//", "Flatten"}], "//", 
  RowBox[{
   RowBox[{"And", "@@", "#"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914436832812458*^9, 3.9144369017283688`*^9}},
 CellLabel->
  "In[259]:=",ExpressionUUID->"f4f79fff-d182-43cd-b862-ab07562c1885"],

Cell[BoxData[
 RowBox[{
  RowBox[{"getBundleTransformS", "[", 
   RowBox[{"d1_", ",", "d2_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{"d1", ",", "d2"}], "}"}], "//", 
     RowBox[{
      RowBox[{"convertDimToString", "/@", "#"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"basisOrder", "/@", "#"}], "&"}]}], "//", "IdS"}]}]], "Input",
 CellChangeTimes->{{3.914063486734685*^9, 3.914063537685124*^9}, {
   3.914063633718734*^9, 3.914063667551051*^9}, 3.914064302794837*^9, {
   3.914435425139204*^9, 3.914435431478156*^9}},
 CellLabel->
  "In[260]:=",ExpressionUUID->"fece0cff-29ec-4b80-a270-bab4be90a53e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformBundleS", "[", 
   RowBox[{"t_tensor", ",", "dimList_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"bundleDims", ",", "bundleInds", ",", "transforms"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Length", "[", 
        RowBox[{
         RowBox[{"getCoordDims", "[", "t", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}], ">", "0"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"transformBundleS", "::", "grid"}], ",", 
        RowBox[{"getDims", "[", "t", "]"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
        RowBox[{"getBundleDims", "[", "t", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"dimList", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "Rule"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"transformBundleS", "[", 
          RowBox[{"t", ",", 
           RowBox[{"ReplacePart", "[", 
            RowBox[{"bundleDims", ",", 
             RowBox[{"dimList", "/.", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"a_Integer", "->", "b_String"}], ")"}], ":>", 
               RowBox[{"(", 
                RowBox[{"a", "->", 
                 RowBox[{"convertStringToDim", "[", "b", "]"}]}], ")"}]}]}]}],
             "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"transforms", "=", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"getBundleTransformS", "@@", "#"}], "&"}], "/@", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"bundleDims", ",", "dimList"}], "}"}], 
               "\[Transpose]"}], ")"}]}], ")"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"contractOnes", "[", 
           RowBox[{"t", ",", "transforms", ",", 
            RowBox[{"Range", "[", 
             RowBox[{"Length", "[", "bundleDims", "]"}], "]"}]}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.9142900557312193`*^9, 3.914290091274193*^9}, {
   3.914290408818806*^9, 3.914290582312446*^9}, {3.9142906456382627`*^9, 
   3.914290677886935*^9}, {3.914290758393472*^9, 3.9142907742575493`*^9}, {
   3.91429323546266*^9, 3.914293256304134*^9}, {3.914293301406815*^9, 
   3.914293317968706*^9}, {3.914293362813817*^9, 3.914293482278599*^9}, {
   3.914293521931184*^9, 3.914293628772142*^9}, {3.914293742474948*^9, 
   3.914293742811478*^9}, 3.914293786975587*^9, {3.9142938546518297`*^9, 
   3.914293867032939*^9}, {3.914293909577513*^9, 3.914293936716976*^9}, {
   3.9142941144093113`*^9, 3.9142941148713293`*^9}, {3.91429418660975*^9, 
   3.914294215077066*^9}, {3.914294260951394*^9, 3.914294271484473*^9}, {
   3.914294303947276*^9, 3.914294306037719*^9}, {3.914296743145322*^9, 
   3.914296796788138*^9}, {3.914296841807053*^9, 3.9142969226007547`*^9}, {
   3.9142971201569633`*^9, 3.91429717981481*^9}, {3.914425778636372*^9, 
   3.9144257788610086`*^9}, {3.914425937760571*^9, 3.914425990963183*^9}, {
   3.914435439677895*^9, 3.914435462223576*^9}, {3.914435518899596*^9, 
   3.91443553284301*^9}, {3.914435620798057*^9, 3.914435780268198*^9}, {
   3.9144358535740223`*^9, 3.914435924582842*^9}, {3.914436005056078*^9, 
   3.914436107625917*^9}, {3.914436394382648*^9, 3.914436456617972*^9}, {
   3.9144365035199823`*^9, 3.914436530931916*^9}, {3.9144366494914618`*^9, 
   3.914436650188046*^9}, {3.9506746210390177`*^9, 3.950674621273364*^9}},
 CellLabel->
  "In[261]:=",ExpressionUUID->"d277ae01-3714-4f05-b248-6d3c7744bdd6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"transformBundleS", "::", "grid"}], "=", 
   "\"\<Tensor has numerical dimensions `1`\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.914436497855437*^9, 3.9144364991545563`*^9}, {
  3.9144365346653357`*^9, 3.914436570932073*^9}},
 CellLabel->
  "In[262]:=",ExpressionUUID->"65da9bb2-f5c6-401c-aa2c-0bde9271daa1"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Differential operators", "Chapter",
 CellChangeTimes->{{3.910990901007436*^9, 
  3.9109909231166563`*^9}},ExpressionUUID->"477a6e2c-0248-49b0-bb0c-\
8c77ddd86851"],

Cell[CellGroupData[{

Cell[TextData[{
 "Scalar gradient (",
 Cell[BoxData[
  FormBox[
   RowBox[{"T", "->", 
    SuperscriptBox["C", 
     RowBox[{"(", "2", ")"}]]}], TraditionalForm]],ExpressionUUID->
  "ee709872-6755-41fd-84c5-1f55e6378b0c"],
 ")"
}], "Subsection",
 CellChangeTimes->{{3.910990939728129*^9, 
  3.910990954315835*^9}},ExpressionUUID->"12564fa6-a3db-45c5-980c-\
aa3aeb9b8ac9"],

Cell[TextData[{
 "Calculate the gradient of a scalar, expressed in the dual basis to the \
tangent vector basis ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["e", "x"], ",", 
    SubscriptBox["e", "y"]}], TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "caa11afc-37fb-4cf7-92e2-86d6b98af892"]
}], "Text",
 CellChangeTimes->{{3.950674741353168*^9, 
  3.950674768717078*^9}},ExpressionUUID->"04ae1c4b-03f4-4185-9192-\
0133cb65ef86"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGradS", "[", 
   RowBox[{
    RowBox[{"STs", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], 
   "]"}], "/.", 
  RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}]], "Input",
 CellChangeTimes->{{3.910990993584869*^9, 3.910991011953141*^9}, {
   3.91103612536001*^9, 3.911036156918483*^9}, 3.91176334928856*^9, 
   3.911763551709118*^9, {3.914266238620931*^9, 3.914266242238529*^9}},
 CellLabel->
  "In[263]:=",ExpressionUUID->"5bbdda85-1ed4-4a70-b870-4a98b321ade8"],

Cell["\<\
Calculate the gradient of a scalar, but express it in the dual basis to the \
Cartesian tangent vector basis, which requires some transforms\
\>", "Text",
 CellChangeTimes->{{3.95067477139249*^9, 
  3.950674808073763*^9}},ExpressionUUID->"23da1d97-3ea9-4ebc-b0c9-\
132e9e36bdd4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGradS", "[", 
   RowBox[{
    RowBox[{"STs", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", "\"\<XY+\>\""}], 
   "]"}], "/.", 
  RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}]], "Input",
 CellChangeTimes->{{3.950674652089944*^9, 3.9506746525929003`*^9}},
 CellLabel->
  "In[265]:=",ExpressionUUID->"ce6e60d5-0f07-4bd4-9809-efb1398f39ab"],

Cell["\<\
Calculate the gradient of a scalar, but express it in the tangent vector \
basis itself\
\>", "Text",
 CellChangeTimes->{{3.950674864480773*^9, 
  3.950674879081381*^9}},ExpressionUUID->"33ccc9a6-c0a6-4478-b5f3-\
50104281de1a"],

Cell[BoxData[
 RowBox[{"calcGradS", "[", 
  RowBox[{
   RowBox[{"STs", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", "\"\<xy-\>\""}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.950674684323266*^9, 3.950674685616391*^9}, {
  3.9506749616706963`*^9, 3.9506749619454308`*^9}, {3.950675132545209*^9, 
  3.95067513454956*^9}},
 CellLabel->
  "In[279]:=",ExpressionUUID->"80b9dd18-d972-4f89-9737-407a3b1b8559"],

Cell[TextData[{
 "This is achieved by contraction with the inverse metric ",
 Cell[BoxData[
  FormBox["H", TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "d290a85c-a37b-416d-852c-5e727413a699"]
}], "Text",
 CellChangeTimes->{{3.950674987484961*^9, 
  3.9506749981966743`*^9}},ExpressionUUID->"9d026f0c-9bb3-420a-b97a-\
5a1a283a5b25"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"STs", "[", "H", "]"}], ".", 
    RowBox[{"calcGradS", "[", 
     RowBox[{
      RowBox[{"STs", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}],
      "]"}]}], "/.", 
   RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "//", "Simplify"}]], "Input",\

 CellChangeTimes->{{3.911036241019019*^9, 3.9110362757352047`*^9}, 
   3.911763350356504*^9, 3.911763552503986*^9, {3.914266246745914*^9, 
   3.91426624793882*^9}, {3.9506749676479883`*^9, 3.950675020017393*^9}},
 CellLabel->
  "In[280]:=",ExpressionUUID->"ac70a8bb-e219-497c-af4d-ed64c1caae7a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Vector divergence", "Subsection",
 CellChangeTimes->{{3.910991029382734*^9, 
  3.910991032340205*^9}},ExpressionUUID->"adbc6c6d-a8a2-419d-a1e3-\
0c6378070fb6"],

Cell["\<\
To calculate a vector divergence, we take a gradient, then contract the result\
\>", "Text",
 CellChangeTimes->{{3.950675146499851*^9, 
  3.9506751644906*^9}},ExpressionUUID->"284a0738-8eca-4a2e-a39c-d9065e6de8bf"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"calcGradS", "[", 
     RowBox[{
      RowBox[{"STs", "[", "ux", "]"}], ",", "\"\<xy\>\"", ",", 
      "\"\<xy+\>\""}], "]"}], "//", 
    RowBox[{
     RowBox[{"TensorContract", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
   RowBox[{
    RowBox[{
     RowBox[{"#", "/.", 
      RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
     RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "&"}]}], "//", 
  "Simplify"}]], "Input",
 CellChangeTimes->{{3.91099103602877*^9, 3.9109911653677683`*^9}, 
   3.910991545443286*^9, 3.911763351216662*^9, 3.911763553788254*^9, {
   3.914266267314855*^9, 3.914266269864521*^9}},
 CellLabel->
  "In[281]:=",ExpressionUUID->"b70b123d-6911-479b-8a80-5ffc4aa6b623"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"calcGradS", "[", 
      RowBox[{
       RowBox[{"STs", "[", "UX", "]"}], ",", "\"\<xy\>\"", ",", 
       "\"\<xy+\>\""}], "]"}], ".", 
     RowBox[{"STs", "[", "K", "]"}]}], "/.", 
    RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
   RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "//", 
  RowBox[{
   RowBox[{"TensorContract", "[", 
    RowBox[{"#", ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.910991205857916*^9, 3.910991365805064*^9}, {
   3.910991554306715*^9, 3.910991557317316*^9}, 3.9117633519828653`*^9, 
   3.911763554360413*^9, 3.914266272665443*^9},
 CellLabel->
  "In[282]:=",ExpressionUUID->"0ab1ae3c-8f8f-463c-8003-56ff6158afb9"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Scalar Laplacian", "Subsection",
 CellChangeTimes->{{3.911036478663997*^9, 
  3.911036482255443*^9}},ExpressionUUID->"d5343cf5-924f-4801-9517-\
6044717c0bd8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<conformalXY\>\"", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", 
        RowBox[{"1", ",", "0"}], "]"}], "[", "Y", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{"-", 
         RowBox[{
          RowBox[{
           RowBox[{"Derivative", "[", 
            RowBox[{"0", ",", "1"}], "]"}], "[", "X", "]"}], "[", 
          RowBox[{"x", ",", "y"}], "]"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", 
        RowBox[{"0", ",", "1"}], "]"}], "[", "Y", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"Derivative", "[", 
           RowBox[{"1", ",", "0"}], "]"}], "[", "X", "]"}], "[", 
         RowBox[{"x", ",", "y"}], "]"}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", 
        RowBox[{"0", ",", "2"}], "]"}], "[", "X", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{"-", 
         RowBox[{
          RowBox[{
           RowBox[{"Derivative", "[", 
            RowBox[{"2", ",", "0"}], "]"}], "[", "X", "]"}], "[", 
          RowBox[{"x", ",", "y"}], "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<conformal\>\"", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{"J", "[", 
       RowBox[{"1", ",", "2"}], "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{"-", 
         RowBox[{
          RowBox[{"J", "[", 
           RowBox[{"2", ",", "1"}], "]"}], "[", 
          RowBox[{"x", ",", "y"}], "]"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"J", "[", 
       RowBox[{"2", ",", "2"}], "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "y"}], "}"}], ",", 
        RowBox[{
         RowBox[{"J", "[", 
          RowBox[{"1", ",", "1"}], "]"}], "[", 
         RowBox[{"x", ",", "y"}], "]"}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", 
         RowBox[{"0", ",", "2"}], "]"}], "[", "X", "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], "->", 
      RowBox[{"-", 
       RowBox[{
        RowBox[{
         RowBox[{"Derivative", "[", 
          RowBox[{"2", ",", "0"}], "]"}], "[", "X", "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}]}]}]}], "\[IndentingNewLine]", "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<toconformalmetric\>\"", "]"}], "=", 
   RowBox[{
    SuperscriptBox[
     RowBox[{
      RowBox[{"J", "[", 
       RowBox[{"1", ",", "1"}], "]"}], "[", 
      RowBox[{"x", ",", "y"}], "]"}], "2"], "->", 
    RowBox[{
     RowBox[{"g", "[", 
      RowBox[{"x", ",", "y"}], "]"}], "-", 
     SuperscriptBox[
      RowBox[{
       RowBox[{"J", "[", 
        RowBox[{"2", ",", "1"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], "2"]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<conformalmetric\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{"g", "[", 
     RowBox[{"x", ",", "y"}], "]"}], "->", 
    RowBox[{
     SuperscriptBox[
      RowBox[{
       RowBox[{"J", "[", 
        RowBox[{"1", ",", "1"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], "2"], "+", 
     SuperscriptBox[
      RowBox[{
       RowBox[{"J", "[", 
        RowBox[{"2", ",", "1"}], "]"}], "[", 
       RowBox[{"x", ",", "y"}], "]"}], "2"]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.911036882637458*^9, 3.911036964937787*^9}, {
  3.9110370765257*^9, 3.911037087243806*^9}, {3.911037205888153*^9, 
  3.9110372331518583`*^9}, {3.911037352749389*^9, 3.911037388090015*^9}, {
  3.911037426620552*^9, 3.9110374376349583`*^9}, {3.911037474440075*^9, 
  3.91103750885141*^9}, {3.911041293364579*^9, 3.911041293479394*^9}, {
  3.911041987991687*^9, 3.911042087404065*^9}, {3.91104213396977*^9, 
  3.911042214542623*^9}},
 CellLabel->
  "In[283]:=",ExpressionUUID->"eac70282-6051-44e9-b048-29811488bca9"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"STs", "[", "p", "]"}], "//", 
      RowBox[{
       RowBox[{"calcGradS", "[", 
        RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}], 
     "//", 
     RowBox[{
      RowBox[{"calcGradS", "[", 
       RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{"iso", "[", 
       RowBox[{
        RowBox[{"STs", "[", "H", "]"}], ",", "0"}], "]"}], ".", 
      RowBox[{"iso", "[", 
       RowBox[{"#", ",", "2"}], "]"}]}], "&"}]}], "//", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "/.", 
             RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
            RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "/.", 
           RowBox[{"rules", "[", "\"\<H0\>\"", "]"}]}], "/.", 
          RowBox[{"rules", "[", "\"\<\[CapitalGamma]0\>\"", "]"}]}], "/.", 
         RowBox[{"rules", "[", "\"\<K0\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<det\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<conformal\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<J0\>\"", "]"}]}], "/.", 
     RowBox[{"rules", "[", "\"\<conformalXY\>\"", "]"}]}], "&"}]}], "//", 
  RowBox[{
   RowBox[{"Collect", "[", 
    RowBox[{
     RowBox[{"#", "[", 
      RowBox[{"[", "1", "]"}], "]"}], ",", 
     RowBox[{"Flatten", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Grad", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"STs", "[", "p", "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", "y"}], "}"}]}], "]"}], ",", 
        RowBox[{"Grad", "[", 
         RowBox[{
          RowBox[{"Grad", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"STs", "[", "p", "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"x", ",", "y"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", "y"}], "}"}]}], "]"}]}], "}"}], "]"}], ",", 
     "Simplify"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.9110364938764067`*^9, 3.91103658920216*^9}, {
  3.911037055494885*^9, 3.911037062345581*^9}, {3.911037249456598*^9, 
  3.911037254418535*^9}, {3.911037523484702*^9, 3.911037527362083*^9}, {
  3.911038687039746*^9, 3.911038757818003*^9}, {3.91103886530999*^9, 
  3.911038926547415*^9}, {3.911039014701655*^9, 3.911039017840217*^9}, {
  3.911040131457671*^9, 3.911040174903009*^9}, {3.911040253245794*^9, 
  3.911040287306343*^9}, {3.911040439406749*^9, 3.91104053662928*^9}, {
  3.911042098430458*^9, 3.911042123398988*^9}, {3.911042251045393*^9, 
  3.91104228312109*^9}, {3.911763352870513*^9, 3.911763353790813*^9}, {
  3.911763555451747*^9, 3.911763556218142*^9}, {3.914016193059133*^9, 
  3.914016193727161*^9}, {3.9142663326768427`*^9, 3.91426633820555*^9}},
 CellLabel->
  "In[287]:=",ExpressionUUID->"289cd5a1-67c5-4f6a-a7f8-68e7ce8207d1"],

Cell["\<\
If the metric is truly an identity operation, then it should have zero \
gradient. And it does!\
\>", "Text",
 CellChangeTimes->{{3.950675843446328*^9, 
  3.950675866302085*^9}},ExpressionUUID->"575691ba-5d3e-4acc-8b0f-\
3529ed014b48"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "G", "]"}], "//", 
       RowBox[{
        RowBox[{"calcGradS", "[", 
         RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}],
       "//", 
      RowBox[{
       RowBox[{"calcGradS", "[", 
        RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}], 
     "//", 
     RowBox[{
      RowBox[{"iso", "[", 
       RowBox[{"#", ",", "2"}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{"iso", "[", 
       RowBox[{
        RowBox[{"STs", "[", "H0", "]"}], ",", "0"}], "]"}], ".", "#"}], 
     "&"}]}], "//", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"#", "/.", 
           RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
          RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "/.", 
         RowBox[{"rules", "[", "\"\<G0\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<\[CapitalGamma]0\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<K0\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<det\>\"", "]"}]}], "/.", 
     RowBox[{"rules", "[", "\"\<J0\>\"", "]"}]}], "&"}]}], "//", 
  "Simplify"}]], "Input",
 CellChangeTimes->{{3.911039425654002*^9, 3.9110396386172132`*^9}, {
  3.911763355107932*^9, 3.911763355923191*^9}, {3.911763557515319*^9, 
  3.911763558018995*^9}, {3.914266335421677*^9, 3.9142663396111*^9}},
 CellLabel->
  "In[288]:=",ExpressionUUID->"d4f688c2-dcbd-4da5-af54-41beff1f945e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Vector Laplacian", "Subsection",
 CellChangeTimes->{{3.910991523240292*^9, 
  3.910991537151308*^9}},ExpressionUUID->"b5054f7a-28d7-4383-ae8b-\
698c61be08ca"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "lapux", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"STs", "[", "ux", "]"}], "//", 
         RowBox[{
          RowBox[{"calcGradS", "[", 
           RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], 
          "&"}]}], "//", 
        RowBox[{
         RowBox[{"calcGradS", "[", 
          RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], 
         "&"}]}], "//", 
       RowBox[{
        RowBox[{"contractOne", "[", 
         RowBox[{"#", ",", 
          RowBox[{"STs", "[", "H", "]"}], ",", "1"}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"TensorContract", "[", 
        RowBox[{"#", ",", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "/.", 
        RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"/.", 
           RowBox[{"rules", "[", "\"\<H0\>\"", "]"}]}], "/."}], "/.", 
         RowBox[{"rules", "[", "\"\<K0\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<J0\>\"", "]"}]}], "*)"}], "&"}]}], "//", 
    "Simplify"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.9109916637984657`*^9, 3.91099184722432*^9}, {
  3.910991924186538*^9, 3.910991941661765*^9}, {3.910992675361354*^9, 
  3.910992675850175*^9}, {3.910992768052956*^9, 3.910992772430927*^9}, {
  3.9109928397611*^9, 3.910992847068487*^9}, {3.910992880345864*^9, 
  3.910992881187442*^9}, {3.911763356827375*^9, 3.911763357593659*^9}, {
  3.9117635597381268`*^9, 3.911763560184737*^9}, {3.91426635269776*^9, 
  3.914266354341069*^9}},
 CellLabel->
  "In[289]:=",ExpressionUUID->"93f662ef-d58c-4f73-9d01-d0d25f427889"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "lapuxa2", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"a", "[", "2", "]"}], "[", 
         RowBox[{"i", ",", "j", ",", "k", ",", "l"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"l", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{"s", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "s"}], "}"}]}], "]"}], "[", 
        "s", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"s", ",", 
         RowBox[{"Characters", "[", "\"\<++-+\>\"", "]"}]}], "}"}]}], "]"}], 
     ",", "0"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.910992860316418*^9, 3.910993044596717*^9}, {
   3.910993184874052*^9, 3.910993193491153*^9}, {3.910993442927069*^9, 
   3.910993475847918*^9}, {3.910993525499073*^9, 3.910993581995254*^9}, {
   3.91099381865827*^9, 3.910993875368074*^9}, {3.91099403087619*^9, 
   3.910994031498956*^9}, 3.911763561510796*^9, 3.913999987390045*^9, {
   3.914016246952965*^9, 3.914016251599181*^9}},
 CellLabel->
  "In[290]:=",ExpressionUUID->"1a468c87-c6ba-4cf1-b663-988db5385205"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "lapuxa1", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"a", "[", "1", "]"}], "[", 
         RowBox[{"i", ",", "j", ",", "k"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{"s", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "s"}], "}"}]}], "]"}], "[", 
        "s", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"s", ",", 
         RowBox[{"Characters", "[", "\"\<+-+\>\"", "]"}]}], "}"}]}], "]"}], 
     ",", "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "lapuxa0", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"a", "[", "0", "]"}], "[", 
         RowBox[{"i", ",", "j"}], "]"}], "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{"s", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "s"}], "}"}]}], "]"}], "[", 
        "s", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"s", ",", 
         RowBox[{"Characters", "[", "\"\<-+\>\"", "]"}]}], "}"}]}], "]"}], 
     ",", "0"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910992860316418*^9, 3.910993044596717*^9}, {
  3.910993184874052*^9, 3.910993193491153*^9}, {3.910993442927069*^9, 
  3.910993475847918*^9}, {3.910993525499073*^9, 3.910993581995254*^9}, {
  3.91099381865827*^9, 3.910993875368074*^9}, {3.910993947828995*^9, 
  3.910993959360414*^9}, {3.910994033134366*^9, 3.910994035336865*^9}, {
  3.9117635632106237`*^9, 3.9117635638361197`*^9}, {3.913999987393968*^9, 
  3.913999987396163*^9}, {3.914016266158875*^9, 3.914016276201455*^9}},
 CellLabel->
  "In[291]:=",ExpressionUUID->"60cace68-dd7f-4e0d-9967-4abe467fb145"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "jacux", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"calcGradS", "[", 
      RowBox[{
       RowBox[{"STs", "[", "ux", "]"}], ",", "\"\<xy\>\"", ",", 
       "\"\<xy+\>\""}], "]"}], "/.", 
     RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
    RowBox[{
     RowBox[{
      RowBox[{"conn", "[", "x__", "]"}], "[", "y__", "]"}], "->", 
     RowBox[{"(", 
      RowBox[{"0", "&"}], ")"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "hessux", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"calcGradS", "[", 
      RowBox[{
       RowBox[{"STs", "[", "jacux", "]"}], ",", "\"\<xy\>\"", ",", 
       "\"\<xy+\>\""}], "]"}], "/.", 
     RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
    RowBox[{
     RowBox[{
      RowBox[{"conn", "[", "x__", "]"}], "[", "y__", "]"}], "->", 
     RowBox[{"(", 
      RowBox[{"0", "&"}], ")"}]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910993063471362*^9, 3.9109931446150017`*^9}, {
  3.911763358330008*^9, 3.911763358951722*^9}, {3.9117635644298077`*^9, 
  3.91176356499785*^9}, {3.914266371099894*^9, 3.914266384933457*^9}},
 CellLabel->
  "In[293]:=",ExpressionUUID->"d0ced964-ca41-4d80-a1da-e8317e48ff0e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"jet", "=", 
   RowBox[{
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "ux", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], ",", 
      RowBox[{
       RowBox[{"STs", "[", "jacux", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], ",", 
      RowBox[{
       RowBox[{"STs", "[", "hessux", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "//", "Flatten"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.910994225941918*^9, 3.910994268795225*^9}},
 CellLabel->
  "In[295]:=",ExpressionUUID->"4ef1a88a-e3d9-45fe-927e-2889abacefbe"],

Cell[BoxData[
 RowBox[{
  RowBox[{"lapterms", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "hessux", "]"}], ",", "0"}], "]"}], ".", 
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "lapuxa2", "]"}], ",", "3"}], "]"}]}], 
       "\[IndentingNewLine]", "+", 
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "jacux", "]"}], ",", "0"}], "]"}], ".", 
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "lapuxa1", "]"}], ",", "2"}], "]"}]}], 
       "\[IndentingNewLine]", "+", 
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "ux", "]"}], ",", "0"}], "]"}], ".", 
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "lapuxa0", "]"}], ",", "1"}], "]"}]}]}], ")"}], 
     "-", 
     RowBox[{"STs", "[", "lapux", "]"}]}], "//", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Coefficient", "[", 
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", "j"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "jet"}], "}"}]}], "]"}], "&"}]}]}], ";"}]], "Input",\

 CellChangeTimes->{{3.910993993027473*^9, 3.910994004401203*^9}, {
  3.910994049651705*^9, 3.910994056798284*^9}, {3.9109941497856817`*^9, 
  3.910994221607445*^9}, {3.91099427020282*^9, 3.910994378808025*^9}},
 CellLabel->
  "In[296]:=",ExpressionUUID->"528120a4-4ec1-4c7c-ac76-9e4a823f19c3"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<lapcoeffs\>\"", "]"}], "=", 
   RowBox[{"Solve", "[", 
    RowBox[{
     RowBox[{"lapterms", "==", "0"}], ",", 
     RowBox[{"Flatten", "[", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"STs", "[", "lapuxa2", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{
         RowBox[{"STs", "[", "lapuxa1", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{
         RowBox[{"STs", "[", "lapuxa0", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.9109943836041203`*^9, 3.9109944371989613`*^9}},
 CellLabel->
  "In[297]:=",ExpressionUUID->"fff03d31-f398-47ec-9493-ceff725cee45"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<lapcoeffssimple\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"rules", "[", "\"\<lapcoeffs\>\"", "]"}], "/.", 
     RowBox[{
      RowBox[{"\[CapitalGamma]", "[", 
       RowBox[{"2", ",", "1", ",", "k_"}], "]"}], "->", 
      RowBox[{"\[CapitalGamma]", "[", 
       RowBox[{"1", ",", "2", ",", "k"}], "]"}]}]}], "/.", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"l_", "->", "r_"}], ")"}], ":>", 
     RowBox[{"(", 
      RowBox[{"l", "->", 
       RowBox[{"(", 
        RowBox[{"r", "/.", 
         RowBox[{
          RowBox[{
           RowBox[{"a", "[", "i_", "]"}], "[", "j__", "]"}], "->", 
          RowBox[{"(", 
           RowBox[{"0", "&"}], ")"}]}]}], ")"}]}], ")"}]}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.910994925212564*^9, 3.910994932934628*^9}},
 CellLabel->
  "In[298]:=",ExpressionUUID->"f053ec07-a5d7-42ee-b0bf-7fcb7e199e92"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}], "-", 
   RowBox[{"Transpose", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"STs", "[", "\[CapitalGamma]f", "]"}], "[", 
      RowBox[{"[", "1", "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], "//", 
  "Simplify"}]], "Input",
 CellChangeTimes->{{3.910994488955784*^9, 3.910994550648944*^9}},
 CellLabel->
  "In[299]:=",ExpressionUUID->"75119378-e46b-4b09-ada6-1eb7677d7120"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"rules", "[", "\"\<lapcoeffs\>\"", "]"}], "//", "Simplify"}], "//",
     "Flatten"}], "//", 
   RowBox[{
    RowBox[{"#", "[", 
     RowBox[{"[", 
      RowBox[{";;", ",", "2"}], "]"}], "]"}], "&"}]}], "//", 
  RowBox[{
   RowBox[{"Length", "/@", "#"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.910994667565772*^9, 3.910994744132049*^9}},
 CellLabel->
  "In[300]:=",ExpressionUUID->"232ceda8-f7b7-453b-8232-cb0d5b6f64a7"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"rules", "[", "\"\<lapcoeffssimple\>\"", "]"}], "//", 
     "Simplify"}], "//", "Flatten"}], "//", 
   RowBox[{
    RowBox[{"#", "[", 
     RowBox[{"[", 
      RowBox[{";;", ",", "2"}], "]"}], "]"}], "&"}]}], "//", 
  RowBox[{
   RowBox[{"Length", "/@", "#"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.9109944402268248`*^9, 3.910994464175701*^9}, {
  3.9109945952152863`*^9, 3.910994645180029*^9}, {3.910994748982195*^9, 
  3.910994757981496*^9}, {3.910994866202394*^9, 3.910994906837504*^9}, {
  3.9109949432606277`*^9, 3.91099494833237*^9}},
 CellLabel->
  "In[301]:=",ExpressionUUID->"a5eb2983-5071-4125-b734-7a1d23f15bfe"],

Cell["What is the tensor for the highest derivatives?", "Text",
 CellChangeTimes->{{3.911042734263595*^9, 3.911042740001145*^9}, {
  3.913999987420916*^9, 
  3.913999997302411*^9}},ExpressionUUID->"f843d776-7c51-444d-8848-\
af09499654fb"],

Cell[BoxData[
 RowBox[{"next", "=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"STs", "[", "lapuxa2", "]"}], "/.", 
        RowBox[{
         RowBox[{"rules", "[", "\"\<lapcoeffs\>\"", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "-", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"STs", "[", "H", "]"}], ",", "0"}], "]"}], 
        "\[TensorProduct]", 
        RowBox[{"iso", "[", 
         RowBox[{
          RowBox[{"dense", "[", 
           RowBox[{"id", "[", 
            RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "]"}], ",", "0"}], 
         "]"}]}], ")"}]}], "//", 
     RowBox[{
      RowBox[{"#", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "&"}]}], "//", "Flatten"}], "//", 
   RowBox[{
    RowBox[{"Solve", "[", 
     RowBox[{
      RowBox[{"#", "==", "0"}], ",", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"STs", "[", "lapuxa2", "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "]"}], "&"}]}]}]], "Input",
 CellChangeTimes->{{3.910994970675784*^9, 3.910994999051508*^9}, {
   3.9109952749161997`*^9, 3.910995277219387*^9}, {3.910995337039967*^9, 
   3.910995452654829*^9}, {3.911042425134068*^9, 3.911042426137365*^9}, 
   3.911763565941162*^9},
 CellLabel->
  "In[302]:=",ExpressionUUID->"69a3a03a-066d-4799-bfbb-215ea8c0c82f"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{"STs", "[", "lapuxa2", "]"}], "/.", 
     RowBox[{
      RowBox[{"rules", "[", "\"\<lapcoeffs\>\"", "]"}], "[", 
      RowBox[{"[", "1", "]"}], "]"}]}], ")"}], "-", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"iso", "[", 
      RowBox[{
       RowBox[{"STs", "[", "H", "]"}], ",", "0"}], "]"}], "\[TensorProduct]", 
     
     RowBox[{"iso", "[", 
      RowBox[{
       RowBox[{"dense", "[", 
        RowBox[{"id", "[", 
         RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "]"}], ",", "0"}], "]"}]}], 
    ")"}]}], "/.", 
  RowBox[{"next", "[", 
   RowBox[{"[", "1", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.910995542702436*^9, 3.910995565876884*^9}, {
   3.911042431560669*^9, 3.911042438339367*^9}, {3.911042666488296*^9, 
   3.911042676866973*^9}, 3.911763567942795*^9},
 CellLabel->
  "In[303]:=",ExpressionUUID->"18ed5b67-e596-4266-82ee-bae0e1a6b8c5"],

Cell[TextData[{
 "So the highest derivative tensor can be written very simply using the \
inverse metric ",
 Cell[BoxData[
  FormBox["H", TraditionalForm]],ExpressionUUID->
  "66dcf656-818e-410a-98fc-1f74e5ec88c5"]
}], "Text",
 CellChangeTimes->{{3.911042745565073*^9, 3.911042760966024*^9}, {
   3.913999987455307*^9, 3.913999997327696*^9}, 
   3.914266431735474*^9},ExpressionUUID->"8709559c-8b2f-4daa-9159-\
f0bf88222e42"],

Cell[BoxData[
 RowBox[{
  RowBox[{"iso", "[", 
   RowBox[{
    RowBox[{"STs", "[", "H", "]"}], ",", "0"}], "]"}], "\[TensorProduct]", 
  RowBox[{"iso", "[", 
   RowBox[{
    RowBox[{"dense", "[", 
     RowBox[{"id", "[", 
      RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "]"}], ",", "0"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.910995055528522*^9, 3.910995056397966*^9}, {
   3.910995094702114*^9, 3.910995179046139*^9}, {3.910995228077529*^9, 
   3.910995260309335*^9}, 3.911763569191422*^9},
 CellLabel->
  "In[304]:=",ExpressionUUID->"23fc370f-fce0-478f-97ce-a3543ca97db9"],

Cell["\<\
Next we want the expression for the first derivative terms. These will \
involve gradients\
\>", "Text",
 CellChangeTimes->{{3.911042764065607*^9, 
  3.911042778778834*^9}},ExpressionUUID->"03b0c961-a7ae-4522-8f3c-\
fd3121b972dd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"a1exp", "=", 
   RowBox[{
    RowBox[{"STs", "[", "lapuxa1", "]"}], "/.", 
    RowBox[{
     RowBox[{"rules", "[", "\"\<lapcoeffssimple\>\"", "]"}], "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.910995023995469*^9, 3.910995026308118*^9}, {
  3.911043311955954*^9, 3.911043325591223*^9}, {3.911043469269293*^9, 
  3.9110435471502037`*^9}},
 CellLabel->
  "In[305]:=",ExpressionUUID->"71149205-f321-4e68-87c4-790a383a9d62"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"a1exp", "-", 
    RowBox[{"Transpose", "[", 
     RowBox[{"a1exp", ",", 
      RowBox[{"{", 
       RowBox[{"3", ",", "2", ",", "1"}], "}"}]}], "]"}]}], "/.", 
   RowBox[{
    RowBox[{"H", "[", 
     RowBox[{"2", ",", "1"}], "]"}], "->", 
    RowBox[{"H", "[", 
     RowBox[{"1", ",", "2"}], "]"}]}]}], "/.", 
  RowBox[{
   RowBox[{"\[CapitalGamma]", "[", 
    RowBox[{"2", ",", "1", ",", "i_"}], "]"}], "->", 
   RowBox[{"\[CapitalGamma]", "[", 
    RowBox[{"1", ",", "2", ",", "i"}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.911043522167625*^9, 3.91104359201269*^9}},
 CellLabel->
  "In[306]:=",ExpressionUUID->"fbcd99b5-613a-41ef-9457-f94a51cc8285"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Standard Stokes problem", "Chapter",
 CellChangeTimes->{{3.910801629091177*^9, 3.910801639690341*^9}, {
   3.910961279386602*^9, 3.910961285399355*^9}, 
   3.911340685930318*^9},ExpressionUUID->"8a42a181-c2b3-4d7b-9708-\
753165cdc61d"],

Cell["\<\
Now we\[CloseCurlyQuote]re going to use this machinery we have built to \
construct the numerical matrices that correspond to a Stokes problem\
\>", "Text",
 CellChangeTimes->{{3.9108016419136553`*^9, 3.910801658608312*^9}, {
  3.950675912485968*^9, 
  3.950675932997232*^9}},ExpressionUUID->"225eec93-e63e-4438-8809-\
9cf134def8dc"],

Cell["\<\
It will be convenient to define operators as having the same logic as \
tensors. We can also transpose the input and output (by inserting \
transposition operators before and after application). But we won\
\[CloseCurlyQuote]t be able to switch arity, since we don\[CloseCurlyQuote]t \
necessarily have access to the actual matrix elements.\
\>", "Text",
 CellChangeTimes->{{3.910809127933355*^9, 3.910809213897152*^9}, {
  3.913999987500538*^9, 
  3.913999997349024*^9}},ExpressionUUID->"5e1183b5-df5b-41a7-8de2-\
afded534cfb8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"basesList", "[", "\"\<xy+\>\"", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"basesList", "[", "\"\<xy-\>\"", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.910801670357216*^9, 3.910801676018203*^9}, {
  3.911762589375452*^9, 3.9117625946807137`*^9}, {3.911763162325926*^9, 
  3.911763165426935*^9}},
 CellLabel->
  "In[307]:=",ExpressionUUID->"c2d7f473-6d6e-4554-990d-c798d25a57d3"],

Cell["Create the Chebyshev-Gauss (or Lobatto?) grid points", "Text",
 CellChangeTimes->{{3.950675964781262*^9, 
  3.950675975356575*^9}},ExpressionUUID->"78329675-858b-4478-baa4-\
add0c3a4c24c"],

Cell[BoxData[
 StyleBox[
  RowBox[{
   RowBox[{"createGrid", "[", "n_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "xs", ",", "ys", ",", "xxs", ",", "yys", ",", "xt", ",", "yt", ",", 
       "xxt", ",", "yyt"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"xs", ",", "ys"}], "}"}], "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Cos", "[", 
          RowBox[{"\[Pi]", " ", 
           FractionBox[
            RowBox[{"Range", "[", 
             RowBox[{".5", ",", "n"}], "]"}], "n"]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "2"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"xxs", ",", "yys"}], "}"}], "=", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"xi", ",", "yj"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"xi", ",", "xs"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"yj", ",", "ys"}], "}"}]}], "]"}], "//", 
        RowBox[{
         RowBox[{"Transpose", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1"}], "}"}]}], "]"}], "&"}]}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"xt", "=", 
       RowBox[{"tensor", "[", 
        RowBox[{"xs", ",", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}], "}"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yt", "=", 
       RowBox[{"tensor", "[", 
        RowBox[{"ys", ",", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}], "}"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"xxt", "=", 
       RowBox[{"tensor", "[", 
        RowBox[{"xxs", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
            "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
            "}"}]}], "}"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yyt", "=", 
       RowBox[{"tensor", "[", 
        RowBox[{"yys", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
            "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
            "}"}]}], "}"}], ",", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"<|", 
       RowBox[{
        RowBox[{"\"\<xs\>\"", "->", "xs"}], ",", 
        RowBox[{"\"\<ys\>\"", "->", "ys"}], ",", 
        RowBox[{"\"\<xxs\>\"", "->", "xxs"}], ",", 
        RowBox[{"\"\<yys\>\"", "->", "yys"}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<xt\>\"", "->", "xt"}], ",", 
        RowBox[{"\"\<yt\>\"", "->", "yt"}], ",", 
        RowBox[{"\"\<xxt\>\"", "->", "xxt"}], ",", 
        RowBox[{"\"\<yyt\>\"", "->", "yyt"}]}], "|>"}]}]}], "]"}]}], 
  "Code"]], "Input",
 CellChangeTimes->{{3.9108016969252787`*^9, 3.9108017312572603`*^9}, {
   3.910801809809827*^9, 3.910801908186354*^9}, {3.910802373759175*^9, 
   3.91080255278318*^9}, {3.911762600888254*^9, 3.911762632743007*^9}, {
   3.913999987512062*^9, 3.913999987520756*^9}, 3.914009671905305*^9, 
   3.914016391717272*^9},
 CellLabel->
  "In[309]:=",ExpressionUUID->"a023264f-a3a9-466d-b709-5cce5c54c60e"],

Cell["\<\
Build the tensors needed to calculate the matrix corresponding to the Stokes \
problem\
\>", "Text",
 CellChangeTimes->{{3.950675978389236*^9, 
  3.950676009853139*^9}},ExpressionUUID->"0c5af5bd-360d-49f8-94a2-\
3cc52a54631d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"createTens", "[", "n_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "Ts", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Ts", "=", 
      RowBox[{"<|", "|>"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Fxg\>\"", "]"}], "=", 
      RowBox[{"GtoC", "[", 
       RowBox[{"n", ",", "\"\<x\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Fyg\>\"", "]"}], "=", 
      RowBox[{"GtoC", "[", 
       RowBox[{"n", ",", "\"\<y\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Fx0\>\"", "]"}], "=", 
      RowBox[{"CtoG", "[", 
       RowBox[{"n", ",", "\"\<x\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Fy0\>\"", "]"}], "=", 
      RowBox[{"CtoG", "[", 
       RowBox[{"n", ",", "\"\<y\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Dx0\>\"", "]"}], "=", 
      RowBox[{"diff", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Dy0\>\"", "]"}], "=", 
      RowBox[{"diff", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Dx1\>\"", "]"}], "=", 
      RowBox[{"diff", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "1"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Dy1\>\"", "]"}], "=", 
      RowBox[{"diff", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "1"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Px0\>\"", "]"}], "=", 
      RowBox[{"shift", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Py0\>\"", "]"}], "=", 
      RowBox[{"shift", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Px1\>\"", "]"}], "=", 
      RowBox[{"shift", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "1"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Py1\>\"", "]"}], "=", 
      RowBox[{"shift", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "1"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Bx-\>\"", "]"}], "=", 
      RowBox[{"interp", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Bx+\>\"", "]"}], "=", 
      RowBox[{"interp", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<By-\>\"", "]"}], "=", 
      RowBox[{"interp", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<By+\>\"", "]"}], "=", 
      RowBox[{"interp", "[", 
       RowBox[{"n", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<e_0\>\"", "]"}], "=", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<xy\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<e_1\>\"", "]"}], "=", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<xy\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<e^0\>\"", "]"}], "=", 
      RowBox[{"covec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<xy\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<e^1\>\"", "]"}], "=", 
      RowBox[{"covec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<xy\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Ts", "[", 
         RowBox[{"\"\<\[CapitalPi]\>\"", "<>", "d", "<>", 
          RowBox[{"ToString", "[", "i", "]"}]}], "]"}], "=", 
        RowBox[{"filter", "[", 
         RowBox[{"n", ",", 
          RowBox[{"{", 
           RowBox[{"d", ",", "i"}], "}"}], ",", 
          RowBox[{"1", ";;", 
           RowBox[{"n", "-", "2"}]}]}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"d", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "1", ",", "2"}], "}"}]}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[Del]0\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"adjoint", "[", 
           RowBox[{"Ts", "[", "\"\<e^0\>\"", "]"}], "]"}], "\[TensorProduct]", 
          RowBox[{"Ts", "[", "\"\<Dx0\>\"", "]"}], "\[TensorProduct]", 
          RowBox[{"Ts", "[", "\"\<Py0\>\"", "]"}]}], "+", 
         RowBox[{
          RowBox[{"adjoint", "[", 
           RowBox[{"Ts", "[", "\"\<e^1\>\"", "]"}], "]"}], "\[TensorProduct]", 
          RowBox[{"Ts", "[", "\"\<Px0\>\"", "]"}], "\[TensorProduct]", 
          RowBox[{"Ts", "[", "\"\<Dy0\>\"", "]"}]}]}], ")"}], ".", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"adjoint", "[", 
          RowBox[{"id", "[", 
           RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<Px1\>\"", "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<Py1\>\"", "]"}]}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[CapitalDelta]0\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{"id", "[", 
        RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "\[TensorProduct]", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<Dx0\>\"", "]"}], ".", 
            RowBox[{"Ts", "[", "\"\<Dx1\>\"", "]"}]}], ")"}], 
          "\[TensorProduct]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<Py0\>\"", "]"}], ".", 
            RowBox[{"Ts", "[", "\"\<Py1\>\"", "]"}]}], ")"}]}], "+", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<Px0\>\"", "]"}], ".", 
            RowBox[{"Ts", "[", "\"\<Px1\>\"", "]"}]}], ")"}], 
          "\[TensorProduct]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<Dy0\>\"", "]"}], ".", 
            RowBox[{"Ts", "[", "\"\<Dy1\>\"", "]"}]}], ")"}]}]}], ")"}]}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[Del]0\[CenterDot]\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Ts", "[", "\"\<e^0\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"Ts", "[", "\"\<Dx0\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"Ts", "[", "\"\<Py0\>\"", "]"}]}], "+", 
       RowBox[{
        RowBox[{"Ts", "[", "\"\<e^1\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"Ts", "[", "\"\<Px0\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"Ts", "[", "\"\<Dy0\>\"", "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[CapitalDelta]0\[CapitalPi]\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{"Ts", "[", "\"\<\[CapitalDelta]0\>\"", "]"}], "//", 
       RowBox[{
        RowBox[{"contractOnes", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]x2\>\"", "]"}], ",", 
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]y2\>\"", "]"}]}], "}"}], ",", 
          
          RowBox[{"{", 
           RowBox[{"5", ",", "6"}], "}"}]}], "]"}], "&"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[Del]0\[CenterDot]\[CapitalPi]\>\"", "]"}], 
      "=", 
      RowBox[{
       RowBox[{"Ts", "[", "\"\<\[Del]0\[CenterDot]\>\"", "]"}], "//", 
       RowBox[{
        RowBox[{"contractOnes", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]x1\>\"", "]"}], ",", 
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]y1\>\"", "]"}]}], "}"}], ",", 
          
          RowBox[{"{", 
           RowBox[{"4", ",", "5"}], "}"}]}], "]"}], "&"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<\[CapitalPi]\[Del]0\[CapitalPi]\>\"", "]"}], 
      "=", 
      RowBox[{
       RowBox[{"Ts", "[", "\"\<\[Del]0\>\"", "]"}], "//", 
       RowBox[{
        RowBox[{"contractOnes", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"flip", "[", 
             RowBox[{"Ts", "[", "\"\<\[CapitalPi]x0\>\"", "]"}], "]"}], ",", 
            RowBox[{"flip", "[", 
             RowBox[{"Ts", "[", "\"\<\[CapitalPi]y0\>\"", "]"}], "]"}], ",", 
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]x2\>\"", "]"}], ",", 
            RowBox[{"Ts", "[", "\"\<\[CapitalPi]y2\>\"", "]"}]}], "}"}], ",", 
          
          RowBox[{"{", 
           RowBox[{"1", ",", "2", ",", "4", ",", "5"}], "}"}]}], "]"}], 
        "&"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Blr\>\"", "]"}], "=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<Bx-\>\"", "]"}], "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"n", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], 
        "\[IndentingNewLine]", "+", 
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<Bx+\>\"", "]"}], "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"n", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ")"}]}], ";", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Bbt\>\"", "]"}], "=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<\[CapitalPi]x0\>\"", "]"}], 
         "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<By-\>\"", "]"}]}], "\[IndentingNewLine]", 
        "+", 
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"2", ",", "\"\<xy\>\""}], "]"}], "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<\[CapitalPi]x0\>\"", "]"}], 
         "\[TensorProduct]", 
         RowBox[{"Ts", "[", "\"\<By+\>\"", "]"}]}]}], ")"}]}], ";", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<Bp\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{"vec", "[", 
        RowBox[{"1", ",", "0", ",", "\"\<bp\>\""}], "]"}], "\[TensorProduct]", 
       RowBox[{"covec", "[", 
        RowBox[{
         RowBox[{"n", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
       RowBox[{"covec", "[", 
        RowBox[{
         RowBox[{"n", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ";", 
     RowBox[{
      RowBox[{"Ts", "[", "\"\<lift\[Tau]\>\"", "]"}], "=", 
      RowBox[{
       RowBox[{"vec", "[", 
        RowBox[{
         RowBox[{"n", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
       RowBox[{"vec", "[", 
        RowBox[{
         RowBox[{"n", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
       RowBox[{"covec", "[", 
        RowBox[{"1", ",", "0", ",", "\"\<\[Tau]\>\""}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "Ts"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",\

 CellChangeTimes->{{3.910802703147379*^9, 3.910802723561659*^9}, {
   3.910802780966758*^9, 3.910802796430207*^9}, {3.9108028406554117`*^9, 
   3.910802863310992*^9}, {3.910802904942206*^9, 3.910802905922435*^9}, {
   3.9108032759583683`*^9, 3.910803353627573*^9}, {3.910803496308223*^9, 
   3.910803496626562*^9}, {3.910809734648913*^9, 3.910809735266689*^9}, {
   3.9108098485730877`*^9, 3.910809879002294*^9}, {3.910809927480358*^9, 
   3.910809954886428*^9}, {3.910809995526165*^9, 3.910810079031374*^9}, {
   3.910810135002174*^9, 3.910810325327164*^9}, {3.91081040440934*^9, 
   3.910810405336749*^9}, {3.9108104498459187`*^9, 3.910810469949995*^9}, {
   3.910810873908719*^9, 3.910811007350339*^9}, {3.910811261746241*^9, 
   3.910811323909816*^9}, {3.910811374940785*^9, 3.910811423319535*^9}, {
   3.910811453720874*^9, 3.9108114565612*^9}, 3.910811516326517*^9, {
   3.910811601572779*^9, 3.910811660080151*^9}, {3.910811695741381*^9, 
   3.910811700898529*^9}, {3.910828139841749*^9, 3.91082814355953*^9}, {
   3.910828174176982*^9, 3.910828228956325*^9}, {3.910828715622888*^9, 
   3.9108289537913322`*^9}, {3.910828999840973*^9, 3.910829187599057*^9}, 
   3.910829224417582*^9, {3.910829269089617*^9, 3.910829404668748*^9}, {
   3.910829436764761*^9, 3.9108295285783043`*^9}, {3.910829808093273*^9, 
   3.9108299900670547`*^9}, {3.910830062480605*^9, 3.910830133590056*^9}, {
   3.910831866048112*^9, 3.910831899921116*^9}, {3.910862473112751*^9, 
   3.910862573102338*^9}, {3.911762505024762*^9, 3.9117625578734913`*^9}, {
   3.9117626458445168`*^9, 3.911762651337214*^9}, 3.911762705048472*^9, {
   3.9117635820347433`*^9, 3.911763599563471*^9}, {3.914024142265732*^9, 
   3.914024159459855*^9}, {3.9506760228832417`*^9, 3.950676034836928*^9}},
 CellLabel->
  "In[315]:=",ExpressionUUID->"f3b75551-94c4-4ab8-8f22-8e944f1a2a6d"],

Cell["\<\
This is where I need to start. Make efficient operators. Especially for a \
given geometry!\
\>", "Text",
 CellChangeTimes->{{3.910833901758037*^9, 
  3.910833919130707*^9}},ExpressionUUID->"ca976bbc-9105-4a67-b3d9-\
0418d4173329"],

Cell[BoxData[
 RowBox[{
  RowBox[{"createStokesDimensions", "[", "n_", "]"}], ":=", 
  RowBox[{"<|", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\"\<vars\>\"", "->", 
     RowBox[{"<|", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"u", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"p", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"\[Tau]", "->", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"\"\<\[Tau]\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
         "}"}]}]}], "|>"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"\"\<eqs\>\"", "->", 
     RowBox[{"<|", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "2"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "2"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"d", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "1"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "1"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"bx", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<lr\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"by", "->", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<bt\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
            RowBox[{"n", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{"bp", "->", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"\"\<bp\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
         "}"}]}]}], "|>"}]}]}], "\[IndentingNewLine]", "|>"}]}]], "Input",
 CellChangeTimes->{{3.910812083351049*^9, 3.910812134305004*^9}, {
  3.9108141564902287`*^9, 3.910814164916049*^9}, {3.911762645877092*^9, 
  3.911762651348422*^9}, {3.911763605631116*^9, 3.911763657002326*^9}, {
  3.9140164503244333`*^9, 3.914016457829154*^9}},
 CellLabel->
  "In[316]:=",ExpressionUUID->"7ab4f07a-627b-44cc-9149-60a58ceda83c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"createStokes", "[", 
   RowBox[{"n_", ",", "Ts_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "vars", ",", "eqs", ",", "dimensions", ",", "linearOps", ",", 
      "stateTensors", ",", "ruleZero", ",", "linearTens", ",", "linearArrs", 
      ",", "splinearArrs", ",", "spsystem", ",", "LUsystem"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"vars", "=", 
      RowBox[{"{", 
       RowBox[{"u", ",", "p", ",", "\[Tau]"}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"eqs", "=", 
      RowBox[{"{", 
       RowBox[{"f", ",", "d", ",", "bx", ",", "by", ",", "bp"}], "}"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"dimensions", "=", 
      RowBox[{"createStokesDimensions", "[", "n", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"linearOps", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"lap", ",", "grad", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"div", ",", "0", ",", "lift"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "bc", ",", "0"}], "}"}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"linearOps", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"op", "[", 
           RowBox[{"eq", ",", "var"}], "]"}], "/.", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"eq", "->", 
             RowBox[{"k1", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"var", "->", 
             RowBox[{"k2", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"op", "->", 
             RowBox[{"linearOps", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"k1", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], ",", 
                RowBox[{"k2", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}]}]}], "}"}]}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"k1", ",", 
           RowBox[{"enumerate", "[", "eqs", "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"k2", ",", 
           RowBox[{"enumerate", "[", "vars", "]"}]}], "}"}]}], "]"}], "/.", 
       " ", 
       RowBox[{"0", "->", "zero"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"stateTensors", "=", 
      RowBox[{"AssociationMap", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "var", "}"}], ",", 
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{
             RowBox[{"{", "dims", "}"}], ",", 
             RowBox[{"tensor", "[", 
              RowBox[{
               RowBox[{"SparseArray", "[", 
                RowBox[{
                 RowBox[{"{", "}"}], ",", 
                 RowBox[{"dims", "[", 
                  RowBox[{"[", 
                   RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", 
               "dims", ",", "0"}], "]"}]}], "]"}], "[", 
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "var", 
            "]"}], "]"}]}], "]"}], ",", "vars"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"linearTens", "=", 
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"lap", "[", 
          RowBox[{"f", ",", "u"}], "]"}], "->", 
         RowBox[{"Ts", "[", "\"\<\[CapitalDelta]0\[CapitalPi]\>\"", "]"}]}], 
        ",", 
        RowBox[{
         RowBox[{"grad", "[", 
          RowBox[{"f", ",", "p"}], "]"}], "->", 
         RowBox[{
         "Ts", "[", "\"\<\[CapitalPi]\[Del]0\[CapitalPi]\>\"", "]"}]}], ",", 
        RowBox[{
         RowBox[{"div", "[", 
          RowBox[{"d", ",", "u"}], "]"}], "->", 
         RowBox[{
         "Ts", "[", "\"\<\[Del]0\[CenterDot]\[CapitalPi]\>\"", "]"}]}], ",", 
        RowBox[{
         RowBox[{"lift", "[", 
          RowBox[{"d", ",", "\[Tau]"}], "]"}], "->", 
         RowBox[{"Ts", "[", "\"\<lift\[Tau]\>\"", "]"}]}], ",", 
        RowBox[{
         RowBox[{"bc", "[", 
          RowBox[{"bx", ",", "u"}], "]"}], "->", 
         RowBox[{"Ts", "[", "\"\<Blr\>\"", "]"}]}], ",", 
        RowBox[{
         RowBox[{"bc", "[", 
          RowBox[{"by", ",", "u"}], "]"}], "->", 
         RowBox[{"Ts", "[", "\"\<Bbt\>\"", "]"}]}], ",", 
        RowBox[{
         RowBox[{"bc", "[", 
          RowBox[{"bp", ",", "p"}], "]"}], "->", 
         RowBox[{"Ts", "[", "\"\<Bp\>\"", "]"}]}]}], "}"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ruleZero", "=", 
      RowBox[{
       RowBox[{"zero", "[", 
        RowBox[{"f_", ",", "g_"}], "]"}], "\[RuleDelayed]", 
       RowBox[{"tensor", "[", 
        RowBox[{
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{"{", "}"}], ",", 
           RowBox[{"Join", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", 
               "]"}], "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{"1", ";;", "All"}], ",", "2"}], 
              "\[RightDoubleBracket]"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", 
               "]"}], "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{"1", ";;", "All"}], ",", "2"}], 
              "\[RightDoubleBracket]"}]}], "]"}]}], "]"}], ",", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}],
            ",", 
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", 
            "]"}]}], "]"}], ",", 
         RowBox[{"Length", "[", 
          RowBox[{
           RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}], 
          "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"linearArrs", "=", 
      RowBox[{
       RowBox[{"linearOps", "/.", "ruleZero"}], "/.", "linearTens"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"splinearArrs", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"sparse", "[", "m", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"row", ",", "linearArrs"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"m", ",", "row"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"spsystem", "=", 
      RowBox[{"transformTensorsToMatrixSystem", "[", "splinearArrs", "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"<|", 
      RowBox[{
       RowBox[{"\"\<dims\>\"", "->", "dimensions"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<spsystem\>\"", "->", 
        RowBox[{"N", "[", "spsystem", "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<LU\>\"", "->", 
        RowBox[{"LinearSolve", "[", 
         RowBox[{"N", "[", "spsystem", "]"}], "]"}]}]}], "|>"}]}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.910811867034082*^9, 3.910811944459922*^9}, {
   3.910812004942296*^9, 3.9108120537271347`*^9}, 3.910812091936397*^9, {
   3.910812146045884*^9, 3.910812286796968*^9}, {3.910812320165601*^9, 
   3.910812351542857*^9}, {3.9108123865605183`*^9, 3.910812484404993*^9}, {
   3.910812520625305*^9, 3.910812522232435*^9}, {3.910812875049184*^9, 
   3.910812887888999*^9}, {3.910814341444967*^9, 3.9108143609668903`*^9}, {
   3.9108145270167313`*^9, 3.9108145346034193`*^9}, {3.910831822636894*^9, 
   3.910831827458148*^9}, {3.9108319098726883`*^9, 3.910831921678405*^9}, {
   3.910833269468279*^9, 3.910833275653058*^9}, {3.913999987527466*^9, 
   3.913999997358842*^9}, {3.914016483447612*^9, 3.9140164903700867`*^9}, {
   3.914016580554221*^9, 3.914016776245311*^9}, {3.914016819305636*^9, 
   3.914016942589837*^9}, {3.914017329036715*^9, 3.914017347452576*^9}},
 CellLabel->
  "In[317]:=",ExpressionUUID->"0ffac668-5693-4323-aec8-2c98f829f9df"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"NN", "=", "32"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"grid", "=", 
   RowBox[{"createGrid", "[", "NN", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Ts", "=", 
   RowBox[{"createTens", "[", "NN", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"stokes", "=", 
   RowBox[{"createStokes", "[", 
    RowBox[{"NN", ",", "Ts"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.910804974209564*^9, 3.910804975383049*^9}, 
   3.910810419889017*^9, {3.91221809734556*^9, 3.912218097394462*^9}, {
   3.914016586756791*^9, 3.9140165980051947`*^9}, 3.914016708705048*^9, 
   3.914016749980811*^9, 3.914016959604146*^9},
 CellLabel->
  "In[318]:=",ExpressionUUID->"f9ab13f1-5710-4ae9-b35f-764a74902ca7"],

Cell[CellGroupData[{

Cell["Test convergence of solution", "Subsection",
 CellChangeTimes->{{3.907438062299514*^9, 
  3.907438068577997*^9}},ExpressionUUID->"4389fc0e-a7ed-4ea7-a4fa-\
9fa35938abd9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformSymbolicToNumerical", "[", 
   RowBox[{"t_tensor", ",", "rules_"}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"tensor", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"getArr", "[", "t", "]"}], "/.", 
     RowBox[{"(", 
      RowBox[{"rules", "/.", 
       RowBox[{
        RowBox[{"tensor", "[", 
         RowBox[{"a_", ",", "d_", ",", "s_"}], "]"}], "->", "a"}]}], ")"}]}], 
    ",", 
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"getDims", "[", "t", "]"}], ",", 
      RowBox[{"getDims", "[", 
       RowBox[{"rules", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}], "]"}], ",", 
    RowBox[{"getSlots", "[", "t", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.914017579188623*^9, 3.914017658369274*^9}, {
  3.91401769700209*^9, 3.914017772247445*^9}},
 CellLabel->
  "In[322]:=",ExpressionUUID->"328d846a-86ec-4497-87b4-d314431aef2e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"sols", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "u", "]"}], "=", 
   RowBox[{
    RowBox[{"Curl", "[", 
     RowBox[{
      RowBox[{
       SuperscriptBox["x", "2"], 
       SuperscriptBox["y", "2"]}], ",", 
      RowBox[{"{", 
       RowBox[{"x", ",", "y"}], "}"}]}], "]"}], "//", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], 
       ",", "0"}], "]"}], "&"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "p", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      SuperscriptBox["x", "2"], 
      SuperscriptBox["y", "2"]}], "-", 
     FractionBox["1", "4"]}], "//", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", "}"}], ",", "0"}], "]"}], "&"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "lapu", "]"}], "=", 
   RowBox[{
    RowBox[{"sols", "[", "u", "]"}], "/.", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{"a_", ",", "d_", ",", "s_"}], "]"}], ":>", 
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{"Laplacian", "[", 
        RowBox[{"a", ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "y"}], "}"}]}], "]"}], ",", "d", ",", "s"}], 
      "]"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "gradp", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"calcGradS", "[", 
       RowBox[{
        RowBox[{"sols", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", 
        "\"\<xy+\>\""}], "]"}], "/.", 
      RowBox[{
       RowBox[{
        RowBox[{"jac", "[", "x__", "]"}], "[", 
        RowBox[{"i_", ",", "j_"}], "]"}], "->", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"KroneckerDelta", "[", 
          RowBox[{"i", ",", "j"}], "]"}], "&"}], ")"}]}]}], "//", 
     RowBox[{
      RowBox[{"adjoint", "[", "#", "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"flip", "[", "#", "]"}], "&"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "f", "]"}], "=", 
   RowBox[{
    RowBox[{"sols", "[", "lapu", "]"}], "+", 
    RowBox[{"sols", "[", "gradp", "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "d", "]"}], "=", "0"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "bx", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"x", "->", 
        RowBox[{"-", "1"}]}]}], ")"}]}], "+", 
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"x", "->", "1"}]}], ")"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "by", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"y", "->", 
        RowBox[{"-", "1"}]}]}], ")"}]}], "+", 
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"y", "->", "1"}]}], ")"}]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}},
 CellLabel->
  "In[323]:=",ExpressionUUID->"e2beb6b8-54c0-495f-8a4b-5fb582815ce3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"solArrs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "ug", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "u", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017538288596*^9}, {3.9140177833494053`*^9, 3.914017804219014*^9}},
 CellLabel->
  "In[332]:=",ExpressionUUID->"cee502b0-ec5a-4422-bcbd-ce92ddaef079"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "uc", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "ug", "]"}], "//", 
     RowBox[{
      RowBox[{"contractOne", "[", 
       RowBox[{"#", ",", 
        RowBox[{"Ts", "[", "\"\<Fxg\>\"", "]"}], ",", "2"}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{"Ts", "[", "\"\<Fyg\>\"", "]"}], ",", "3"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.9140175507628202`*^9}},
 CellLabel->
  "In[334]:=",ExpressionUUID->"4b41a855-4b74-426b-ab5e-77a64bbca246"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "pg", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "p", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017574353551*^9}, {3.914017833762197*^9, 3.914017836179799*^9}},
 CellLabel->
  "In[335]:=",ExpressionUUID->"35fc8085-d754-4c1b-b0c7-4c6d621a9bf2"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "pc", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "pg", "]"}], "//", 
     RowBox[{
      RowBox[{"contractOne", "[", 
       RowBox[{"#", ",", 
        RowBox[{
         RowBox[{"Ts", "[", "\"\<Fxg\>\"", "]"}], ".", 
         RowBox[{"Ts", "[", "\"\<\[CapitalPi]x0\>\"", "]"}]}], ",", "1"}], 
       "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{
        RowBox[{"Ts", "[", "\"\<Fyg\>\"", "]"}], ".", 
        RowBox[{"Ts", "[", "\"\<\[CapitalPi]y0\>\"", "]"}]}], ",", "2"}], 
      "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017553708893*^9}, 3.914017846238037*^9},
 CellLabel->
  "In[336]:=",ExpressionUUID->"33552eb3-51c0-4b7e-be89-6aca5be8033c"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "\[Tau]", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"stokes", "[", "\"\<dims\>\"", "]"}], "[", "\"\<vars\>\"", 
      "]"}], "[", "\[Tau]", "]"}], "//", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "#", ",", 
       "0"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017553708893*^9}, {3.914017846238037*^9, 3.914017853664221*^9}, {
   3.9140178858192463`*^9, 3.9140178947946157`*^9}},
 CellLabel->
  "In[337]:=",ExpressionUUID->"f24b6231-559d-4e29-b1df-04d6b7575aed"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "fg", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "f", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017925033864*^9}},
 CellLabel->
  "In[338]:=",ExpressionUUID->"8f88e0c3-851d-4898-8b66-5ceada94a60c"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "fc", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "fg", "]"}], "//", 
     RowBox[{
      RowBox[{"contractOne", "[", 
       RowBox[{"#", ",", 
        RowBox[{
         RowBox[{"Ts", "[", "\"\<Fxg\>\"", "]"}], ".", 
         RowBox[{"Ts", "[", "\"\<Px0\>\"", "]"}], ".", 
         RowBox[{"Ts", "[", "\"\<Px1\>\"", "]"}], ".", 
         RowBox[{"Ts", "[", "\"\<\[CapitalPi]x2\>\"", "]"}]}], ",", "2"}], 
       "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{
        RowBox[{"Ts", "[", "\"\<Fyg\>\"", "]"}], ".", 
        RowBox[{"Ts", "[", "\"\<Py0\>\"", "]"}], ".", 
        RowBox[{"Ts", "[", "\"\<Py1\>\"", "]"}], ".", 
        RowBox[{"Ts", "[", "\"\<\[CapitalPi]y2\>\"", "]"}]}], ",", "3"}], 
      "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017930558676*^9}, 3.9140241094218397`*^9, 
   3.91402419997544*^9},
 CellLabel->
  "In[339]:=",ExpressionUUID->"cb13b10c-d4bf-4fec-b142-670449f3b793"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "dc", "]"}], "=", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{"d", ",", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "d", ",", 
        "0"}], "]"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{
      RowBox[{"stokes", "[", "\"\<dims\>\"", "]"}], "[", "\"\<eqs\>\"", "]"}],
      "[", "d", "]"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017966503405*^9}},
 CellLabel->
  "In[340]:=",ExpressionUUID->"858959ac-9432-45c7-acfa-fe4e98ef3a46"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bxg", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "bx", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", "->", 
       RowBox[{"grid", "[", "\"\<yt\>\"", "]"}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, {3.9140179734889708`*^9, 
   3.914017996991905*^9}},
 CellLabel->
  "In[341]:=",ExpressionUUID->"7bf1e688-ff77-4091-b190-fcad244190d7"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bxc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "bxg", "]"}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{"Ts", "[", "\"\<Fyg\>\"", "]"}], ",", "3"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, 3.9140180022590733`*^9},
 CellLabel->
  "In[342]:=",ExpressionUUID->"92d489af-3654-4026-8701-d391a80a385d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "byg", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "by", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", "->", 
       RowBox[{"grid", "[", "\"\<xt\>\"", "]"}]}], "}"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "byc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "byg", "]"}], "//", 
    RowBox[{
     RowBox[{"contractOne", "[", 
      RowBox[{"#", ",", 
       RowBox[{
        RowBox[{"Ts", "[", "\"\<Fxg\>\"", "]"}], ".", 
        RowBox[{"Ts", "[", "\"\<\[CapitalPi]x0\>\"", "]"}]}], ",", "3"}], 
      "]"}], "&"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, {3.9140180022590733`*^9, 
   3.914018022179827*^9}},
 CellLabel->
  "In[343]:=",ExpressionUUID->"2a7e8b35-2cbd-40af-be37-ae6ace34cb17"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bpc", "]"}], "=", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{"d", ",", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"d", "[", 
           RowBox[{"[", 
            RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "d", ",", 
        "0"}], "]"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{
      RowBox[{"stokes", "[", "\"\<dims\>\"", "]"}], "[", "\"\<eqs\>\"", "]"}],
      "[", "bp", "]"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, {3.9140180022590733`*^9, 
   3.914018030384942*^9}},
 CellLabel->
  "In[345]:=",ExpressionUUID->"8271e754-bccb-44a6-b101-239beddc410f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhs", "=", 
   RowBox[{"transformTensorsToVector", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"solArrs", "[", "fc", "]"}], ",", 
      RowBox[{"solArrs", "[", "dc", "]"}], ",", 
      RowBox[{"solArrs", "[", "bxc", "]"}], ",", 
      RowBox[{"solArrs", "[", "byc", "]"}], ",", 
      RowBox[{"solArrs", "[", "bpc", "]"}]}], "}"}], "]"}]}], ";"}]], "Input",\

 CellChangeTimes->{{3.907184409557091*^9, 3.907184589530293*^9}, {
  3.907185066381054*^9, 3.907185079575674*^9}, {3.9074388444234962`*^9, 
  3.907438886997363*^9}, {3.907439108660837*^9, 3.907439111930518*^9}, {
  3.907439167333377*^9, 3.9074391792689*^9}, {3.908573650765775*^9, 
  3.908573659943903*^9}, {3.908573695437396*^9, 3.908573701713323*^9}, {
  3.910813677900455*^9, 3.910813678491828*^9}, {3.914018034965099*^9, 
  3.9140180512065277`*^9}, {3.914024039382469*^9, 3.914024076871774*^9}, {
  3.914024213635038*^9, 3.9140242151955013`*^9}},
 CellLabel->
  "In[346]:=",ExpressionUUID->"fd33bcf3-9fe1-4517-bb50-cdd447468012"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhsTens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"rhs", ",", 
     RowBox[{
      RowBox[{"stokes", "[", "\"\<dims\>\"", "]"}], "[", "\"\<eqs\>\"", 
      "]"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907439331897048*^9, 3.907439338184476*^9}, 
   3.910814411840589*^9, {3.914018071307755*^9, 3.914018077175647*^9}},
 CellLabel->
  "In[347]:=",ExpressionUUID->"c74504a7-1a8c-4fbc-9675-4ead55d1b0ca"],

Cell[BoxData[
 RowBox[{
  RowBox[{"sol", "=", 
   RowBox[{
    RowBox[{"stokes", "[", "\"\<LU\>\"", "]"}], "[", "rhs", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907184591792636*^9, 3.907184610061055*^9}, {
  3.907185768003332*^9, 3.907185768218328*^9}, {3.9071861456096992`*^9, 
  3.907186147460622*^9}, {3.907439322163537*^9, 3.907439322409265*^9}, {
  3.908573840995533*^9, 3.908573848246015*^9}, {3.910831801279393*^9, 
  3.9108318038435307`*^9}, {3.910833335297669*^9, 3.910833338958765*^9}},
 CellLabel->
  "In[348]:=",ExpressionUUID->"ba85e1c2-d782-4bb5-939d-2962634c1b0a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Timing", "[", 
   RowBox[{
    RowBox[{"stokes", "[", "\"\<LU\>\"", "]"}], "[", "rhs", "]"}], "]"}], "[", 
  RowBox[{"[", "1", "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.910833419093704*^9, 3.910833425629266*^9}},
 CellLabel->
  "In[349]:=",ExpressionUUID->"8ee2b92c-370d-4a95-bd44-53c308f2707d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"solTens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"sol", ",", 
     RowBox[{
      RowBox[{"stokes", "[", "\"\<dims\>\"", "]"}], "[", "\"\<vars\>\"", 
      "]"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907439286675009*^9, 3.907439319992487*^9}, {
  3.907499245260896*^9, 3.907499245594618*^9}, {3.910831983681581*^9, 
  3.910831987857511*^9}, {3.914018197398287*^9, 3.914018206001658*^9}},
 CellLabel->
  "In[350]:=",ExpressionUUID->"f3159612-1ec8-42ee-865e-cffb89a78060"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"solTens", "[", "p", "]"}], "-", 
      RowBox[{"solArrs", "[", "pc", "]"}]}], ")"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}], "//", "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.908573866068597*^9, 3.9085739037151003`*^9}, {
  3.910832015942008*^9, 3.9108320161997337`*^9}},
 CellLabel->
  "In[351]:=",ExpressionUUID->"38fcb831-a92a-4733-9b74-4207c3f2b1b1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"solTens", "[", "u", "]"}], "-", 
      RowBox[{"solArrs", "[", "uc", "]"}]}], ")"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}], "//", "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.908573912199007*^9, 3.908573927593771*^9}},
 CellLabel->
  "In[352]:=",ExpressionUUID->"e1c5b0ec-f4d2-4607-aac4-c7c59448698e"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remapped problem", "Chapter",
 CellChangeTimes->{{3.911340689716069*^9, 3.9113407011533203`*^9}, {
  3.913894923436164*^9, 
  3.913894924211286*^9}},ExpressionUUID->"337b0d1c-620d-4da8-b84e-\
029ee7d7b98b"],

Cell[CellGroupData[{

Cell["Coordinate function", "Subsection",
 CellChangeTimes->{{3.91134883398589*^9, 3.911348835034282*^9}, {
  3.911349535264895*^9, 
  3.911349536284547*^9}},ExpressionUUID->"84194f74-761a-4503-9cde-\
91a458377f85"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "l", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"X", "[", "l", "]"}], "[", "y", "]"}], ",", 
       RowBox[{
        RowBox[{"Y", "[", "l", "]"}], "[", "y", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "r", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"X", "[", "r", "]"}], "[", "y", "]"}], ",", 
       RowBox[{
        RowBox[{"Y", "[", "r", "]"}], "[", "y", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "b", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"X", "[", "b", "]"}], "[", "x", "]"}], ",", 
       RowBox[{
        RowBox[{"Y", "[", "b", "]"}], "[", "x", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "t", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"X", "[", "t", "]"}], "[", "x", "]"}], ",", 
       RowBox[{
        RowBox[{"Y", "[", "t", "]"}], "[", "x", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", 
    RowBox[{"{", 
     RowBox[{"\[Delta]", ",", "l"}], "}"}], "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     FractionBox[
      RowBox[{"1", "-", "x"}], "2"], ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", 
    RowBox[{"{", 
     RowBox[{"\[Delta]", ",", "r"}], "}"}], "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     FractionBox[
      RowBox[{"1", "+", "x"}], "2"], ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", 
    RowBox[{"{", 
     RowBox[{"\[Delta]", ",", "b"}], "}"}], "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     FractionBox[
      RowBox[{"1", "-", "y"}], "2"], ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", 
    RowBox[{"{", 
     RowBox[{"\[Delta]", ",", "t"}], "}"}], "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     FractionBox[
      RowBox[{"1", "+", "y"}], "2"], ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.911341096277054*^9, 3.911341151329693*^9}, {
  3.911341316513874*^9, 3.911341340677898*^9}, {3.911763509129533*^9, 
  3.911763510484383*^9}, {3.913999987581624*^9, 3.913999987595029*^9}, {
  3.914018265476961*^9, 3.914018316800406*^9}},
 CellLabel->
  "In[353]:=",ExpressionUUID->"19ca239c-d464-4e0e-bae3-11f5f30c72a6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "X", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"X", "[", 
        RowBox[{"x", ",", "y"}], "]"}], ",", 
       RowBox[{"Y", "[", 
        RowBox[{"x", ",", "y"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], ",", 
     "0"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.911355567399893*^9, 3.9113555889442587`*^9}, 
   3.91176351151136*^9, 3.913999987598215*^9, {3.9140183200744*^9, 
   3.91401832249697*^9}},
 CellLabel->
  "In[361]:=",ExpressionUUID->"5cc25782-7143-44f9-97d0-d6421f30ee23"],

Cell["Check the curves match up", "Text",
 CellChangeTimes->{{3.914438095055781*^9, 3.914438099614545*^9}, {
  3.914438166028219*^9, 
  3.9144381673337307`*^9}},ExpressionUUID->"d81b7339-b226-4c0a-bb1a-\
35bd5b816ffd"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "X0", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{
           SubscriptBox["\[Delta]", "l"], "[", "x", "]"}], 
          RowBox[{
           SubscriptBox["\[Gamma]", "l"], "[", "y", "]"}]}], "+", 
         RowBox[{
          RowBox[{
           SubscriptBox["\[Delta]", "r"], "[", "x", "]"}], 
          RowBox[{
           SubscriptBox["\[Gamma]", "r"], "[", "y", "]"}]}], "+", 
         RowBox[{
          RowBox[{
           SubscriptBox["\[Gamma]", "b"], "[", "x", "]"}], 
          RowBox[{
           SubscriptBox["\[Delta]", "b"], "[", "y", "]"}]}], "+", 
         RowBox[{
          RowBox[{
           SubscriptBox["\[Gamma]", "t"], "[", "x", "]"}], 
          RowBox[{
           SubscriptBox["\[Delta]", "t"], "[", "y", "]"}]}], 
         RowBox[{"(*", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{
               SubscriptBox["\[Delta]", "l"], "[", "x", "]"}], 
              RowBox[{
               SubscriptBox["\[Delta]", "b"], "[", "y", "]"}], 
              RowBox[{
               SubscriptBox["\[Gamma]", "b"], "[", 
               RowBox[{"-", "1"}], "]"}]}], "+", 
             RowBox[{
              RowBox[{
               SubscriptBox["\[Delta]", "r"], "[", "x", "]"}], 
              RowBox[{
               SubscriptBox["\[Delta]", "b"], "[", "y", "]"}], 
              RowBox[{
               SubscriptBox["\[Gamma]", "b"], "[", "1", "]"}]}], "+", 
             RowBox[{
              RowBox[{
               SubscriptBox["\[Delta]", "l"], "[", "x", "]"}], 
              RowBox[{
               SubscriptBox["\[Delta]", "t"], "[", "y", "]"}], 
              RowBox[{
               SubscriptBox["\[Gamma]", "t"], "[", 
               RowBox[{"-", "1"}], "]"}]}], "+", 
             RowBox[{
              RowBox[{
               SubscriptBox["\[Delta]", "r"], "[", "x", "]"}], 
              RowBox[{
               SubscriptBox["\[Delta]", "t"], "[", "y", "]"}], 
              RowBox[{
               SubscriptBox["\[Gamma]", "t"], "[", "1", "]"}]}]}], ")"}]}], 
          "*)"}], "\[IndentingNewLine]", "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{
             SubscriptBox["\[Gamma]", "l"], "[", 
             RowBox[{"-", "1"}], "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "l"], "[", "x", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "b"], "[", "y", "]"}]}], "+", 
           RowBox[{
            RowBox[{
             SubscriptBox["\[Gamma]", "r"], "[", 
             RowBox[{"-", "1"}], "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "r"], "[", "x", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "b"], "[", "y", "]"}]}], "+", 
           RowBox[{
            RowBox[{
             SubscriptBox["\[Gamma]", "l"], "[", "1", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "l"], "[", "x", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "t"], "[", "y", "]"}]}], "+", 
           RowBox[{
            RowBox[{
             SubscriptBox["\[Gamma]", "r"], "[", "1", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "r"], "[", "x", "]"}], 
            RowBox[{
             SubscriptBox["\[Delta]", "t"], "[", "y", "]"}]}]}], ")"}]}], 
        ")"}], "//", "Evaluate"}], "//", "Hold"}], "//", 
     RowBox[{
      RowBox[{"#", "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{
           SubscriptBox["\[Delta]", "f_"], "[", "x_", "]"}], ":>", 
          RowBox[{"STs", "[", 
           RowBox[{"{", 
            RowBox[{"\[Delta]", ",", "f"}], "}"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{
           SubscriptBox["\[Gamma]", "f_"], "[", "xy_", "]"}], ":>", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"STs", "[", "f", "]"}], "/.", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"x", "->", "xy"}], ",", 
              RowBox[{"y", "->", "xy"}]}], "}"}]}], ")"}]}]}], "}"}]}], 
      "&"}]}], "//", "ReleaseHold"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.911341192231634*^9, 3.911341199582388*^9}, {
   3.9113412348856363`*^9, 3.911341236318001*^9}, {3.911341326507049*^9, 
   3.911341453974889*^9}, 3.911355565493384*^9, 3.914421459770493*^9, 
   3.914421734795316*^9, {3.914438553608364*^9, 3.914438554468975*^9}, {
   3.914438822084529*^9, 3.914438888557631*^9}, {3.914438936313884*^9, 
   3.914439011579313*^9}, 3.91443904392518*^9, 3.914439076092875*^9, {
   3.91443910698602*^9, 3.914439114436425*^9}, {3.914439206382983*^9, 
   3.914439270627124*^9}, {3.914439324261819*^9, 3.914439521556657*^9}},
 CellLabel->
  "In[362]:=",ExpressionUUID->"2c4d4b0d-0b03-4289-a091-be64b4c045f7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"coordFuncs", "=", 
   RowBox[{"<|", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"X", "[", "l", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"y", ",", 
        FractionBox[
         RowBox[{"Sin", "[", 
          RowBox[{"\[Pi]", " ", "y"}], "]"}], "10"]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Y", "[", "l", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"y", ",", 
        FractionBox[
         RowBox[{"y", "+", "1"}], "2"]}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"X", "[", "r", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"y", ",", 
        RowBox[{
         FractionBox[
          RowBox[{"Cos", "[", 
           RowBox[{"\[Pi]", " ", 
            RowBox[{"y", "/", "2"}]}], "]"}], "10"], "+", "1"}]}], "]"}]}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Y", "[", "r", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"y", ",", 
        FractionBox[
         RowBox[{"y", "+", "1"}], "2"]}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"X", "[", "b", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"x", ",", 
        FractionBox[
         RowBox[{"x", "+", "1"}], "2"]}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Y", "[", "b", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"x", ",", 
        FractionBox[
         RowBox[{"Cos", "[", 
          RowBox[{"\[Pi]", " ", 
           RowBox[{"x", "/", "2"}]}], "]"}], "10"]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"X", "[", "t", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"x", ",", 
        FractionBox[
         RowBox[{"x", "+", "1"}], "2"]}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Y", "[", "t", "]"}], "->", 
      RowBox[{"Function", "[", 
       RowBox[{"x", ",", 
        RowBox[{
         FractionBox[
          RowBox[{"Sin", "[", 
           RowBox[{"\[Pi]", " ", "x"}], "]"}], "20"], "+", "1"}]}], "]"}]}]}],
     "\[IndentingNewLine]", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.911341185670735*^9, 3.911341186739263*^9}, {
  3.911348907791843*^9, 3.911349074244837*^9}, {3.911349136970138*^9, 
  3.911349137998954*^9}, {3.91134945097648*^9, 3.911349454186874*^9}, {
  3.914422503700613*^9, 3.914422507565292*^9}},
 CellLabel->
  "In[363]:=",ExpressionUUID->"5a26b4a1-f5e7-4e5f-8420-0960d3fe3da7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "l", "]"}], "-", 
       RowBox[{"STs", "[", "t", "]"}]}], "/.", "coordFuncs"}], "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"-", "1"}]}], ",", 
       RowBox[{"y", "->", "1"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "r", "]"}], "-", 
       RowBox[{"STs", "[", "t", "]"}]}], "/.", "coordFuncs"}], "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", "1"}], ",", 
       RowBox[{"y", "->", "1"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "l", "]"}], "-", 
       RowBox[{"STs", "[", "b", "]"}]}], "/.", "coordFuncs"}], "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"-", "1"}]}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"-", "1"}]}]}], "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"STs", "[", "r", "]"}], "-", 
       RowBox[{"STs", "[", "b", "]"}]}], "/.", "coordFuncs"}], "/.", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", "1"}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"-", "1"}]}]}], "}"}]}]}], "}"}], ";"}]], "Input",
 CellChangeTimes->{{3.914422134030841*^9, 3.914422185102065*^9}, {
   3.914422300347284*^9, 3.914422352031281*^9}, {3.914438078652518*^9, 
   3.914438093010504*^9}, {3.914438135735733*^9, 3.9144381380459337`*^9}, 
   3.914438786446665*^9},
 CellLabel->
  "In[364]:=",ExpressionUUID->"cc52e1c9-650d-48de-80b6-b6529db4343c"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"STs", "[", "Xf", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"STs", "[", "X0", "]"}], "/.", "coordFuncs"}], "//", 
    "Simplify"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.911349150001017*^9, 3.911349190642159*^9}, 
   3.911355601609994*^9, {3.91443810698577*^9, 3.914438107620153*^9}, {
   3.914438142412808*^9, 3.914438147190975*^9}, 3.914439628880846*^9},
 CellLabel->
  "In[365]:=",ExpressionUUID->"896bda85-c1c1-4c9e-a53e-a4928f09c807"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"X", "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "Xf", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "1"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Y", "->", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"xx", ",", "yy"}], "}"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"STs", "[", "Xf", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "2"}], "]"}], "]"}], "/.", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"x", "->", "xx"}], ",", 
           RowBox[{"y", "->", "yy"}]}], "}"}]}]}], "]"}]}]}], "}"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.911349170265296*^9, 3.911349173276271*^9}, {
  3.9113492934729977`*^9, 3.911349297204621*^9}, {3.911349334334614*^9, 
  3.911349374577778*^9}, {3.911349415767707*^9, 3.911349417623749*^9}},
 CellLabel->
  "In[366]:=",ExpressionUUID->"1ae409ef-b603-4434-ac3f-21bf72e25052"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"Show", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ParametricPlot", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"X", "[", "l", "]"}], "[", "y", "]"}], ",", 
           RowBox[{
            RowBox[{"Y", "[", "l", "]"}], "[", "y", "]"}]}], "}"}], "/.", 
         "coordFuncs"}], ",", 
        RowBox[{"{", 
         RowBox[{"y", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ParametricPlot", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"X", "[", "r", "]"}], "[", "y", "]"}], ",", 
           RowBox[{
            RowBox[{"Y", "[", "r", "]"}], "[", "y", "]"}]}], "}"}], "/.", 
         "coordFuncs"}], ",", 
        RowBox[{"{", 
         RowBox[{"y", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ParametricPlot", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"X", "[", "b", "]"}], "[", "x", "]"}], ",", 
           RowBox[{
            RowBox[{"Y", "[", "b", "]"}], "[", "x", "]"}]}], "}"}], "/.", 
         "coordFuncs"}], ",", 
        RowBox[{"{", 
         RowBox[{"x", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ParametricPlot", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"X", "[", "t", "]"}], "[", "x", "]"}], ",", 
           RowBox[{
            RowBox[{"Y", "[", "t", "]"}], "[", "x", "]"}]}], "}"}], "/.", 
         "coordFuncs"}], ",", 
        RowBox[{"{", 
         RowBox[{"x", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ParametricPlot", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"STs", "[", "Xf", "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"x", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"y", ",", 
          RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
        RowBox[{"MeshFunctions", "->", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"#3", "&"}], ",", " ", 
           RowBox[{"#4", "&"}]}], "}"}]}], ",", 
        RowBox[{"Mesh", "->", 
         RowBox[{"{", 
          RowBox[{"10", ",", "10"}], "}"}]}]}], "]"}]}], 
     "\[IndentingNewLine]", "}"}], ",", 
    RowBox[{"PlotRange", "->", "All"}]}], "]"}], "*)"}]], "Input",
 CellChangeTimes->{{3.914438190851269*^9, 3.914438273119313*^9}, {
  3.914439589221464*^9, 3.9144396065370083`*^9}, {3.91443965508508*^9, 
  3.914439688924082*^9}, {3.914439729144569*^9, 3.914439739002865*^9}, {
  3.914439777462909*^9, 3.914439786488946*^9}},
 CellLabel->
  "In[367]:=",ExpressionUUID->"77b7c203-cd04-4542-ae04-b49c3f68686f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Numerical discretisation of tensors", "Subsection",
 CellChangeTimes->{{3.911349541197923*^9, 3.911349546786489*^9}, {
  3.913999987617337*^9, 
  3.913999997376474*^9}},ExpressionUUID->"592feef4-ce9f-4a09-ac3b-\
0d469f9d5b30"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"NTs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"NTs", "[", 
      RowBox[{"ToExpression", "[", 
       RowBox[{"k", "<>", "\"\<g\>\""}], "]"}], "]"}], "=", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"STs", "[", 
         RowBox[{"ToExpression", "[", 
          RowBox[{"k", "<>", "\"\<f\>\""}], "]"}], "]"}], "/.", 
        RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "//", 
       RowBox[{
        RowBox[{"transformSymbolicToNumerical", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "->", 
             RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
            RowBox[{"y", "->", 
             RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], 
        "&"}]}], ")"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"k", ",", 
      RowBox[{"Characters", "[", "\"\<XJKGH\[CapitalGamma]\>\"", "]"}]}], 
     "}"}]}], "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.911349547460993*^9, 3.911349549674987*^9}, {
  3.911350622946972*^9, 3.9113507455228662`*^9}, {3.911351216246878*^9, 
  3.911351285353337*^9}, {3.911351315663991*^9, 3.911351345329302*^9}, {
  3.911351415249609*^9, 3.911351537122849*^9}, {3.911351601310087*^9, 
  3.911351601954398*^9}, {3.9140183717744837`*^9, 3.914018403904365*^9}, {
  3.914018442693636*^9, 3.914018442927936*^9}},
 CellLabel->
  "In[368]:=",ExpressionUUID->"475e662b-2f65-4730-bc0e-4bd6db495936"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"NTs", "[", "1", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"Array", "[", 
      RowBox[{
       RowBox[{"1", "&"}], ",", 
       RowBox[{"{", 
        RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", 
           RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], "}"}], 
       ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\"\<y\>\"", ",", 
           RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
        "}"}]}], "}"}], ",", "0"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.91435919152213*^9, 3.914359250885721*^9}},
 CellLabel->
  "In[370]:=",ExpressionUUID->"68b154ed-e6af-41d0-b8eb-a92e36bb7644"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"NTs", "[", "Ig", "]"}], "=", 
   RowBox[{
    RowBox[{"orthonormalMetric", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
    "\[TensorProduct]", 
    RowBox[{"NTs", "[", "1", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"NTs", "[", "IIg", "]"}], "=", 
   RowBox[{
    RowBox[{"orthonormalMetric", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], "]"}], 
    "\[TensorProduct]", 
    RowBox[{"NTs", "[", "1", "]"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914359451992188*^9, 3.914359458109*^9}, {
  3.914359499313147*^9, 3.91435955059265*^9}},
 CellLabel->
  "In[371]:=",ExpressionUUID->"c7e4bf2a-3ab1-41bd-ac6d-bd26dbbe7dff"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remapped Tensor Fields and Calculus", "Chapter",
 CellChangeTimes->{{3.913894848752054*^9, 3.91389485069785*^9}, {
  3.913896558344234*^9, 3.913896565984249*^9}, {3.914422689213171*^9, 
  3.914422726742052*^9}},ExpressionUUID->"5f69ef11-250e-413d-aa63-\
97e21ebdeae6"],

Cell[CellGroupData[{

Cell["Distinguishing coordinate and bundle dimensions", "Subsection",
 CellChangeTimes->{{3.914289773595117*^9, 
  3.914289786863538*^9}},ExpressionUUID->"a2b55815-2bd7-44c8-88ac-\
78e2046a8498"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"checkCoordDim", "[", "dim_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Head", "[", 
     RowBox[{"dim", "[", 
      RowBox[{"[", "1", "]"}], "]"}], "]"}], "===", "List"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"getDimCoord", "[", "dim_", "]"}], ":=", 
   RowBox[{"dim", "[", 
    RowBox[{"[", 
     RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getDimSpace", "[", "dim_", "]"}], ":=", 
   RowBox[{"dim", "[", 
    RowBox[{"[", 
     RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getDimSize", "[", "dim_", "]"}], ":=", 
   RowBox[{"dim", "[", 
    RowBox[{"[", "2", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"getDimBasis", "[", "dim_", "]"}], ":=", 
   RowBox[{"dim", "[", 
    RowBox[{"[", "3", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"changeDimSpace", "[", 
    RowBox[{"dim_", ",", "i_"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"getDimCoord", "[", "dim", "]"}], ",", "i"}], "}"}], ",", 
     RowBox[{"getDimSize", "[", "dim", "]"}], ",", 
     RowBox[{"getDimBasis", "[", "dim", "]"}]}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.91167127539978*^9, 3.911671290359324*^9}, {
   3.911697343159431*^9, 3.911697343903689*^9}, 3.91169739851611*^9, {
   3.911697443817323*^9, 3.911697567095653*^9}, {3.9116976031969757`*^9, 
   3.911697614386671*^9}, {3.911766155026018*^9, 3.9117661639693*^9}, {
   3.911766240737071*^9, 3.911766241254679*^9}, {3.911767120754932*^9, 
   3.911767122961497*^9}, 3.911770521925784*^9, {3.914282207980699*^9, 
   3.91428233863785*^9}},
 CellLabel->
  "In[373]:=",ExpressionUUID->"b35273d8-ab45-4610-a404-71989d7bd04b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"getCoordDims", "[", 
    RowBox[{"dims_", ",", 
     RowBox[{"crit_", ":", 
      RowBox[{"(", 
       RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"dims", "//", "enumerate"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"checkCoordDim", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "]"}], "&&", 
            RowBox[{"crit", "[", "#", "]"}]}], "&"}], ")"}], "[", "#", "]"}], 
        "&"}]}], "]"}], "\[Transpose]"}], "//", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"#", "===", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"{", "}"}]}], "}"}], ",", "#"}], "]"}], "&"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getCoordDims", "[", 
    RowBox[{"t_tensor", ",", 
     RowBox[{"crit_", ":", 
      RowBox[{"(", 
       RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
   RowBox[{"getCoordDims", "[", 
    RowBox[{
     RowBox[{"getDims", "[", "t", "]"}], ",", "crit"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getOutCoordDims", "[", 
    RowBox[{"t_tensor", ",", 
     RowBox[{"crit_", ":", 
      RowBox[{"(", 
       RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
   RowBox[{"getCoordDims", "[", 
    RowBox[{
     RowBox[{"getDims", "[", "t", "]"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"crit", "[", "#", "]"}], "&&", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ">", 
         RowBox[{"getSlots", "[", "t", "]"}]}], ")"}]}], "&"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.9116990452495937`*^9, 3.911699073714967*^9}, {
  3.91176637683361*^9, 3.91176638726206*^9}, {3.911766650247746*^9, 
  3.911766666743376*^9}, {3.911766770604714*^9, 3.9117667712780857`*^9}, {
  3.911766825269139*^9, 3.911766826963208*^9}, {3.9117672877318983`*^9, 
  3.911767289338017*^9}, {3.911767347321271*^9, 3.911767349383563*^9}, {
  3.91176757572058*^9, 3.911767615015781*^9}, {3.911768413774127*^9, 
  3.911768416151164*^9}, {3.911768570195897*^9, 3.911768638395699*^9}, {
  3.914026050731517*^9, 3.914026122789987*^9}, {3.914028619082841*^9, 
  3.914028644051729*^9}, {3.914031591950502*^9, 3.914031603311002*^9}, {
  3.9142860114963617`*^9, 3.914286033979871*^9}, {3.914287962431999*^9, 
  3.914288030758583*^9}},
 CellLabel->
  "In[379]:=",ExpressionUUID->"31e6dd55-7401-45ea-8cbb-b6805aa6abb7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"getBundleDims", "[", 
   RowBox[{"dims_List", ",", 
    RowBox[{"crit_", ":", 
     RowBox[{"(", 
      RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "numberedDims", ",", "bundleInds", 
      ",", "bundleDims"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getCoordDims", "[", "dims", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"numberedDims", "=", 
      RowBox[{"enumerate", "[", "dims", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Select", "[", 
         RowBox[{"numberedDims", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Not", "[", 
             RowBox[{"MemberQ", "[", 
              RowBox[{"coordInds", ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}], "&&", 
            RowBox[{"crit", "[", "#", "]"}]}], "&"}]}], "]"}], 
        "\[Transpose]"}], "//", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", "===", 
           RowBox[{"{", "}"}]}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", "}"}], ",", 
            RowBox[{"{", "}"}]}], "}"}], ",", "#"}], "]"}], "&"}]}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"getBundleDims", "[", 
   RowBox[{"t_tensor", ",", 
    RowBox[{"crit_", ":", 
     RowBox[{"(", 
      RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
  RowBox[{"getBundleDims", "[", 
   RowBox[{
    RowBox[{"getDims", "[", "t", "]"}], ",", "crit"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getOutBundleDims", "[", 
   RowBox[{"t_tensor", ",", 
    RowBox[{"crit_", ":", 
     RowBox[{"(", 
      RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
  RowBox[{"getBundleDims", "[", 
   RowBox[{
    RowBox[{"getDims", "[", "t", "]"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"crit", "[", "#", "]"}], "&&", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ">", 
        RowBox[{"getSlots", "[", "t", "]"}]}], ")"}]}], "&"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.911849971757616*^9, 3.91185000584807*^9}, {
   3.911850178841111*^9, 3.911850195666659*^9}, {3.9118502455038767`*^9, 
   3.911850371138667*^9}, {3.911850403254449*^9, 3.911850436479435*^9}, {
   3.911850469689846*^9, 3.911850498020876*^9}, {3.911851180018937*^9, 
   3.911851180938618*^9}, {3.911851279988598*^9, 3.9118513135037565`*^9}, {
   3.91402634404146*^9, 3.914026356810087*^9}, {3.914026411261319*^9, 
   3.914026423029533*^9}, {3.914026453101654*^9, 3.914026464743965*^9}, {
   3.914026495153954*^9, 3.914026500367673*^9}, {3.914026533327359*^9, 
   3.914026546723955*^9}, 3.9140290664915752`*^9, {3.914029595172869*^9, 
   3.914029597166394*^9}, {3.914030965123779*^9, 3.914031044090693*^9}, {
   3.914286678045229*^9, 3.914286689526701*^9}, {3.91428672665869*^9, 
   3.914286778483171*^9}, {3.91428811650814*^9, 3.914288122770055*^9}, {
   3.91428819393186*^9, 3.914288285511335*^9}, {3.914288330226371*^9, 
   3.914288330478315*^9}, {3.914288377102138*^9, 3.914288381872513*^9}, {
   3.91428841348273*^9, 3.914288419346273*^9}, {3.914288467348012*^9, 
   3.914288497794711*^9}},
 CellLabel->
  "In[382]:=",ExpressionUUID->"e2f85204-3a4f-4619-851d-a68fbab9ff65"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Convert tensor fields to linear operators (grid multiplication)\
\>", "Subsection",
 CellChangeTimes->{{3.91428979390852*^9, 
  3.914289809498321*^9}},ExpressionUUID->"665f4e14-a40d-421a-b381-\
8877e564c6c3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"checkGridSpace", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"And", "@@", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{"dim", ",", 
       RowBox[{
        RowBox[{"getDimSpace", "[", "dim", "]"}], "==", 
        RowBox[{"-", "1"}]}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"getCoordDims", "[", "t", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{"checkChebSpace", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"And", "@@", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{"dim", ",", 
       RowBox[{
        RowBox[{"getDimSpace", "[", "dim", "]"}], "==", "0"}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"getCoordDims", "[", "t", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"checkCoeffSpace", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"And", "@@", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{"dim", ",", 
       RowBox[{
        RowBox[{"getDimSpace", "[", "dim", "]"}], ">", 
        RowBox[{"-", "1"}]}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"getCoordDims", "[", "t", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}], "\n", 
 RowBox[{
  RowBox[{"checkOutGridSpace", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"And", "@@", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{"dim", ",", 
       RowBox[{
        RowBox[{"getDimSpace", "[", "dim", "]"}], "==", 
        RowBox[{"-", "1"}]}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"getOutCoordDims", "[", "t", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.914280891777611*^9, 3.91428089787829*^9}, {
  3.914280940710634*^9, 3.914280990530519*^9}, {3.914281021309984*^9, 
  3.914281042488961*^9}, {3.914281075168109*^9, 3.9142810759607477`*^9}, {
  3.914281138006002*^9, 3.914281173794772*^9}, {3.9145936057246304`*^9, 
  3.914593615708971*^9}},
 CellLabel->
  "In[385]:=",ExpressionUUID->"0be7a059-9269-498f-993e-ec52944f3c58"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"toDiag", "[", 
    RowBox[{"n_", ",", "d_"}], "]"}], ":=", 
   RowBox[{"tensor", "[", 
    RowBox[{
     RowBox[{"sp", "[", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"KroneckerDelta", "[", 
         RowBox[{"i", ",", "j", ",", "k"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "n"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "n"}], "}"}]}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<-\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"d", ",", "n", ",", "\"\<+\>\""}], "}"}]}], "}"}], ",", "1"}],
     "]"}]}], ";"}]], "Input",
 CellChangeTimes->{
  3.913899563521522*^9, 3.913999987784237*^9, {3.914032246531086*^9, 
   3.914032252012033*^9}},
 CellLabel->
  "In[389]:=",ExpressionUUID->"26749a4f-77ec-403d-865c-ed2f87d37ebc"],

Cell[BoxData[
 RowBox[{
  RowBox[{"convertGridTensorToMultOp", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "numCoords", ",", "numIn", ",", 
      "numDims", ",", "numOut", ",", "gridToOp"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getCoordDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numCoords", "=", 
      RowBox[{"Length", "[", "coordInds", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numIn", "=", 
      RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numDims", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numOut", "=", 
      RowBox[{"numDims", "-", "numIn", "-", "numCoords"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"checkGridSpace", "[", "t", "]"}], ",", "\[IndentingNewLine]", 
       
       RowBox[{
        RowBox[{"gridToOp", "=", 
         RowBox[{
          RowBox[{"TensorProduct", "@@", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Function", "[", 
               RowBox[{
                RowBox[{"{", "dim", "}"}], ",", 
                RowBox[{"toDiag", "[", 
                 RowBox[{
                  RowBox[{"getDimSize", "[", "dim", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"getDimCoord", "[", "dim", "]"}], ",", 
                    RowBox[{"getDimSpace", "[", "dim", "]"}]}], "}"}]}], 
                 "]"}]}], "]"}], "[", "dim", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"dim", ",", "coordDims"}], "}"}]}], "]"}]}], "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"calcMultiPermutation", "[", 
              RowBox[{
               RowBox[{"Table", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"numCoords", "+", 
                   RowBox[{"2", "i"}], "+", "1"}], "->", 
                  RowBox[{"numCoords", "+", "i", "+", "1"}]}], ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "0", ",", 
                   RowBox[{"numCoords", "-", "1"}]}], "}"}]}], "]"}], ",", 
               RowBox[{"3", "numCoords"}]}], "]"}]}], "]"}], "&"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"t", "//", "sparse"}], "//", 
            RowBox[{
             RowBox[{"iso", "[", 
              RowBox[{"#", ",", 
               RowBox[{"numDims", "-", "numCoords"}]}], "]"}], "&"}]}], "//", 
           
           RowBox[{
            RowBox[{"#", ".", "gridToOp"}], "&"}]}], "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"Join", "[", 
              RowBox[{
               RowBox[{"Range", "[", "numIn", "]"}], ",", 
               RowBox[{
                RowBox[{"Range", "[", "numOut", "]"}], "+", "numIn", "+", 
                "numCoords"}], ",", 
               RowBox[{
                RowBox[{"Range", "[", "numCoords", "]"}], "+", "numIn"}], ",", 
               RowBox[{
                RowBox[{"Range", "[", "numCoords", "]"}], "+", "numIn", "+", 
                "numOut", "+", "numCoords"}]}], "]"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"iso", "[", 
           RowBox[{"#", ",", 
            RowBox[{"numIn", "+", "numCoords"}]}], "]"}], "&"}]}]}]}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.913900162905003*^9, 3.913900188464377*^9}, {
   3.913900228697756*^9, 3.913900300281261*^9}, {3.913900356742457*^9, 
   3.913900507289215*^9}, {3.913900622031753*^9, 3.91390063413098*^9}, {
   3.913900677062873*^9, 3.913900759137162*^9}, {3.913900806322837*^9, 
   3.913900811737645*^9}, {3.913900855869059*^9, 3.91390092157339*^9}, {
   3.913900956348965*^9, 3.91390113683016*^9}, 3.913999987788048*^9, {
   3.914032275686907*^9, 3.914032307035824*^9}, {3.914080880433695*^9, 
   3.914080888336093*^9}, {3.9140809820278273`*^9, 3.914080984804745*^9}, {
   3.9142808010915422`*^9, 3.9142808863269*^9}, {3.914281269183902*^9, 
   3.914281289443191*^9}, {3.914282181528934*^9, 3.91428218578044*^9}, {
   3.914282485084347*^9, 3.914282556649744*^9}, {3.914282588139303*^9, 
   3.914282600151146*^9}, {3.914283873439231*^9, 3.914283989568412*^9}, {
   3.914284061758092*^9, 3.914284076845355*^9}, {3.914284130917201*^9, 
   3.914284160443254*^9}, 3.91428421180969*^9, {3.91428425773608*^9, 
   3.914284259030672*^9}, {3.914284304252326*^9, 3.914284447041956*^9}, {
   3.914284755377372*^9, 3.914284760411647*^9}, {3.9142848432730513`*^9, 
   3.914284843591188*^9}, {3.914362138744569*^9, 3.91436215319423*^9}, 
   3.914362257594577*^9},
 CellLabel->
  "In[390]:=",ExpressionUUID->"5462538d-bd14-4df9-879c-7c9747147e50"],

Cell["\<\
I suspect that it makes most sense to define these operators correctly \
yourself. \
\>", "Text",
 CellChangeTimes->{{3.914285548882326*^9, 
  3.914285561242765*^9}},ExpressionUUID->"2771c953-72c7-4598-99f6-\
59765edb4947"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Calculate gradient operators", "Subsection",
 CellChangeTimes->{{3.9140741180036283`*^9, 
  3.914074121396791*^9}},ExpressionUUID->"bc097691-ac37-4114-a5c6-\
3d24a9a1569e"],

Cell["Convert ultraspherical space", "Text",
 CellChangeTimes->{{3.914074126194062*^9, 
  3.914074141225327*^9}},ExpressionUUID->"c5808fc4-c3b7-414c-a8e8-\
336222e7cbf9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGridTransformTensor", "[", 
   RowBox[{"t_tensor", ",", "rules_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"dims", ",", "newDims", ",", "pairs"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"dims", "=", 
      RowBox[{"getOutDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"newDims", "=", 
      RowBox[{"dims", "/.", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"c_", "/;", 
            RowBox[{"MemberQ", "[", 
             RowBox[{
              RowBox[{"rules", "[", 
               RowBox[{"[", 
                RowBox[{";;", ",", "1"}], "]"}], "]"}], ",", "c"}], "]"}]}], 
           ")"}], ",", "i_Integer"}], "}"}], ":>", 
        RowBox[{"{", 
         RowBox[{"c", ",", 
          RowBox[{"c", "/.", "rules"}]}], "}"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"pairs", "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"dims", ",", "newDims"}], "}"}], "\[Transpose]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"TensorProduct", "@@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"Equal", "@@", "pair"}], ",", 
          RowBox[{"id", "[", 
           RowBox[{"pair", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
          RowBox[{"ultrasphericalTransform", "@@", "pair"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"pair", ",", "pairs"}], "}"}]}], "]"}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.914067028285041*^9, 3.914067104281736*^9}, {
  3.9140671385695753`*^9, 3.914067156591324*^9}, {3.914067195203289*^9, 
  3.914067359838497*^9}, {3.91406741072431*^9, 3.914067435902626*^9}, {
  3.9140674757078238`*^9, 3.914067571855591*^9}, {3.914067720565954*^9, 
  3.914067825257085*^9}, {3.914067864025649*^9, 3.914067929740618*^9}, {
  3.914068766218899*^9, 3.914068775147862*^9}, {3.914068884551224*^9, 
  3.914068945561281*^9}, {3.914077206619158*^9, 3.9140772069078608`*^9}},
 CellLabel->
  "In[391]:=",ExpressionUUID->"7eebecd5-aedd-4b0c-8575-c7a99601814e"],

Cell["Calculate partial derivatives", "Text",
 CellChangeTimes->{{3.9140741453912277`*^9, 
  3.914074151091922*^9}},ExpressionUUID->"a41055c3-784d-45f0-840f-\
b9a65ff69213"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcPartialTensor", "[", 
   RowBox[{"t_tensor", ",", "rules_", ",", "name_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "coordStrings", ",", "newDims", ",", 
      "funcs", ",", "coordIndex"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getOutCoordDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordStrings", "=", 
      RowBox[{"coordDims", "[", 
       RowBox[{"[", 
        RowBox[{";;", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordIndex", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"FirstPosition", "[", 
         RowBox[{"coordStrings", ",", "name"}], "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}], "-", "1"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newDims", "=", 
      RowBox[{
       RowBox[{"getOutDims", "[", "t", "]"}], "/.", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"c_", "/;", 
            RowBox[{"MemberQ", "[", 
             RowBox[{
              RowBox[{"rules", "[", 
               RowBox[{"[", 
                RowBox[{";;", ",", "1"}], "]"}], "]"}], ",", "c"}], "]"}]}], 
           ")"}], ",", "i_Integer"}], "}"}], ":>", 
        RowBox[{"{", 
         RowBox[{"c", ",", 
          RowBox[{"c", "/.", "rules"}]}], "}"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"funcs", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"StringQ", "[", 
           RowBox[{"d", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
          RowBox[{
           RowBox[{"id", "[", "#1", "]"}], "&"}], ",", 
          RowBox[{
           RowBox[{"d", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "==", "name"}], ",", 
          "ultrasphericalDerivative", ",", 
          RowBox[{
           RowBox[{"d", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "!=", "name"}], ",", 
          "ultrasphericalTransform"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"d", ",", 
          RowBox[{"getOutDims", "[", "t", "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"TensorProduct", "@@", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"func", ",", "inDim", ",", "outDim"}], "}"}], ",", 
          RowBox[{"func", "[", 
           RowBox[{"inDim", ",", "outDim"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"funcs", ",", 
          RowBox[{"getOutDims", "[", "t", "]"}], ",", "newDims"}], "}"}]}], 
       "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.914070425874582*^9, 3.914070431126486*^9}, {
   3.914070916805893*^9, 3.9140709191470337`*^9}, {3.914070949781343*^9, 
   3.914071041876061*^9}, {3.914071116335059*^9, 3.914071117261499*^9}, {
   3.914071207019272*^9, 3.914071238477815*^9}, {3.914071529726729*^9, 
   3.914071685487265*^9}, {3.914071761987177*^9, 3.914071801145524*^9}, {
   3.9140718442843857`*^9, 3.914071869471215*^9}, {3.914071913040277*^9, 
   3.914072037571039*^9}, {3.914072075986685*^9, 3.914072315487855*^9}, {
   3.914072357869135*^9, 3.914072387236506*^9}, {3.914072418410696*^9, 
   3.914072446645155*^9}, {3.914072481564292*^9, 3.914072526177259*^9}, {
   3.914286367170369*^9, 3.914286367541923*^9}, {3.914286415141851*^9, 
   3.914286415415623*^9}, {3.91428648534365*^9, 3.914286493836128*^9}, 
   3.9143626783098707`*^9, {3.9143718349215393`*^9, 3.914371853818262*^9}, {
   3.914454211279042*^9, 3.914454211424054*^9}},
 CellLabel->
  "In[392]:=",ExpressionUUID->"5df25f7e-4962-499e-91ba-02cffbce11a6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"calcPartialsTensor", "[", 
    RowBox[{"t_tensor", ",", "rules_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"coordInds", ",", "coordDims", ",", "coordStrings"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
       RowBox[{"getOutCoordDims", "[", "t", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"coordStrings", "=", 
       RowBox[{"coordDims", "[", 
        RowBox[{"[", 
         RowBox[{";;", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Total", "[", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i", ",", "ci"}], "}"}], ",", 
           RowBox[{
            RowBox[{"adjoint", "[", 
             RowBox[{"covec", "[", 
              RowBox[{
               RowBox[{"Length", "[", "coordStrings", "]"}], ",", 
               RowBox[{"i", "-", "1"}], ",", 
               RowBox[{"StringJoin", "[", "coordStrings", "]"}]}], "]"}], 
             "]"}], "\[TensorProduct]", 
            RowBox[{"calcPartialTensor", "[", 
             RowBox[{"t", ",", "rules", ",", "ci"}], "]"}]}]}], "]"}], ",", 
         RowBox[{
          RowBox[{"enumerate", "[", "coordStrings", "]"}], "\[Transpose]"}]}],
         "]"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.91406505258505*^9, 3.914065133512278*^9}, {
   3.914065179951336*^9, 3.91406518051656*^9}, {3.914065227892215*^9, 
   3.9140652803269997`*^9}, 3.914069237708438*^9, {3.914069298732963*^9, 
   3.914069310625284*^9}, {3.914069984105819*^9, 3.914069995968074*^9}, {
   3.914070112343277*^9, 3.914070119477338*^9}, {3.914070166924539*^9, 
   3.914070172243424*^9}, {3.914070277127651*^9, 3.9140703361344137`*^9}, {
   3.914070370787549*^9, 3.914070400668146*^9}, {3.914072559246537*^9, 
   3.91407260544*^9}, {3.914286545986964*^9, 3.914286550636634*^9}, {
   3.914371838372964*^9, 3.91437184611868*^9}, {3.914371881254737*^9, 
   3.914372006726778*^9}, {3.914372050468333*^9, 3.9143721169504547`*^9}, 
   3.914372152216418*^9, {3.914372237744351*^9, 3.914372297202305*^9}},
 CellLabel->
  "In[393]:=",ExpressionUUID->"e729b46f-daf3-4e75-8927-3d5144465bae"],

Cell["Calculate connection operators", "Text",
 CellChangeTimes->{{3.914074154737975*^9, 
  3.914074160604114*^9}},ExpressionUUID->"7a84ca17-4527-4480-bb4f-\
0cd508afcb4d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transposeGrid", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", "coordDims", ",", "coordInds"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getCoordDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Transpose", "[", 
      RowBox[{"t", ",", 
       RowBox[{"calcMultiPermutation", "[", 
        RowBox[{
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"i", ",", "index"}], "}"}], ",", 
             RowBox[{"index", "->", 
              RowBox[{"n", "-", 
               RowBox[{"Length", "[", "coordInds", "]"}], "+", "i"}]}]}], 
            "]"}], ",", 
           RowBox[{
            RowBox[{"enumerate", "[", "coordInds", "]"}], "\[Transpose]"}]}], 
          "]"}], ",", "n"}], "]"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.9140762907138367`*^9, 3.9140765614252987`*^9}, {
  3.914076620803636*^9, 3.914076690766288*^9}},
 CellLabel->
  "In[394]:=",ExpressionUUID->"5135b5f1-5dc3-4cd8-bde3-1fe15eba51f1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcConnectionTensor", "[", 
   RowBox[{"t_tensor", ",", "rules_", ",", "index_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "coordStrings", ",", "bundleDims", 
      ",", "bundleInds", ",", "conn", ",", "connTensor", ",", "newconn", ",", 
      "s", ",", "n", ",", "connOp"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getOutCoordDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordStrings", "=", 
      RowBox[{"coordDims", "[", 
       RowBox[{"[", 
        RowBox[{";;", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
      RowBox[{"getOutBundleDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"conn", "=", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"connections", "[", 
            RowBox[{"{", 
             RowBox[{"#", ",", 
              RowBox[{"StringJoin", "[", "coordStrings", "]"}], ",", "#"}], 
             "}"}], "]"}], "&"}], "@", 
          RowBox[{"convertDimToString", "[", 
           RowBox[{
            RowBox[{"getDims", "[", "t", "]"}], "[", 
            RowBox[{"[", "index", "]"}], "]"}], "]"}]}], ",", "1"}], "]"}], "//",
        "sparse"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"newconn", "=", 
      RowBox[{
       RowBox[{"TensorProduct", "@@", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"ind", ",", "dim"}], "}"}], ",", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"ind", "!=", "index"}], ",", 
              RowBox[{"id", "[", "dim", "]"}], ",", "conn"}], "]"}]}], "]"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"bundleInds", ",", "bundleDims"}], "}"}]}], "]"}]}], "//", 
       "transposeGrid"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"connOp", "=", 
      RowBox[{"convertGridTensorToMultOp", "[", "newconn", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"connOp", ".", 
      RowBox[{"calcGridTransformTensor", "[", 
       RowBox[{"connOp", ",", "rules"}], "]"}]}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.91406505258505*^9, 3.914065133512278*^9}, {
   3.914065179951336*^9, 3.91406518051656*^9}, {3.914065227892215*^9, 
   3.9140652803269997`*^9}, 3.914069237708438*^9, {3.914072693962941*^9, 
   3.914072713879003*^9}, {3.9140730000572557`*^9, 3.914073029954668*^9}, {
   3.914073098048258*^9, 3.914073200562383*^9}, {3.914074209194477*^9, 
   3.91407430536088*^9}, {3.914074372513329*^9, 3.914074585913718*^9}, {
   3.914074670020562*^9, 3.91407475495783*^9}, {3.91407484555907*^9, 
   3.914074865313836*^9}, {3.91407498026064*^9, 3.914075017707378*^9}, {
   3.914075048742638*^9, 3.914075061268649*^9}, {3.914075099934286*^9, 
   3.91407512029689*^9}, {3.914075194660577*^9, 3.914075208956418*^9}, {
   3.914075256785123*^9, 3.9140752907711973`*^9}, {3.914075359848659*^9, 
   3.9140753660261183`*^9}, {3.914075422404969*^9, 3.914075462516487*^9}, {
   3.914075522835416*^9, 3.9140757740621233`*^9}, {3.914075805436132*^9, 
   3.914075848323884*^9}, {3.914076064397622*^9, 3.91407607982474*^9}, {
   3.914076120752259*^9, 3.914076249049311*^9}, {3.914076730833241*^9, 
   3.914076809965744*^9}, {3.914076928360045*^9, 3.914077034136525*^9}, {
   3.914077092380097*^9, 3.9140770925300426`*^9}, {3.914077347136806*^9, 
   3.914077380812737*^9}, {3.914080965384351*^9, 3.9140809998852577`*^9}, {
   3.91428662502914*^9, 3.914286653926954*^9}, {3.9142876555948343`*^9, 
   3.914287718779233*^9}, {3.9142877620306253`*^9, 3.914287765964102*^9}, {
   3.9142885608911657`*^9, 3.91428858890053*^9}},
 CellLabel->
  "In[395]:=",ExpressionUUID->"e9dd205b-ac9a-4240-9171-72a3925b473c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcConnectionsTensor", "[", 
   RowBox[{"t_tensor", ",", "rules_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "coordStrings", ",", "bundleDims", 
      ",", "bundleInds", ",", "conn", ",", "connTensor", ",", "newconn", ",", 
      "s", ",", "n", ",", "connOp"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getOutCoordDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordStrings", "=", 
      RowBox[{"coordDims", "[", 
       RowBox[{"[", 
        RowBox[{";;", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
      RowBox[{"getOutBundleDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"calcConnectionTensor", "[", 
        RowBox[{"t", ",", "rules", ",", "index"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"index", ",", "bundleInds"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.914077475365487*^9, 3.914077545281752*^9}, {
  3.9142870195473013`*^9, 3.914287021593027*^9}},
 CellLabel->
  "In[396]:=",ExpressionUUID->"f1972c62-aafa-4f19-8ac4-1b8f536f7157"],

Cell["Calculate gradient operator", "Text",
 CellChangeTimes->{{3.914076916031247*^9, 
  3.914076919520895*^9}},ExpressionUUID->"b309d358-4495-496d-96ff-\
21e1e6c32540"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGradTensor", "[", 
   RowBox[{"t_tensor", ",", "rules_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"calcPartialsTensor", "[", 
    RowBox[{"t", ",", "rules"}], "]"}], "+", 
   RowBox[{"calcConnectionsTensor", "[", 
    RowBox[{"t", ",", "rules"}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.91406505258505*^9, 3.914065133512278*^9}, {
   3.914065179951336*^9, 3.91406518051656*^9}, {3.914065227892215*^9, 
   3.9140652803269997`*^9}, 3.914069237708438*^9, {3.914072693962941*^9, 
   3.914072713879003*^9}, {3.9140776224101954`*^9, 3.914077667081985*^9}},
 CellLabel->
  "In[397]:=",ExpressionUUID->"620b3a01-d6a0-4a10-a99c-954329ff5b86"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor Field Contraction", "Subsection",
 CellChangeTimes->{{3.91135098080796*^9, 3.9113509906053267`*^9}, {
  3.911394021334158*^9, 3.911394039330599*^9}, {3.914293140840935*^9, 
  3.9142931498219843`*^9}},ExpressionUUID->"cb0690d3-e5cf-4eed-9d19-\
d82988862376"],

Cell[BoxData[
 RowBox[{
  RowBox[{"TensorProdContractMult", "[", 
   RowBox[{"A_", ",", "B_", ",", "cdims_", ",", "mdims_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"Avec", ",", "Bvec", ",", "Aflat", ",", "Bflat"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Avec", "=", 
      RowBox[{"Map", "[", 
       RowBox[{"vec", ",", "A", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"ArrayDepth", "[", "A", "]"}], "-", "mdims"}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Bvec", "=", 
      RowBox[{"Map", "[", 
       RowBox[{"vec", ",", "B", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"ArrayDepth", "[", "B", "]"}], "-", "mdims"}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Not", "[", 
        RowBox[{"cdims", "===", 
         RowBox[{"{", "}"}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Aflat", "=", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{"#", ",", 
              RowBox[{"RotateRight", "@", 
               RowBox[{"Range", "@", 
                RowBox[{"ArrayDepth", "[", "#", "]"}]}]}]}], "]"}], "&"}], 
           "@", 
           RowBox[{"Flatten", "[", 
            RowBox[{"Avec", ",", 
             RowBox[{"List", "@", 
              RowBox[{
               RowBox[{"Transpose", "[", "cdims", "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "All"}], "]"}], "]"}]}]}], "]"}]}], ")"}]}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"Bflat", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"Bvec", ",", 
           RowBox[{"List", "@", 
            RowBox[{
             RowBox[{"Transpose", "[", "cdims", "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "All"}], "]"}], "]"}]}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Inner", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Times", "[", 
            RowBox[{
             RowBox[{"#1", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"#2", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], ",", "Aflat", 
          ",", "Bflat"}], "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"Outer", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Times", "[", 
           RowBox[{
            RowBox[{"#1", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"#2", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], ",", "Avec", ",",
          "Bvec"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.911390442416784*^9, 3.911390481913862*^9}, {
  3.91139076947978*^9, 3.911390783752864*^9}, {3.911390975544774*^9, 
  3.911390982217493*^9}, {3.911391349388699*^9, 3.911391350964906*^9}, {
  3.911391599623563*^9, 3.9113916611087847`*^9}, {3.9113926118079247`*^9, 
  3.9113926150369673`*^9}, {3.911392775650653*^9, 3.911392786534787*^9}, {
  3.9113928988857393`*^9, 3.911392925087325*^9}, {3.9113931557232428`*^9, 
  3.9113932210135736`*^9}, {3.91139326126812*^9, 3.9113933241283073`*^9}, {
  3.911393447105823*^9, 3.911393454987933*^9}, {3.911393827682143*^9, 
  3.911393870446307*^9}, {3.914292275085535*^9, 3.91429232287682*^9}, {
  3.91429240385024*^9, 3.914292406852714*^9}},
 CellLabel->
  "In[398]:=",ExpressionUUID->"7a403f7b-05cf-441b-83fe-28b49507400b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"contractGrid", "[", 
     RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "coordInds", ",", "coordDims", ",", "bundleInds", ",", "bundleDims", 
        ",", "s1", ",", "s2"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"getCoordDims", "/@", 
           RowBox[{"{", 
            RowBox[{"t1", ",", "t2"}], "}"}]}], ")"}], "\[Transpose]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"getBundleDims", "/@", 
           RowBox[{"{", 
            RowBox[{"t1", ",", "t2"}], "}"}]}], ")"}], "\[Transpose]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"s1", ",", "s2"}], "}"}], "=", 
        RowBox[{"getSlots", "/@", 
         RowBox[{"{", 
          RowBox[{"t1", ",", "t2"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"contractiblePairs", "@", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"bundleDims", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", 
                 RowBox[{
                  RowBox[{"s1", "+", "1"}], ";;"}]}], "]"}], "]"}], ",", 
              RowBox[{"bundleDims", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", 
                 RowBox[{";;", "s2"}]}], "]"}], "]"}]}], "}"}], 
            "\[Transpose]"}], ")"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"tensor", "[", 
          RowBox[{
           RowBox[{"TensorProdContractMult", "[", 
            RowBox[{
             RowBox[{"getArr", "[", "t1", "]"}], ",", 
             RowBox[{"getArr", "[", "t2", "]"}], ",", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"bundleInds", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", 
                   RowBox[{
                    RowBox[{"s1", "+", "1"}], ";;"}]}], "]"}], "]"}], ",", 
                RowBox[{"bundleInds", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", 
                   RowBox[{";;", "s2"}]}], "]"}], "]"}]}], "}"}], 
              "\[Transpose]"}], ",", 
             RowBox[{"Length", "[", "coordInds", "]"}]}], "]"}], ",", 
           RowBox[{"Join", "[", 
            RowBox[{
             RowBox[{"getInDims", "[", "t1", "]"}], ",", 
             RowBox[{"getOutDims", "[", "t2", "]"}]}], "]"}], ",", "s1"}], 
          "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"CenterDot", "[", "t1_tensor", "]"}], ":=", "t1"}], 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{"CenterDot", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
  RowBox[{"contractGrid", "[", 
   RowBox[{"t1", ",", "t2"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CenterDot", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor", ",", "ts__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"(", 
    RowBox[{"t1", "\[CenterDot]", "t2"}], ")"}], "\[CenterDot]", 
   RowBox[{"CenterDot", "[", "ts", "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.911848410085947*^9, 3.911848458076449*^9}, {
   3.911848646307241*^9, 3.911848757430805*^9}, {3.911849182622498*^9, 
   3.911849185145208*^9}, {3.911849324125026*^9, 3.911849329564053*^9}, {
   3.9118493887915173`*^9, 3.911849398604888*^9}, {3.911849437604266*^9, 
   3.911849467895615*^9}, {3.911849521037898*^9, 3.911849555270008*^9}, {
   3.911849664286944*^9, 3.9118497510115423`*^9}, {3.911850508514069*^9, 
   3.911850548042798*^9}, {3.91185079141652*^9, 3.911850823950409*^9}, {
   3.9118511478877697`*^9, 3.911851153413356*^9}, {3.911851377355704*^9, 
   3.911851464314444*^9}, {3.911851499238012*^9, 3.911851522848637*^9}, 
   3.911851606507348*^9, {3.911851645670924*^9, 3.911851803558207*^9}, {
   3.911852234929402*^9, 3.9118522394928455`*^9}, 3.911854834417181*^9, {
   3.913999987724182*^9, 3.913999987728366*^9}, {3.914026779268774*^9, 
   3.914026874958259*^9}, {3.9140279959695597`*^9, 3.914028016406972*^9}, {
   3.9140280481682034`*^9, 3.914028133923848*^9}, {3.914028552144479*^9, 
   3.9140286072036*^9}, {3.914028738752152*^9, 3.914028772044301*^9}, {
   3.914028853936586*^9, 3.914028893617528*^9}, {3.914029014879169*^9, 
   3.914029020644124*^9}, {3.9140291182250757`*^9, 3.914029153865766*^9}, {
   3.914029226960608*^9, 3.9140292459244413`*^9}, {3.9140292854500227`*^9, 
   3.914029330672594*^9}, {3.9140295404032087`*^9, 3.914029558362699*^9}, {
   3.914029606623461*^9, 3.914029631673215*^9}, {3.9142909994004107`*^9, 
   3.914291007682288*^9}, 3.914291052092872*^9, {3.914291086826682*^9, 
   3.914291114505768*^9}, {3.914291394288192*^9, 3.914291400844029*^9}, {
   3.914588283185421*^9, 3.9145882832876997`*^9}, {3.914588317129771*^9, 
   3.914588330540965*^9}, {3.914588375935326*^9, 3.914588394424361*^9}, {
   3.914588995572794*^9, 3.914589011713225*^9}, {3.914589239223646*^9, 
   3.914589258646128*^9}, {3.914589312039849*^9, 3.9145893160194197`*^9}, {
   3.914590216613755*^9, 3.914590228519054*^9}, {3.9145902893801203`*^9, 
   3.914590300201457*^9}, {3.914591067140032*^9, 3.91459108335119*^9}, {
   3.914591113367309*^9, 3.9145911360096273`*^9}},
 CellLabel->
  "In[399]:=",ExpressionUUID->"5f6c0c2f-e8a8-4467-8fd0-2e158548336b"],

Cell[BoxData[
 RowBox[{"SetAttributes", "[", 
  RowBox[{"CenterDot", ",", 
   RowBox[{"{", 
    RowBox[{"Flat", ",", "OneIdentity"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.914591119011091*^9, 3.91459112810423*^9}},
 CellLabel->
  "In[402]:=",ExpressionUUID->"453c8226-aa5e-455d-9438-eb9b47a88aa0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor Field Product", "Subsection",
 CellChangeTimes->{{3.914291597615599*^9, 
  3.9142916176151114`*^9}},ExpressionUUID->"c449ef95-91d7-45e9-95df-\
e821b6ee3840"],

Cell[BoxData[
 RowBox[{
  RowBox[{"tensorGrid", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "bundleInds", ",", "bundleDims", ",",
       "s1", ",", "s2", ",", "o1", ",", "o2", ",", "n1", ",", "nb1", ",", 
      "nb2", ",", "perm"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"getCoordDims", "/@", 
         RowBox[{"{", 
          RowBox[{"t1", ",", "t2"}], "}"}]}], ")"}], "\[Transpose]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"getBundleDims", "/@", 
         RowBox[{"{", 
          RowBox[{"t1", ",", "t2"}], "}"}]}], ")"}], "\[Transpose]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"s1", ",", "s2"}], "}"}], "=", 
      RowBox[{"getSlots", "/@", 
       RowBox[{"{", 
        RowBox[{"t1", ",", "t2"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"o1", ",", "o2", ",", "nb1", ",", "nb2", ",", "n1"}], "}"}], 
      "=", 
      RowBox[{"Length", "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"getOutBundleDims", "[", "t1", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"getOutBundleDims", "[", "t2", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"bundleInds", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"bundleInds", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", 
         RowBox[{"getDims", "[", "t1", "]"}]}], "}"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"perm", "=", 
      RowBox[{"calcMultiPermutation", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"i", "->", 
           RowBox[{"i", "-", "o1"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{
             RowBox[{"Range", "[", "s2", "]"}], "+", "nb1"}]}], "}"}]}], 
         "]"}], ",", 
        RowBox[{"n1", "+", "nb2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"TensorProdContractMult", "[", 
         RowBox[{
          RowBox[{"getArr", "[", "t1", "]"}], ",", 
          RowBox[{"getArr", "[", "t2", "]"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"Length", "[", "coordInds", "]"}]}], "]"}], ",", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"bundleDims", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"bundleDims", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", 
          RowBox[{"coordDims", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"s1", "+", "s2"}]}], "]"}], "//", 
      RowBox[{
       RowBox[{"Transpose", "[", 
        RowBox[{"#", ",", "perm"}], "]"}], "&"}]}]}]}], "\[IndentingNewLine]",
    "]"}]}]], "Input",
 CellChangeTimes->{{3.914291626283847*^9, 3.914291641748904*^9}, {
  3.914292108091076*^9, 3.9142921103474703`*^9}, {3.914292606333605*^9, 
  3.914292617647509*^9}, {3.914292653193462*^9, 3.914292670307307*^9}, {
  3.914292705148459*^9, 3.914292726319287*^9}, {3.91429277802751*^9, 
  3.914292794828066*^9}, {3.914379131563074*^9, 3.914379272813789*^9}, {
  3.914379375519907*^9, 3.914379602337493*^9}, {3.914379726659577*^9, 
  3.914379763420888*^9}, {3.914379814120226*^9, 3.914379816289424*^9}, {
  3.914379867063105*^9, 3.914379867240223*^9}, {3.914379902402939*^9, 
  3.9143799868660393`*^9}, {3.914380056168659*^9, 3.914380070174708*^9}, {
  3.914380105291938*^9, 3.914380123768672*^9}, {3.914380390387908*^9, 
  3.914380401618241*^9}, {3.9143804408493843`*^9, 3.914380444488801*^9}, {
  3.914380479282051*^9, 3.914380576007106*^9}},
 CellLabel->
  "In[403]:=",ExpressionUUID->"72f99197-4f8c-413e-9209-341512443d99"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"CircleTimes", "[", "t1_tensor", "]"}], ":=", 
  "t1"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CircleTimes", "[", 
    RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":=", 
   RowBox[{"tensorGrid", "[", 
    RowBox[{"t1", ",", "t2"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"CircleTimes", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensor", ",", "ts__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"(", 
    RowBox[{"t1", "\[CircleTimes]", "t2"}], ")"}], "\[CircleTimes]", 
   RowBox[{"CircleTimes", "[", "ts", "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.914292931513994*^9, 3.914292964580798*^9}, 
   3.9142929975205584`*^9, {3.9144178489038553`*^9, 3.914417850633644*^9}, {
   3.914417899108602*^9, 3.914417914038312*^9}, 3.914588461920539*^9, {
   3.914589378526885*^9, 3.914589388521612*^9}, 3.914589432688809*^9, {
   3.914589576655756*^9, 3.914589578395328*^9}, {3.914590722699645*^9, 
   3.914590723566972*^9}, {3.914590824382277*^9, 3.914590825031825*^9}, {
   3.91459097042778*^9, 3.91459097478574*^9}, {3.914671226786071*^9, 
   3.914671260794175*^9}, {3.914673473592648*^9, 3.91467347496789*^9}, {
   3.914674081506782*^9, 3.914674083144456*^9}, 3.914674122851783*^9, {
   3.914674251239939*^9, 3.914674251863412*^9}, {3.914674481796912*^9, 
   3.914674487931984*^9}, 3.914674519779735*^9},
 CellLabel->
  "In[404]:=",ExpressionUUID->"ad20dab2-7b33-4cb3-b909-42872365954b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor Field Scalar Product", "Subsection",
 CellChangeTimes->{{3.914363444698646*^9, 
  3.914363449619679*^9}},ExpressionUUID->"450e69bc-4e25-4005-8ace-\
669cea68bf38"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"testRule", "=", 
   RowBox[{
    RowBox[{"Times", "[", 
     RowBox[{"t1_tensor", ",", "t2_tensor"}], "]"}], ":>", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"getBundleDims", "[", "t1", "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "==", 
          RowBox[{"{", "}"}]}], "&&", 
         RowBox[{
          RowBox[{
           RowBox[{"getCoordDims", "[", "t1", "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "==", 
          RowBox[{
           RowBox[{"getCoordDims", "[", "t2", "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"tensor", "[", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
     "]"}]}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.914363450905903*^9, 3.9143635377139874`*^9}, {
   3.914363582291244*^9, 3.914363623600834*^9}, 3.91436377354039*^9},
 CellLabel->
  "In[407]:=",ExpressionUUID->"f37e83f3-432b-4e49-bade-cf908fc6b57f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Bundle transform operators", "Subsection",
 CellChangeTimes->{{3.914289818273676*^9, 3.914289822338744*^9}, {
  3.914435020400189*^9, 
  3.914435021069808*^9}},ExpressionUUID->"ef0e8501-4b10-417a-a73d-\
4188466138a9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"convertDimToString", "[", "dim_", "]"}], ":=", 
   RowBox[{
    RowBox[{"dim", "[", 
     RowBox[{"[", "1", "]"}], "]"}], "<>", 
    RowBox[{"dim", "[", 
     RowBox[{"[", "3", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"convertStringToDim", "[", "string_", "]"}], ":=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"StringTake", "[", 
     RowBox[{"string", ",", "2"}], "]"}], ",", "2", ",", 
    RowBox[{"StringTake", "[", 
     RowBox[{"string", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}]}], "}"}]}]}], "Input",
 CellChangeTimes->{{3.914033915324918*^9, 3.914033990320442*^9}, {
  3.914034181770423*^9, 3.914034182037466*^9}},
 CellLabel->
  "In[408]:=",ExpressionUUID->"b0dfbc27-0def-4a97-a3f7-a063fec68568"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"basisOrder", "=", 
   RowBox[{"<|", 
    RowBox[{
     RowBox[{"\"\<xy-\>\"", "->", "0"}], ",", 
     RowBox[{"\"\<XY-\>\"", "->", "1"}], ",", 
     RowBox[{"\"\<XY+\>\"", "->", "2"}], ",", 
     RowBox[{"\"\<xy+\>\"", "->", "3"}]}], "|>"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"intToBasis", "=", 
   RowBox[{"basisOrder", "//", 
    RowBox[{
     RowBox[{"AssociationThread", "[", 
      RowBox[{
       RowBox[{"Values", "[", "#", "]"}], ",", 
       RowBox[{"Keys", "[", "#", "]"}]}], "]"}], "&"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914033893273896*^9, 3.914033900621971*^9}, {
  3.914034023098666*^9, 3.914034091055307*^9}, {3.91403416780703*^9, 
  3.91403416901217*^9}},
 CellLabel->
  "In[410]:=",ExpressionUUID->"c4962df0-7f48-4eba-bc28-14291eb2e4e8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Ids", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Ids", "[", 
      RowBox[{"{", 
       RowBox[{"i", ",", "i"}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"id", "[", 
       RowBox[{
        RowBox[{"intToBasis", "[", "i", "]"}], "//", "convertStringToDim"}], 
       "]"}], "\[TensorProduct]", 
      RowBox[{"NTs", "[", "1", "]"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", 
      RowBox[{"Keys", "[", "intToBasis", "]"}]}], "}"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"0", ",", "1"}], "}"}], "]"}], "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Kg", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "3", ",", "4"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"1", ",", "2"}], "}"}], "]"}], "=", 
   RowBox[{"NTs", "[", "Ig", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"2", ",", "3"}], "}"}], "]"}], "=", 
   RowBox[{"NTs", "[", "Kg", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"3", ",", "2"}], "}"}], "]"}], "=", 
   RowBox[{"NTs", "[", "Jg", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"2", ",", "1"}], "}"}], "]"}], "=", 
   RowBox[{"NTs", "[", "IIg", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"1", ",", "0"}], "}"}], "]"}], "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Jg", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "3", ",", "4"}], "}"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{"Do", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Ids", "[", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"i", "+", "2"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"Ids", "[", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"i", "+", "1"}]}], "}"}], "]"}], "\[CenterDot]", 
      RowBox[{"Ids", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "1"}], ",", 
         RowBox[{"i", "+", "2"}]}], "}"}], "]"}]}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Ids", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"i", "+", "2"}], ",", "i"}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"Ids", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "2"}], ",", 
         RowBox[{"i", "+", "1"}]}], "}"}], "]"}], "\[CenterDot]", 
      RowBox[{"Ids", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"i", "+", "1"}], ",", "i"}], "}"}], "]"}]}]}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{"i", ",", "0", ",", "1"}], "}"}]}], "\[IndentingNewLine]", 
  "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"0", ",", "3"}], "}"}], "]"}], "=", 
   RowBox[{
    RowBox[{"Ids", "[", 
     RowBox[{"{", 
      RowBox[{"0", ",", "1"}], "}"}], "]"}], "\[CenterDot]", 
    RowBox[{"Ids", "[", 
     RowBox[{"{", 
      RowBox[{"1", ",", "3"}], "}"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Ids", "[", 
    RowBox[{"{", 
     RowBox[{"3", ",", "0"}], "}"}], "]"}], "=", 
   RowBox[{
    RowBox[{"Ids", "[", 
     RowBox[{"{", 
      RowBox[{"3", ",", "1"}], "}"}], "]"}], "\[CenterDot]", 
    RowBox[{"Ids", "[", 
     RowBox[{"{", 
      RowBox[{"1", ",", "0"}], "}"}], "]"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914034066253605*^9, 3.9140340749400253`*^9}, {
   3.914034177591407*^9, 3.914034186550076*^9}, 3.914417535662088*^9},
 CellLabel->
  "In[412]:=",ExpressionUUID->"471751a5-7820-4e33-8c69-7b2da57b4e29"],

Cell[BoxData[
 RowBox[{
  RowBox[{"getGridTransform", "[", 
   RowBox[{"d1_", ",", "d2_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{"d1", ",", "d2"}], "}"}], "//", 
     RowBox[{
      RowBox[{"convertDimToString", "/@", "#"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"basisOrder", "/@", "#"}], "&"}]}], "//", "Ids"}]}]], "Input",
 CellChangeTimes->{{3.914063486734685*^9, 3.914063537685124*^9}, {
   3.914063633718734*^9, 3.914063667551051*^9}, 3.914064302794837*^9},
 CellLabel->
  "In[423]:=",ExpressionUUID->"7796ce51-94a2-4afe-b27d-0e6d188c8ca4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcBundleTransformTensor", "[", 
   RowBox[{"t_tensor", ",", "dimList_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"bundleDims", ",", "bundleInds", ",", "newDims"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"checkOutGridSpace", "[", "t", "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"dimList", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "Rule"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"newDims", "=", 
          RowBox[{"ReplacePart", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"getOutBundleDims", "[", "t", "]"}], "[", 
             RowBox[{"[", "2", "]"}], "]"}], ",", 
            RowBox[{"dimList", "/.", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"a_Integer", "->", "b_String"}], ")"}], ":>", 
              RowBox[{"(", 
               RowBox[{"a", "->", 
                RowBox[{"convertStringToDim", "[", "b", "]"}]}], ")"}]}]}]}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"calcBundleTransformTensor", "[", 
          RowBox[{"t", ",", "newDims"}], "]"}]}], ",", "\[IndentingNewLine]", 
        
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"bundleInds", ",", "bundleDims"}], "}"}], "=", 
          RowBox[{"getOutBundleDims", "[", "t", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"getGridTransform", "@@", "#"}], "&"}], "/@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"bundleDims", ",", "dimList"}], "}"}], 
                "\[Transpose]"}], ")"}]}], ")"}], "//", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", "bundleInds", "]"}], "==", "1"}], ",", 
               
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], ",", 
               RowBox[{"CircleTimes", "@@", "#"}]}], "]"}], "&"}]}], "//", 
           "sparse"}], "//", "convertGridTensorToMultOp"}]}]}], 
       "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"calcBundleTransformTensor", "::", "gridspace"}], ",", 
        RowBox[{"getDims", "[", "t", "]"}]}], "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.9142900557312193`*^9, 3.914290091274193*^9}, {
   3.914290408818806*^9, 3.914290582312446*^9}, {3.9142906456382627`*^9, 
   3.914290677886935*^9}, {3.914290758393472*^9, 3.9142907742575493`*^9}, {
   3.91429323546266*^9, 3.914293256304134*^9}, {3.914293301406815*^9, 
   3.914293317968706*^9}, {3.914293362813817*^9, 3.914293482278599*^9}, {
   3.914293521931184*^9, 3.914293628772142*^9}, {3.914293742474948*^9, 
   3.914293742811478*^9}, 3.914293786975587*^9, {3.9142938546518297`*^9, 
   3.914293867032939*^9}, {3.914293909577513*^9, 3.914293936716976*^9}, {
   3.9142941144093113`*^9, 3.9142941148713293`*^9}, {3.91429418660975*^9, 
   3.914294215077066*^9}, {3.914294260951394*^9, 3.914294271484473*^9}, {
   3.914294303947276*^9, 3.914294306037719*^9}, {3.914296743145322*^9, 
   3.914296796788138*^9}, {3.914296841807053*^9, 3.9142969226007547`*^9}, {
   3.9142971201569633`*^9, 3.91429717981481*^9}, {3.914425778636372*^9, 
   3.9144257788610086`*^9}, {3.914425937760571*^9, 3.914425990963183*^9}, {
   3.9144547646950207`*^9, 3.91445476498778*^9}, {3.914587790081568*^9, 
   3.914587834652878*^9}, {3.91458786573279*^9, 3.914587886146248*^9}, {
   3.914587956734548*^9, 3.914587959149035*^9}, {3.914591330671733*^9, 
   3.9145913336606283`*^9}, {3.91467396548528*^9, 3.914673965816994*^9}},
 CellLabel->
  "In[424]:=",ExpressionUUID->"abe44a73-01ce-4165-b961-e331dd78531b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"calcBundleTransformTensor", "::", "gridspace"}], "=", 
   "\"\<tensor not in grid space `1`\>\""}], ";"}]], "Input",
 CellChangeTimes->{{3.914425936410132*^9, 3.914425936645123*^9}, {
  3.91442599597317*^9, 3.914426036299784*^9}, {3.9144260750721188`*^9, 
  3.9144260862478237`*^9}},
 CellLabel->
  "In[425]:=",ExpressionUUID->"c129a611-7015-4f09-9b42-edfdabca96e0"],

Cell["\<\
Note that this function only considers the outgoing dimensions of the tensor, \
unlike the transformBundle operator, which can switch both in and output \
dimensions!\
\>", "Text",
 CellChangeTimes->{{3.91429699011887*^9, 
  3.914297016690712*^9}},ExpressionUUID->"a5f70273-b10c-4977-a5ce-\
fee214bbc70a"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remapped Linear Operators (matrix-free/separable operators)", "Chapter",
 CellChangeTimes->{{3.91086443186421*^9, 3.910864433879889*^9}, {
  3.914422784070642*^9, 
  3.914422804944965*^9}},ExpressionUUID->"35fbcc38-7d79-4140-b33f-\
dadc1810c409"],

Cell[CellGroupData[{

Cell["Operator composition", "Subsection",
 CellChangeTimes->{{3.911750300765602*^9, 
  3.9117503053428507`*^9}},ExpressionUUID->"9162d4cf-9804-4709-b2cf-\
1e7534d023ab"],

Cell[BoxData[{
 RowBox[{"tensorop", "/:", 
  RowBox[{"Dot", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensorop"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"dual", "/@", 
       RowBox[{"getOutDims", "[", "t1", "]"}]}], ")"}], "==", 
     RowBox[{"getInDims", "[", "t2", "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"getArr", "[", "t1", "]"}], "//", 
       RowBox[{"getFunc", "[", "t2", "]"}]}], ",", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"getInDims", "[", "t1", "]"}], ",", 
        RowBox[{"getOutDims", "[", "t2", "]"}]}], "]"}], ",", 
      RowBox[{"getSlots", "[", "t1", "]"}]}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"tensorop", "::", "dot"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t1", "]"}], ",", 
        RowBox[{"getSlots", "[", "t1", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t2", "]"}], ",", 
        RowBox[{"getDims", "[", "t2", "]"}]}], "}"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensorop", "::", "dot"}], "=", 
   "\"\<(.) Incompatible Contraction `1` with `2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.9108652279702263`*^9, 3.910865273164682*^9}, {
   3.910865335202924*^9, 3.910865357239273*^9}, 3.910865695789525*^9, {
   3.910865909165848*^9, 3.910865910587021*^9}, {3.910865945293782*^9, 
   3.910865974921263*^9}, 3.911604712769582*^9, {3.911750278184874*^9, 
   3.911750284683193*^9}, {3.913999987631759*^9, 3.913999987640004*^9}, {
   3.914018504663903*^9, 3.914018524632059*^9}, {3.914024273878578*^9, 
   3.9140242877756042`*^9}, {3.9140243599247026`*^9, 3.914024380774331*^9}, {
   3.9140244346217327`*^9, 3.914024518324057*^9}},
 CellLabel->
  "In[426]:=",ExpressionUUID->"39eb1990-919e-4d4d-b018-66c914c5152b"],

Cell[BoxData[{
 RowBox[{"tensorop", "/:", 
  RowBox[{"Dot", "[", 
   RowBox[{"t1_tensorop", ",", "t2_tensorop"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"dual", "/@", 
       RowBox[{"getOutDims", "[", "t1", "]"}]}], ")"}], "==", 
     RowBox[{"getInDims", "[", "t2", "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"tensorop", "[", 
     RowBox[{
      RowBox[{"RightComposition", "[", 
       RowBox[{
        RowBox[{"getFunc", "[", "t1", "]"}], ",", 
        RowBox[{"getFunc", "[", "t2", "]"}]}], "]"}], ",", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"getInDims", "[", "t1", "]"}], ",", 
        RowBox[{"getOutDims", "[", "t2", "]"}]}], "]"}], ",", 
      RowBox[{"getSlots", "[", "t1", "]"}]}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"tensorop", "::", "dot"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t1", "]"}], ",", 
        RowBox[{"getSlots", "[", "t1", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t2", "]"}], ",", 
        RowBox[{"getSlots", "[", "t2", "]"}]}], "}"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensorop", "::", "dot"}], "=", 
   "\"\<(.) Incompatible Contraction `1` with `2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.907416067182745*^9, 3.907416067496353*^9}, {
   3.9076367349683332`*^9, 3.907636753722583*^9}, {3.9076370135830183`*^9, 
   3.907637020855905*^9}, {3.9076720251590223`*^9, 3.907672082677361*^9}, {
   3.907672253866226*^9, 3.90767226495068*^9}, {3.907672419952404*^9, 
   3.907672420083069*^9}, {3.907673687131363*^9, 3.907673781561283*^9}, {
   3.907713136059516*^9, 3.9077131385936604`*^9}, {3.907716263646322*^9, 
   3.907716304868898*^9}, {3.907716355200255*^9, 3.907716356736556*^9}, {
   3.907717728778864*^9, 3.907717814807884*^9}, {3.907722768145527*^9, 
   3.90772277264531*^9}, 3.907722870881987*^9, {3.907723204407166*^9, 
   3.907723206891835*^9}, {3.907775096317631*^9, 3.907775134384741*^9}, {
   3.907775305180152*^9, 3.907775312535729*^9}, {3.907776099788756*^9, 
   3.907776122229355*^9}, {3.907888017991217*^9, 3.907888024414515*^9}, {
   3.907888594312314*^9, 3.907888595019957*^9}, 3.907888732210315*^9, {
   3.908396040304098*^9, 3.90839612307782*^9}, {3.908397147071259*^9, 
   3.908397152422577*^9}, {3.908478735759414*^9, 3.908478763189942*^9}, {
   3.908478841214872*^9, 3.9084788727284193`*^9}, {3.910864743894883*^9, 
   3.910864748020388*^9}, {3.910864845227543*^9, 3.910864887622209*^9}, {
   3.910864918741272*^9, 3.910864991870848*^9}, {3.910865675615788*^9, 
   3.9108656881407*^9}, 3.910865957672206*^9, {3.910866171225075*^9, 
   3.910866194894487*^9}, {3.910869075904256*^9, 3.910869077913115*^9}, {
   3.911668914911126*^9, 3.911668920551882*^9}, {3.913999987642837*^9, 
   3.913999987652081*^9}, {3.914024537727291*^9, 3.9140246271581793`*^9}},
 CellLabel->
  "In[428]:=",ExpressionUUID->"ca9ead4e-4d8e-4367-b063-e68f7ac81f72"],

Cell[BoxData[{
 RowBox[{"tensorop", "/:", 
  RowBox[{"Plus", "[", 
   RowBox[{"t1_tensorop", ",", "t2_tensorop"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"getDims", "[", "t1", "]"}], "==", 
      RowBox[{"getDims", "[", "t2", "]"}]}], "&&", 
     RowBox[{
      RowBox[{"getSlots", "[", "t1", "]"}], "==", 
      RowBox[{"getSlots", "[", "t2", "]"}]}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"tensorop", "[", 
     RowBox[{
      RowBox[{"Function", "[", 
       RowBox[{"a", ",", 
        RowBox[{
         RowBox[{
          RowBox[{"getFunc", "[", "t1", "]"}], "[", "a", "]"}], "+", 
         RowBox[{
          RowBox[{"getFunc", "[", "t2", "]"}], "[", "a", "]"}]}]}], "]"}], 
      ",", 
      RowBox[{"getDims", "[", "t1", "]"}], ",", 
      RowBox[{"getSlots", "[", "t1", "]"}]}], "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"tensorop", "::", "dot"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t1", "]"}], ",", 
        RowBox[{"getSlots", "[", "t1", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"getDims", "[", "t2", "]"}], ",", 
        RowBox[{"getSlots", "[", "t2", "]"}]}], "}"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensorop", "::", "plus"}], "=", 
   "\"\<(+) Incompatible Addition `1` with `2`\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.914592245717598*^9, 3.914592265106996*^9}, {
  3.914592447139858*^9, 3.914592459774788*^9}, {3.91459257191473*^9, 
  3.9145926004896293`*^9}, {3.914592760522624*^9, 3.914592789015319*^9}},
 CellLabel->
  "In[430]:=",ExpressionUUID->"77c16501-f2c3-481b-adb5-263ab0c94e65"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Fast operator constructors", "Subsection",
 CellChangeTimes->{{3.910830247159818*^9, 3.910830251221376*^9}, 
   3.911668763916623*^9, {3.911668872273095*^9, 3.9116688726336*^9}, {
   3.911750313425759*^9, 
   3.911750320384669*^9}},ExpressionUUID->"b99c3d2c-2c1d-4673-9ab6-\
0288d3646a7d"],

Cell["Apply linear solve object to last dimension of array", "Text",
 CellChangeTimes->{{3.911750439738579*^9, 
  3.911750449444252*^9}},ExpressionUUID->"1b964aae-0811-4da3-a9ab-\
49b5287f8c1f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"applyTensorLinearSolve", "[", 
   RowBox[{"array_", ",", "solve_", ",", "dout_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "shape", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"shape", "=", 
      RowBox[{"Dimensions", "[", "array", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"array", "//", 
          RowBox[{
           RowBox[{"ArrayReshape", "[", 
            RowBox[{"#", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Times", "@@", 
                RowBox[{"shape", "[", 
                 RowBox[{"[", 
                  RowBox[{";;", 
                   RowBox[{"-", "2"}]}], "]"}], "]"}]}], ",", 
               RowBox[{"shape", "[", 
                RowBox[{"[", 
                 RowBox[{"-", "1"}], "]"}], "]"}]}], "}"}]}], "]"}], "&"}]}], 
         "//", "Transpose"}], "//", "solve"}], "//", "Transpose"}], "//", 
      RowBox[{
       RowBox[{"ArrayReshape", "[", 
        RowBox[{"#", ",", 
         RowBox[{"Append", "[", 
          RowBox[{
           RowBox[{"shape", "[", 
            RowBox[{"[", 
             RowBox[{";;", 
              RowBox[{"-", "2"}]}], "]"}], "]"}], ",", "dout"}], "]"}]}], 
        "]"}], "&"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.911614025480649*^9, 3.911614069936776*^9}, {
   3.911614125092245*^9, 3.91161419990331*^9}, {3.911614230421313*^9, 
   3.911614338829083*^9}, {3.911614606545197*^9, 3.911614606826112*^9}, {
   3.911615030536786*^9, 3.9116150405937977`*^9}, 3.911615106803991*^9, {
   3.91161519444545*^9, 3.911615201129282*^9}, 3.911750434483079*^9, {
   3.91399998765486*^9, 3.913999997387261*^9}, {3.914024684727026*^9, 
   3.914024685942961*^9}, {3.914024729797151*^9, 3.91402474320863*^9}, {
   3.914024802949403*^9, 3.914024853421448*^9}, {3.914263610220335*^9, 
   3.914263621035228*^9}, 3.914266575832121*^9},
 CellLabel->
  "In[432]:=",ExpressionUUID->"c0d724b7-da80-44a9-8d9d-0ecfe9c4c2e3"],

Cell["Create inverse operator from matrix LU factorisation", "Text",
 CellChangeTimes->{{3.911750451881823*^9, 
  3.911750468300141*^9}},ExpressionUUID->"3a62f751-3f78-4902-8618-\
84c0d812836d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"buildInverseOp", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"invop", ",", "shape"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"getSlots", "[", "t", "]"}], "==", "1"}], "&&", 
       RowBox[{
        RowBox[{"getNumDims", "[", "t", "]"}], "==", "2"}], "&&", 
       RowBox[{"Equal", "@@", 
        RowBox[{"getDimShapes", "[", "t", "]"}]}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"invop", "=", 
        RowBox[{"LinearSolve", "[", 
         RowBox[{"N", "[", 
          RowBox[{
           RowBox[{"getArr", "[", "t", "]"}], "\[Transpose]"}], "]"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"shape", "=", 
        RowBox[{
         RowBox[{"getDimShapes", "[", "t", "]"}], "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tensorop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"applyTensorLinearSolve", "[", 
            RowBox[{"#", ",", "invop", ",", "shape"}], "]"}], "&"}], ")"}], 
         ",", 
         RowBox[{"dual", "/@", 
          RowBox[{"Reverse", "[", 
           RowBox[{"getDims", "[", "t", "]"}], "]"}]}], ",", "1"}], "]"}]}]}],
      "\[IndentingNewLine]", "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.911615716183261*^9, 3.911615842197785*^9}, {
   3.9116613865570517`*^9, 3.911661456582613*^9}, {3.9116615473685713`*^9, 
   3.911661549972376*^9}, {3.911661606152842*^9, 3.911661608409463*^9}, 
   3.911661642694617*^9, {3.9116616863634353`*^9, 3.911661741035016*^9}, {
   3.911774406129992*^9, 3.911774412082051*^9}, {3.913999987661747*^9, 
   3.913999987663835*^9}, {3.91402486928975*^9, 3.914025089108376*^9}, {
   3.914025119658629*^9, 3.9140251997736845`*^9}, {3.914426787567833*^9, 
   3.914426805463578*^9}, {3.9144619854810762`*^9, 3.914461986513581*^9}},
 CellLabel->
  "In[433]:=",ExpressionUUID->"13767301-413f-4fa5-bf63-f04d56b344f7"],

Cell["Apply operator to single dimension of tensor", "Text",
 CellChangeTimes->{{3.91175047179346*^9, 3.911750491462028*^9}, {
  3.9139999876807003`*^9, 
  3.9139999974031353`*^9}},ExpressionUUID->"fa291480-8bb0-427a-9d47-\
d5fcacf7e693"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractOne", "[", 
   RowBox[{"t1_tensor", ",", "t2_tensorop", ",", "i_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", "s"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", "=", 
      RowBox[{"getNumDims", "[", "t1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"s", "=", 
      RowBox[{"getSlots", "[", "t1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"t1", "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"permutationSwitch", "[", 
              RowBox[{"i", ",", "n", ",", "n"}], "]"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"iso", "[", 
           RowBox[{"#", ",", 
            RowBox[{"n", "-", "1"}]}], "]"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"#", ".", "t2"}], "&"}]}], "//", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"#", ",", 
          RowBox[{"permutationSwitch", "[", 
           RowBox[{"i", ",", "n", ",", "n"}], "]"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "s"}], "]"}], "&"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.911609579607659*^9, 3.911609579697757*^9}, {
  3.911668822066725*^9, 3.911668829126799*^9}, {3.9139999876898947`*^9, 
  3.913999987691784*^9}, {3.914025252597768*^9, 3.9140252655196333`*^9}, {
  3.914463372212295*^9, 3.914463382152403*^9}, {3.914592871818306*^9, 
  3.914592875217925*^9}, {3.914593126879245*^9, 3.914593127547286*^9}},
 CellLabel->
  "In[434]:=",ExpressionUUID->"964fa9d8-72be-42ae-ab8b-c16fa12bdf69"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"opFs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"opFs", "[", "\"\<Igc\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dim", ",", "NN"}], "}"}], ",", 
     RowBox[{"tensorop", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"a", ",", 
         RowBox[{"Map", "[", 
          RowBox[{"G2C", ",", "a", ",", 
           RowBox[{"{", 
            RowBox[{"-", "2"}], "}"}]}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dim", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<-\>\""}], 
          "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dim", ",", "0"}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
          "}"}]}], "}"}], ",", "1"}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"opFs", "[", "\"\<Icg\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dim", ",", "NN"}], "}"}], ",", 
     RowBox[{"tensorop", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"a", ",", 
         RowBox[{"Map", "[", 
          RowBox[{"C2G", ",", "a", ",", 
           RowBox[{"{", 
            RowBox[{"-", "2"}], "}"}]}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dim", ",", "0"}], "}"}], ",", "NN", ",", "\"\<-\>\""}], 
          "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"dim", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
          "}"}]}], "}"}], ",", "1"}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"opFs", "[", "\"\<Icicj\>\"", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dim", ",", "i0", ",", "i1", ",", "NN"}], "}"}], ",", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "forward", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"forward", "=", 
         RowBox[{"shifts", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"dim", ",", 
             RowBox[{"Min", "[", 
              RowBox[{"i0", ",", "i1"}], "]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"dim", ",", 
             RowBox[{"Max", "[", 
              RowBox[{"i0", ",", "i1"}], "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"i0", "<=", "i1"}], ",", "forward", ",", 
          RowBox[{"i0", ">", "i1"}], ",", 
          RowBox[{"buildInverseOp", "[", "forward", "]"}]}], "]"}]}]}], 
      "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.911669421514449*^9, 3.911669555476437*^9}, {
   3.91166960326207*^9, 3.911669619735219*^9}, {3.911670093889847*^9, 
   3.911670096502625*^9}, {3.911670144789319*^9, 3.911670288336173*^9}, {
   3.911762706579981*^9, 3.911762708996955*^9}, {3.911762909365088*^9, 
   3.9117629098975*^9}, {3.911764285678397*^9, 3.911764297029983*^9}, {
   3.911764806983851*^9, 3.911764830152076*^9}, {3.9139999876958427`*^9, 
   3.913999987698193*^9}, {3.914025381797572*^9, 3.914025417165873*^9}, {
   3.914025451089025*^9, 3.914025451237294*^9}, 3.914587127560213*^9},
 CellLabel->
  "In[435]:=",ExpressionUUID->"216afeaa-23d6-4c8b-86ff-7b3c9a9ba630"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Fast operators for basis change", "Subsection",
 CellChangeTimes->{{3.911750506822928*^9, 
  3.91175051311939*^9}},ExpressionUUID->"73f6516e-b12d-420f-9c80-\
21809ea65f43"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Fs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{"Do", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], "}"}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"opFs", "[", "\"\<Igc\>\"", "]"}], "[", 
      RowBox[{"\"\<x\>\"", ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], "}"}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"opFs", "[", "\"\<Igc\>\"", "]"}], "[", 
      RowBox[{"\"\<y\>\"", ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
         "}"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"opFs", "[", "\"\<Icg\>\"", "]"}], "[", 
      RowBox[{"\"\<x\>\"", ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", 
            RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
         "}"}]}], "}"}], "]"}], "=", 
     RowBox[{
      RowBox[{"opFs", "[", "\"\<Icg\>\"", "]"}], "[", 
      RowBox[{"\"\<y\>\"", ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}]}], "}"}]}], "}"}], "]"}], "=", 
     RowBox[{"tensorop", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"a", ",", 
         RowBox[{"Map", "[", 
          RowBox[{"G2C", ",", "a", ",", 
           RowBox[{"{", 
            RowBox[{"-", "3"}], "}"}]}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<-\>\""}], "}"}],
          ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<-\>\""}], "}"}],
          ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
           "\"\<+\>\""}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
           "\"\<+\>\""}], "}"}]}], "}"}], ",", "2"}], "]"}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<I\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
            "\"\<+\>\""}], "}"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}]}], "}"}]}], "}"}], "]"}], "=", 
     RowBox[{"tensorop", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"a", ",", 
         RowBox[{"Map", "[", 
          RowBox[{"C2G", ",", "a", ",", 
           RowBox[{"{", 
            RowBox[{"-", "3"}], "}"}]}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "n", ",", 
           "\"\<-\>\""}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "n", ",", 
           "\"\<-\>\""}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], "}"}],
          ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", 
             RowBox[{"-", "1"}]}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
          "}"}]}], "}"}], ",", "2"}], "]"}]}], ";", "\n", 
    RowBox[{"Do", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Fs", "[", 
        RowBox[{"{", 
         RowBox[{"\"\<I\>\"", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"dim", ",", "i"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"dim", ",", "j"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
           "}"}]}], "}"}], "]"}], "=", 
       RowBox[{
        RowBox[{"opFs", "[", "\"\<Icicj\>\"", "]"}], "[", 
        RowBox[{"dim", ",", "i", ",", "j", ",", "n"}], "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"dim", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "0", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "0", ",", "2"}], "}"}]}], "]"}], ";"}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{"n", ",", 
     RowBox[{"{", 
      RowBox[{"NN", ",", 
       RowBox[{"NN", "-", "2"}]}], "}"}]}], "}"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.910869835451871*^9, 3.91086983764845*^9}, {
   3.911339561516794*^9, 3.911339562260078*^9}, 3.911604800736678*^9, {
   3.911668986782387*^9, 3.9116690089270287`*^9}, {3.911670377605657*^9, 
   3.911670412556336*^9}, 3.911671110356537*^9, {3.911762625845504*^9, 
   3.911762651365052*^9}, {3.911766076415015*^9, 3.9117660853319407`*^9}, {
   3.913999987705593*^9, 3.9139999877082043`*^9}, {3.914025699224477*^9, 
   3.914025724701242*^9}, {3.914426598056966*^9, 3.914426651112009*^9}, {
   3.9146721203961887`*^9, 3.914672120669011*^9}},
 CellLabel->
  "In[439]:=",ExpressionUUID->"056b2ca6-05d8-4ef5-a005-87bf66d16ec2"],

Cell[BoxData[
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{"Fs", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<I\>\"", ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"c", ",", 
            RowBox[{"s", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"c", ",", 
            RowBox[{"s", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", "n", ",", 
          "\"\<+\>\""}], "}"}], "}"}]}], "}"}], "]"}], "=", 
    RowBox[{"Fs", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<I\>\"", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"c", ",", 
           RowBox[{"s", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", "n", ",", 
         "\"\<+\>\""}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"c", ",", 
           RowBox[{"s", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}], ",", "n", ",", 
         "\"\<+\>\""}], "}"}]}], "}"}], "]"}]}], ",", 
   RowBox[{"{", 
    RowBox[{"c", ",", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"s", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"0", ",", 
         RowBox[{"-", "1"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", "1"}], ",", "0"}], "}"}]}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"n", ",", 
     RowBox[{"{", 
      RowBox[{"NN", ",", 
       RowBox[{"NN", "-", "2"}]}], "}"}]}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.914672200986408*^9, 3.914672295309971*^9}, {
  3.914672439407744*^9, 3.914672457671859*^9}},
 CellLabel->
  "In[441]:=",ExpressionUUID->"f9c1e4b9-c7be-46e1-b83b-4a6db5ec58f3"],

Cell[BoxData[
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{"Fs", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<I\>\"", ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"c", ",", "si"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
         "}"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"c", ",", "sj"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
         "}"}], "}"}]}], "}"}], "]"}], "=", 
    RowBox[{"Fs", "[", 
     RowBox[{"{", 
      RowBox[{"\"\<I\>\"", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"c", ",", "si"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
        "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"c", ",", "sj"}], "}"}], ",", "n", ",", "\"\<+\>\""}], 
        "}"}]}], "}"}], "]"}]}], ",", 
   RowBox[{"{", 
    RowBox[{"c", ",", 
     RowBox[{"{", 
      RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"si", ",", 
     RowBox[{"Range", "[", 
      RowBox[{"0", ",", "2"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"sj", ",", 
     RowBox[{"Range", "[", 
      RowBox[{"0", ",", "2"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"n", ",", 
     RowBox[{"{", 
      RowBox[{"NN", ",", 
       RowBox[{"NN", "-", "2"}]}], "}"}]}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.9146724695502844`*^9, 3.914672502628359*^9}},
 CellLabel->
  "In[442]:=",ExpressionUUID->"23640041-2e9b-4a3f-8fe4-a7cdaecc0b7e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Define multiple transform operators", "Subsection",
 CellChangeTimes->{{3.911766902126893*^9, 
  3.911766912711041*^9}},ExpressionUUID->"c6b696ec-11d7-45f0-907a-\
951fbb149ea2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"toSpace", "[", 
   RowBox[{"t_tensor", ",", "i_", ",", 
    RowBox[{"crit_", ":", 
     RowBox[{"(", 
      RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"changeInds", ",", "changeDims", ",", "transforms"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"changeInds", ",", "changeDims"}], "}"}], "=", 
      RowBox[{"getCoordDims", "[", 
       RowBox[{"t", ",", "crit"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"transforms", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Fs", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<I\>\"", ",", "dim", ",", 
           RowBox[{"changeDimSpace", "[", 
            RowBox[{"dim", ",", "i"}], "]"}]}], "}"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"dim", ",", "changeDims"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"contractOnes", "[", 
      RowBox[{"t", ",", "transforms", ",", "changeInds"}], "]"}]}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.911669097155892*^9, 3.91166910698686*^9}, {
   3.9116691834529533`*^9, 3.911669215829981*^9}, 3.9116708822985907`*^9, {
   3.9116711867306337`*^9, 3.911671261222734*^9}, {3.911697824877366*^9, 
   3.911697834650237*^9}, {3.911697881688292*^9, 3.911697883779913*^9}, {
   3.911698123929051*^9, 3.911698328542991*^9}, {3.911698540023418*^9, 
   3.911698645868803*^9}, 3.911698690101777*^9, {3.911698725704513*^9, 
   3.911698729864201*^9}, {3.911698784582796*^9, 3.911698785937167*^9}, {
   3.911699092325987*^9, 3.91169909945763*^9}, 3.911699293169264*^9, {
   3.911766406368881*^9, 3.911766408550621*^9}, {3.911766493202304*^9, 
   3.911766534379688*^9}, {3.9117668554651623`*^9, 3.911766873535832*^9}, {
   3.911767648273687*^9, 3.911767666431074*^9}, {3.9117678353410397`*^9, 
   3.9117678382276793`*^9}, {3.911768465254972*^9, 3.911768466537554*^9}, {
   3.911768521125402*^9, 3.911768527009486*^9}, {3.911768653677567*^9, 
   3.911768685540475*^9}, {3.911770298651264*^9, 3.91177032059184*^9}, 
   3.913999987711368*^9, {3.914026131677241*^9, 3.914026136115427*^9}, 
   3.914031288425309*^9, {3.914031340362002*^9, 3.914031345542342*^9}, 
   3.914031678496671*^9},
 CellLabel->
  "In[443]:=",ExpressionUUID->"a07f31db-aec4-48ab-8543-4e1142671606"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"convertCoordDimsToSpace", "[", 
    RowBox[{"dims_", ",", "space_"}], "]"}], ":=", 
   RowBox[{"dims", "/.", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"c_String", ",", "i_Integer"}], "}"}], ":>", 
     RowBox[{"{", 
      RowBox[{"c", ",", "space"}], "}"}]}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914464109767836*^9, 3.914464116394965*^9}, {
  3.914464221592533*^9, 3.914464313029127*^9}},
 CellLabel->
  "In[444]:=",ExpressionUUID->"2c4a7b19-af7f-4358-a1d3-f7a2979d7bea"],

Cell[BoxData[
 RowBox[{
  RowBox[{"toGrid", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "n", ",", "s", ",", "outCoordDims", ",", "nc", ",", "transform"}], "}"}],
     ",", "\[IndentingNewLine]", 
    RowBox[{"Which", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"checkGridSpace", "[", "t", "]"}], ",", "\[IndentingNewLine]", 
      "t", ",", "\[IndentingNewLine]", 
      RowBox[{"checkChebSpace", "[", "t", "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"n", "=", 
        RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"s", "=", 
        RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"outCoordDims", "=", 
        RowBox[{
         RowBox[{"getOutCoordDims", "[", "t", "]"}], "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"nc", "=", 
        RowBox[{"Length", "[", "outCoordDims", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"transform", "=", 
        RowBox[{"Fs", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<I\>\"", ",", "outCoordDims", ",", 
           RowBox[{"convertCoordDimsToSpace", "[", 
            RowBox[{"outCoordDims", ",", 
             RowBox[{"-", "1"}]}], "]"}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"t", "//", 
          RowBox[{
           RowBox[{"iso", "[", 
            RowBox[{"#", ",", 
             RowBox[{"n", "-", "nc"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"#", ".", "transform"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"iso", "[", 
          RowBox[{"#", ",", "s"}], "]"}], "&"}]}]}], ",", 
      "\[IndentingNewLine]", "True", ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"t", "//", 
        RowBox[{
         RowBox[{"toSpace", "[", 
          RowBox[{"#", ",", "0", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{"dim", ",", 
               RowBox[{
                RowBox[{"getDimSpace", "[", "dim", "]"}], ">", "0"}]}], "]"}],
              "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}]}], "]"}], "&"}]}], 
       "//", 
       RowBox[{
        RowBox[{"toSpace", "[", 
         RowBox[{"#", ",", 
          RowBox[{"-", "1"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Function", "[", 
             RowBox[{"dim", ",", 
              RowBox[{
               RowBox[{"getDimSpace", "[", "dim", "]"}], "!=", 
               RowBox[{"-", "1"}]}]}], "]"}], "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}]}], "]"}], "&"}]}]}],
      "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.911698856495069*^9, 3.911698865610868*^9}, 
   3.911699238875917*^9, {3.911766412505493*^9, 3.911766414941039*^9}, {
   3.911766568192725*^9, 3.91176657233702*^9}, {3.911767693800834*^9, 
   3.911767729497754*^9}, {3.911773601988038*^9, 3.9117736385022917`*^9}, {
   3.911848783650547*^9, 3.9118488165463*^9}, {3.911848921326406*^9, 
   3.911848942179341*^9}, 3.9139999877140093`*^9, 3.914031367594282*^9, 
   3.914031683184266*^9, {3.914295364391424*^9, 3.914295386708698*^9}, {
   3.914463462527543*^9, 3.914463471397573*^9}, {3.914463701417932*^9, 
   3.91446373385959*^9}, {3.914463780304233*^9, 3.914463962969969*^9}, {
   3.91446432907178*^9, 3.914464463702669*^9}, 3.91446472557428*^9, {
   3.914464763887798*^9, 3.91446477408665*^9}},
 CellLabel->
  "In[445]:=",ExpressionUUID->"16caa552-6598-410d-ba87-765e2dce6b9c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"toCoeff", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "n", ",", "s", ",", "outCoordDims", ",", "nc", ",", "transform"}], "}"}],
     ",", "\[IndentingNewLine]", 
    RowBox[{"Which", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"checkCoeffSpace", "[", "t", "]"}], ",", "\[IndentingNewLine]", 
      "\t", "t", ",", "\[IndentingNewLine]", 
      RowBox[{"checkGridSpace", "[", "t", "]"}], ",", "\[IndentingNewLine]", 
      "\t", 
      RowBox[{
       RowBox[{"n", "=", 
        RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
       "\t", 
       RowBox[{"s", "=", 
        RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
       "\t", 
       RowBox[{"outCoordDims", "=", 
        RowBox[{
         RowBox[{"getOutCoordDims", "[", "t", "]"}], "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", "\t", 
       RowBox[{"nc", "=", 
        RowBox[{"Length", "[", "outCoordDims", "]"}]}], ";", 
       "\[IndentingNewLine]", "\t", 
       RowBox[{"transform", "=", 
        RowBox[{"Fs", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<I\>\"", ",", "outCoordDims", ",", 
           RowBox[{"convertCoordDimsToSpace", "[", 
            RowBox[{"outCoordDims", ",", "0"}], "]"}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\t", 
       RowBox[{
        RowBox[{
         RowBox[{"t", "//", 
          RowBox[{
           RowBox[{"iso", "[", 
            RowBox[{"#", ",", 
             RowBox[{"n", "-", "nc"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"#", ".", "transform"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"iso", "[", 
          RowBox[{"#", ",", "s"}], "]"}], "&"}]}]}], ",", 
      "\[IndentingNewLine]", "True", ",", "\[IndentingNewLine]", "\t", 
      RowBox[{"toSpace", "[", 
       RowBox[{"t", ",", "0", ",", 
        RowBox[{
         RowBox[{
          RowBox[{"Function", "[", 
           RowBox[{"dim", ",", 
            RowBox[{
             RowBox[{"getDimSpace", "[", "dim", "]"}], "==", 
             RowBox[{"-", "1"}]}]}], "]"}], "[", 
          RowBox[{"#", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}]}], "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",\

 CellChangeTimes->{{3.911766575144503*^9, 3.911766613232319*^9}, {
   3.911767737640822*^9, 3.911767758020176*^9}, {3.911773650917023*^9, 
   3.911773654768564*^9}, 3.913999987716583*^9, {3.91402618532618*^9, 
   3.9140261898555517`*^9}, {3.914295392371036*^9, 3.9142953985712347`*^9}, {
   3.914593463922936*^9, 3.914593493285026*^9}, {3.914593638898175*^9, 
   3.9145937800482063`*^9}, {3.9145938633822317`*^9, 3.914593863640245*^9}, {
   3.91459400632601*^9, 3.914594027765411*^9}},
 CellLabel->
  "In[446]:=",ExpressionUUID->"75040682-97c1-4628-806c-dbf5e8532d2d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Vector space transforms", "Subsection",
 CellChangeTimes->{
  3.913902060857054*^9, {3.913943893610465*^9, 3.913943904664962*^9}, {
   3.913987240824922*^9, 
   3.913987242808207*^9}},ExpressionUUID->"5a588546-7642-4b4a-a22d-\
10a4d67eb317"],

Cell[BoxData[
 RowBox[{
  RowBox[{"selectDifferentPairs", "[", 
   RowBox[{"list1_", ",", "list2_"}], "]"}], ":=", 
  RowBox[{"MapThread", "[", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"i", ",", "e1i", ",", "e2i"}], "}"}], ",", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Not", "[", 
         RowBox[{"e1i", "===", "e2i"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "e1i", ",", "e2i"}], "}"}], ",", "Nothing"}], 
       "]"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Range", "[", 
       RowBox[{"Length", "[", "list1", "]"}], "]"}], ",", "list1", ",", 
      "list2"}], "}"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.913988536400248*^9, 3.913988609709395*^9}},
 CellLabel->
  "In[447]:=",ExpressionUUID->"1d7f6f0c-d109-437a-b885-48f48ce3e6c5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"transformBundle", "[", 
   RowBox[{"t_tensor", ",", "dimList_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"out", ",", "changePairs", ",", "transforms"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"dimList", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "0"}], "]"}], "]"}], "===", "Rule"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"transformBundle", "[", 
       RowBox[{"t", ",", 
        RowBox[{"ReplacePart", "[", 
         RowBox[{
          RowBox[{"getDims", "[", "t", "]"}], ",", 
          RowBox[{"dimList", "/.", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"a_", "->", "b_String"}], ")"}], ":>", 
            RowBox[{"(", 
             RowBox[{"a", "->", 
              RowBox[{"convertStringToDim", "[", "b", "]"}]}], ")"}]}]}]}], 
         "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"out", "=", 
        RowBox[{"t", "//", "toGrid"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"changePairs", "=", 
        RowBox[{"selectDifferentPairs", "[", 
         RowBox[{
          RowBox[{"getDims", "[", "t", "]"}], ",", "dimList"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{"out", "=", 
          RowBox[{"contractGridTransform", "[", 
           RowBox[{"out", ",", 
            RowBox[{"getGridTransform", "@@", 
             RowBox[{"pair", "[", 
              RowBox[{"[", 
               RowBox[{"2", ";;"}], "]"}], "]"}]}], ",", 
            RowBox[{"pair", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"pair", ",", "changePairs"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "out"}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.913987862148449*^9, 3.913987902913058*^9}, {
   3.91398795231032*^9, 3.913987954457954*^9}, {3.913988050863587*^9, 
   3.913988095667127*^9}, {3.9139881442668867`*^9, 3.913988194639589*^9}, {
   3.913988270651688*^9, 3.91398830381568*^9}, {3.913988351496457*^9, 
   3.9139883565105047`*^9}, {3.913988630416004*^9, 3.9139886534452763`*^9}, {
   3.91398879215685*^9, 3.91398879790068*^9}, {3.9139890778208*^9, 
   3.913989123871041*^9}, {3.9139892180072*^9, 3.913989306085699*^9}, 
   3.913999987839917*^9, {3.914033349829654*^9, 3.9140333656800613`*^9}, {
   3.914033412424955*^9, 3.914033514320776*^9}, {3.914033569633198*^9, 
   3.914033655244832*^9}, {3.914033686177064*^9, 3.914033768757842*^9}, {
   3.9140347421285686`*^9, 3.914035021848315*^9}, {3.914035061699168*^9, 
   3.914035064672523*^9}, {3.914035098866699*^9, 3.91403510496581*^9}, {
   3.914035174520848*^9, 3.914035177172244*^9}, {3.914035444200465*^9, 
   3.914035452847595*^9}, {3.914035495179797*^9, 3.914035505475441*^9}, {
   3.914063736225094*^9, 3.9140637945260983`*^9}, {3.914063964244288*^9, 
   3.914063974754817*^9}, {3.914064052610087*^9, 3.914064092445697*^9}, {
   3.914064124062521*^9, 3.914064124687607*^9}, 3.914064204143613*^9, {
   3.914064275467227*^9, 3.9140642822981987`*^9}, {3.914294739690221*^9, 
   3.914294743167482*^9}, {3.914294777890051*^9, 3.9142947897927217`*^9}, {
   3.914294845191433*^9, 3.914294919347765*^9}, {3.914294955099999*^9, 
   3.914294958873571*^9}, {3.914295527002269*^9, 3.914295635491336*^9}, {
   3.914295730638651*^9, 3.9142957315294113`*^9}, {3.914295790129987*^9, 
   3.914295802916637*^9}, {3.91429592431399*^9, 3.9142959958122783`*^9}},
 CellLabel->
  "In[448]:=",ExpressionUUID->"2465533f-bf63-4b4f-8049-704ee99e5c40"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"transformBundle", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Xg", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914464952358251*^9, 3.914464981888352*^9}},
 CellLabel->
  "In[449]:=",ExpressionUUID->"c1c89adc-94dc-425d-b0f4-f481e765ae74"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"NTs", "[", "Xg", "]"}], "\[CenterDot]", 
    RowBox[{"NTs", "[", "Kg", "]"}]}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914464992160963*^9, 3.914465007315753*^9}},
 CellLabel->
  "In[451]:=",ExpressionUUID->"af90b59b-c26b-4cec-bbd3-0322834fd9cf"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"TensorProdContractMult", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"NTs", "[", "Xg", "]"}], "[", 
      RowBox[{"[", "1", "]"}], "]"}], ",", 
     RowBox[{
      RowBox[{"NTs", "[", "Kg", "]"}], "[", 
      RowBox[{"[", "1", "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"1", ",", "1"}], "}"}], "}"}], ",", "2"}], "]"}], "//", 
   "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914465034150443*^9, 3.914465072800761*^9}},
 CellLabel->
  "In[452]:=",ExpressionUUID->"6c634ea0-8c58-4237-b540-6b03521b8b82"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Partial derivatives operator", "Subsection",
 CellChangeTimes->{{3.911750531831019*^9, 3.911750533404944*^9}, {
  3.911773925557355*^9, 
  3.911773928445939*^9}},ExpressionUUID->"a04b9664-f07b-4a8c-841d-\
d09da67e476a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Fs", "[", 
      RowBox[{"{", 
       RowBox[{"\"\<D\>\"", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"d", ",", "i"}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
         "}"}]}], "}"}], "]"}], "=", 
     RowBox[{"diff", "[", 
      RowBox[{"NN", ",", 
       RowBox[{"{", 
        RowBox[{"d", ",", "i"}], "}"}]}], "]"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"d", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<x\>\"", ",", "\"\<y\>\""}], "}"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "1", ",", "2"}], "}"}]}], "}"}]}], "]"}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.911760187668802*^9, 3.911760192449333*^9}, {
  3.9117602356831*^9, 3.911760275484188*^9}, {3.911761197250031*^9, 
  3.911761197302353*^9}, {3.911762712911292*^9, 3.911762713560703*^9}, {
  3.911770579650331*^9, 3.911770603735661*^9}, {3.911770870915914*^9, 
  3.911770872471081*^9}},
 CellLabel->
  "In[453]:=",ExpressionUUID->"f4c7a106-b313-403a-954a-2c407fd0f9c5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcPartial", "[", 
   RowBox[{"t_tensor", ",", "name_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "coordStrings", ",", "newDims", ",", 
      "funcs", ",", "coordIndex", ",", "coordSpace", ",", "transform", ",", 
      "coordRank"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"t", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Not", "[", 
         RowBox[{"checkCoeffSpace", "[", "t", "]"}], "]"}], ",", 
        RowBox[{"t", "//", "toCoeff"}], ",", "t"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{"getOutCoordDims", "[", "t", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordStrings", "=", 
      RowBox[{"coordDims", "[", 
       RowBox[{"[", 
        RowBox[{";;", ",", "1", ",", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"coordRank", "=", 
      RowBox[{
       RowBox[{"FirstPosition", "[", 
        RowBox[{"coordDims", ",", "name"}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"coordIndex", "=", 
      RowBox[{"coordInds", "[", 
       RowBox[{"[", "coordRank", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"coordSpace", "=", 
      RowBox[{"getDimSpace", "[", 
       RowBox[{
        RowBox[{"getDims", "[", "t", "]"}], "[", 
        RowBox[{"[", "coordIndex", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"newDims", "=", 
       RowBox[{
        RowBox[{"getOutDims", "[", "t", "]"}], "/.", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"c_", "/;", 
             RowBox[{"MemberQ", "[", 
              RowBox[{
               RowBox[{"rules", "[", 
                RowBox[{"[", 
                 RowBox[{";;", ",", "1"}], "]"}], "]"}], ",", "c"}], "]"}]}], 
            ")"}], ",", "i_Integer"}], "}"}], ":>", 
         RowBox[{"{", 
          RowBox[{"c", ",", 
           RowBox[{"c", "/.", "rules"}]}], "}"}]}]}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"transform", "=", 
      RowBox[{"Fs", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<D\>\"", ",", 
         RowBox[{
          RowBox[{"getDims", "[", "t", "]"}], "[", 
          RowBox[{"[", "coordIndex", "]"}], "]"}]}], "}"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"contractOne", "[", 
      RowBox[{
       RowBox[{"t", "//", "toCoeff"}], ",", "transform", ",", "coordIndex"}], 
      "]"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.914070425874582*^9, 3.914070431126486*^9}, {
   3.914070916805893*^9, 3.9140709191470337`*^9}, {3.914070949781343*^9, 
   3.914071041876061*^9}, {3.914071116335059*^9, 3.914071117261499*^9}, {
   3.914071207019272*^9, 3.914071238477815*^9}, {3.914071529726729*^9, 
   3.914071685487265*^9}, {3.914071761987177*^9, 3.914071801145524*^9}, {
   3.9140718442843857`*^9, 3.914071869471215*^9}, {3.914071913040277*^9, 
   3.914072037571039*^9}, {3.914072075986685*^9, 3.914072315487855*^9}, {
   3.914072357869135*^9, 3.914072387236506*^9}, {3.914072418410696*^9, 
   3.914072446645155*^9}, {3.914072481564292*^9, 3.914072526177259*^9}, {
   3.914286367170369*^9, 3.914286367541923*^9}, {3.914286415141851*^9, 
   3.914286415415623*^9}, {3.91428648534365*^9, 3.914286493836128*^9}, 
   3.9143626783098707`*^9, {3.9143718349215393`*^9, 3.914371853818262*^9}, {
   3.914454211279042*^9, 3.914454211424054*^9}, {3.914602055647828*^9, 
   3.914602057135475*^9}, {3.914602139726994*^9, 3.914602211356923*^9}, {
   3.914602350487609*^9, 3.914602425366553*^9}, {3.914602680753995*^9, 
   3.9146026835766063`*^9}, {3.914602722845275*^9, 3.914602736177376*^9}, {
   3.914602788361421*^9, 3.914602850534297*^9}, {3.914602887646343*^9, 
   3.914602907526733*^9}, {3.914602964505226*^9, 3.914603080052944*^9}, {
   3.914603115618588*^9, 3.914603118117972*^9}, {3.914603200181579*^9, 
   3.914603225717663*^9}, {3.914603270133916*^9, 3.914603295515039*^9}, {
   3.914603678589753*^9, 3.91460385255538*^9}, {3.914603884383452*^9, 
   3.914603885669352*^9}},
 CellLabel->
  "In[454]:=",ExpressionUUID->"96cc154d-52d8-45a7-8d78-ff6dc476ea97"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcPartials", "[", 
   RowBox[{"t_tensor", ",", 
    RowBox[{"crit_", ":", 
     RowBox[{"(", 
      RowBox[{"True", "&"}], ")"}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "changeInds", ",", "changeDims", ",", "transforms", ",", "coords", ",", 
      "partials", ",", "maxInd", ",", "tc"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"t", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Not", "[", 
         RowBox[{"checkCoeffSpace", "[", "t", "]"}], "]"}], ",", 
        RowBox[{"t", "//", "toCoeff"}], ",", "t"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"changeInds", ",", "changeDims"}], "}"}], "=", 
      RowBox[{"getCoordDims", "[", 
       RowBox[{"t", ",", "crit"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"coords", "=", 
      RowBox[{"getDimCoord", "/@", "changeDims"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"maxInd", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"getDimSpace", "[", "dim", "]"}], "+", "1"}], ",", 
         RowBox[{"{", 
          RowBox[{"dim", ",", "changeDims"}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"partials", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i", ",", "c"}], "}"}], ",", 
          RowBox[{
           RowBox[{"dense", "[", 
            RowBox[{"covec", "[", 
             RowBox[{"2", ",", 
              RowBox[{"i", "-", "1"}], ",", 
              RowBox[{"StringJoin", "[", "coords", "]"}]}], "]"}], "]"}], 
           "\[TensorProduct]", 
           RowBox[{"calcPartial", "[", 
            RowBox[{"t", ",", "c"}], "]"}]}]}], "]"}], ",", 
        RowBox[{
         RowBox[{"enumerate", "[", "coords", "]"}], "\[Transpose]"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"toSpace", "[", 
        RowBox[{"ti", ",", "maxInd", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Function", "[", 
            RowBox[{"dim", ",", 
             RowBox[{
              RowBox[{"getDimSpace", "[", "dim", "]"}], "!=", "maxInd"}]}], 
            "]"}], "[", 
           RowBox[{"#", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"ti", ",", "partials"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.91177124536068*^9, 3.911771265767981*^9}, {
   3.911771304204019*^9, 3.911771324275853*^9}, {3.911771727702696*^9, 
   3.911771816022133*^9}, {3.911771848278754*^9, 3.911771915711765*^9}, {
   3.911771962517137*^9, 3.911772065929802*^9}, {3.91177211525164*^9, 
   3.9117721202147*^9}, {3.911772152900546*^9, 3.91177217035887*^9}, {
   3.911773245421223*^9, 3.9117733331699333`*^9}, {3.911773403044382*^9, 
   3.91177354263233*^9}, {3.911773776297155*^9, 3.911773889802213*^9}, {
   3.9118483674827147`*^9, 3.911848373945335*^9}, {3.911862227765608*^9, 
   3.911862231489962*^9}, {3.912148102377015*^9, 3.912148103971946*^9}, 
   3.913999987720372*^9, {3.9140262174436483`*^9, 3.9140262274564342`*^9}, 
   3.9140286517415047`*^9, {3.914030780793589*^9, 3.914030793132034*^9}, {
   3.914030825685639*^9, 3.914030829145958*^9}, 3.914423169725877*^9, {
   3.9144232212356863`*^9, 3.914423225159988*^9}, {3.914423292422944*^9, 
   3.9144232962672033`*^9}, {3.914423341556342*^9, 3.914423353082674*^9}, 
   3.914423385477275*^9, 3.914423581884147*^9, {3.914423650414773*^9, 
   3.914423659599326*^9}, {3.914594190761039*^9, 3.914594224834756*^9}, {
   3.914594364321272*^9, 3.914594366931561*^9}, {3.914594796107592*^9, 
   3.914594809466345*^9}, {3.9146014915427523`*^9, 3.914601515707184*^9}, {
   3.914601560712311*^9, 3.9146015838229938`*^9}, {3.91460164175092*^9, 
   3.914601701545132*^9}, {3.914601741133252*^9, 3.91460174536487*^9}, {
   3.9146040777386627`*^9, 3.914604104671123*^9}, {3.914604153122233*^9, 
   3.914604171427106*^9}, {3.91460420965406*^9, 3.914604223948591*^9}, {
   3.9146042631711483`*^9, 3.914604325580989*^9}, {3.9146044533387113`*^9, 
   3.914604498145685*^9}, {3.914607508112021*^9, 3.914607516369199*^9}},
 CellLabel->
  "In[455]:=",ExpressionUUID->"4ce1ef70-0780-49da-80ca-f889d24f7509"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ds", "=", 
   RowBox[{"calcPartialsTensor", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"NTs", "[", "Xg", "]"}], "//", "toCoeff"}], ",", 
     RowBox[{"{", "}"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914607415501042*^9, 3.914607441277394*^9}},
 CellLabel->
  "In[456]:=",ExpressionUUID->"71d330e7-a44d-4380-8721-d68a163136a1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{"partials", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"NTs", "[", "Xg", "]"}], "//", "toCoeff"}], "//", 
       RowBox[{
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{"Function", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"diffOp", ",", "i"}], "}"}], ",", 
            RowBox[{"contractOne", "[", 
             RowBox[{"#", ",", "diffOp", ",", "i"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Fs", "[", 
               RowBox[{"{", 
                RowBox[{"\"\<D\>\"", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
                   "\"\<+\>\""}], "}"}]}], "}"}], "]"}], ",", 
              RowBox[{"Fs", "[", 
               RowBox[{"{", 
                RowBox[{"\"\<D\>\"", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
                   "\"\<+\>\""}], "}"}]}], "}"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "3"}], "}"}]}], "}"}]}], "]"}], "&"}]}]}], 
     ";"}], ")"}], 
   RowBox[{"(*", 
    RowBox[{"//", 
     RowBox[{
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"deriv", ",", "i"}], "}"}], ",", 
          RowBox[{
           RowBox[{"dense", "[", 
            RowBox[{"covec", "[", 
             RowBox[{"2", ",", 
              RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], "]"}], 
           "\[TensorProduct]", "deriv"}]}], "]"}], ",", 
        RowBox[{"Reverse", "[", 
         RowBox[{
          RowBox[{"enumerate", "[", "#", "]"}], "\[Transpose]"}], "]"}]}], 
       "]"}], "&"}]}], "*)"}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914594831458841*^9, 3.9145948910688667`*^9}, {
  3.91459492646461*^9, 3.914595038084136*^9}, {3.914595083204719*^9, 
  3.914595279326826*^9}, {3.9145954321995907`*^9, 3.914595443948577*^9}, {
  3.914595536687656*^9, 3.91459554601098*^9}, {3.914595576667666*^9, 
  3.914595589320878*^9}, {3.9146011978737373`*^9, 3.914601203322835*^9}, {
  3.914607615362732*^9, 3.914607640561565*^9}},
 CellLabel->
  "In[457]:=",ExpressionUUID->"98cba180-1db8-4872-9d5e-a24691ba7217"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"partials", "//", 
    RowBox[{
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"deriv", ",", "i"}], "}"}], ",", 
         RowBox[{
          RowBox[{"dense", "[", 
           RowBox[{"covec", "[", 
            RowBox[{"2", ",", 
             RowBox[{"i", "-", "1"}], ",", "\"\<xy\>\""}], "]"}], "]"}], 
          "\[TensorProduct]", "deriv"}]}], "]"}], ",", 
       RowBox[{"Reverse", "[", 
        RowBox[{
         RowBox[{"enumerate", "[", "#", "]"}], "\[Transpose]"}], "]"}]}], 
      "]"}], "&"}]}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914601183805695*^9, 3.914601193110034*^9}},
 CellLabel->
  "In[458]:=",ExpressionUUID->"b05e036d-67e7-4f0e-8a2b-352e1134fc9c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Gradient operator", "Subsection",
 CellChangeTimes->{{3.911773958539058*^9, 3.911773973974944*^9}, {
  3.911871602940707*^9, 
  3.911871603806952*^9}},ExpressionUUID->"f12f67cf-ebb5-4ea1-879f-\
03184a47f38d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"jacobians", "=", 
   RowBox[{"<|", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<xy+\>\"", ",", "\"\<XY+\>\""}], "}"}], "->", 
      RowBox[{"NTs", "[", "Jg", "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<XY+\>\"", ",", "\"\<xy+\>\""}], "}"}], "->", 
      RowBox[{"NTs", "[", "Kg", "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<xy-\>\"", ",", "\"\<XY-\>\""}], "}"}], "->", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"NTs", "[", "Kg", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "1", ",", "3", ",", "4"}], "}"}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<XY-\>\"", ",", "\"\<xy-\>\""}], "}"}], "->", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"NTs", "[", "Jg", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "1", ",", "3", ",", "4"}], "}"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.9118529410069304`*^9, 3.911852982426677*^9}, {
  3.911853014399273*^9, 3.911853060493588*^9}, {3.911853122274401*^9, 
  3.911853127633766*^9}, {3.911853157858419*^9, 3.911853183532465*^9}},
 CellLabel->
  "In[459]:=",ExpressionUUID->"b7aae5d8-4cc8-4a04-bce1-f6b0796ffa8a"],

Cell[TextData[{
 "The connection coefficients ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{"\[CapitalGamma]", "[", 
      RowBox[{"a", ",", "b", ",", "c"}], "]"}], "[", 
     RowBox[{"i", ",", "j", ",", "k"}], "]"}], "=", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"e", "[", 
          RowBox[{"b", ";", "j"}], "]"}], "\[CenterDot]", "\[Del]"}], ")"}], 
       "[", 
       RowBox[{"e", "[", 
        RowBox[{"a", ";", "i"}], "]"}], "]"}], ")"}], "\[CenterDot]", 
     SuperscriptBox[
      RowBox[{"e", "[", 
       RowBox[{"c", ";", "k"}], "]"}], "*"]}]}], TraditionalForm]],
  ExpressionUUID->"c0be8907-df9b-4fd9-a539-99594bd6c00c"],
 " for the ",
 Cell[BoxData[
  FormBox["i", TraditionalForm]],ExpressionUUID->
  "76a6d06b-322d-4202-86f7-8f8e4f4bfb08"],
 "th basis vector of the ",
 Cell[BoxData[
  FormBox["a", TraditionalForm]],ExpressionUUID->
  "b5f88b50-0b81-4b14-80c5-44c85e61edb0"],
 " frame, differentiated in the ",
 Cell[BoxData[
  FormBox["j", TraditionalForm]],ExpressionUUID->
  "65d5e17b-c473-44b9-95ae-02b6334edcd9"],
 "th direction of the ",
 Cell[BoxData[
  FormBox["b", TraditionalForm]],ExpressionUUID->
  "b1bbf49e-a256-4342-9559-5e526145d9d1"],
 " frame, expressed in the ",
 Cell[BoxData[
  FormBox["k", TraditionalForm]],ExpressionUUID->
  "86c19b13-fd1b-4d1f-9af7-2dadac11b6e7"],
 "th component of the ",
 Cell[BoxData[
  FormBox["c", TraditionalForm]],ExpressionUUID->
  "7eda8290-a1d3-44ca-9291-877f0d572b56"],
 " frame"
}], "Text",
 CellChangeTimes->{{3.911864913988221*^9, 
  3.911865085818125*^9}},ExpressionUUID->"63299a5d-acdb-4210-901b-\
46256bfbca9e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"connections", "=", 
   RowBox[{"<|", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<xy+\>\"", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "}"}], 
      "->", 
      RowBox[{"iso", "[", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"NTs", "[", "\[CapitalGamma]g", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "1", ",", "3", ",", "4", ",", "5"}], "}"}]}], 
         "]"}], ",", "1"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<xy-\>\"", ",", "\"\<xy\>\"", ",", "\"\<xy-\>\""}], "}"}], 
      "->", 
      RowBox[{"iso", "[", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"-", 
           RowBox[{"NTs", "[", "\[CapitalGamma]g", "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "2", ",", "1", ",", "4", ",", "5"}], "}"}]}], 
         "]"}], ",", "1"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<XY+\>\"", ",", "\"\<xy\>\"", ",", "\"\<XY+\>\""}], "}"}], 
      "->", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "2", ",", "2", ",", "NN", ",", "NN"}], "}"}]}], 
         "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
           "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
           "}"}]}], "}"}], ",", "1"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"\"\<XY-\>\"", ",", "\"\<xy\>\"", ",", "\"\<XY-\>\""}], "}"}], 
      "->", 
      RowBox[{"tensor", "[", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "2", ",", "2", ",", "NN", ",", "NN"}], "}"}]}], 
         "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<-\>\""}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
           "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", 
              RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
           "}"}]}], "}"}], ",", "1"}], "]"}]}]}], "\[IndentingNewLine]", 
    "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.911853185632658*^9, 3.9118531939831214`*^9}, {
  3.91185359950283*^9, 3.911853607220031*^9}, {3.911853754999134*^9, 
  3.911853803222499*^9}, {3.911853927633709*^9, 3.911854023310367*^9}, {
  3.911854072635676*^9, 3.911854124632033*^9}, {3.911862355684843*^9, 
  3.911862356378572*^9}, {3.911862842606615*^9, 3.91186293165283*^9}, {
  3.911864693769369*^9, 3.911864702133353*^9}, {3.911864811985529*^9, 
  3.911864814828092*^9}, {3.911864893546041*^9, 3.911864910621625*^9}, {
  3.91186522022138*^9, 3.911865221752047*^9}, {3.911865260254211*^9, 
  3.9118652625819607`*^9}, {3.911865299377851*^9, 3.911865300421179*^9}, {
  3.911866449220189*^9, 3.911866472007015*^9}, {3.912218201852869*^9, 
  3.912218209648733*^9}, {3.913999987737495*^9, 3.913999987740059*^9}, {
  3.914029790062437*^9, 3.914029815103531*^9}},
 CellLabel->
  "In[460]:=",ExpressionUUID->"2087c2f7-62ed-40bb-acda-7930141fa02b"],

Cell["\<\
Minimal permutation that sends dimensions to targets, while preserving \
relative ordering of unspecified dimensions\
\>", "Text",
 CellChangeTimes->{{3.9118674474706583`*^9, 
  3.91186747263212*^9}},ExpressionUUID->"7d73a9e1-1828-47e8-8a30-\
222006973db5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractGridTransform", "[", 
   RowBox[{"t_tensor", ",", "m_tensor", ",", "index_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "numCoords", ",", "numDims", ",", 
      "numBundles", ",", "numIn"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{
       RowBox[{"getCoordDims", "/@", 
        RowBox[{"{", 
         RowBox[{"t", ",", "m"}], "}"}]}], "//", "Transpose"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"numIn", "=", 
      RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numCoords", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"coordInds", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numDims", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numBundles", "=", 
      RowBox[{"numDims", "-", "numCoords"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"t", "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"calcMultiPermutation", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"index", "->", "numBundles"}], "}"}], ",", 
               "numDims"}], "]"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"iso", "[", 
           RowBox[{"#", ",", 
            RowBox[{"numBundles", "-", "1"}]}], "]"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"contractGrid", "[", 
          RowBox[{"#", ",", "m"}], "]"}], "&"}]}], "//", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"#", ",", 
          RowBox[{"calcMultiPermutation", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"numBundles", "->", "index"}], "}"}], ",", "numDims"}], 
           "]"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "numIn"}], "]"}], "&"}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.911872803971819*^9, 3.911872839769023*^9}, {
  3.911872911717164*^9, 3.911872937481517*^9}, {3.91399998774352*^9, 
  3.913999987745524*^9}, {3.91402984038218*^9, 3.914029873146181*^9}, {
  3.91428604612568*^9, 3.914286046737454*^9}},
 CellLabel->
  "In[461]:=",ExpressionUUID->"d3f4ee6f-9202-437d-a7a9-b0d00dea5c96"],

Cell[BoxData[
 RowBox[{
  RowBox[{"contractGridConnection", "[", 
   RowBox[{"t_tensor", ",", "c_tensor", ",", "index_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "coordInds", ",", "coordDims", ",", "numCoords", ",", "numDims", ",", 
      "numBundles", ",", "numIn"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"coordInds", ",", "coordDims"}], "}"}], "=", 
      RowBox[{
       RowBox[{"getCoordDims", "/@", 
        RowBox[{"{", 
         RowBox[{"t", ",", "c"}], "}"}]}], "//", "Transpose"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"numIn", "=", 
      RowBox[{"getSlots", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numCoords", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"coordInds", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numDims", "=", 
      RowBox[{"getNumDims", "[", "t", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numBundles", "=", 
      RowBox[{"numDims", "-", "numCoords"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"t", "//", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"#", ",", 
             RowBox[{"calcMultiPermutation", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"index", "->", "numBundles"}], "}"}], ",", 
               "numDims"}], "]"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"iso", "[", 
           RowBox[{"#", ",", 
            RowBox[{"numBundles", "-", "1"}]}], "]"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{"contractGrid", "[", 
          RowBox[{"#", ",", "c"}], "]"}], "&"}]}], "//", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"#", ",", 
          RowBox[{"calcMultiPermutation", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"numBundles", "->", "1"}], ",", 
              RowBox[{
               RowBox[{"numBundles", "+", "1"}], "->", 
               RowBox[{"index", "+", "1"}]}]}], "}"}], ",", 
            RowBox[{"numDims", "+", "1"}]}], "]"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", 
         RowBox[{"numIn", "+", "1"}]}], "]"}], "&"}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.9118544349062405`*^9, 3.911854438953434*^9}, {
   3.911854477405525*^9, 3.911854493699247*^9}, 3.911854529461481*^9, 
   3.911854838049194*^9, {3.9118549454115057`*^9, 3.911854954839248*^9}, {
   3.91186373574205*^9, 3.911863792870679*^9}, {3.911864168088466*^9, 
   3.911864418734194*^9}, {3.911864473980772*^9, 3.911864527266698*^9}, {
   3.911864568536735*^9, 3.911864610279891*^9}, {3.911865492221526*^9, 
   3.911865521686411*^9}, {3.911865572045066*^9, 3.911865580546142*^9}, {
   3.911865991551866*^9, 3.911866058657175*^9}, {3.911866101255547*^9, 
   3.911866107348631*^9}, {3.911866149560538*^9, 3.911866158845276*^9}, {
   3.911866720238781*^9, 3.911866723627295*^9}, {3.911866814813043*^9, 
   3.911866815474148*^9}, {3.911867188651906*^9, 3.91186720377759*^9}, {
   3.911869222021791*^9, 3.9118692826014357`*^9}, {3.911869312955257*^9, 
   3.911869406307781*^9}, 3.9118694541191835`*^9, {3.91186949220808*^9, 
   3.911869619474011*^9}, {3.911871668919305*^9, 3.911871675049274*^9}, {
   3.913999987749619*^9, 3.913999987752271*^9}, {3.914029895168832*^9, 
   3.914029917990625*^9}},
 CellLabel->
  "In[462]:=",ExpressionUUID->"f4633e20-f5fe-4b46-b27a-f866df1baf6c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"calcGradNOp", "[", "t_tensor", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"partials", ",", "bundlePairs", ",", "conns", ",", "tG"}], "}"}],
     ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"partials", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"t", "//", "toCoeff"}], "//", "calcPartials"}], "//", 
       "toGrid"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"bundlePairs", "=", 
      RowBox[{
       RowBox[{"getBundleDims", "[", "t", "]"}], "\[Transpose]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tG", "=", 
      RowBox[{"t", "//", "toGrid"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"conns", "=", 
      RowBox[{"Sum", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"index", ",", "dim"}], "}"}], ",", 
           RowBox[{"contractGridConnection", "[", 
            RowBox[{"tG", ",", 
             RowBox[{"connections", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"#", ",", "\"\<xy\>\"", ",", "#"}], "}"}], "&"}], 
               "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"dim", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "<>", 
                 RowBox[{"dim", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}], ")"}]}], "]"}], ",", 
             "index"}], "]"}]}], "]"}], "@@", "bundle"}], ",", 
        RowBox[{"{", 
         RowBox[{"bundle", ",", "bundlePairs"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"partials", "+", "conns"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.911871130200577*^9, 3.911871396610465*^9}, {
   3.911871741723217*^9, 3.911871745422848*^9}, {3.911871815987486*^9, 
   3.911871837356015*^9}, {3.911871901045385*^9, 3.91187204983257*^9}, 
   3.913999987755774*^9, 3.914029946429302*^9, {3.914030085603914*^9, 
   3.914030086272077*^9}, 3.914030605275509*^9, {3.914030887669083*^9, 
   3.914030926619236*^9}, {3.914031069744102*^9, 3.91403107510352*^9}, {
   3.914031768118005*^9, 3.914031770203695*^9}, {3.914031983822296*^9, 
   3.914031996282254*^9}, {3.9142666483141747`*^9, 3.914266652696896*^9}, {
   3.914423065686759*^9, 3.914423079539151*^9}, {3.91442376412423*^9, 
   3.914423766258844*^9}},
 CellLabel->
  "In[463]:=",ExpressionUUID->"bc71ac90-17b4-49e3-a9bb-8a8b7388f15b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"transformBundle", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Xg", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914460351433468*^9, 3.9144603762206507`*^9}},
 CellLabel->
  "In[464]:=",ExpressionUUID->"eafc78cb-7428-48cf-9f8e-995d58171910"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"calcPartials", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Xg", "]"}], "//", "toCoeff"}], "]"}], "//", 
   "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.9146078028131332`*^9, 3.914607820729656*^9}},
 CellLabel->
  "In[465]:=",ExpressionUUID->"c4258cc0-acd4-40a7-b400-4899bad68389"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"NTs", "[", "Xg", "]"}], "//", 
     RowBox[{
      RowBox[{"#", ".", 
       RowBox[{"calcPartialTensor", "[", 
        RowBox[{"#", ",", "\"\<x\>\""}], "]"}]}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{"adjoint", "[", 
       RowBox[{"covec", "[", 
        RowBox[{"2", ",", "0", ",", "\"\<xy\>\""}], "]"}], "]"}], 
      "\[TensorProduct]", "#"}], "&"}]}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914460427522273*^9, 3.914460451569821*^9}, {
  3.914460657923037*^9, 3.914460710788419*^9}},
 CellLabel->
  "In[466]:=",ExpressionUUID->"c9a27b76-3da3-48cb-9a05-2dda4563d86d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"NTs", "[", "Xg", "]"}], "\[CenterDot]", 
    RowBox[{"NTs", "[", "Kg", "]"}]}], "//", "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914460297260337*^9, 3.914460330182097*^9}},
 CellLabel->
  "In[467]:=",ExpressionUUID->"51ab3548-b5df-4e61-9aae-dc775ec71b4b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"calcGradNOp", "[", 
    RowBox[{
     RowBox[{"NTs", "[", "Xg", "]"}], "//", 
     RowBox[{
      RowBox[{"transformBundle", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "]"}], "//",
    "Timing"}], "//", 
  RowBox[{
   RowBox[{"#", "[", 
    RowBox[{"[", "1", "]"}], "]"}], "&"}]}]], "Input",
 CellChangeTimes->{{3.914296104460085*^9, 3.914296113777006*^9}, {
  3.914423060550926*^9, 3.914423090961458*^9}, {3.914423777967904*^9, 
  3.91442378418979*^9}, {3.914423850140977*^9, 3.914423921133381*^9}, {
  3.914460269865453*^9, 3.914460274526846*^9}, {3.914549708704008*^9, 
  3.914549714136627*^9}},
 CellLabel->
  "In[468]:=",ExpressionUUID->"8abb25cf-3010-4a9f-869b-b334e6210396"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"contractGridTransform", "[", 
        RowBox[{
         RowBox[{"NTs", "[", "Kg", "]"}], ",", 
         RowBox[{"jacobians", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<XY-\>\"", ",", "\"\<xy-\>\""}], "}"}], "]"}], ",", 
         "1"}], "]"}], "//", "getArr"}], ")"}], "-", 
     RowBox[{
      RowBox[{"IdentityMatrix", "[", "2", "]"}], "\[TensorProduct]", 
      RowBox[{"Array", "[", 
       RowBox[{
        RowBox[{"1", "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"NN", ",", "NN"}], "}"}]}], "]"}]}]}], "//", "Abs"}], "//", 
   "Max"}], ";"}]], "Input",
 CellChangeTimes->{{3.911872971528257*^9, 3.91187300150564*^9}, {
   3.911873035603677*^9, 3.911873070100597*^9}, {3.911873103122859*^9, 
   3.911873115963546*^9}, {3.91187318750751*^9, 3.911873208401667*^9}, {
   3.912218142725951*^9, 3.912218144291007*^9}, 3.914030118161605*^9, {
   3.914030190072179*^9, 3.91403023367509*^9}, 3.914030900692468*^9},
 CellLabel->
  "In[469]:=",ExpressionUUID->"39123789-8216-4f1c-8d71-7bf2c49c4982"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"in", "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"NTs", "[", "Xg", "]"}], "//", 
       RowBox[{
        RowBox[{"#", "\[CenterDot]", 
         RowBox[{"NTs", "[", "IIg", "]"}]}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "1"}], "]"}], "&"}]}], "//", 
     RowBox[{
      RowBox[{
       RowBox[{"NTs", "[", "Xg", "]"}], "\[CenterDot]", "#"}], " ", "&"}]}], 
    ")"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"out", "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"in", "//", 
         RowBox[{
          RowBox[{"calcGradNOp", "[", "#", "]"}], "&"}]}], "//", 
        RowBox[{
         RowBox[{
          RowBox[{"NTs", "[", "Hg", "]"}], "\[CenterDot]", "#"}], " ", 
         "&"}]}], "//", 
       RowBox[{
        RowBox[{"iso", "[", 
         RowBox[{"#", ",", "0"}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"#", "\[CenterDot]", 
        RowBox[{"NTs", "[", "Jg", "]"}]}], " ", "&"}]}], "//", 
     RowBox[{
      RowBox[{"#", "-", 
       RowBox[{"2", 
        RowBox[{"NTs", "[", "Xg", "]"}]}]}], "&"}]}], ")"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"out", "//", "getArr"}], "//", "Abs"}], "//", "Max"}]}], "Input",
 CellChangeTimes->{{3.914030643835083*^9, 3.914030662068994*^9}, 
   3.914030911557181*^9, {3.914032041884016*^9, 3.9140320791751547`*^9}, {
   3.914266674381014*^9, 3.914266675208229*^9}, 3.914549872470435*^9, {
   3.914550147718209*^9, 3.914550188080345*^9}, {3.914591436565491*^9, 
   3.914591441179601*^9}, {3.914609936884822*^9, 3.914609939375304*^9}},
 CellLabel->
  "In[470]:=",ExpressionUUID->"fff69478-954a-4a81-b589-62b989ee55bf"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{"out", "=", 
    RowBox[{"contractGrid", "[", 
     RowBox[{
      RowBox[{"grad", "[", 
       RowBox[{"NTs", "[", "Xg", "]"}], "]"}], ",", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"jacobians", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<xy-\>\"", ",", "\"\<XY-\>\""}], "}"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "1", ",", "3", ",", "4"}], "}"}]}], "]"}]}], 
     "]"}]}], ";"}], "*)"}]], "Input",
 CellChangeTimes->{{3.9118721865049*^9, 3.911872201086279*^9}, {
  3.91187248322563*^9, 3.91187248814058*^9}, {3.911872524769636*^9, 
  3.911872540525959*^9}, {3.912148215091695*^9, 3.912148216353847*^9}, {
  3.912216654601132*^9, 3.912216684805966*^9}},
 CellLabel->
  "In[473]:=",ExpressionUUID->"252ab897-05b6-43bb-88d1-f2e62ece7a0f"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remapped Stokes direct solve", "Chapter",
 CellChangeTimes->{{3.914422761044812*^9, 
  3.9144227657837563`*^9}},ExpressionUUID->"80de2ffe-b929-4949-b062-\
07b51bf0d7aa"],

Cell[CellGroupData[{

Cell["Filtering operators", "Subsection",
 CellChangeTimes->{{3.914381412916446*^9, 3.914381417138767*^9}, {
  3.914453449877376*^9, 
  3.914453451913021*^9}},ExpressionUUID->"48ed025e-3fc3-44fe-a061-\
a4e8fdedfe02"],

Cell[BoxData[
 RowBox[{
  RowBox[{"gT", "=", "ultrasphericalTransform"}], ";"}]], "Input",
 CellChangeTimes->{{3.91443289838229*^9, 3.9144329329503117`*^9}, {
  3.914432967326996*^9, 3.914432969523449*^9}},
 CellLabel->
  "In[474]:=",ExpressionUUID->"b7d77c30-4037-4693-93f7-e0a3bad8ae19"],

Cell[BoxData[
 RowBox[{
  RowBox[{"\[CapitalPi]", "=", 
   RowBox[{"<|", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914429970331415*^9, 3.914429978534704*^9}},
 CellLabel->
  "In[475]:=",ExpressionUUID->"50ff11c0-6aad-441c-a525-72477553e85e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], "=", 
   RowBox[{"filter", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "NN", ",", "\"\<+\>\""}],
       "}"}], ",", 
     RowBox[{"1", ";;", 
      RowBox[{"NN", "-", "2"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}], "=", 
   RowBox[{"filter", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", "\"\<+\>\""}],
       "}"}], ",", 
     RowBox[{"1", ";;", 
      RowBox[{"NN", "-", "2"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<x0^\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], "//", "flip"}], "//", 
    "adjoint"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<y0^\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}], "//", "flip"}], "//", 
    "adjoint"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{"gT", "[", 
     RowBox[{"NN", ",", "\"\<x\>\"", ",", 
      RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
    RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ".", 
    RowBox[{"gT", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "\"\<x\>\"", ",", "0", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<ygv\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{"gT", "[", 
     RowBox[{"NN", ",", "\"\<y\>\"", ",", 
      RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
    RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}], ".", 
    RowBox[{"gT", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "\"\<y\>\"", ",", "0", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<xg^\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{"gT", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "\"\<x\>\"", ",", 
      RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
    RowBox[{"\[CapitalPi]", "[", "\"\<x0^\>\"", "]"}], ".", 
    RowBox[{"gT", "[", 
     RowBox[{"NN", ",", "\"\<x\>\"", ",", "0", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPi]", "[", "\"\<yg^\>\"", "]"}], "=", 
   RowBox[{
    RowBox[{"gT", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "\"\<y\>\"", ",", 
      RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
    RowBox[{"\[CapitalPi]", "[", "\"\<y0^\>\"", "]"}], ".", 
    RowBox[{"gT", "[", 
     RowBox[{"NN", ",", "\"\<y\>\"", ",", "0", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.9144298937179203`*^9, 3.9144298955971107`*^9}, {
  3.914429947818111*^9, 3.914430056259374*^9}, {3.91443009174656*^9, 
  3.914430129898283*^9}, {3.91443025355583*^9, 3.914430344848546*^9}, {
  3.914430404756042*^9, 3.9144304337279043`*^9}, {3.914430571399283*^9, 
  3.914430613357688*^9}, {3.914430718845553*^9, 3.914430753179654*^9}, {
  3.91443297395395*^9, 3.9144330096681747`*^9}},
 CellLabel->
  "In[476]:=",ExpressionUUID->"6ee8b4dc-a89d-4099-a607-8ada1c274028"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"vars", "=", 
   RowBox[{"{", 
    RowBox[{"u", ",", "p", ",", "\[Tau]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"eqs", "=", 
   RowBox[{"{", 
    RowBox[{"f", ",", "d", ",", "bx", ",", "by", ",", "bp"}], "}"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.914381664922626*^9, 3.9143817088468137`*^9}, {
   3.914381758960112*^9, 3.914381763429529*^9}, 3.914426114246284*^9, {
   3.914453385453376*^9, 3.914453401365633*^9}, {3.914453513285087*^9, 
   3.914453514365041*^9}},
 CellLabel->
  "In[484]:=",ExpressionUUID->"e594ff3f-3622-42aa-bb78-730f153991d1"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tangent basis, grid to grid", "Subsection",
 CellChangeTimes->{
  3.914425438686026*^9, {3.914425468912088*^9, 3.914425491273267*^9}, {
   3.914453337797348*^9, 
   3.914453350744604*^9}},ExpressionUUID->"99c9035b-e3d4-48ce-8a80-\
0f882ac29ea9"],

Cell["State and equation dimensions", "Text",
 CellChangeTimes->{{3.914453724058341*^9, 
  3.914453727641678*^9}},ExpressionUUID->"5ab48c43-20d3-4948-adf5-\
c178da12b8a9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"dimensions", "=", 
   RowBox[{"\[LeftAssociation]", 
    RowBox[{
     RowBox[{"\"\<vars\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"u", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
            "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
            "}"}]}], "}"}]}], ",", 
        RowBox[{"p", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"\[Tau]", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<\[Tau]\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}], ",", 
     RowBox[{"\"\<eqs\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"f", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"d", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"bx", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<lr\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", "NN", ",", "\"\<+\>\""}], 
            "}"}]}], "}"}]}], ",", 
        RowBox[{"by", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<bt\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", 
               RowBox[{"-", "1"}]}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"bp", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<bp\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}]}], "\[RightAssociation]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914453573246442*^9, 3.914453600036243*^9}, {
  3.914453669168013*^9, 3.914453703279081*^9}},
 CellLabel->
  "In[486]:=",ExpressionUUID->"c85762f5-31ec-4537-814f-e08cc2c6d9e6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"stateTensors", "=", 
   RowBox[{"AssociationMap", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{
       RowBox[{"{", "var", "}"}], ",", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "dims", "}"}], ",", 
          RowBox[{"tensor", "[", 
           RowBox[{
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{"{", "}"}], ",", 
              RowBox[{"dims", "[", 
               RowBox[{"[", 
                RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "dims", 
            ",", "0"}], "]"}]}], "]"}], "[", 
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "var", "]"}], 
        "]"}]}], "]"}], ",", "vars"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{3.9144540262190523`*^9},
 CellLabel->
  "In[487]:=",ExpressionUUID->"580dfa6f-e0e3-4f46-a684-cc7003a52eb5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"stokesTensors", "=", 
   RowBox[{"<|", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914591550740851*^9, 3.914591555678643*^9}},
 CellLabel->
  "In[488]:=",ExpressionUUID->"4c83828c-dbef-45e1-a604-61a24aba67bc"],

Cell["Vector Laplacian operator", "Text",
 CellChangeTimes->{{3.914420620823155*^9, 3.914420624504178*^9}, {
  3.914425507159361*^9, 3.91442550911316*^9}, {3.914453732924753*^9, 
  3.914453735213713*^9}},ExpressionUUID->"d57201b6-9f69-45d4-af01-\
208637a30cbb"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "lapu", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"stateTensors", "[", "u", "]"}], "//", 
        RowBox[{
         RowBox[{"calcGradTensor", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", "}"}]}], "]"}], "&"}]}], "//", 
       RowBox[{
        RowBox[{"#", ".", 
         RowBox[{"calcGradTensor", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"#", ".", 
        RowBox[{"calcBundleTransformTensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}]}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"TensorContract", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"4", ",", "5"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"#", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"id", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
        "\[TensorProduct]", 
        RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"\[CapitalPi]", "[", "\"\<ygv\>\"", "]"}]}], ")"}]}], 
     "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.91438146243089*^9, 3.914381482249358*^9}, {
   3.914381951333983*^9, 3.9143819635660152`*^9}, {3.914381998636724*^9, 
   3.914382059188892*^9}, {3.914382104189888*^9, 3.914382107840341*^9}, 
   3.914382177551136*^9, {3.914382742217247*^9, 3.914382852426993*^9}, {
   3.914417579445548*^9, 3.9144176005750027`*^9}, {3.914418008819211*^9, 
   3.914418010585162*^9}, 3.914420625946085*^9, {3.914430442097114*^9, 
   3.914430444524087*^9}, {3.91443053307352*^9, 3.914430535572569*^9}, {
   3.914430785047696*^9, 3.914430814470723*^9}, {3.914587421912629*^9, 
   3.914587434130745*^9}, {3.9145915597540708`*^9, 3.914591572167539*^9}, 
   3.914671143704472*^9, {3.914673250490459*^9, 3.914673263674683*^9}, {
   3.914673536735961*^9, 3.914673552468472*^9}},
 CellLabel->
  "In[489]:=",ExpressionUUID->"2fb661f8-0173-46a1-8625-63461d7c0ef8"],

Cell["Vector divergence", "Text",
 CellChangeTimes->{{3.914420657196999*^9, 3.9144206675856943`*^9}, {
  3.914428998579241*^9, 
  3.914429000275338*^9}},ExpressionUUID->"b15740e9-d3fb-409b-bbc7-\
f28d0fbe9444"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "divu", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"stateTensors", "[", "u", "]"}], "//", 
      RowBox[{
       RowBox[{"calcGradTensor", "[", 
        RowBox[{"#", ",", 
         RowBox[{"{", "}"}]}], "]"}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"TensorContract", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"4", ",", "5"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"#", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"\[CapitalPi]", "[", "\"\<ygv\>\"", "]"}]}], ")"}]}], 
     "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.91438320210652*^9, 3.914383254487862*^9}, {
  3.914430840607913*^9, 3.9144308773443813`*^9}, {3.914591593681469*^9, 
  3.914591597531906*^9}},
 CellLabel->
  "In[490]:=",ExpressionUUID->"8b05174f-6d0e-4669-879c-77a0dc881320"],

Cell["Scalar Gradient (to \
\[OpenCurlyDoubleQuote]xy+\[OpenCurlyDoubleQuote])", "Text",
 CellChangeTimes->{{3.91442560197885*^9, 
  3.9144256201024237`*^9}},ExpressionUUID->"8cea4af7-81ac-4fe6-9558-\
a74b7e624a70"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "gradp", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"\[CapitalPi]", "[", "\"\<xg^\>\"", "]"}], "\[TensorProduct]", 
       
       RowBox[{"\[CapitalPi]", "[", "\"\<yg^\>\"", "]"}]}], "//", 
      RowBox[{
       RowBox[{"#", ".", 
        RowBox[{"calcGradTensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"#", ".", 
       RowBox[{"calcBundleTransformTensor", "[", 
        RowBox[{"#", ",", 
         RowBox[{"{", 
          RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}]}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"#", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"id", "[", 
         RowBox[{"{", 
          RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
        "\[TensorProduct]", 
        RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], "\[TensorProduct]", 
        RowBox[{"\[CapitalPi]", "[", "\"\<ygv\>\"", "]"}]}], ")"}]}], 
     "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914428058602106*^9, 3.914428139916244*^9}, {
  3.914428732465074*^9, 3.914428737688817*^9}, {3.914431058527186*^9, 
  3.914431141490452*^9}, {3.9145916005217876`*^9, 3.914591604784717*^9}},
 CellLabel->
  "In[491]:=",ExpressionUUID->"e7548c29-0e48-498e-b16b-684285ebfa0b"],

Cell["Horizontal boundaries", "Text",
 CellChangeTimes->{{3.914431714820297*^9, 
  3.914431721861604*^9}},ExpressionUUID->"dd9094f4-01b1-4d4e-ac24-\
1d7abcf69600"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Blru", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"gT", "[", 
         RowBox[{"NN", ",", "\"\<x\>\"", ",", 
          RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
        RowBox[{"interp", "[", 
         RowBox[{"NN", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
          RowBox[{"-", "1"}]}], "]"}]}], ")"}], "\[TensorProduct]", 
      RowBox[{"id", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", 
          RowBox[{"-", "1"}]}], "}"}]}], "]"}]}], "\[IndentingNewLine]", "+", 
     
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"gT", "[", 
          RowBox[{"NN", ",", "\"\<x\>\"", ",", 
           RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
         RowBox[{"interp", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}], 
        ")"}], ")"}], "\[TensorProduct]", 
      RowBox[{"id", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", 
          RowBox[{"-", "1"}]}], "}"}]}], "]"}]}]}], ")"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
  3.914432149759726*^9, 3.91443219647787*^9}, {3.914432237920389*^9, 
  3.9144322414377413`*^9}, {3.914432995993266*^9, 3.914432997358787*^9}, {
  3.914591612537969*^9, 3.914591616969448*^9}, {3.914672562096097*^9, 
  3.914672564979257*^9}},
 CellLabel->
  "In[492]:=",ExpressionUUID->"9145a993-5e93-45bf-98a5-33ef10c80610"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Bbtu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], ")"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"gT", "[", 
         RowBox[{"NN", ",", "\"\<y\>\"", ",", 
          RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
        RowBox[{"interp", "[", 
         RowBox[{"NN", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
          RowBox[{"-", "1"}]}], "]"}]}], ")"}]}], "\[IndentingNewLine]", "+", 
     
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], ")"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"gT", "[", 
         RowBox[{"NN", ",", "\"\<y\>\"", ",", 
          RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
        RowBox[{"interp", "[", 
         RowBox[{"NN", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}], 
       ")"}]}]}], ")"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
  3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
  3.91443230936213*^9}, {3.914432441955035*^9, 3.914432484865398*^9}, {
  3.914432998126777*^9, 3.914432998737596*^9}, {3.914591620541471*^9, 
  3.9145916246068487`*^9}},
 CellLabel->
  "In[493]:=",ExpressionUUID->"7816dad5-fb51-4741-865d-d06653e3c21f"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Bp", "]"}], "=", 
   RowBox[{
    RowBox[{"vec", "[", 
     RowBox[{"1", ",", "0", ",", "\"\<bp\>\""}], "]"}], "\[TensorProduct]", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"gT", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "\"\<x\>\"", ",", 
        RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
      RowBox[{"covec", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "0", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}]}], ")"}], 
    "\[TensorProduct]", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"gT", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "\"\<y\>\"", ",", 
        RowBox[{"-", "1"}], ",", "0"}], "]"}], ".", 
      RowBox[{"covec", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "0", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], ")"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
  3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
  3.91443230936213*^9}, {3.914432441955035*^9, 3.9144324476589403`*^9}, {
  3.9144325662733583`*^9, 3.914432621102821*^9}, {3.91443299935546*^9, 
  3.914432999803076*^9}, {3.914591628739739*^9, 3.91459163419911*^9}},
 CellLabel->
  "In[494]:=",ExpressionUUID->"72b98cb1-f589-474d-b8bf-b00aa3c7b0c6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "lift\[Tau]", "]"}], "=", 
   RowBox[{
    RowBox[{"covec", "[", 
     RowBox[{"1", ",", "0", ",", "\"\<\[Tau]\>\""}], "]"}], 
    "\[TensorProduct]", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "0", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], ".", 
      RowBox[{"gT", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "\"\<x\>\"", ",", "0", ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ")"}], "\[TensorProduct]", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "0", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}], ".", 
      RowBox[{"gT", "[", 
       RowBox[{
        RowBox[{"NN", "-", "2"}], ",", "\"\<y\>\"", ",", "0", ",", 
        RowBox[{"-", "1"}]}], "]"}]}], ")"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
  3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
  3.91443230936213*^9}, {3.914432441955035*^9, 3.9144324476589403`*^9}, {
  3.9144325662733583`*^9, 3.914432621102821*^9}, {3.91443277590138*^9, 
  3.914432783485914*^9}, {3.914433255043366*^9, 3.914433259187025*^9}, {
  3.9144333603531647`*^9, 3.914433360762507*^9}, {3.91445621807821*^9, 
  3.914456268221512*^9}, {3.914591635837387*^9, 3.91459163961665*^9}},
 CellLabel->
  "In[495]:=",ExpressionUUID->"003f97ef-f206-449d-a734-b5b59981007c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"linearOps", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"lap", ",", "grad", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"div", ",", "0", ",", "lift"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "bc", ",", "0"}], "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"linearOps", "=", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"eq", ",", "var"}], "]"}], "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"eq", "->", 
          RowBox[{"k1", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ",", 
         RowBox[{"var", "->", 
          RowBox[{"k2", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ",", 
         RowBox[{"op", "->", 
          RowBox[{"linearOps", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"k1", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"k2", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}]}]}], "}"}]}], 
      ",", 
      RowBox[{"{", 
       RowBox[{"k1", ",", 
        RowBox[{"enumerate", "[", "eqs", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"k2", ",", 
        RowBox[{"enumerate", "[", "vars", "]"}]}], "}"}]}], "]"}], "/.", " ", 
    
    RowBox[{"0", "->", "zero"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"linearTens", "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"lap", "[", 
       RowBox[{"f", ",", "u"}], "]"}], "->", 
      RowBox[{"-", 
       RowBox[{"stokesTensors", "[", "lapu", "]"}]}]}], ",", 
     RowBox[{
      RowBox[{"grad", "[", 
       RowBox[{"f", ",", "p"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "gradp", "]"}]}], ",", 
     RowBox[{
      RowBox[{"div", "[", 
       RowBox[{"d", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "divu", "]"}]}], ",", 
     RowBox[{
      RowBox[{"lift", "[", 
       RowBox[{"d", ",", "\[Tau]"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "lift\[Tau]", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"bx", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Blru", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"by", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Bbtu", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"bp", ",", "p"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Bp", "]"}]}]}], "}"}]}], ";"}]}], "Input",\

 CellChangeTimes->{{3.91443334238294*^9, 3.91443338030726*^9}, {
   3.914443630923668*^9, 3.914443640948897*^9}, 3.914454019011353*^9, {
   3.914591645338535*^9, 3.914591689989007*^9}},
 CellLabel->
  "In[496]:=",ExpressionUUID->"6c65c292-937e-49e1-8969-7e364b9ee17f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ruleZero", "=", 
   RowBox[{
    RowBox[{"zero", "[", 
     RowBox[{"f_", ",", "g_"}], "]"}], "\[RuleDelayed]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}],
            "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "All"}], ",", "2"}], "\[RightDoubleBracket]"}],
           ",", 
          RowBox[{
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", "]"}], 
           "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "All"}], ",", "2"}], 
           "\[RightDoubleBracket]"}]}], "]"}]}], "]"}], ",", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}], 
        ",", 
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", "]"}]}], 
       "]"}], ",", 
      RowBox[{"Length", "[", 
       RowBox[{
        RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}], 
       "]"}]}], "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9},
 CellLabel->
  "In[499]:=",ExpressionUUID->"c2ddc091-3d6a-4ceb-b0c2-654fee799c18"],

Cell[BoxData[
 RowBox[{
  RowBox[{"linearArrs", "=", 
   RowBox[{
    RowBox[{"linearOps", "/.", "ruleZero"}], "/.", "linearTens"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9, 3.91443393435355*^9},
 CellLabel->
  "In[500]:=",ExpressionUUID->"6b51f303-5954-4759-ae29-46d841a5f962"],

Cell[BoxData[
 RowBox[{
  RowBox[{"splinearArrs", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"sparse", "[", "m", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"row", ",", "linearArrs"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"m", ",", "row"}], "}"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9, 3.91443393435355*^9, 
  3.914434067424762*^9},
 CellLabel->
  "In[501]:=",ExpressionUUID->"544413c9-14fc-42d6-a88e-db00612afa10"],

Cell[BoxData[
 RowBox[{
  RowBox[{"spsystem", "=", 
   RowBox[{"transformTensorsToMatrixSystem", "[", "splinearArrs", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.914433427659485*^9, 3.91443393435355*^9, {3.914434067424762*^9, 
   3.914434076972457*^9}},
 CellLabel->
  "In[502]:=",ExpressionUUID->"c684bb1a-83a6-41b2-9795-b7867cb6c945"],

Cell[BoxData[
 RowBox[{"spsystemLU", "=", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{"N", "[", "spsystem", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.914433427659485*^9, 3.91443393435355*^9, {3.914434067424762*^9, 
   3.914434129636977*^9}},
 CellLabel->
  "In[503]:=",ExpressionUUID->"58b2987f-b232-4e2a-837c-3900f338bcd7"],

Cell[CellGroupData[{

Cell["Test convergence of solution", "Subsubsection",
 CellChangeTimes->{{3.907438062299514*^9, 
  3.907438068577997*^9}},ExpressionUUID->"9957bb14-b67a-48c2-916f-\
fa5cb20b8a4e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"sols", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "u", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Curl", "[", 
        RowBox[{
         RowBox[{
          SuperscriptBox["X", "2"], 
          SuperscriptBox["Y", "2"]}], ",", 
         RowBox[{"{", 
          RowBox[{"X", ",", "Y"}], "}"}]}], "]"}], "//", 
       RowBox[{
        RowBox[{"tensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"\"\<XY\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "}"}], 
          ",", "0"}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"#", "/.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"X", "->", 
           RowBox[{"X", "[", 
            RowBox[{"x", ",", "y"}], "]"}]}], ",", 
          RowBox[{"Y", "->", 
           RowBox[{"Y", "[", 
            RowBox[{"x", ",", "y"}], "]"}]}]}], "}"}]}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"transformBundleS", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "/.", 
       RowBox[{"rules", "[", "\"\<Kf\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "&"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434320548655*^9}, {
   3.914434367999054*^9, 3.914434381890215*^9}, {3.914434442548552*^9, 
   3.914434443996955*^9}, {3.914442587652437*^9, 3.914442730138502*^9}, 
   3.914442796473359*^9, {3.914443724845148*^9, 3.914443727404567*^9}},
 CellLabel->
  "In[504]:=",ExpressionUUID->"bcd9b7a5-d172-469c-a2e0-2c98af9d2768"],

Cell["Test that it\[CloseCurlyQuote]s divergence free:", "Text",
 CellChangeTimes->{{3.914442981350753*^9, 
  3.914442986412993*^9}},ExpressionUUID->"0df35699-9007-4338-ada2-\
06a2dd551df4"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"sols", "[", "u", "]"}], "//", 
      RowBox[{
       RowBox[{"calcGradS", "[", 
        RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}], 
     "//", 
     RowBox[{
      RowBox[{"TensorContract", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"#", "/.", 
           RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
          RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "/.", 
         RowBox[{"rules", "[", "\"\<Jf\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<Kf\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<\[CapitalGamma]f\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "&"}]}], "//", 
   "Simplify"}], "*)"}]], "Input",
 CellChangeTimes->{{3.9144428303748455`*^9, 3.914442989070068*^9}},
 CellLabel->
  "In[506]:=",ExpressionUUID->"ca451291-75a3-4469-869c-44f2dd44c9e6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "p", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       SuperscriptBox["X", "2"], 
       SuperscriptBox["Y", "2"]}], "-", 
      FractionBox["1", "4"]}], "//", 
     RowBox[{
      RowBox[{"tensor", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", "}"}], ",", "0"}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"X", "->", 
          RowBox[{"X", "[", 
           RowBox[{"x", ",", "y"}], "]"}]}], ",", 
         RowBox[{"Y", "->", 
          RowBox[{"Y", "[", 
           RowBox[{"x", ",", "y"}], "]"}]}]}], "}"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, 
   3.914434492607579*^9, {3.91444300349838*^9, 3.914443035664608*^9}},
 CellLabel->
  "In[507]:=",ExpressionUUID->"8186ad87-950d-42bf-a966-a162f53527e1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "lapu", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"sols", "[", "u", "]"}], "//", 
        RowBox[{
         RowBox[{"calcGradS", "[", 
          RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], 
         "&"}]}], "//", 
       RowBox[{
        RowBox[{"calcGradS", "[", 
         RowBox[{"#", ",", "\"\<xy\>\"", ",", "\"\<xy+\>\""}], "]"}], "&"}]}],
       "//", 
      RowBox[{
       RowBox[{"transformBundleS", "[", 
        RowBox[{"#", ",", 
         RowBox[{"{", 
          RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"TensorContract", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"##", "/.", 
            RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
           RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "/.", 
          RowBox[{"rules", "[", "\"\<Hf\>\"", "]"}]}], "/.", 
         RowBox[{"rules", "[", "\"\<Jf\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<Kf\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<\[CapitalGamma]f\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.91444321691296*^9, 3.9144432985568933`*^9}, 
   3.914443383203414*^9, {3.914444138417387*^9, 3.9144441389286*^9}},
 CellLabel->
  "In[508]:=",ExpressionUUID->"8c78da07-2ec8-4cb4-80fd-7c20575eefe1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "gradp", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"calcGradS", "[", 
       RowBox[{
        RowBox[{"sols", "[", "p", "]"}], ",", "\"\<xy\>\"", ",", 
        "\"\<xy+\>\""}], "]"}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "0"}], "]"}], "&"}]}], "//", 
     RowBox[{
      RowBox[{"transformBundleS", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"#", "/.", 
         RowBox[{"rules", "[", "\"\<jacs\>\"", "]"}]}], "/.", 
        RowBox[{"rules", "[", "\"\<conns\>\"", "]"}]}], "/.", 
       RowBox[{"rules", "[", "\"\<Hf\>\"", "]"}]}], "/.", 
      RowBox[{"rules", "[", "\"\<Xfunc\>\"", "]"}]}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, {
   3.914434492607579*^9, 3.914434498852934*^9}, {3.914443402542691*^9, 
   3.914443520002373*^9}, {3.9144441664660883`*^9, 3.914444182906773*^9}},
 CellLabel->
  "In[509]:=",ExpressionUUID->"61f81918-c633-4619-9350-c7ed20a5af7e"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "f", "]"}], "=", 
   RowBox[{
    RowBox[{"-", 
     RowBox[{"sols", "[", "lapu", "]"}]}], "+", 
    RowBox[{"sols", "[", "gradp", "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, {
   3.914434492607579*^9, 3.914434500264895*^9}, 3.9144435389713306`*^9},
 CellLabel->
  "In[510]:=",ExpressionUUID->"fb8fe767-740d-468a-b123-93c448626ba6"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "d", "]"}], "=", 
   RowBox[{"tensor", "[", 
    RowBox[{"0", ",", 
     RowBox[{"{", "}"}], ",", "0"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, {
   3.914434492607579*^9, 3.91443450178012*^9}, {3.914445576638145*^9, 
   3.914445583962393*^9}},
 CellLabel->
  "In[511]:=",ExpressionUUID->"7c834f57-aa9b-48c3-b208-636a53bd0084"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "bx", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"x", "->", 
        RowBox[{"-", "1"}]}]}], ")"}]}], "+", 
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"x", "->", "1"}]}], ")"}]}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, {
   3.914434492607579*^9, 3.914434503478133*^9}},
 CellLabel->
  "In[512]:=",ExpressionUUID->"8f65e634-84c0-4138-a20b-ff325ffee3ed"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"sols", "[", "by", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"y", "->", 
        RowBox[{"-", "1"}]}]}], ")"}]}], "+", 
    RowBox[{
     RowBox[{"dense", "[", 
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], "]"}], 
     "\[TensorProduct]", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"sols", "[", "u", "]"}], "/.", 
       RowBox[{"y", "->", "1"}]}], ")"}]}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907181452761424*^9, 3.907181609067067*^9}, {
   3.907181679073862*^9, 3.907181708946413*^9}, {3.907181818390417*^9, 
   3.907181831414493*^9}, {3.907181872492835*^9, 3.907181904589109*^9}, {
   3.907181939343636*^9, 3.907181995189703*^9}, {3.907182027823071*^9, 
   3.907182028555735*^9}, {3.907182084364305*^9, 3.907182112625904*^9}, {
   3.907182364974618*^9, 3.907182366395428*^9}, {3.907183896949612*^9, 
   3.907183912379915*^9}, {3.9071856695242558`*^9, 3.907185686450755*^9}, {
   3.907438117083213*^9, 3.907438121880743*^9}, {3.907439048009149*^9, 
   3.907439049073586*^9}, {3.907439363672261*^9, 3.907439392518107*^9}, {
   3.908571722779492*^9, 3.908571765630512*^9}, 3.910813339552063*^9, {
   3.9108141957128077`*^9, 3.910814201105326*^9}, {3.911762768986412*^9, 
   3.911762769811269*^9}, 3.91176336002637*^9, {3.911763687244117*^9, 
   3.911763689412826*^9}, {3.913999987540946*^9, 3.913999987549049*^9}, {
   3.914017369915844*^9, 3.914017399053974*^9}, {3.91426651232812*^9, 
   3.914266513204384*^9}, {3.914434278481768*^9, 3.914434304068568*^9}, {
   3.914434492607579*^9, 3.914434503478133*^9}},
 CellLabel->
  "In[513]:=",ExpressionUUID->"af3fa3ef-b33b-4abb-8666-792ff54681bc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"solArrs", "=", 
   RowBox[{"<|", "|>"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "ug", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "u", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"x", "->", 
        RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
       RowBox[{"y", "->", 
        RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017538288596*^9}, {3.9140177833494053`*^9, 3.914017804219014*^9}},
 CellLabel->
  "In[514]:=",ExpressionUUID->"4ba66e87-6038-4aee-bb4e-cf9254753910"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "pg", "]"}], "=", 
   RowBox[{
    RowBox[{"transformSymbolicToNumerical", "[", 
     RowBox[{
      RowBox[{"sols", "[", "p", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"x", "->", 
         RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
        RowBox[{"y", "->", 
         RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], "//", 
    
    RowBox[{
     RowBox[{"contractOnes", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], ",", 
         RowBox[{"\[CapitalPi]", "[", "\"\<ygv\>\"", "]"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017574353551*^9}, {3.914017833762197*^9, 3.914017836179799*^9}, {
   3.914446677182171*^9, 3.914446718552233*^9}},
 CellLabel->
  "In[516]:=",ExpressionUUID->"27ccac50-1a92-4e9c-9c70-56fa187770d4"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "\[Tau]", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "\[Tau]", "]"}], "//", 
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "#", ",", 
       "0"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, {
   3.9108148616331244`*^9, 3.910814872899563*^9}, {3.91083157856917*^9, 
   3.910831617164916*^9}, {3.911762625828977*^9, 3.911762632749203*^9}, {
   3.913999987554212*^9, 3.9139999875590553`*^9}, {3.914017454200844*^9, 
   3.914017553708893*^9}, {3.914017846238037*^9, 3.914017853664221*^9}, {
   3.9140178858192463`*^9, 3.9140178947946157`*^9}, {3.914444400516214*^9, 
   3.9144444032304173`*^9}},
 CellLabel->
  "In[517]:=",ExpressionUUID->"a6b0a87d-de65-434d-8405-ee70b0322961"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "fg", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"transformSymbolicToNumerical", "[", 
       RowBox[{
        RowBox[{"sols", "[", "f", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"x", "->", 
           RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
          RowBox[{"y", "->", 
           RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], "//",
       "toCoeff"}], "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "3"}], "}"}]}], "]"}], "&"}]}], "//", "toGrid"}]}],
   ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017925033864*^9}, 3.914445244785321*^9},
 CellLabel->
  "In[518]:=",ExpressionUUID->"3a18df6f-68da-4014-b63f-02373c133f00"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "dg", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"transformSymbolicToNumerical", "[", 
       RowBox[{
        RowBox[{"sols", "[", "d", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"0", "->", 
           RowBox[{"0", 
            RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}]}], ",", 
          RowBox[{"x", "->", 
           RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
          RowBox[{"y", "->", 
           RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], "//",
       "toCoeff"}], "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "&"}]}], "//", "toGrid"}]}],
   ";"}]], "Input",
 CellChangeTimes->{{3.9144455452356377`*^9, 3.9144455458713083`*^9}, {
  3.914445600437317*^9, 3.914445685558442*^9}},
 CellLabel->
  "In[519]:=",ExpressionUUID->"32ff34dd-2021-4c94-bca5-4d592462851d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bxg", "]"}], "=", 
   RowBox[{"transformSymbolicToNumerical", "[", 
    RowBox[{
     RowBox[{"sols", "[", "bx", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", "->", 
       RowBox[{"grid", "[", "\"\<yt\>\"", "]"}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, {3.9140179734889708`*^9, 
   3.914017996991905*^9}, {3.914445379038286*^9, 3.91444537976992*^9}},
 CellLabel->
  "In[520]:=",ExpressionUUID->"64f4b519-de68-4512-a71e-171a886056eb"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "byg", "]"}], "=", 
   RowBox[{
    RowBox[{"transformSymbolicToNumerical", "[", 
     RowBox[{
      RowBox[{"sols", "[", "by", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"x", "->", 
        RowBox[{"grid", "[", "\"\<xt\>\"", "]"}]}], "}"}]}], "]"}], "//", 
    RowBox[{
     RowBox[{"contractOnes", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"\[CapitalPi]", "[", "\"\<xgv\>\"", "]"}], "}"}], ",", 
       RowBox[{"{", "3", "}"}]}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907182115602841*^9, 3.907182125147994*^9}, {
   3.907182207765067*^9, 3.907182233149793*^9}, {3.907182324182053*^9, 
   3.907182342105959*^9}, {3.907182373441914*^9, 3.907182527905704*^9}, {
   3.907182575040533*^9, 3.907182576757852*^9}, {3.9071826115448093`*^9, 
   3.907182898920508*^9}, {3.907183574030017*^9, 3.907183602510964*^9}, {
   3.907183671987331*^9, 3.907183694851841*^9}, {3.907183778298736*^9, 
   3.907183841959837*^9}, {3.907183924446783*^9, 3.907183928045257*^9}, {
   3.907184035033886*^9, 3.907184107208866*^9}, {3.907184216228705*^9, 
   3.907184270630011*^9}, {3.907184318920167*^9, 3.907184339255985*^9}, 
   3.907185545793792*^9, {3.907185707165763*^9, 3.907185714194793*^9}, {
   3.907202055758527*^9, 3.907202057519538*^9}, {3.907438299336296*^9, 
   3.907438399507265*^9}, {3.9074384588681583`*^9, 3.907438494301547*^9}, 
   3.907439411460689*^9, 3.908572269787332*^9, {3.910813352442265*^9, 
   3.910813361250953*^9}, {3.910813489697547*^9, 3.910813499318948*^9}, 
   3.910814210937138*^9, {3.910814783772608*^9, 3.9108148194525757`*^9}, 
   3.9108148616331244`*^9, {3.910831625993681*^9, 3.910831663661578*^9}, {
   3.910831701488127*^9, 3.910831717615514*^9}, {3.911762625835435*^9, 
   3.911762632755198*^9}, {3.91399998756551*^9, 3.913999987576961*^9}, {
   3.914017902712878*^9, 3.914017935214802*^9}, {3.9140180022590733`*^9, 
   3.914018022179827*^9}, 3.914444034932759*^9, {3.914445809237019*^9, 
   3.914445818765644*^9}, {3.914445972800842*^9, 3.914445982259841*^9}, {
   3.9144460171913757`*^9, 3.914446021324544*^9}, {3.914673174521173*^9, 
   3.914673177330471*^9}},
 CellLabel->
  "In[521]:=",ExpressionUUID->"6d10b4f3-0533-4229-a708-793251f70557"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bp", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "bp", "]"}], "//", 
    
    RowBox[{
     RowBox[{"tensor", "[", 
      RowBox[{
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"#", "[", 
          RowBox[{"[", 
           RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "#", ",", 
       "0"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914444271307806*^9, 3.91444427670833*^9}, {
   3.914444312265175*^9, 3.914444326989524*^9}, {3.9144444163414717`*^9, 
   3.914444426214033*^9}, 3.914446078949004*^9},
 CellLabel->
  "In[522]:=",ExpressionUUID->"585e6634-8a64-4757-97d6-91672681bcdb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhs", "=", 
   RowBox[{"transformTensorsToVector", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"solArrs", "[", "fg", "]"}], ",", 
      RowBox[{"solArrs", "[", "dg", "]"}], ",", 
      RowBox[{"solArrs", "[", "bxg", "]"}], ",", 
      RowBox[{"solArrs", "[", "byg", "]"}], ",", 
      RowBox[{"solArrs", "[", "bp", "]"}]}], "}"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907184409557091*^9, 3.907184589530293*^9}, {
   3.907185066381054*^9, 3.907185079575674*^9}, {3.9074388444234962`*^9, 
   3.907438886997363*^9}, {3.907439108660837*^9, 3.907439111930518*^9}, {
   3.907439167333377*^9, 3.9074391792689*^9}, {3.908573650765775*^9, 
   3.908573659943903*^9}, {3.908573695437396*^9, 3.908573701713323*^9}, {
   3.910813677900455*^9, 3.910813678491828*^9}, {3.914018034965099*^9, 
   3.9140180512065277`*^9}, {3.914024039382469*^9, 3.914024076871774*^9}, {
   3.914024213635038*^9, 3.9140242151955013`*^9}, {3.914444050162519*^9, 
   3.914444068351761*^9}, {3.914444476910515*^9, 3.9144444785105953`*^9}, 
   3.9144446575328074`*^9, {3.914673184878818*^9, 3.914673194624026*^9}},
 CellLabel->
  "In[523]:=",ExpressionUUID->"db43c34c-4f5f-45f6-9139-0f09439958db"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"getDims", "[", 
       RowBox[{"solArrs", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<g\>\""}], "//", 
         "ToExpression"}], "]"}], "]"}], "==", 
      RowBox[{
       RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "s", "]"}]}], 
     ",", 
     RowBox[{"{", 
      RowBox[{"s", ",", 
       RowBox[{"{", 
        RowBox[{"f", ",", "d", ",", "bx", ",", "by"}], "}"}]}], "}"}]}], 
    "]"}], "//", 
   RowBox[{
    RowBox[{"And", "@@", "#"}], "&"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914446138701017*^9, 3.914446305970232*^9}, {
  3.91467319819947*^9, 3.9146732000275784`*^9}},
 CellLabel->
  "In[524]:=",ExpressionUUID->"6340996b-2d36-46e7-8ca5-554e029c808d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhsTens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"rhs", ",", 
     RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907439331897048*^9, 3.907439338184476*^9}, 
   3.910814411840589*^9, {3.914018071307755*^9, 3.914018077175647*^9}, {
   3.914444668696793*^9, 3.914444670755978*^9}},
 CellLabel->
  "In[525]:=",ExpressionUUID->"6ae51362-e675-45e4-8ef2-c1c3e9a65feb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"outvec", "=", 
   RowBox[{"spsystemLU", "[", "rhs", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914446370887936*^9, 3.914446379115769*^9}, {
   3.91444656897134*^9, 3.9144465729156*^9}, {3.914446619802821*^9, 
   3.914446620143382*^9}, 3.9146732161054983`*^9, 3.9146736762773046`*^9},
 CellLabel->
  "In[526]:=",ExpressionUUID->"e3c69d9b-00fd-4ef7-a762-b7aabdab1e4a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"outtens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"outvec", ",", 
     RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914446584928589*^9, 3.914446626662054*^9}, {
  3.914591843979075*^9, 3.914591844305099*^9}},
 CellLabel->
  "In[527]:=",ExpressionUUID->"ca694b89-8970-4cd8-8254-9ed9a59df3f5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"p0", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "pg", "]"}], "//", "toCoeff"}], "//", 
    RowBox[{
     RowBox[{"#", "[", 
      RowBox[{"[", 
       RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914446794654896*^9, 3.914446795798244*^9}, {
  3.914446838606612*^9, 3.914446905490564*^9}},
 CellLabel->
  "In[528]:=",ExpressionUUID->"f1b19e18-8059-4069-b213-eec06bc1a8da"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"outtens", "[", "p", "]"}], "-", 
       RowBox[{"solArrs", "[", "pg", "]"}]}], ")"}], "//", "getArr"}], "//", 
    RowBox[{
     RowBox[{"#", "+", "p0"}], "&"}]}], "//", "Abs"}], "//", "Max"}]], "Input",\

 CellChangeTimes->{{3.9144467347327337`*^9, 3.914446792616104*^9}, {
  3.914446922662259*^9, 3.914446928055319*^9}, {3.914446965684403*^9, 
  3.914446984589849*^9}},
 CellLabel->
  "In[529]:=",ExpressionUUID->"fda1585f-893a-407f-bcce-608b7488f9ca"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"outtens", "[", "u", "]"}], "-", 
      RowBox[{"solArrs", "[", "ug", "]"}]}], ")"}], "//", "getArr"}], "//", 
   "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914447005325264*^9, 3.914447010963786*^9}},
 CellLabel->
  "In[530]:=",ExpressionUUID->"fdc3bef1-4ef0-4536-957e-f0d94a7ead98"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tangent basis, cheb to cheb", "Subsection",
 CellChangeTimes->{{3.9144533320154667`*^9, 
  3.914453343454045*^9}},ExpressionUUID->"7a129ffc-6277-47de-aa48-\
ad5d1a30c19a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"dimensions", "=", 
   RowBox[{"\[LeftAssociation]", 
    RowBox[{
     RowBox[{"\"\<vars\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"u", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}]}], "}"}]}], ",", 
        RowBox[{"p", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"\[Tau]", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<\[Tau]\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}], ",", 
     RowBox[{"\"\<eqs\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"f", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"d", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"bx", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<lr\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}]}], "}"}]}], ",", 
        RowBox[{"by", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<bt\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"bp", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<bp\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}]}], "\[RightAssociation]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.914453861962858*^9, {3.914453918085449*^9, 3.914453945525513*^9}},
 CellLabel->
  "In[531]:=",ExpressionUUID->"13c02f3c-675a-4784-9114-eec7615eee9b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"stateTensors", "=", 
   RowBox[{"AssociationMap", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{
       RowBox[{"{", "var", "}"}], ",", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "dims", "}"}], ",", 
          RowBox[{"tensor", "[", 
           RowBox[{
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{"{", "}"}], ",", 
              RowBox[{"dims", "[", 
               RowBox[{"[", 
                RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "dims", 
            ",", "0"}], "]"}]}], "]"}], "[", 
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "var", "]"}], 
        "]"}]}], "]"}], ",", "vars"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914453964162551*^9, 3.914453967004397*^9}, {
  3.914454032757519*^9, 3.9144540463702793`*^9}},
 CellLabel->
  "In[532]:=",ExpressionUUID->"06bbd894-0818-41e3-a608-db7adfb3ef53"],

Cell["Vector Laplacian", "Text",
 CellChangeTimes->{{3.91445395501862*^9, 
  3.914453958961391*^9}},ExpressionUUID->"d4e68108-f56c-4e6f-af83-\
3574a172d7b7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"stokesTensors", "=", 
   RowBox[{"<|", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914454827838995*^9, 3.9144548509989*^9}},
 CellLabel->
  "In[533]:=",ExpressionUUID->"fba61bb5-baf3-4dd2-8656-a8c205e35f29"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "lapu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"stateTensors", "[", "u", "]"}], "\[IndentingNewLine]", "//", 
           RowBox[{
            RowBox[{"calcGridTransformTensor", "[", 
             RowBox[{"#", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"\"\<x\>\"", "->", 
                 RowBox[{"-", "1"}]}], ",", 
                RowBox[{"\"\<y\>\"", "->", 
                 RowBox[{"-", "1"}]}]}], "}"}]}], "]"}], "&"}]}], 
          "\[IndentingNewLine]", "//", 
          RowBox[{
           RowBox[{"#", ".", 
            RowBox[{"calcGradTensor", "[", 
             RowBox[{"#", ",", 
              RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "\[IndentingNewLine]", "//", 
         RowBox[{
          RowBox[{"#", ".", 
           RowBox[{"calcGradTensor", "[", 
            RowBox[{"#", ",", 
             RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "\[IndentingNewLine]", "//", 
        RowBox[{
         RowBox[{"#", ".", 
          RowBox[{"calcBundleTransformTensor", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}]}], "&"}]}], 
       "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"TensorContract", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"4", ",", "5"}], "}"}], "}"}]}], "]"}], "&"}]}], 
      "\[IndentingNewLine]", "//", 
      RowBox[{
       RowBox[{"#", ".", 
        RowBox[{"calcGridTransformTensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<x\>\"", "->", "0"}], ",", 
            RowBox[{"\"\<y\>\"", "->", "0"}]}], "}"}]}], "]"}]}], "&"}]}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"5", ",", "6"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914454057494947*^9, 3.914454076657535*^9}, {
   3.914454127492359*^9, 3.91445416272543*^9}, {3.914454326159289*^9, 
   3.9144543368911324`*^9}, {3.914454377198745*^9, 3.91445439376116*^9}, {
   3.914454450690277*^9, 3.914454450828788*^9}, {3.914454500541567*^9, 
   3.91445456945093*^9}, {3.914454603383944*^9, 3.914454662660007*^9}, {
   3.9144548236928377`*^9, 3.914454866827429*^9}, {3.914456443729844*^9, 
   3.914456465222312*^9}, 3.914456605391904*^9},
 CellLabel->
  "In[534]:=",ExpressionUUID->"6dcda9f9-17bc-469f-8ef1-505a3ae35662"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "gradp", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[CapitalPi]", "[", "\"\<x0^\>\"", "]"}], 
           "\[TensorProduct]", 
           RowBox[{"\[CapitalPi]", "[", "\"\<y0^\>\"", "]"}]}], ")"}], 
         "\[IndentingNewLine]", "//", 
         RowBox[{
          RowBox[{"#", ".", 
           RowBox[{"calcGridTransformTensor", "[", 
            RowBox[{"#", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"\"\<x\>\"", "->", 
                RowBox[{"-", "1"}]}], ",", 
               RowBox[{"\"\<y\>\"", "->", 
                RowBox[{"-", "1"}]}]}], "}"}]}], "]"}]}], "&"}]}], 
        "\[IndentingNewLine]", "//", 
        RowBox[{
         RowBox[{"#", ".", 
          RowBox[{"calcGradTensor", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"#", ".", 
         RowBox[{"calcBundleTransformTensor", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}]}], "&"}]}], 
      "\[IndentingNewLine]", "//", 
      RowBox[{
       RowBox[{"#", ".", 
        RowBox[{"calcGridTransformTensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<x\>\"", "->", "0"}], ",", 
            RowBox[{"\"\<y\>\"", "->", "0"}]}], "}"}]}], "]"}]}], "&"}]}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"4", ",", "5"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914454929639822*^9, 3.914455150547803*^9}, {
  3.914456474203206*^9, 3.91445648554528*^9}},
 CellLabel->
  "In[535]:=",ExpressionUUID->"f0a9114a-8a03-40c7-ba0f-142aca8ede3e"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "divu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"stateTensors", "[", "u", "]"}], "\[IndentingNewLine]", "//", 
         RowBox[{
          RowBox[{"calcGridTransformTensor", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<x\>\"", "->", 
               RowBox[{"-", "1"}]}], ",", 
              RowBox[{"\"\<y\>\"", "->", 
               RowBox[{"-", "1"}]}]}], "}"}]}], "]"}], "&"}]}], 
        "\[IndentingNewLine]", "//", 
        RowBox[{
         RowBox[{"#", ".", 
          RowBox[{"calcGradTensor", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"TensorContract", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"{", 
            RowBox[{"4", ",", "5"}], "}"}], "}"}]}], "]"}], "&"}]}], 
      "\[IndentingNewLine]", "//", 
      RowBox[{
       RowBox[{"#", ".", 
        RowBox[{"calcGridTransformTensor", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<x\>\"", "->", "0"}], ",", 
            RowBox[{"\"\<y\>\"", "->", "0"}]}], "}"}]}], "]"}]}], "&"}]}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"4", ",", "5"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.9144552026563683`*^9, 3.914455400077204*^9}, {
  3.914456493355373*^9, 3.914456504491682*^9}},
 CellLabel->
  "In[536]:=",ExpressionUUID->"4a067d60-9531-482e-8c36-14691ef1104e"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Blru", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"interp", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
        RowBox[{"-", "1"}]}], "]"}], "\[TensorProduct]", 
      RowBox[{"id", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], 
     "\[IndentingNewLine]", "+", 
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"interp", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"id", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
   3.914432149759726*^9, 3.91443219647787*^9}, {3.914432237920389*^9, 
   3.9144322414377413`*^9}, {3.914432995993266*^9, 3.914432997358787*^9}, {
   3.914456056234662*^9, 3.914456093601943*^9}, 3.914456782772204*^9},
 CellLabel->
  "In[537]:=",ExpressionUUID->"1d836c73-e5fd-4d7c-9e0e-5960cfd3a5bd"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Bbtu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ")"}], 
      "\[TensorProduct]", 
      RowBox[{"interp", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], "\[IndentingNewLine]", "+", 
     RowBox[{
      RowBox[{"vec", "[", 
       RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
      
      RowBox[{"id", "[", 
       RowBox[{"{", 
        RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
      "\[TensorProduct]", 
      RowBox[{"(", 
       RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ")"}], 
      "\[TensorProduct]", 
      RowBox[{"interp", "[", 
       RowBox[{"NN", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}]}], 
    ")"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
   3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
   3.91443230936213*^9}, {3.914432441955035*^9, 3.914432484865398*^9}, {
   3.914432998126777*^9, 3.914432998737596*^9}, {3.9144560982152863`*^9, 
   3.9144561427060547`*^9}, 3.914456783717025*^9},
 CellLabel->
  "In[538]:=",ExpressionUUID->"c88786d8-d8c9-42e5-87fa-4c6d3bc1c9c1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "Bp", "]"}], "=", 
   RowBox[{
    RowBox[{"vec", "[", 
     RowBox[{"1", ",", "0", ",", "\"\<bp\>\""}], "]"}], "\[TensorProduct]", 
    RowBox[{"covec", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "0", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
    RowBox[{"covec", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "0", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
   3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
   3.91443230936213*^9}, {3.914432441955035*^9, 3.9144324476589403`*^9}, {
   3.9144325662733583`*^9, 3.914432621102821*^9}, {3.91443299935546*^9, 
   3.914432999803076*^9}, {3.9144561511074343`*^9, 3.914456175170657*^9}, 
   3.914456784618161*^9},
 CellLabel->
  "In[539]:=",ExpressionUUID->"a05b4906-7948-4d25-851e-1bef6894c532"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesTensors", "[", "lift\[Tau]", "]"}], "=", 
   RowBox[{
    RowBox[{"covec", "[", 
     RowBox[{"1", ",", "0", ",", "\"\<\[Tau]\>\""}], "]"}], 
    "\[TensorProduct]", 
    RowBox[{"vec", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "0", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
    RowBox[{"vec", "[", 
     RowBox[{
      RowBox[{"NN", "-", "2"}], ",", "0", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914431961753078*^9, 3.914431990533448*^9}, {
   3.914432149759726*^9, 3.91443219647787*^9}, {3.914432270319984*^9, 
   3.91443230936213*^9}, {3.914432441955035*^9, 3.9144324476589403`*^9}, {
   3.9144325662733583`*^9, 3.914432621102821*^9}, {3.91443277590138*^9, 
   3.914432783485914*^9}, {3.914433255043366*^9, 3.914433259187025*^9}, {
   3.9144333603531647`*^9, 3.914433360762507*^9}, {3.914456180904407*^9, 
   3.914456186455608*^9}, 3.914456785413993*^9},
 CellLabel->
  "In[540]:=",ExpressionUUID->"e2002ba0-9b44-4d86-a5dd-66fa6b10c0ce"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"linearOps", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"lap", ",", "grad", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"div", ",", "0", ",", "lift"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"bc", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "bc", ",", "0"}], "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"linearOps", "=", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"eq", ",", "var"}], "]"}], "/.", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"eq", "->", 
          RowBox[{"k1", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ",", 
         RowBox[{"var", "->", 
          RowBox[{"k2", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ",", 
         RowBox[{"op", "->", 
          RowBox[{"linearOps", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"k1", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"k2", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}]}]}], "}"}]}], 
      ",", 
      RowBox[{"{", 
       RowBox[{"k1", ",", 
        RowBox[{"enumerate", "[", "eqs", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"k2", ",", 
        RowBox[{"enumerate", "[", "vars", "]"}]}], "}"}]}], "]"}], "/.", " ", 
    
    RowBox[{"0", "->", "zero"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"linearTens", "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"lap", "[", 
       RowBox[{"f", ",", "u"}], "]"}], "->", 
      RowBox[{"-", 
       RowBox[{"stokesTensors", "[", "lapu", "]"}]}]}], ",", 
     RowBox[{
      RowBox[{"grad", "[", 
       RowBox[{"f", ",", "p"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "gradp", "]"}]}], ",", 
     RowBox[{
      RowBox[{"div", "[", 
       RowBox[{"d", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "divu", "]"}]}], ",", 
     RowBox[{
      RowBox[{"lift", "[", 
       RowBox[{"d", ",", "\[Tau]"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "lift\[Tau]", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"bx", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Blru", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"by", ",", "u"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Bbtu", "]"}]}], ",", 
     RowBox[{
      RowBox[{"bc", "[", 
       RowBox[{"bp", ",", "p"}], "]"}], "->", 
      RowBox[{"stokesTensors", "[", "Bp", "]"}]}]}], "}"}]}], ";"}]}], "Input",\

 CellChangeTimes->{{3.91443334238294*^9, 3.91443338030726*^9}, {
   3.914443630923668*^9, 3.914443640948897*^9}, 3.914454019011353*^9, {
   3.914456742198447*^9, 3.914456824002756*^9}, 3.914456894804965*^9},
 CellLabel->
  "In[541]:=",ExpressionUUID->"f5649b4a-bff2-4b89-a0b3-c6b9693d8e08"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ruleZero", "=", 
   RowBox[{
    RowBox[{"zero", "[", 
     RowBox[{"f_", ",", "g_"}], "]"}], "\[RuleDelayed]", 
    RowBox[{"tensor", "[", 
     RowBox[{
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}],
            "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "All"}], ",", "2"}], "\[RightDoubleBracket]"}],
           ",", 
          RowBox[{
           RowBox[{
            RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", "]"}], 
           "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "All"}], ",", "2"}], 
           "\[RightDoubleBracket]"}]}], "]"}]}], "]"}], ",", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}], 
        ",", 
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}], "[", "f", "]"}]}], 
       "]"}], ",", 
      RowBox[{"Length", "[", 
       RowBox[{
        RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "g", "]"}], 
       "]"}]}], "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9},
 CellLabel->
  "In[544]:=",ExpressionUUID->"4674842f-b332-472b-a41a-cc6ab21f7770"],

Cell[BoxData[
 RowBox[{
  RowBox[{"linearArrs", "=", 
   RowBox[{
    RowBox[{"linearOps", "/.", "ruleZero"}], "/.", "linearTens"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9, 3.91443393435355*^9},
 CellLabel->
  "In[545]:=",ExpressionUUID->"b6d24a2f-45ca-400c-a9ab-6fe14d3b4332"],

Cell[BoxData[
 RowBox[{
  RowBox[{"splinearArrs", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"sparse", "[", "m", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"row", ",", "linearArrs"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"m", ",", "row"}], "}"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{3.914433427659485*^9, 3.91443393435355*^9, 
  3.914434067424762*^9},
 CellLabel->
  "In[546]:=",ExpressionUUID->"cc287492-09c7-4d0b-bdc9-a1886524178c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"spsystem", "=", 
   RowBox[{"transformTensorsToMatrixSystem", "[", "splinearArrs", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.914433427659485*^9, 3.91443393435355*^9, {3.914434067424762*^9, 
   3.914434076972457*^9}},
 CellLabel->
  "In[547]:=",ExpressionUUID->"0d2dbf97-565c-4043-ab04-e0b1629a2c1a"],

Cell[BoxData[
 RowBox[{"spsystemLU", "=", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{"N", "[", "spsystem", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.914433427659485*^9, 3.91443393435355*^9, {3.914434067424762*^9, 
   3.914434129636977*^9}},
 CellLabel->
  "In[548]:=",ExpressionUUID->"33885bdf-8158-44a5-b95e-0860b826110f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"prodOp", "=", 
   RowBox[{
    RowBox[{"stokes", "[", "\"\<LU\>\"", "]"}], "[", "spsystem", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.91467786464279*^9, 3.914677890486949*^9}, {
  3.914677920709062*^9, 3.914677924305888*^9}},
 CellLabel->
  "In[549]:=",ExpressionUUID->"babf4bee-cc57-4349-b032-00f0639b1d76"],

Cell[BoxData[
 RowBox[{
  RowBox[{"prodEigs", "=", 
   RowBox[{"Eigensystem", "[", 
    RowBox[{"prodOp", ",", "10"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914677971220496*^9, 3.914677986909409*^9}, {
  3.914678143991941*^9, 3.9146781468710947`*^9}},
 CellLabel->
  "In[550]:=",ExpressionUUID->"015d7dff-d914-4c5f-9412-f90ddc130b0e"],

Cell[BoxData["prodEigs"], "Input",
 CellChangeTimes->{{3.91467819898167*^9, 3.9146781993229723`*^9}},
 CellLabel->
  "In[551]:=",ExpressionUUID->"42656ae1-6cd8-469a-9acf-531b7a3d6c56"],

Cell[CellGroupData[{

Cell["Test accuracy", "Subsubsection",
 CellChangeTimes->{{3.914457002279319*^9, 
  3.91445700421393*^9}},ExpressionUUID->"8d27c259-fff3-4dee-b636-\
6b4bc66e060c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "uc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "ug", "]"}], "//", "toCoeff"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "pc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "pg", "]"}], "//", "toCoeff"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "fc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "fg", "]"}], "//", "toCoeff"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "dc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "dg", "]"}], "//", "toCoeff"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "bxc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "bxg", "]"}], "//", "toCoeff"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "byc", "]"}], "=", 
   RowBox[{
    RowBox[{"solArrs", "[", "byg", "]"}], "//", "toCoeff"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.914457013206849*^9, 3.914457073651999*^9}},
 CellLabel->
  "In[552]:=",ExpressionUUID->"18b96d2f-6ba9-4004-8509-95e5c6e0c1ae"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhs", "=", 
   RowBox[{"transformTensorsToVector", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"solArrs", "[", "fc", "]"}], ",", 
      RowBox[{"solArrs", "[", "dc", "]"}], ",", 
      RowBox[{"solArrs", "[", "bxc", "]"}], ",", 
      RowBox[{"solArrs", "[", "byc", "]"}], ",", 
      RowBox[{"solArrs", "[", "bp", "]"}]}], "}"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.907184409557091*^9, 3.907184589530293*^9}, {
   3.907185066381054*^9, 3.907185079575674*^9}, {3.9074388444234962`*^9, 
   3.907438886997363*^9}, {3.907439108660837*^9, 3.907439111930518*^9}, {
   3.907439167333377*^9, 3.9074391792689*^9}, {3.908573650765775*^9, 
   3.908573659943903*^9}, {3.908573695437396*^9, 3.908573701713323*^9}, {
   3.910813677900455*^9, 3.910813678491828*^9}, {3.914018034965099*^9, 
   3.9140180512065277`*^9}, {3.914024039382469*^9, 3.914024076871774*^9}, {
   3.914024213635038*^9, 3.9140242151955013`*^9}, {3.914444050162519*^9, 
   3.914444068351761*^9}, {3.914444476910515*^9, 3.9144444785105953`*^9}, 
   3.9144446575328074`*^9, {3.914457159109064*^9, 3.914457164359015*^9}},
 CellLabel->
  "In[558]:=",ExpressionUUID->"1eb6b390-7cbc-47fc-8ca6-860e0cc40027"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhsTens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"rhs", ",", 
     RowBox[{"dimensions", "[", "\"\<eqs\>\"", "]"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.907439331897048*^9, 3.907439338184476*^9}, 
   3.910814411840589*^9, {3.914018071307755*^9, 3.914018077175647*^9}, {
   3.914444668696793*^9, 3.914444670755978*^9}},
 CellLabel->
  "In[559]:=",ExpressionUUID->"7923d557-d956-413f-ac4c-fd7e9fdbdbb9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"outvec", "=", 
   RowBox[{"spsystemLU", "[", "rhs", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914446370887936*^9, 3.914446379115769*^9}, {
  3.91444656897134*^9, 3.9144465729156*^9}, {3.914446619802821*^9, 
  3.914446620143382*^9}},
 CellLabel->
  "In[560]:=",ExpressionUUID->"cb8b1dba-9815-49f8-bdcf-1038de7a7f13"],

Cell[BoxData[
 RowBox[{
  RowBox[{"outtens", "=", 
   RowBox[{"transformVectorToTensors", "[", 
    RowBox[{"outvec", ",", 
     RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914446584928589*^9, 3.914446626662054*^9}, {
  3.914459326703929*^9, 3.914459327005283*^9}},
 CellLabel->
  "In[561]:=",ExpressionUUID->"adbe37f6-8d45-4273-a92e-9dfae2de54e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"p0", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "pc", "]"}], "//", "toCoeff"}], "//", 
    RowBox[{
     RowBox[{"#", "[", 
      RowBox[{"[", 
       RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "&"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914446794654896*^9, 3.914446795798244*^9}, {
  3.914446838606612*^9, 3.914446905490564*^9}, {3.914457223466249*^9, 
  3.914457223762284*^9}},
 CellLabel->
  "In[562]:=",ExpressionUUID->"036b0532-ef37-4fc7-867a-b3cf05110d8e"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"outtens", "[", "p", "]"}], "-", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"solArrs", "[", "pc", "]"}], "-", 
        RowBox[{"p0", " ", 
         RowBox[{
          RowBox[{"vec", "[", 
           RowBox[{"30", ",", "0", ",", 
            RowBox[{"{", 
             RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], 
          "\[TensorProduct]", 
          RowBox[{"vec", "[", 
           RowBox[{"30", ",", "0", ",", 
            RowBox[{"{", 
             RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}]}], ")"}]}], 
     ")"}], "//", "getArr"}], "//", "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.9144467347327337`*^9, 3.914446792616104*^9}, {
  3.914446922662259*^9, 3.914446928055319*^9}, {3.914446965684403*^9, 
  3.914446984589849*^9}, {3.9144572384046307`*^9, 3.914457239207537*^9}, {
  3.91445938232899*^9, 3.91445949967991*^9}},
 CellLabel->
  "In[563]:=",ExpressionUUID->"8882007d-ebad-4026-9a27-dbedf1b6d556"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"outtens", "[", "u", "]"}], "-", 
      RowBox[{"solArrs", "[", "uc", "]"}]}], ")"}], "//", "getArr"}], "//", 
   "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914447005325264*^9, 3.914447010963786*^9}, {
  3.914459346474893*^9, 3.914459346678261*^9}},
 CellLabel->
  "In[564]:=",ExpressionUUID->"d457aa80-9076-4a89-9a91-8d09efc7d80f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Test each operator to figure out the problem", "Subsubsection",
 CellChangeTimes->{{3.914458014671708*^9, 
  3.914458035846606*^9}},ExpressionUUID->"addc04f5-5249-476b-b9b8-\
7c081d5e48c5"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "lapuc", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"sols", "[", "lapu", "]"}], "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"transformSymbolicToNumerical", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "->", 
             RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
            RowBox[{"y", "->", 
             RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], 
        "&"}]}], "\[IndentingNewLine]", "//", "toCoeff"}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "3"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914457362032817*^9, 3.914457394314524*^9}, {
   3.914457460639144*^9, 3.914457485131461*^9}, {3.914457630576894*^9, 
   3.914457636222685*^9}, 3.914457684557146*^9, {3.914457750906052*^9, 
   3.914457767380568*^9}},
 CellLabel->
  "In[432]:=",ExpressionUUID->"c5273151-c284-4dd0-8161-a2ff89116597"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "lapuc", "]"}], "-", 
     RowBox[{
      RowBox[{"solArrs", "[", "uc", "]"}], ".", 
      RowBox[{"stokesTensors", "[", "lapu", "]"}]}]}], "//", "getArr"}], "//",
    "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.91445779745603*^9, 3.9144578374253798`*^9}},
 CellLabel->
  "In[433]:=",ExpressionUUID->"ec6fed44-b4a3-4eb6-9fbb-428dd7522fba"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "gradpc", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"sols", "[", "gradp", "]"}], "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"transformSymbolicToNumerical", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "->", 
             RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
            RowBox[{"y", "->", 
             RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], 
        "&"}]}], "\[IndentingNewLine]", "//", "toCoeff"}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "3"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.91445804335959*^9, 3.914458049178412*^9}},
 CellLabel->
  "In[434]:=",ExpressionUUID->"6ec53343-d260-41ff-b9ff-d5edff8414e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "gradpc", "]"}], "-", 
     RowBox[{
      RowBox[{"solArrs", "[", "pc", "]"}], ".", 
      RowBox[{"stokesTensors", "[", "gradp", "]"}]}]}], "//", "getArr"}], "//",
    "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914458104263489*^9, 3.914458121329453*^9}},
 CellLabel->
  "In[435]:=",ExpressionUUID->"bfd92d82-8b5c-4a8b-a556-329e4559b36a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"solArrs", "[", "fc", "]"}], "-", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{
          RowBox[{"solArrs", "[", "uc", "]"}], ".", 
          RowBox[{"stokesTensors", "[", "lapu", "]"}]}]}], "+", 
        RowBox[{
         RowBox[{"solArrs", "[", "pc", "]"}], ".", 
         RowBox[{"stokesTensors", "[", "gradp", "]"}]}]}], ")"}]}], "//", 
     "toGrid"}], "//", "getArr"}], "//", "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914459036744631*^9, 3.914459092578253*^9}},
 CellLabel->
  "In[436]:=",ExpressionUUID->"d5ad031c-3508-4266-8828-906f58daeb52"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "divuc", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"sols", "[", "d", "]"}], "\[IndentingNewLine]", "//", 
       RowBox[{
        RowBox[{"transformSymbolicToNumerical", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"0", "->", 
             RowBox[{"0", 
              RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}]}], ",", 
            RowBox[{"x", "->", 
             RowBox[{"grid", "[", "\"\<xxt\>\"", "]"}]}], ",", 
            RowBox[{"y", "->", 
             RowBox[{"grid", "[", "\"\<yyt\>\"", "]"}]}]}], "}"}]}], "]"}], 
        "&"}]}], "\[IndentingNewLine]", "//", "toCoeff"}], 
     "\[IndentingNewLine]", "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
          RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914458216396718*^9, 3.914458315506816*^9}},
 CellLabel->
  "In[437]:=",ExpressionUUID->"6ea4de32-da1c-4e1d-b0bc-9efead36403b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"solArrs", "[", "uc", "]"}], ".", 
       RowBox[{"stokesTensors", "[", "divu", "]"}]}], "-", 
      RowBox[{"solArrs", "[", "divuc", "]"}]}], ")"}], "//", "getArr"}], "//",
    "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914458321239155*^9, 3.914458354517129*^9}},
 CellLabel->
  "In[438]:=",ExpressionUUID->"7b0eae51-591f-441f-af2b-c59281667445"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Blu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"transformSymbolicToNumerical", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"sols", "[", "u", "]"}], "/.", 
        RowBox[{"x", "->", 
         RowBox[{"-", "1"}]}]}], ",", 
       RowBox[{"{", 
        RowBox[{"y", "->", 
         RowBox[{"grid", "[", "\"\<yt\>\"", "]"}]}], "}"}]}], "]"}], "//", 
     "toCoeff"}], ")"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Bru", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"transformSymbolicToNumerical", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"sols", "[", "u", "]"}], "/.", 
        RowBox[{"x", "->", "1"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"y", "->", 
         RowBox[{"grid", "[", "\"\<yt\>\"", "]"}]}], "}"}]}], "]"}], "//", 
     "toCoeff"}], ")"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Bbu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"transformSymbolicToNumerical", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"sols", "[", "u", "]"}], "/.", 
         RowBox[{"y", "->", 
          RowBox[{"-", "1"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"x", "->", 
          RowBox[{"grid", "[", "\"\<xt\>\"", "]"}]}], "}"}]}], "]"}], "//", 
      "toCoeff"}], "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], "}"}], ",", 
        RowBox[{"{", "2", "}"}]}], "]"}], "&"}]}], ")"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Btu", "]"}], "=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"transformSymbolicToNumerical", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"sols", "[", "u", "]"}], "/.", 
         RowBox[{"y", "->", "1"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"x", "->", 
          RowBox[{"grid", "[", "\"\<xt\>\"", "]"}]}], "}"}]}], "]"}], "//", 
      "toCoeff"}], "//", 
     RowBox[{
      RowBox[{"contractOnes", "[", 
       RowBox[{"#", ",", 
        RowBox[{"{", 
         RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], "}"}], ",", 
        RowBox[{"{", "2", "}"}]}], "]"}], "&"}]}], ")"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914458443793686*^9, 3.9144586525434027`*^9}},
 CellLabel->
  "In[439]:=",ExpressionUUID->"37dfb135-f7cc-4bc2-a16a-bd5c6c713a67"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Blru", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"vec", "[", 
      RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
     RowBox[{"solArrs", "[", "Blu", "]"}]}], "+", 
    RowBox[{
     RowBox[{"vec", "[", 
      RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], "\[TensorProduct]", 
     RowBox[{"solArrs", "[", "Bru", "]"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"solArrs", "[", "Bbtu", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"vec", "[", 
      RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
     RowBox[{"solArrs", "[", "Bbu", "]"}]}], "+", 
    RowBox[{
     RowBox[{"vec", "[", 
      RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], "\[TensorProduct]", 
     RowBox[{"solArrs", "[", "Btu", "]"}]}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914458664490415*^9, 3.9144587678849487`*^9}},
 CellLabel->
  "In[443]:=",ExpressionUUID->"bf89f0ea-7304-4740-8ace-15a1eb2e9de4"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "Blru", "]"}], "-", 
     RowBox[{
      RowBox[{"solArrs", "[", "uc", "]"}], ".", 
      RowBox[{"stokesTensors", "[", "Blru", "]"}]}]}], "//", "getArr"}], "//",
    "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914458770090008*^9, 3.9144588047470303`*^9}},
 CellLabel->
  "In[445]:=",ExpressionUUID->"091637e7-981c-4b68-a337-dba544e77208"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"solArrs", "[", "Bbtu", "]"}], "-", 
     RowBox[{
      RowBox[{"solArrs", "[", "uc", "]"}], ".", 
      RowBox[{"stokesTensors", "[", "Bbtu", "]"}]}]}], "//", "getArr"}], "//",
    "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914458810583694*^9, 3.914458814874186*^9}},
 CellLabel->
  "In[446]:=",ExpressionUUID->"f8131d4e-49fb-4f46-b409-c9a33bddcf4f"]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remapped Stokes iterative solve", "Chapter",
 CellChangeTimes->{{3.913894950933446*^9, 3.913894955576505*^9}, {
  3.9138965704691973`*^9, 
  3.913896577388015*^9}},ExpressionUUID->"f53885c6-4c2b-48c0-bfdb-\
9434dd8b535c"],

Cell["\<\
Now I instead want to build a bunch of operators that apply Stokes. Then I \
can solve things\
\>", "Text",
 CellChangeTimes->{{3.914459618492468*^9, 
  3.914459639275969*^9}},ExpressionUUID->"b13adb52-4b05-4dab-a180-\
0e369b4cd13b"],

Cell["Let\[CloseCurlyQuote]s not try to optimise yet. Let\[CloseCurlyQuote]s \
just calculate", "Text",
 CellChangeTimes->{{3.914607869036675*^9, 
  3.914607877720339*^9}},ExpressionUUID->"959ee570-0317-47c4-ac63-\
fd7193cbb0a6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"dimensions", "=", 
   RowBox[{"\[LeftAssociation]", 
    RowBox[{
     RowBox[{"\"\<vars\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"u", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}]}], "}"}]}], ",", 
        RowBox[{"p", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"\[Tau]", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<\[Tau]\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}], ",", 
     RowBox[{"\"\<eqs\>\"", "\[Rule]", 
      RowBox[{"\[LeftAssociation]", 
       RowBox[{
        RowBox[{"f", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"d", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", 
        RowBox[{"bx", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<lr\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "NN", ",", 
             "\"\<+\>\""}], "}"}]}], "}"}]}], ",", 
        RowBox[{"by", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<bt\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
             RowBox[{"NN", "-", "2"}], ",", "\"\<+\>\""}], "}"}]}], "}"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"bp", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<bp\>\"", ",", "1", ",", "\"\<+\>\""}], "}"}], 
          "}"}]}]}], "\[RightAssociation]"}]}]}], "\[RightAssociation]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"stateTensors", "=", 
   RowBox[{"AssociationMap", "[", 
    RowBox[{
     RowBox[{"Function", "[", 
      RowBox[{
       RowBox[{"{", "var", "}"}], ",", 
       RowBox[{
        RowBox[{"Function", "[", 
         RowBox[{
          RowBox[{"{", "dims", "}"}], ",", 
          RowBox[{"tensor", "[", 
           RowBox[{
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{"{", "}"}], ",", 
              RowBox[{"dims", "[", 
               RowBox[{"[", 
                RowBox[{";;", ",", "2"}], "]"}], "]"}]}], "]"}], ",", "dims", 
            ",", "0"}], "]"}]}], "]"}], "[", 
        RowBox[{
         RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}], "[", "var", "]"}], 
        "]"}]}], "]"}], ",", "vars"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914607897261264*^9, 3.9146079255959873`*^9}},
 CellLabel->
  "In[445]:=",ExpressionUUID->"31a4f749-0f3d-4834-a310-07a0ad44c3fd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"stokesOps", "=", 
   RowBox[{"<|", "|>"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914607991089594*^9, 3.9146080298527937`*^9}},
 CellLabel->
  "In[447]:=",ExpressionUUID->"1c7d8b8a-fbaf-4316-a539-0948298c042d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "lapu", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"u", ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"u", "//", "calcGradNOp"}], "//", "calcGradNOp"}], "//", 
          RowBox[{
           RowBox[{"transformBundle", "[", 
            RowBox[{"#", ",", 
             RowBox[{"{", 
              RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "//", 
         RowBox[{
          RowBox[{"TensorContract", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
        "toCoeff"}], "//", 
       RowBox[{
        RowBox[{"contractOnes", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
            RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "3"}], "}"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "0"}], "]"}], "&"}]}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.9146080750423326`*^9, 3.9146083124313717`*^9}, {
  3.9146083514459343`*^9, 3.9146083696173983`*^9}, {3.9146085823600283`*^9, 
  3.914608611907983*^9}},
 CellLabel->
  "In[492]:=",ExpressionUUID->"62617cba-d299-45d5-a67d-e0c9815b6321"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "gradp", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"p", ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"p", ".", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"\[CapitalPi]", "[", "\"\<x0^\>\"", "]"}], 
              "\[TensorProduct]", 
              RowBox[{"\[CapitalPi]", "[", "\"\<y0^\>\"", "]"}]}], ")"}]}], "//",
            "toGrid"}], "//", "calcGradNOp"}], "//", 
         RowBox[{
          RowBox[{"transformBundle", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"1", "->", "\"\<xy+\>\""}], "}"}]}], "]"}], "&"}]}], "//",
         "toCoeff"}], "//", 
       RowBox[{
        RowBox[{"contractOnes", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
            RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "3"}], "}"}]}], "]"}], "&"}]}], "//", 
      RowBox[{
       RowBox[{"iso", "[", 
        RowBox[{"#", ",", "0"}], "]"}], "&"}]}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914608382915973*^9, 3.914608502434421*^9}, {
  3.914608547415694*^9, 3.914608551081624*^9}, {3.9146085873700247`*^9, 
  3.914608616147329*^9}},
 CellLabel->
  "In[493]:=",ExpressionUUID->"5c456f94-cab3-448a-909b-235a8a2d557a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "divu", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"u", ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"u", "//", "calcGradNOp"}], "//", 
        RowBox[{
         RowBox[{"TensorContract", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"1", ",", "2"}], "}"}], "}"}]}], "]"}], "&"}]}], "//", 
       "toCoeff"}], "//", 
      RowBox[{
       RowBox[{"contractOnes", "[", 
        RowBox[{"#", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ",", 
           RowBox[{"\[CapitalPi]", "[", "\"\<y0v\>\"", "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "&"}]}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914608762440489*^9, 3.914608768907333*^9}, 
   3.914608929801149*^9, {3.9146089831693163`*^9, 3.914609047160197*^9}, {
   3.9146090783853083`*^9, 3.914609119834861*^9}},
 CellLabel->
  "In[494]:=",ExpressionUUID->"12244b28-2adb-4fcf-8295-4c34a5f321fe"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "Blru", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"u", ",", 
     RowBox[{"u", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "0", ",", "\"\<lr\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"interp", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", 
           RowBox[{"-", "1"}]}], "]"}], "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], 
        "\[IndentingNewLine]", "+", 
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "1", ",", "\"\<lr\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"interp", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<x\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}], ")"}]}]}], 
    "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "Bbtu", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"u", ",", 
     RowBox[{"u", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "0", ",", "\"\<bt\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"(", 
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ")"}], 
         "\[TensorProduct]", 
         RowBox[{"interp", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", 
           RowBox[{"-", "1"}]}], "]"}]}], "\[IndentingNewLine]", "+", 
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"2", ",", "1", ",", "\"\<bt\>\""}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"id", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<xy\>\"", ",", "2", ",", "\"\<+\>\""}], "}"}], "]"}], 
         "\[TensorProduct]", 
         RowBox[{"(", 
          RowBox[{"\[CapitalPi]", "[", "\"\<x0v\>\"", "]"}], ")"}], 
         "\[TensorProduct]", 
         RowBox[{"interp", "[", 
          RowBox[{"NN", ",", 
           RowBox[{"{", 
            RowBox[{"\"\<y\>\"", ",", "0"}], "}"}], ",", "1"}], "]"}]}]}], 
       ")"}]}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "Bp", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"p", ",", 
     RowBox[{"p", ".", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"vec", "[", 
         RowBox[{"1", ",", "0", ",", "\"\<bp\>\""}], "]"}], 
        "\[TensorProduct]", 
        RowBox[{"covec", "[", 
         RowBox[{
          RowBox[{"NN", "-", "2"}], ",", "0", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], 
        "\[TensorProduct]", 
        RowBox[{"covec", "[", 
         RowBox[{
          RowBox[{"NN", "-", "2"}], ",", "0", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}], ")"}]}]}], 
    "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.914607991089594*^9, 3.914608034825404*^9}, {
   3.914608759694153*^9, 3.9146087605972157`*^9}, {3.914609123638077*^9, 
   3.9146091243863163`*^9}, {3.914609228544256*^9, 3.914609305078649*^9}, 
   3.914676144901011*^9},
 CellLabel->
  "In[495]:=",ExpressionUUID->"dc117aa0-cdf5-4f6f-87b9-69c7ee0c8aae"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "lift\[Tau]", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"\[Tau]", ",", 
     RowBox[{"\[Tau]", ".", 
      RowBox[{
       RowBox[{"covec", "[", 
        RowBox[{"1", ",", "0", ",", "\"\<\[Tau]\>\""}], "]"}], 
       "\[TensorProduct]", 
       RowBox[{"vec", "[", 
        RowBox[{
         RowBox[{"NN", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", "0"}], "}"}]}], "]"}], "\[TensorProduct]", 
       RowBox[{"vec", "[", 
        RowBox[{
         RowBox[{"NN", "-", "2"}], ",", "0", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<y\>\"", ",", "0"}], "}"}]}], "]"}]}]}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.914607991089594*^9, 3.914608034825404*^9}, {
   3.914608759694153*^9, 3.9146087605972157`*^9}, {3.914609123638077*^9, 
   3.9146091243863163`*^9}, {3.914609228544256*^9, 3.914609305078649*^9}, 
   3.914676144901011*^9},
 CellLabel->
  "In[498]:=",ExpressionUUID->"65022bc8-5101-48cb-9a36-bb31f436583d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "\"\<eqs\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"state", ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"u", ",", "p", ",", "\[Tau]"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"u", ",", "p", ",", "\[Tau]"}], "}"}], "=", "state"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{
             RowBox[{"stokesOps", "[", "lapu", "]"}], "[", "u", "]"}]}], "+", 
           
           RowBox[{
            RowBox[{"stokesOps", "[", "gradp", "]"}], "[", "p", "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"stokesOps", "[", "divu", "]"}], "[", "u", "]"}], "+", 
           RowBox[{
            RowBox[{"stokesOps", "[", "lift\[Tau]", "]"}], "[", "\[Tau]", 
            "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"stokesOps", "[", "Blru", "]"}], "[", "u", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"stokesOps", "[", "Bbtu", "]"}], "[", "u", "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"stokesOps", "[", "Bp", "]"}], "[", "p", "]"}]}], 
         "}"}]}]}], "]"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914609498032361*^9, 3.9146096926972647`*^9}, {
  3.914609786462953*^9, 3.914609804668413*^9}, {3.914609886874842*^9, 
  3.9146098982369633`*^9}, {3.914676038497493*^9, 3.914676082750537*^9}, {
  3.9146762185185423`*^9, 3.914676223526074*^9}, {3.914676308293991*^9, 
  3.914676308730706*^9}},
 CellLabel->
  "In[509]:=",ExpressionUUID->"f99b9324-3c64-4e4a-9577-806a11f83902"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"stokesOps", "[", "\"\<eqsN\>\"", "]"}], "=", 
   RowBox[{"Function", "[", 
    RowBox[{"v", ",", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"v", "//", 
         RowBox[{
          RowBox[{"transformVectorToTensors", "[", 
           RowBox[{"#", ",", 
            RowBox[{"dimensions", "[", "\"\<vars\>\"", "]"}]}], "]"}], 
          "&"}]}], "//", "Values"}], "//", 
       RowBox[{"stokesOps", "[", "\"\<eqs\>\"", "]"}]}], "//", 
      "transformTensorsToVector"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914676277667139*^9, 3.9146762948176928`*^9}, {
  3.914676406103414*^9, 3.914676436905563*^9}, {3.914676469809011*^9, 
  3.914676484188816*^9}},
 CellLabel->
  "In[513]:=",ExpressionUUID->"e2907790-e22a-40ce-a9b1-2492e85c1e56"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"stokesOps", "[", "\"\<eqsN\>\"", "]"}], "[", "outvec", "]"}], 
    "-", "rhs"}], "//", "Abs"}], "//", "Max"}]], "Input",
 CellChangeTimes->{{3.914677023573613*^9, 3.914677069047653*^9}},
 CellLabel->
  "In[532]:=",ExpressionUUID->"114311a0-b4ef-4c8e-9fd3-4092cd20b0b3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"out", "=", 
   RowBox[{"LinearSolve", "[", 
    RowBox[{
     RowBox[{"stokesOps", "[", "\"\<eqsN\>\"", "]"}], ",", "rhs", ",", 
     RowBox[{"Method", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<Krylov\>\"", ",", 
        RowBox[{"\"\<Method\>\"", "->", "\"\<GMRES\>\""}], ",", 
        RowBox[{"MaxIterations", "->", "20"}], ",", 
        RowBox[{"Preconditioner", "->", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"stokes", "[", "\"\<LU\>\"", "]"}], "[", "#", "]"}], 
           "&"}], ")"}]}], ",", 
        RowBox[{"StartingVector", "->", "outvec"}]}], "}"}]}]}], "]"}]}], 
  RowBox[{"(*", 
   RowBox[{",", ",", 
    RowBox[{"\"\<Preconditioner\>\"", "->", "pre"}]}], "*)"}], ";"}]], "Input",\

 CellChangeTimes->{{3.914676909480445*^9, 3.914676925976764*^9}, {
   3.914677015102768*^9, 3.914677015249387*^9}, 3.914677084834921*^9, {
   3.914677137554773*^9, 3.9146771513111777`*^9}, {3.914677260903262*^9, 
   3.914677281113017*^9}, {3.9146773190045137`*^9, 3.914677333554537*^9}, {
   3.9146773992749367`*^9, 3.914677598675976*^9}},
 CellLabel->
  "In[559]:=",ExpressionUUID->"37f8d49a-f0cf-44cc-8327-1e105ec658ba"],

Cell[BoxData[
 RowBox[{
  RowBox[{"matrix", "=", 
   RowBox[{"RandomReal", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"10", ",", "10"}], "}"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.914610259535688*^9, 3.9146102865461407`*^9}, {
  3.914676236110457*^9, 3.914676236696621*^9}},
 CellLabel->
  "In[535]:=",ExpressionUUID->"4a14bfd3-73db-4d20-bbb5-870d762067c8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"vector", "=", 
   RowBox[{"RandomReal", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
     RowBox[{"{", "10", "}"}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.9146103010413713`*^9, 3.914610308752347*^9}, {
  3.914676238257757*^9, 3.9146762386036263`*^9}},
 CellLabel->
  "In[536]:=",ExpressionUUID->"48be7e39-0009-4e87-8bc8-ba69031b50d7"],

Cell[BoxData[
 RowBox[{"LinearSolve", "[", 
  RowBox[{
   RowBox[{
    RowBox[{"matrix", ".", "#"}], "&"}], ",", "vector", ",", 
   RowBox[{"Method", "->", 
    RowBox[{"{", "\"\<Krylov\>\"", "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.914677089597707*^9, 3.914677122887488*^9}},
 CellLabel->
  "In[539]:=",ExpressionUUID->"9a7df599-01c4-4cc3-9e17-88a4eec85c78"],

Cell[BoxData[
 RowBox[{"pre", "=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"mat", "//", "Diagonal"}], "//", 
      RowBox[{
       RowBox[{"1", "/", "#"}], "&"}]}], "//", "DiagonalMatrix"}], "//", 
    "SparseArray"}], "//", 
   RowBox[{
    RowBox[{"Function", "[", 
     RowBox[{"v", ",", 
      RowBox[{"#", ".", "v"}]}], "]"}], "&"}]}]}]], "Input",
 CellChangeTimes->{{3.914675091161169*^9, 3.914675144414976*^9}},
 CellLabel->
  "In[463]:=",ExpressionUUID->"cf0063b9-30d7-4785-b6bc-dffcb529cedb"],

Cell[BoxData[
 RowBox[{"Timing", "[", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{"mat", ",", "vec", ",", 
    RowBox[{"Method", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Krylov\>\"", ",", 
       RowBox[{"\"\<Method\>\"", "->", "\"\<GMRES\>\""}]}], "}"}]}]}], "]"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.914675237499557*^9, 3.914675237631274*^9}},
 CellLabel->
  "In[471]:=",ExpressionUUID->"a885b061-a290-45d5-b79b-2af0309e0a47"],

Cell[BoxData[
 RowBox[{"Timing", "[", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{"mat", ",", "vec", ",", 
    RowBox[{"Method", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Krylov\>\"", ",", 
       RowBox[{"\"\<Method\>\"", "->", "\"\<GMRES\>\""}], ",", 
       RowBox[{"\"\<Preconditioner\>\"", "->", "\"\<ILU0\>\""}]}], "}"}]}]}], 
   "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.914675223323217*^9, 3.914675226246847*^9}},
 CellLabel->
  "In[469]:=",ExpressionUUID->"77826675-6e7d-4eb9-b1b0-b9966ae534ea"],

Cell[BoxData[
 RowBox[{"Timing", "[", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{"mat", ",", "vec", ",", 
    RowBox[{"Method", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Krylov\>\"", ",", 
       RowBox[{"\"\<Method\>\"", "->", "\"\<GMRES\>\""}], ",", 
       RowBox[{"\"\<Preconditioner\>\"", "->", "pre"}]}], "}"}]}]}], "]"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.914674857452392*^9, 3.914674919922281*^9}, {
  3.914675184593018*^9, 3.914675211389236*^9}},
 CellLabel->
  "In[474]:=",ExpressionUUID->"7506030e-a2ef-462e-87c5-0897d423c458"],

Cell[BoxData[
 RowBox[{"Timing", "[", 
  RowBox[{"LinearSolve", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"mat", ".", "#"}], "&"}], ",", "vec", ",", 
    RowBox[{"Method", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Krylov\>\"", ",", 
       RowBox[{"\"\<Method\>\"", "->", "\"\<GMRES\>\""}], ",", 
       RowBox[{"\"\<Preconditioner\>\"", "->", "pre"}]}], "}"}]}]}], "]"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.914675849945604*^9, 3.914675850709744*^9}},
 CellLabel->
  "In[475]:=",ExpressionUUID->"6537087e-8720-4217-8c59-3c7ab058b769"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1023, 942},
WindowMargins->{{271, Automatic}, {Automatic, 0}},
CellEpilog:>SelectionMove[
  NextCell[CellStyle -> "Input"], All, Cell],
FrontEndVersion->"14.1 for Mac OS X ARM (64-bit) (July 16, 2024)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"2c41937e-e744-4d52-8bd9-1c29d4270d5a"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 150, 3, 144, "Title",ExpressionUUID->"c6eaf04e-5dd5-4fa8-8343-b8a0adf0f543"],
Cell[733, 27, 729, 14, 181, "Text",ExpressionUUID->"51853c45-fdd6-48d2-a8bf-19abede64a62"],
Cell[1465, 43, 679, 14, 74, "Input",ExpressionUUID->"54c3bc48-6d32-47a6-b000-3708fa8050da"],
Cell[2147, 59, 399, 12, 44, "Input",ExpressionUUID->"ba8fb7a7-a42e-417e-ae8d-70df1a2a678e"],
Cell[CellGroupData[{
Cell[2571, 75, 163, 3, 101, "Chapter",ExpressionUUID->"11b3a1c5-fdce-4466-a82d-e301c5a953ca"],
Cell[2737, 80, 792, 13, 149, "Text",ExpressionUUID->"7ba65c4f-a04e-41aa-800a-3d68ae21e13a"],
Cell[3532, 95, 171, 3, 50, "Text",ExpressionUUID->"a9789e02-6695-4f4c-8da8-7fa3b2c9b5f3"],
Cell[3706, 100, 1001, 24, 44, "Input",ExpressionUUID->"15db0f28-36e5-442e-a3c0-3b68aa4f7b90"],
Cell[4710, 126, 1076, 20, 247, "Text",ExpressionUUID->"0931edf4-abbd-4fd9-b0f5-a876e02f0dd5"],
Cell[5789, 148, 344, 7, 83, "Text",ExpressionUUID->"b57a2df7-22e0-40ea-a85f-f54565ec6558"],
Cell[6136, 157, 1090, 27, 135, "Input",ExpressionUUID->"16c0bc3a-8e04-4850-83dc-c4233f529981"],
Cell[7229, 186, 254, 6, 50, "Text",ExpressionUUID->"5f45dd4a-e3dd-45c5-a460-4bfaa5fd4133"],
Cell[7486, 194, 1661, 47, 227, "Input",ExpressionUUID->"53ae447e-bb21-45e3-b0d8-db043541951b"],
Cell[9150, 243, 366, 7, 83, "Text",ExpressionUUID->"3f78eae5-715e-4870-9371-aefefe5689b8"],
Cell[9519, 252, 1583, 46, 227, "Input",ExpressionUUID->"841373e2-27a2-4eb0-a117-2e488c5c0ffd"],
Cell[CellGroupData[{
Cell[11127, 302, 174, 3, 79, "Subsection",ExpressionUUID->"b5930f48-7416-4eb0-96c7-211200554e6d"],
Cell[CellGroupData[{
Cell[11326, 309, 213, 4, 46, "ItemNumbered",ExpressionUUID->"c806f52f-ff07-4371-a770-4da294c2dbb7"],
Cell[11542, 315, 1741, 40, 258, "Input",ExpressionUUID->"95b063e2-a55d-42c4-b9fa-95b15a13872c"],
Cell[13286, 357, 594, 17, 44, "Input",ExpressionUUID->"892f1ab5-dd76-49b3-a12f-6883a6233b93"],
Cell[13883, 376, 594, 17, 44, "Input",ExpressionUUID->"fc1717a9-ec1e-4007-be58-5be041360baf"]
}, Open  ]],
Cell[CellGroupData[{
Cell[14514, 398, 231, 4, 46, "ItemNumbered",ExpressionUUID->"247b04f1-364a-4cb3-89e4-742a66e1b12a"],
Cell[14748, 404, 2917, 72, 319, "Input",ExpressionUUID->"8ce8e460-f80a-4ab2-a765-0e516e937bca"],
Cell[17668, 478, 390, 10, 44, "Input",ExpressionUUID->"59747450-e202-4dce-9590-0457e5691eef"]
}, Open  ]],
Cell[CellGroupData[{
Cell[18095, 493, 372, 8, 46, "ItemNumbered",ExpressionUUID->"21806d49-ab7a-4fee-ad72-82974c605789"],
Cell[18470, 503, 2789, 61, 166, "Input",ExpressionUUID->"18fe28f2-da44-4f19-95a2-793b3ef1d738"],
Cell[21262, 566, 2802, 71, 258, "Input",ExpressionUUID->"b77c839d-ab95-44c0-ab8a-20f1daf5810b"],
Cell[24067, 639, 771, 22, 74, "Input",ExpressionUUID->"defc2de5-843d-4003-b800-2950a7c4048a"]
}, Open  ]],
Cell[CellGroupData[{
Cell[24875, 666, 290, 7, 46, "ItemNumbered",ExpressionUUID->"c35e4632-a609-44c1-8338-76fd7edb3c09"],
Cell[25168, 675, 991, 20, 105, "Input",ExpressionUUID->"985883f7-f1cf-437d-abec-db29939503ae"],
Cell[26162, 697, 795, 23, 74, "Input",ExpressionUUID->"e7e9cd6b-fef2-415c-a139-2734c57965b4"]
}, Open  ]],
Cell[CellGroupData[{
Cell[26994, 725, 371, 8, 76, "ItemNumbered",ExpressionUUID->"6b9fc686-53e8-4e05-af94-9d219cc9b09f"],
Cell[27368, 735, 697, 14, 44, "Input",ExpressionUUID->"489309fb-38ac-4590-8862-1d93d412f75b"],
Cell[28068, 751, 463, 13, 44, "Input",ExpressionUUID->"0af2bd34-44ae-44c2-a3bc-0c41dd3d012b"]
}, Open  ]],
Cell[28546, 767, 554, 14, 83, "Text",ExpressionUUID->"c8b0e505-1196-4d32-9779-e229a25b01d2"],
Cell[CellGroupData[{
Cell[29125, 785, 331, 7, 46, "ItemNumbered",ExpressionUUID->"4609aaa4-f233-4a0a-bb52-3c3dc85af540"],
Cell[29459, 794, 4354, 90, 289, "Input",ExpressionUUID->"0202d96c-3929-4236-a745-86c7c4196c45"]
}, Open  ]],
Cell[33828, 887, 528, 9, 116, "Text",ExpressionUUID->"ab3b26fd-3622-4c02-900d-67ce319a7983"],
Cell[34359, 898, 667, 20, 44, "Input",ExpressionUUID->"69116e60-33f4-4c89-a2c5-e2615964804c"],
Cell[35029, 920, 667, 20, 44, "Input",ExpressionUUID->"6f3cef9d-a4ea-40b0-9456-ccc2bbd58c1b"],
Cell[35699, 942, 342, 7, 116, "Text",ExpressionUUID->"9d4dbd7e-bd80-4e4b-9763-1b489fe6a404"],
Cell[CellGroupData[{
Cell[36066, 953, 356, 6, 46, "ItemNumbered",ExpressionUUID->"b8c79a89-c8d5-46ff-afa9-4079f07c8a57"],
Cell[36425, 961, 1111, 32, 135, "Input",ExpressionUUID->"4f7b240c-8070-4eac-a56c-c386ccb5a338"],
Cell[37539, 995, 4511, 98, 319, "Input",ExpressionUUID->"91145917-5bbb-45c5-8d54-e529613ada85"]
}, Open  ]],
Cell[42065, 1096, 317, 7, 83, "Text",ExpressionUUID->"86934ce1-431a-4826-bd02-ccaa94d75f94"],
Cell[42385, 1105, 228, 5, 50, "Text",ExpressionUUID->"4fc37b44-cc76-4393-924d-b93923c9a444"],
Cell[42616, 1112, 652, 20, 44, "Input",ExpressionUUID->"6a711267-79f4-4b06-9edf-986dc528f0b4"],
Cell[43271, 1134, 310, 7, 83, "Text",ExpressionUUID->"64af2cab-c347-4045-a873-f6e845197187"],
Cell[43584, 1143, 652, 20, 44, "Input",ExpressionUUID->"8974940e-65ac-4104-8156-f0e171028ecd"],
Cell[44239, 1165, 205, 3, 50, "Text",ExpressionUUID->"1a296220-10e9-448d-91c1-5af5efe20800"],
Cell[44447, 1170, 971, 30, 74, "Input",ExpressionUUID->"0e42a38c-40a4-49c3-a10e-fe01e55f0021"],
Cell[45421, 1202, 971, 30, 74, "Input",ExpressionUUID->"9a7ecf83-3855-4ac6-8336-3cb2426718ab"],
Cell[46395, 1234, 493, 9, 149, "Text",ExpressionUUID->"ec3d1919-1f0b-44de-a24c-b90748241073"],
Cell[CellGroupData[{
Cell[46913, 1247, 255, 4, 46, "ItemNumbered",ExpressionUUID->"65b1896c-316a-46cd-b051-f46e42f8dc53"],
Cell[47171, 1253, 1933, 43, 135, "Input",ExpressionUUID->"12363023-cc94-432f-9148-e1d11db7247d"]
}, Open  ]],
Cell[49119, 1299, 403, 8, 116, "Text",ExpressionUUID->"48ca36b3-0391-4312-9bad-a196e759b9fd"],
Cell[CellGroupData[{
Cell[49547, 1311, 467, 12, 46, "ItemNumbered",ExpressionUUID->"53b922d2-125f-4a6d-8435-660836c3d4da"],
Cell[50017, 1325, 2482, 61, 258, "Input",ExpressionUUID->"9974d3f9-6557-40d9-b39a-d840789cff83"]
}, Open  ]],
Cell[CellGroupData[{
Cell[52536, 1391, 359, 7, 76, "ItemNumbered",ExpressionUUID->"bde73839-5d6e-4158-83dc-2924dc0624dd"],
Cell[52898, 1400, 1324, 33, 227, "Input",ExpressionUUID->"0c6b95eb-3ee6-44fc-a525-61fc1abdd305"]
}, Open  ]],
Cell[CellGroupData[{
Cell[54259, 1438, 480, 9, 46, "ItemNumbered",ExpressionUUID->"c6167a36-5e0d-40cb-92fa-11df0d13c09f"],
Cell[54742, 1449, 647, 17, 105, "Input",ExpressionUUID->"fba344d6-b732-4614-9f7a-a39cbe1eb669"],
Cell[55392, 1468, 1807, 44, 166, "Input",ExpressionUUID->"b6b04c4a-0ea4-444d-8478-c2e5a85938ae"],
Cell[57202, 1514, 1557, 38, 197, "Input",ExpressionUUID->"637478d3-f56e-427a-86bf-273f6ef8de66"]
}, Open  ]],
Cell[58774, 1555, 710, 12, 214, "Text",ExpressionUUID->"5b293b61-0f4c-4a7a-a13b-734ab6752273"],
Cell[CellGroupData[{
Cell[59509, 1571, 539, 10, 76, "ItemNumbered",ExpressionUUID->"cbfd1bb8-f22d-4745-8283-813f358b2b0e"],
Cell[60051, 1583, 576, 14, 74, "Input",ExpressionUUID->"7c66ab43-43fc-491f-9ad0-8b38d282975b"]
}, Open  ]],
Cell[CellGroupData[{
Cell[60664, 1602, 599, 10, 76, "ItemNumbered",ExpressionUUID->"a232dc43-db31-4da9-9b4a-f0675478a5a7"],
Cell[61266, 1614, 597, 13, 74, "Input",ExpressionUUID->"e4e17f3a-554b-4741-a3e6-e2b36dd0547e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[61900, 1632, 542, 8, 46, "ItemNumbered",ExpressionUUID->"010a95c7-0b51-40f2-8a75-df46b76adafe"],
Cell[62445, 1642, 595, 13, 44, "Input",ExpressionUUID->"08e195bb-e017-45fb-af3a-4c7a7e2a27d4"]
}, Open  ]],
Cell[CellGroupData[{
Cell[63077, 1660, 644, 11, 76, "ItemNumbered",ExpressionUUID->"8669f0eb-473e-4a43-9da0-fc420f5b1a64"],
Cell[63724, 1673, 493, 12, 44, "Input",ExpressionUUID->"4cc9d3ef-f237-4bbe-89ef-e2ea45279d59"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[64278, 1692, 212, 4, 101, "Chapter",ExpressionUUID->"23cd2ae5-36b9-4253-a5d6-81d5a38d8390"],
Cell[64493, 1698, 456, 8, 83, "Text",ExpressionUUID->"33bb27f1-f492-43dd-b4d7-d5203cf0ffd1"],
Cell[CellGroupData[{
Cell[64974, 1710, 430, 8, 76, "ItemNumbered",ExpressionUUID->"1f967315-7adc-44f9-b79b-f271382a6842"],
Cell[65407, 1720, 1500, 33, 166, "Input",ExpressionUUID->"f8f8b370-985c-4efe-a3df-0be747b46286"],
Cell[66910, 1755, 544, 13, 74, "Input",ExpressionUUID->"b94e7325-b489-4c77-a532-4e42c874b743"]
}, Open  ]],
Cell[CellGroupData[{
Cell[67491, 1773, 444, 8, 76, "ItemNumbered",ExpressionUUID->"7226d879-d035-4dfd-9288-e267c23332cd"],
Cell[67938, 1783, 3475, 94, 503, "Input",ExpressionUUID->"3cc515e9-2e89-4e77-a7a4-1b2441034827"]
}, Open  ]],
Cell[CellGroupData[{
Cell[71450, 1882, 441, 6, 46, "ItemNumbered",ExpressionUUID->"794b3135-1d4e-4fd2-bb7e-ea88c8088510"],
Cell[71894, 1890, 743, 20, 105, "Input",ExpressionUUID->"75376685-d169-438f-9c29-d8ac9c5b5d9e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[72674, 1915, 573, 10, 105, "ItemNumbered",ExpressionUUID->"c611872b-9dbf-4449-875c-f2357ce0a9d8"],
Cell[73250, 1927, 1544, 35, 135, "Input",ExpressionUUID->"9141e0e9-0a4f-432b-8223-8bc5927eba45"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[74843, 1968, 257, 4, 101, "Chapter",ExpressionUUID->"25460260-283f-442d-8e7e-6bce2630c320"],
Cell[75103, 1974, 331, 7, 83, "Text",ExpressionUUID->"5e236c9c-e5ed-4cb0-b98b-0f7abe03773c"],
Cell[CellGroupData[{
Cell[75459, 1985, 203, 3, 79, "Subsection",ExpressionUUID->"c3ac774a-51f8-4afd-881f-6525c0b69498"],
Cell[75665, 1990, 407, 8, 116, "Text",ExpressionUUID->"a27cbc06-d8db-47a9-8446-2e79b3dfb1ee"],
Cell[76075, 2000, 11833, 337, 2113, "Input",ExpressionUUID->"19c8849e-ca79-4174-a1a9-9234067314e8"],
Cell[87911, 2339, 189, 3, 50, "Text",ExpressionUUID->"5e0aac2e-0cc3-419d-8db4-8b8c593bdbfc"],
Cell[88103, 2344, 1410, 43, 197, "Input",ExpressionUUID->"8bbb0fab-33d7-43e5-b2b1-91b66f628712"]
}, Open  ]],
Cell[CellGroupData[{
Cell[89550, 2392, 238, 4, 79, "Subsection",ExpressionUUID->"a31e258a-553b-4472-9d4f-84ad26b4b920"],
Cell[CellGroupData[{
Cell[89813, 2400, 520, 14, 46, "ItemNumbered",ExpressionUUID->"622a8c88-e4c9-453d-8436-080c1d2c6883"],
Cell[90336, 2416, 1177, 33, 105, "Input",ExpressionUUID->"0706ee6e-8b4f-433e-a74c-2591fb719819"]
}, Open  ]],
Cell[CellGroupData[{
Cell[91550, 2454, 730, 22, 46, "ItemNumbered",ExpressionUUID->"10f47d50-959a-492d-b5b6-30a7e6f170b5"],
Cell[92283, 2478, 1036, 26, 105, "Input",ExpressionUUID->"7e739273-d004-43d5-a6d3-0910138394f0"]
}, Open  ]],
Cell[CellGroupData[{
Cell[93356, 2509, 656, 16, 46, "ItemNumbered",ExpressionUUID->"f7a6b15c-3de6-4713-af1e-bfb893449589"],
Cell[94015, 2527, 2538, 44, 44, "Input",ExpressionUUID->"087db718-5caf-403e-8561-12eb93d6ffe7"]
}, Open  ]],
Cell[CellGroupData[{
Cell[96590, 2576, 772, 18, 46, "ItemNumbered",ExpressionUUID->"92072a9b-81be-4cf4-9eea-a28d63ab4107"],
Cell[97365, 2596, 2585, 44, 44, "Input",ExpressionUUID->"7c53fbef-bfab-4824-8458-390108d8a107"]
}, Open  ]],
Cell[CellGroupData[{
Cell[99987, 2645, 833, 19, 76, "ItemNumbered",ExpressionUUID->"7411d23d-8314-4bfd-b9b5-549f89ec5a7f"],
Cell[100823, 2666, 893, 24, 74, "Input",ExpressionUUID->"5db70b1e-b780-4098-8eb7-940aaa8f5237"]
}, Open  ]],
Cell[CellGroupData[{
Cell[101753, 2695, 1152, 28, 105, "ItemNumbered",ExpressionUUID->"af1d2587-49d6-475d-b431-cb278899d104"],
Cell[102908, 2725, 2259, 59, 258, "Input",ExpressionUUID->"48a701a6-838c-49b1-b9f6-8ccb868e515b"]
}, Open  ]],
Cell[CellGroupData[{
Cell[105204, 2789, 937, 24, 105, "ItemNumbered",ExpressionUUID->"2926e7ba-6640-46fd-b3db-2ef77405c0e1"],
Cell[106144, 2815, 1405, 34, 135, "Input",ExpressionUUID->"2d836afb-10fa-49f7-91d6-d147a8e53cfa"]
}, Open  ]],
Cell[CellGroupData[{
Cell[107586, 2854, 1090, 31, 105, "ItemNumbered",ExpressionUUID->"9e658c87-875c-4502-8a72-945d5242358b"],
Cell[108679, 2887, 928, 27, 74, "Input",ExpressionUUID->"b84867c7-85ff-46a2-b096-11f9becbd5f5"]
}, Open  ]],
Cell[CellGroupData[{
Cell[109644, 2919, 774, 24, 76, "ItemNumbered",ExpressionUUID->"d9dc7360-272e-4611-a0ed-1fc9a5f61dbd"],
Cell[110421, 2945, 2207, 63, 227, "Input",ExpressionUUID->"4371c52d-8dad-47ad-a4c5-517c78286743"]
}, Open  ]],
Cell[CellGroupData[{
Cell[112665, 3013, 1014, 31, 76, "ItemNumbered",ExpressionUUID->"24864900-16ad-4477-b5f2-4b8747e06860"],
Cell[113682, 3046, 990, 28, 74, "Input",ExpressionUUID->"371b1b87-3275-47a4-8cee-00b179605d24"]
}, Open  ]],
Cell[CellGroupData[{
Cell[114709, 3079, 723, 20, 46, "ItemNumbered",ExpressionUUID->"d788940c-31e1-40d1-9f66-72f58efc1df6"],
Cell[115435, 3101, 2795, 52, 74, "Input",ExpressionUUID->"0838ca9a-571c-4a17-a026-df034c0989cb"]
}, Open  ]],
Cell[CellGroupData[{
Cell[118267, 3158, 888, 23, 76, "ItemNumbered",ExpressionUUID->"d56a7eaf-7523-4287-a201-ae21a98d13ba"],
Cell[119158, 3183, 3929, 83, 259, "Input",ExpressionUUID->"4db253c8-3d6e-4f1d-9413-f595ba7199dd"]
}, Open  ]],
Cell[CellGroupData[{
Cell[123124, 3271, 729, 17, 77, "ItemNumbered",ExpressionUUID->"5bbb41ae-32f6-44ff-85f6-d321c9933e0b"],
Cell[123856, 3290, 1116, 32, 74, "Input",ExpressionUUID->"cb9dddf1-2c96-432f-af45-7bb40c9e000c"]
}, Open  ]],
Cell[CellGroupData[{
Cell[125009, 3327, 826, 19, 77, "ItemNumbered",ExpressionUUID->"6734b151-7121-43bb-8d80-d54a4747ec1e"],
Cell[125838, 3348, 1062, 31, 74, "Input",ExpressionUUID->"a1da5e31-9f6d-4934-ad20-0360a5cb2a17"]
}, Open  ]],
Cell[CellGroupData[{
Cell[126937, 3384, 474, 7, 46, "ItemNumbered",ExpressionUUID->"2ee49d0b-038e-44f6-8be3-5cde5c2a40b5"],
Cell[127414, 3393, 1739, 49, 227, "Input",ExpressionUUID->"45032a8d-9620-4c8a-b02a-a37751a20771"],
Cell[129156, 3444, 680, 19, 74, "Input",ExpressionUUID->"139d428c-a6f0-48c0-992b-dc47a4d05e17"]
}, Open  ]],
Cell[CellGroupData[{
Cell[129873, 3468, 524, 8, 46, "ItemNumbered",ExpressionUUID->"163ff97b-32ff-4db9-ac87-677226fd2f09"],
Cell[130400, 3478, 982, 25, 74, "Input",ExpressionUUID->"772e3a16-54dd-48d7-8b8a-ae79e130e662"],
Cell[131385, 3505, 496, 14, 74, "Input",ExpressionUUID->"ba6bea37-7f2b-4ca1-9353-b8794e82c5c4"],
Cell[131884, 3521, 606, 15, 105, "Input",ExpressionUUID->"cfceb139-9845-4c9b-bfd4-4074c4f4e33d"],
Cell[132493, 3538, 733, 20, 74, "Input",ExpressionUUID->"4a953ab4-eb0f-444e-a68b-350c8d60ca33"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[133287, 3565, 162, 3, 101, "Chapter",ExpressionUUID->"809365ce-c9c9-4f47-b089-df929c1ad113"],
Cell[133452, 3570, 251, 6, 83, "Text",ExpressionUUID->"daaff92b-a738-4e77-8105-070ecaf7979b"],
Cell[CellGroupData[{
Cell[133728, 3580, 242, 4, 79, "Subsection",ExpressionUUID->"721c12b9-7371-4e61-8acf-d34ff49ab51d"],
Cell[133973, 3586, 849, 18, 74, "Input",ExpressionUUID->"0cd359fd-fd2f-4621-a238-18f7c0502b4b"],
Cell[134825, 3606, 1356, 30, 166, "Input",ExpressionUUID->"879150d2-73ee-478d-b986-6cc96ab5aca9"],
Cell[136184, 3638, 242, 6, 50, "Text",ExpressionUUID->"b7515fa3-50df-447b-8eac-8e8f008d3272"],
Cell[136429, 3646, 2909, 72, 381, "Input",ExpressionUUID->"50c725b3-a0fa-455c-9e87-7bf718b5477c"],
Cell[139341, 3720, 237, 6, 50, "Text",ExpressionUUID->"2c22d19b-ff50-4624-b4a9-cbc57de09d3f"],
Cell[139581, 3728, 2591, 61, 197, "Input",ExpressionUUID->"ba410ddf-7108-4a7f-8413-bbe5552d42e6"],
Cell[142175, 3791, 334, 7, 83, "Text",ExpressionUUID->"fb9c61a8-74ca-4ae0-96ba-c5141e336610"],
Cell[142512, 3800, 2216, 59, 227, "Input",ExpressionUUID->"a236f225-e1ba-4984-992b-dabd391f4063"],
Cell[144731, 3861, 329, 7, 83, "Text",ExpressionUUID->"ab66ba09-1151-41c3-8911-c65db94ea8af"],
Cell[145063, 3870, 2155, 50, 289, "Input",ExpressionUUID->"2d9c4f47-8202-4eb6-9477-542ba5646b21"],
Cell[147221, 3922, 234, 6, 50, "Text",ExpressionUUID->"da88134f-0788-4b29-a599-db3e65b1e97f"],
Cell[147458, 3930, 6594, 128, 472, "Input",ExpressionUUID->"630e263a-62ac-40c3-af96-14cd31a4b728"]
}, Open  ]],
Cell[CellGroupData[{
Cell[154089, 4063, 265, 4, 79, "Subsection",ExpressionUUID->"2eff3394-3006-479e-bf69-86a6097936f9"],
Cell[154357, 4069, 618, 12, 181, "Text",ExpressionUUID->"6f7777b9-2749-47af-a5fe-f6aa1735deed"],
Cell[154978, 4083, 336, 9, 74, "Input",ExpressionUUID->"7e284ead-293c-4444-b7e0-fe7872be2285"],
Cell[155317, 4094, 4641, 146, 350, "Input",ExpressionUUID->"b3d6455a-c0bf-4633-979f-0f385a7ed93d"],
Cell[159961, 4242, 163, 3, 50, "Text",ExpressionUUID->"5d93bcca-aafd-4b38-8038-9f3e67723d7a"],
Cell[160127, 4247, 794, 20, 44, "Input",ExpressionUUID->"6733593c-cd00-4656-989c-6abbe135f51a"],
Cell[160924, 4269, 153, 3, 50, "Text",ExpressionUUID->"56b81e5c-519b-4dd3-b357-7780cac746b5"],
Cell[161080, 4274, 297, 7, 44, "Input",ExpressionUUID->"ab562252-c3c0-46d2-b533-45efa087c6eb"],
Cell[161380, 4283, 1064, 21, 44, "Input",ExpressionUUID->"a3d3d1e7-6962-41da-94ce-6bcc5832fd8a"],
Cell[162447, 4306, 1674, 41, 105, "Input",ExpressionUUID->"e7fc1d4b-ecff-43ef-a71a-82b7d4596570"],
Cell[164124, 4349, 293, 6, 83, "Text",ExpressionUUID->"4fbff1b5-45ca-4281-9d84-4599bbee3491"],
Cell[164420, 4357, 859, 16, 44, "Input",ExpressionUUID->"ce9deb63-7767-41bb-8b06-1af30f30fd71"],
Cell[165282, 4375, 1443, 36, 105, "Input",ExpressionUUID->"b8fca20b-ca8d-4def-954b-e2efe8c8e68e"],
Cell[166728, 4413, 217, 5, 50, "Text",ExpressionUUID->"80dfb0e1-119f-4dd4-ab7f-2551e3421c5f"],
Cell[166948, 4420, 557, 13, 44, "Input",ExpressionUUID->"02c4b812-474b-4e38-8086-b659dc1a4b50"],
Cell[167508, 4435, 250, 6, 83, "Text",ExpressionUUID->"db859df2-59ca-45cc-994c-411928ae6836"],
Cell[167761, 4443, 1631, 44, 135, "Input",ExpressionUUID->"7893c068-4589-49ae-a555-ddd60b0c0ccd"],
Cell[169395, 4489, 205, 4, 44, "Input",ExpressionUUID->"688b90ce-44f8-4e62-99e5-4f28193ac3e3"],
Cell[169603, 4495, 213, 5, 50, "Text",ExpressionUUID->"0bb27577-2b7d-497a-9f9f-b5b8d4e9601d"],
Cell[169819, 4502, 758, 18, 44, "Input",ExpressionUUID->"51d3376b-b4fc-4ead-8464-69c2032ce865"],
Cell[170580, 4522, 487, 13, 44, "Input",ExpressionUUID->"22066e38-2a7c-4aab-bd1b-accf0792f8c1"],
Cell[171070, 4537, 1105, 26, 74, "Input",ExpressionUUID->"622f1570-3719-4ae7-919d-8b93e0d0ff84"],
Cell[172178, 4565, 216, 5, 50, "Text",ExpressionUUID->"e473dc8e-4e8c-4079-b6f1-f8a03f09eff5"],
Cell[172397, 4572, 2101, 50, 105, "Input",ExpressionUUID->"cf69b482-1552-428b-ab3a-63be92312012"],
Cell[174501, 4624, 2195, 51, 105, "Input",ExpressionUUID->"8ba1f839-8a3b-48a9-91f5-68e4808f99f2"],
Cell[176699, 4677, 1484, 33, 74, "Input",ExpressionUUID->"174e8818-5691-4a63-a3cc-b3f1fa32bed1"],
Cell[178186, 4712, 284, 6, 83, "Text",ExpressionUUID->"b2eef85b-0c42-4e2e-a773-4c94b254f251"],
Cell[178473, 4720, 854, 19, 44, "Input",ExpressionUUID->"b6ceabbf-4064-4570-9429-3b5c411e0920"],
Cell[179330, 4741, 800, 18, 44, "Input",ExpressionUUID->"10fd71f3-3b7a-45f9-ab7e-eda2aef52e7f"],
Cell[180133, 4761, 1193, 29, 74, "Input",ExpressionUUID->"fc97719e-c453-4c3d-85e3-5d8d10e173f4"],
Cell[181329, 4792, 267, 6, 83, "Text",ExpressionUUID->"9bcf551a-5e39-440c-a5bf-111a4e2c2a21"],
Cell[181599, 4800, 1463, 43, 166, "Input",ExpressionUUID->"0dfd653d-81db-4c44-92a3-22ad0938448d"],
Cell[183065, 4845, 1473, 42, 166, "Input",ExpressionUUID->"3dcf22dc-92f5-4b04-88de-95a08b116bd5"],
Cell[184541, 4889, 6108, 169, 656, "Input",ExpressionUUID->"cfa30ac3-ec75-4a16-ab2b-d5cb33213e70"],
Cell[190652, 5060, 210, 4, 50, "Text",ExpressionUUID->"7df4d0b3-f520-4d58-bb93-797263d41f93"],
Cell[190865, 5066, 1952, 54, 166, "Input",ExpressionUUID->"02056c2a-fbf7-41f9-9a8e-1b701b58be3c"]
}, Open  ]],
Cell[CellGroupData[{
Cell[192854, 5125, 179, 3, 79, "Subsection",ExpressionUUID->"c21fac60-9b40-4b15-8581-e9750c9032ab"],
Cell[193036, 5130, 268, 6, 83, "Text",ExpressionUUID->"4db4b55a-ff6a-4a01-a7a1-e9f7233b29cd"],
Cell[193307, 5138, 784, 21, 105, "Input",ExpressionUUID->"f786fdf2-6a5b-4613-b04b-7406acc15c85"],
Cell[194094, 5161, 824, 22, 74, "Input",ExpressionUUID->"1678bb38-bafc-42d4-9ffc-9ddcf0d1dde9"],
Cell[194921, 5185, 211, 5, 50, "Text",ExpressionUUID->"8a7b2264-5154-4d1b-adbd-66cb642d40e8"],
Cell[195135, 5192, 3827, 120, 503, "Input",ExpressionUUID->"7af0c93c-78ad-4f32-997f-ba502ba44b15"],
Cell[198965, 5314, 187, 3, 50, "Text",ExpressionUUID->"a59eba20-6246-4438-91a9-f0960355c054"],
Cell[199155, 5319, 1124, 33, 105, "Input",ExpressionUUID->"f4f79fff-d182-43cd-b862-ab07562c1885"],
Cell[200282, 5354, 649, 17, 74, "Input",ExpressionUUID->"fece0cff-29ec-4b80-a270-bab4be90a53e"],
Cell[200934, 5373, 3976, 85, 411, "Input",ExpressionUUID->"d277ae01-3714-4f05-b248-6d3c7744bdd6"],
Cell[204913, 5460, 358, 8, 44, "Input",ExpressionUUID->"65da9bb2-f5c6-401c-aa2c-0bde9271daa1"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[205320, 5474, 169, 3, 101, "Chapter",ExpressionUUID->"477a6e2c-0248-49b0-bb0c-8c77ddd86851"],
Cell[CellGroupData[{
Cell[205514, 5481, 371, 12, 79, "Subsection",ExpressionUUID->"12564fa6-a3db-45c5-980c-aa3aeb9b8ac9"],
Cell[205888, 5495, 462, 13, 80, "Text",ExpressionUUID->"04ae1c4b-03f4-4185-9192-0133cb65ef86"],
Cell[206353, 5510, 509, 11, 44, "Input",ExpressionUUID->"5bbdda85-1ed4-4a70-b870-4a98b321ade8"],
Cell[206865, 5523, 289, 6, 83, "Text",ExpressionUUID->"23da1d97-3ea9-4ebc-b0c9-132e9e36bdd4"],
Cell[207157, 5531, 369, 9, 44, "Input",ExpressionUUID->"ce6e60d5-0f07-4bd4-9809-efb1398f39ab"],
Cell[207529, 5542, 237, 6, 50, "Text",ExpressionUUID->"33ccc9a6-c0a6-4478-b5f3-50104281de1a"],
Cell[207769, 5550, 398, 9, 44, "Input",ExpressionUUID->"80b9dd18-d972-4f89-9737-407a3b1b8559"],
Cell[208170, 5561, 354, 9, 50, "Text",ExpressionUUID->"9d026f0c-9bb3-420a-b97a-5a1a283a5b25"],
Cell[208527, 5572, 612, 15, 44, "Input",ExpressionUUID->"ac70a8bb-e219-497c-af4d-ed64c1caae7a"]
}, Open  ]],
Cell[CellGroupData[{
Cell[209176, 5592, 165, 3, 79, "Subsection",ExpressionUUID->"adbc6c6d-a8a2-419d-a1e3-0c6378070fb6"],
Cell[209344, 5597, 224, 4, 50, "Text",ExpressionUUID->"284a0738-8eca-4a2e-a39c-d9065e6de8bf"],
Cell[209571, 5603, 858, 24, 74, "Input",ExpressionUUID->"b70b123d-6911-479b-8a80-5ffc4aa6b623"],
Cell[210432, 5629, 823, 22, 74, "Input",ExpressionUUID->"0ab1ae3c-8f8f-463c-8003-56ff6158afb9"]
}, Open  ]],
Cell[CellGroupData[{
Cell[211292, 5656, 164, 3, 79, "Subsection",ExpressionUUID->"d5343cf5-924f-4801-9517-6044717c0bd8"],
Cell[211459, 5661, 4570, 136, 350, "Input",ExpressionUUID->"eac70282-6051-44e9-b048-29811488bca9"],
Cell[216032, 5799, 3131, 79, 258, "Input",ExpressionUUID->"289cd5a1-67c5-4f6a-a7f8-68e7ce8207d1"],
Cell[219166, 5880, 245, 6, 50, "Text",ExpressionUUID->"575691ba-5d3e-4acc-8b0f-3529ed014b48"],
Cell[219414, 5888, 1581, 45, 135, "Input",ExpressionUUID->"d4f688c2-dcbd-4da5-af54-41beff1f945e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[221032, 5938, 164, 3, 79, "Subsection",ExpressionUUID->"b5054f7a-28d7-4383-ae8b-698c61be08ca"],
Cell[221199, 5943, 1932, 51, 166, "Input",ExpressionUUID->"93f662ef-d58c-4f73-9d01-d0d25f427889"],
Cell[223134, 5996, 1536, 40, 105, "Input",ExpressionUUID->"1a468c87-c6ba-4cf1-b663-988db5385205"],
Cell[224673, 6038, 2451, 67, 135, "Input",ExpressionUUID->"60cace68-dd7f-4e0d-9967-4abe467fb145"],
Cell[227127, 6107, 1267, 35, 135, "Input",ExpressionUUID->"d0ced964-ca41-4d80-a1da-e8317e48ff0e"],
Cell[228397, 6144, 616, 18, 44, "Input",ExpressionUUID->"4ef1a88a-e3d9-45fe-927e-2889abacefbe"],
Cell[229016, 6164, 1603, 46, 135, "Input",ExpressionUUID->"528120a4-4ec1-4c7c-ac76-9e4a823f19c3"],
Cell[230622, 6212, 795, 22, 105, "Input",ExpressionUUID->"fff03d31-f398-47ec-9493-ceff725cee45"],
Cell[231420, 6236, 931, 27, 105, "Input",ExpressionUUID->"f053ec07-a5d7-42ee-b0bf-7fcb7e199e92"],
Cell[232354, 6265, 565, 16, 44, "Input",ExpressionUUID->"75119378-e46b-4b09-ada6-1eb7677d7120"],
Cell[232922, 6283, 494, 15, 44, "Input",ExpressionUUID->"232ceda8-f7b7-453b-8232-cb0d5b6f64a7"],
Cell[233419, 6300, 699, 18, 74, "Input",ExpressionUUID->"a5eb2983-5071-4125-b734-7a1d23f15bfe"],
Cell[234121, 6320, 238, 4, 50, "Text",ExpressionUUID->"f843d776-7c51-444d-8848-af09499654fb"],
Cell[234362, 6326, 1408, 40, 135, "Input",ExpressionUUID->"69a3a03a-066d-4799-bfbb-215ea8c0c82f"],
Cell[235773, 6368, 939, 27, 74, "Input",ExpressionUUID->"18ed5b67-e596-4266-82ee-bae0e1a6b8c5"],
Cell[236715, 6397, 425, 10, 50, "Text",ExpressionUUID->"8709559c-8b2f-4daa-9159-f0bf88222e42"],
Cell[237143, 6409, 581, 15, 44, "Input",ExpressionUUID->"23fc370f-fce0-478f-97ce-a3543ca97db9"],
Cell[237727, 6426, 240, 6, 50, "Text",ExpressionUUID->"03b0c961-a7ae-4522-8f3c-fd3121b972dd"],
Cell[237970, 6434, 496, 12, 44, "Input",ExpressionUUID->"71149205-f321-4e68-87c4-790a383a9d62"],
Cell[238469, 6448, 701, 20, 74, "Input",ExpressionUUID->"fbcd99b5-613a-41ef-9457-f94a51cc8285"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[239219, 6474, 241, 4, 83, "Chapter",ExpressionUUID->"8a42a181-c2b3-4d7b-9708-753165cdc61d"],
Cell[239463, 6480, 343, 7, 83, "Text",ExpressionUUID->"225eec93-e63e-4438-8809-9cf134def8dc"],
Cell[239809, 6489, 539, 10, 149, "Text",ExpressionUUID->"5e1183b5-df5b-41a7-8de2-afded534cfb8"],
Cell[240351, 6501, 638, 17, 74, "Input",ExpressionUUID->"c2d7f473-6d6e-4554-990d-c798d25a57d3"],
Cell[240992, 6520, 194, 3, 50, "Text",ExpressionUUID->"78329675-858b-4478-baa4-add0c3a4c24c"],
Cell[241189, 6525, 4204, 113, 333, "Input",ExpressionUUID->"a023264f-a3a9-466d-b709-5cce5c54c60e"],
Cell[245396, 6640, 236, 6, 50, "Text",ExpressionUUID->"0c5af5bd-360d-49f8-94a2-3cc52a54631d"],
Cell[245635, 6648, 15121, 371, 1575, "Input",ExpressionUUID->"f3b75551-94c4-4ab8-8f22-8e944f1a2a6d"],
Cell[260759, 7021, 241, 6, 50, "Text",ExpressionUUID->"ca976bbc-9105-4a67-b3d9-0418d4173329"],
Cell[261003, 7029, 4265, 110, 381, "Input",ExpressionUUID->"7ab4f07a-627b-44cc-9149-60a58ceda83c"],
Cell[265271, 7141, 8142, 204, 1024, "Input",ExpressionUUID->"0ffac668-5693-4323-aec8-2c98f829f9df"],
Cell[273416, 7347, 720, 18, 135, "Input",ExpressionUUID->"f9ab13f1-5710-4ae9-b35f-764a74902ca7"],
Cell[CellGroupData[{
Cell[274161, 7369, 176, 3, 79, "Subsection",ExpressionUUID->"4389fc0e-a7ed-4ea7-a4fa-9fa35938abd9"],
Cell[274340, 7374, 932, 25, 105, "Input",ExpressionUUID->"328d846a-86ec-4497-87b4-d314431aef2e"],
Cell[275275, 7401, 4875, 143, 501, "Input",ExpressionUUID->"e2beb6b8-54c0-495f-8a4b-5fb582815ce3"],
Cell[280153, 7546, 1976, 37, 105, "Input",ExpressionUUID->"cee502b0-ec5a-4422-bcbd-ce92ddaef079"],
Cell[282132, 7585, 1907, 36, 74, "Input",ExpressionUUID->"4b41a855-4b74-426b-ab5e-77a64bbca246"],
Cell[284042, 7623, 1894, 34, 74, "Input",ExpressionUUID->"35fc8085-d754-4c1b-b0c7-4c6d621a9bf2"],
Cell[285939, 7659, 2111, 41, 74, "Input",ExpressionUUID->"33552eb3-51c0-4b7e-be89-6aca5be8033c"],
Cell[288053, 7702, 2083, 40, 74, "Input",ExpressionUUID->"f24b6231-559d-4e29-b1df-04d6b7575aed"],
Cell[290139, 7744, 1868, 34, 74, "Input",ExpressionUUID->"8f88e0c3-851d-4898-8b66-5ceada94a60c"],
Cell[292010, 7780, 2380, 46, 135, "Input",ExpressionUUID->"cb13b10c-d4bf-4fec-b142-670449f3b793"],
Cell[294393, 7828, 2048, 40, 74, "Input",ExpressionUUID->"858959ac-9432-45c7-acfa-fe4e98ef3a46"],
Cell[296444, 7870, 1816, 32, 44, "Input",ExpressionUUID->"7bf1e688-ff77-4091-b190-fcad244190d7"],
Cell[298263, 7904, 1778, 31, 44, "Input",ExpressionUUID->"92d489af-3654-4026-8701-d391a80a385d"],
Cell[300044, 7937, 2203, 44, 74, "Input",ExpressionUUID->"2a7e8b35-2cbd-40af-be37-ae6ace34cb17"],
Cell[302250, 7983, 2102, 41, 74, "Input",ExpressionUUID->"8271e754-bccb-44a6-b101-239beddc410f"],
Cell[304355, 8026, 1036, 21, 74, "Input",ExpressionUUID->"fd33bcf3-9fe1-4517-bb50-cdd447468012"],
Cell[305394, 8049, 469, 11, 44, "Input",ExpressionUUID->"c74504a7-1a8c-4fbc-9675-4ead55d1b0ca"],
Cell[305866, 8062, 588, 12, 44, "Input",ExpressionUUID->"ba85e1c2-d782-4bb5-939d-2962634c1b0a"],
Cell[306457, 8076, 334, 8, 44, "Input",ExpressionUUID->"8ee2b92c-370d-4a95-bd44-53c308f2707d"],
Cell[306794, 8086, 542, 12, 44, "Input",ExpressionUUID->"f3159612-1ec8-42ee-865e-cffb89a78060"],
Cell[307339, 8100, 462, 12, 44, "Input",ExpressionUUID->"38fcb831-a92a-4733-9b74-4207c3f2b1b1"],
Cell[307804, 8114, 409, 11, 44, "Input",ExpressionUUID->"e1c5b0ec-f4d2-4607-aac4-c7c59448698e"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[308262, 8131, 212, 4, 101, "Chapter",ExpressionUUID->"337b0d1c-620d-4da8-b84e-029ee7d7b98b"],
Cell[CellGroupData[{
Cell[308499, 8139, 215, 4, 79, "Subsection",ExpressionUUID->"84194f74-761a-4503-9cde-91a458377f85"],
Cell[308717, 8145, 3394, 106, 354, "Input",ExpressionUUID->"19ca239c-d464-4e0e-bae3-11f5f30c72a6"],
Cell[312114, 8253, 703, 20, 44, "Input",ExpressionUUID->"5cc25782-7143-44f9-97d0-d6421f30ee23"],
Cell[312820, 8275, 218, 4, 50, "Text",ExpressionUUID->"d81b7339-b226-4c0a-bb1a-35bd5b816ffd"],
Cell[313041, 8281, 4918, 128, 260, "Input",ExpressionUUID->"2c4d4b0d-0b03-4289-a091-be64b4c045f7"],
Cell[317962, 8411, 2523, 70, 523, "Input",ExpressionUUID->"5a26b4a1-f5e7-4e5f-8420-0960d3fe3da7"],
Cell[320488, 8483, 1679, 49, 135, "Input",ExpressionUUID->"cc52e1c9-650d-48de-80b6-b6529db4343c"],
Cell[322170, 8534, 497, 12, 44, "Input",ExpressionUUID->"896bda85-c1c1-4c9e-a53e-a4928f09c807"],
Cell[322670, 8548, 1390, 40, 74, "Input",ExpressionUUID->"1ae409ef-b603-4434-ac3f-21bf72e25052"],
Cell[324063, 8590, 3105, 88, 258, "Input",ExpressionUUID->"77b7c203-cd04-4542-ae04-b49c3f68686f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[327205, 8683, 232, 4, 79, "Subsection",ExpressionUUID->"592feef4-ce9f-4a09-ac3b-0d469f9d5b30"],
Cell[327440, 8689, 1556, 39, 166, "Input",ExpressionUUID->"475e662b-2f65-4730-bc0e-4bd6db495936"],
Cell[328999, 8730, 873, 27, 74, "Input",ExpressionUUID->"68b154ed-e6af-41d0-b8eb-a92e36bb7644"],
Cell[329875, 8759, 800, 22, 74, "Input",ExpressionUUID->"c7e4bf2a-3ab1-41bd-ac6d-bd26dbbe7dff"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[330724, 8787, 274, 4, 101, "Chapter",ExpressionUUID->"5f69ef11-250e-413d-aa63-97e21ebdeae6"],
Cell[CellGroupData[{
Cell[331023, 8795, 195, 3, 79, "Subsection",ExpressionUUID->"a2b55815-2bd7-44c8-88ac-78e2046a8498"],
Cell[331221, 8800, 1839, 49, 227, "Input",ExpressionUUID->"b35273d8-ab45-4610-a404-71989d7bd04b"],
Cell[333063, 8851, 2696, 75, 197, "Input",ExpressionUUID->"31e6dd55-7401-45ea-8cbb-b6805aa6abb7"],
Cell[335762, 8928, 3633, 92, 350, "Input",ExpressionUUID->"e2f85204-3a4f-4619-851d-a68fbab9ff65"]
}, Open  ]],
Cell[CellGroupData[{
Cell[339432, 9025, 218, 5, 79, "Subsection",ExpressionUUID->"665f4e14-a40d-421a-b381-8877e564c6c3"],
Cell[339653, 9032, 2135, 58, 258, "Input",ExpressionUUID->"0be7a059-9269-498f-993e-ec52944f3c58"],
Cell[341791, 9092, 1071, 31, 105, "Input",ExpressionUUID->"26749a4f-77ec-403d-865c-ed2f87d37ebc"],
Cell[342865, 9125, 5124, 114, 718, "Input",ExpressionUUID->"5462538d-bd14-4df9-879c-7c9747147e50"],
Cell[347992, 9241, 233, 6, 50, "Text",ExpressionUUID->"2771c953-72c7-4598-99f6-59765edb4947"]
}, Open  ]],
Cell[CellGroupData[{
Cell[348262, 9252, 178, 3, 79, "Subsection",ExpressionUUID->"bc097691-ac37-4114-a5c6-3d24a9a1569e"],
Cell[348443, 9257, 170, 3, 50, "Text",ExpressionUUID->"c5808fc4-c3b7-414c-a8e8-336222e7cbf9"],
Cell[348616, 9262, 2210, 55, 319, "Input",ExpressionUUID->"7eebecd5-aedd-4b0c-8575-c7a99601814e"],
Cell[350829, 9319, 173, 3, 50, "Text",ExpressionUUID->"a41055c3-784d-45f0-840f-b9a65ff69213"],
Cell[351005, 9324, 3986, 97, 442, "Input",ExpressionUUID->"5df25f7e-4962-499e-91ba-02cffbce11a6"],
Cell[354994, 9423, 2415, 53, 319, "Input",ExpressionUUID->"e729b46f-daf3-4e75-8927-3d5144465bae"],
Cell[357412, 9478, 172, 3, 50, "Text",ExpressionUUID->"7a84ca17-4527-4480-bb4f-0cd508afcb4d"],
Cell[357587, 9483, 1401, 36, 227, "Input",ExpressionUUID->"5135b5f1-5dc3-4cd8-bde3-1fe15eba51f1"],
Cell[358991, 9521, 4126, 89, 503, "Input",ExpressionUUID->"e9dd205b-ac9a-4240-9171-72a3925b473c"],
Cell[363120, 9612, 1465, 37, 258, "Input",ExpressionUUID->"f1972c62-aafa-4f19-8ac4-1b8f536f7157"],
Cell[364588, 9651, 169, 3, 50, "Text",ExpressionUUID->"b309d358-4495-496d-96ff-21e1e6c32540"],
Cell[364760, 9656, 672, 14, 74, "Input",ExpressionUUID->"620b3a01-d6a0-4a10-a99c-954329ff5b86"]
}, Open  ]],
Cell[CellGroupData[{
Cell[365469, 9675, 270, 4, 79, "Subsection",ExpressionUUID->"cb0690d3-e5cf-4eed-9d19-d82988862376"],
Cell[365742, 9681, 3608, 89, 381, "Input",ExpressionUUID->"7a403f7b-05cf-441b-83fe-28b49507400b"],
Cell[369353, 9772, 5749, 126, 472, "Input",ExpressionUUID->"5f6c0c2f-e8a8-4467-8fd0-2e158548336b"],
Cell[375105, 9900, 307, 7, 44, "Input",ExpressionUUID->"453c8226-aa5e-455d-9438-eb9b47a88aa0"]
}, Open  ]],
Cell[CellGroupData[{
Cell[375449, 9912, 170, 3, 79, "Subsection",ExpressionUUID->"c449ef95-91d7-45e9-95df-e821b6ee3840"],
Cell[375622, 9917, 4173, 103, 472, "Input",ExpressionUUID->"72f99197-4f8c-413e-9209-341512443d99"],
Cell[379798, 10022, 1433, 29, 105, "Input",ExpressionUUID->"ad20dab2-7b33-4cb3-b909-42872365954b"]
}, Open  ]],
Cell[CellGroupData[{
Cell[381268, 10056, 175, 3, 79, "Subsection",ExpressionUUID->"450e69bc-4e25-4005-8ace-669cea68bf38"],
Cell[381446, 10061, 1127, 29, 135, "Input",ExpressionUUID->"f37e83f3-432b-4e49-bade-cf908fc6b57f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[382610, 10095, 223, 4, 79, "Subsection",ExpressionUUID->"ef0e8501-4b10-417a-a73d-4188466138a9"],
Cell[382836, 10101, 784, 21, 105, "Input",ExpressionUUID->"b0dfbc27-0def-4a97-a3f7-a063fec68568"],
Cell[383623, 10124, 824, 22, 74, "Input",ExpressionUUID->"c4962df0-7f48-4eba-bc28-14291eb2e4e8"],
Cell[384450, 10148, 4009, 131, 503, "Input",ExpressionUUID->"471751a5-7820-4e33-8c69-7b2da57b4e29"],
Cell[388462, 10281, 596, 16, 74, "Input",ExpressionUUID->"7796ce51-94a2-4afe-b27d-0e6d188c8ca4"],
Cell[389061, 10299, 4165, 91, 472, "Input",ExpressionUUID->"abe44a73-01ce-4165-b961-e331dd78531b"],
Cell[393229, 10392, 413, 9, 44, "Input",ExpressionUUID->"c129a611-7015-4f09-9b42-edfdabca96e0"],
Cell[393645, 10403, 315, 7, 83, "Text",ExpressionUUID->"a5f70273-b10c-4977-a5ce-fee214bbc70a"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[394009, 10416, 252, 4, 171, "Chapter",ExpressionUUID->"35fbcc38-7d79-4140-b33f-dadc1810c409"],
Cell[CellGroupData[{
Cell[394286, 10424, 170, 3, 79, "Subsection",ExpressionUUID->"9162d4cf-9804-4709-b2cf-1e7534d023ab"],
Cell[394459, 10429, 2001, 48, 227, "Input",ExpressionUUID->"39eb1990-919e-4d4d-b018-66c914c5152b"],
Cell[396463, 10479, 3099, 63, 227, "Input",ExpressionUUID->"ca9ead4e-4d8e-4367-b063-e68f7ac81f72"],
Cell[399565, 10544, 1769, 47, 227, "Input",ExpressionUUID->"77c16501-f2c3-481b-adb5-263ab0c94e65"]
}, Open  ]],
Cell[CellGroupData[{
Cell[401371, 10596, 295, 5, 79, "Subsection",ExpressionUUID->"b99c3d2c-2c1d-4673-9ab6-0288d3646a7d"],
Cell[401669, 10603, 194, 3, 50, "Text",ExpressionUUID->"1b964aae-0811-4da3-a9ab-49b5287f8c1f"],
Cell[401866, 10608, 2061, 49, 166, "Input",ExpressionUUID->"c0d724b7-da80-44a9-8d9d-0ecfe9c4c2e3"],
Cell[403930, 10659, 194, 3, 50, "Text",ExpressionUUID->"3a62f751-3f78-4902-8618-84c0d812836d"],
Cell[404127, 10664, 2078, 48, 227, "Input",ExpressionUUID->"13767301-413f-4fa5-bf63-f04d56b344f7"],
Cell[406208, 10714, 238, 4, 50, "Text",ExpressionUUID->"fa291480-8bb0-427a-9d47-d5fcacf7e693"],
Cell[406449, 10720, 1736, 43, 166, "Input",ExpressionUUID->"964fa9d8-72be-42ae-ab8b-c16fa12bdf69"],
Cell[408188, 10765, 3645, 100, 319, "Input",ExpressionUUID->"216afeaa-23d6-4c8b-86ff-7b3c9a9ba630"]
}, Open  ]],
Cell[CellGroupData[{
Cell[411870, 10870, 178, 3, 79, "Subsection",ExpressionUUID->"73f6516e-b12d-420f-9c80-21809ea65f43"],
Cell[412051, 10875, 8595, 247, 626, "Input",ExpressionUUID->"056b2ca6-05d8-4ef5-a005-87bf66d16ec2"],
Cell[420649, 11124, 1974, 62, 105, "Input",ExpressionUUID->"f9c1e4b9-c7be-46e1-b83b-4a6db5ec58f3"],
Cell[422626, 11188, 1611, 51, 105, "Input",ExpressionUUID->"23640041-2e9b-4a3f-8fe4-a7cdaecc0b7e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[424274, 11244, 183, 3, 79, "Subsection",ExpressionUUID->"c6b696ec-11d7-45f0-907a-951fbb149ea2"],
Cell[424460, 11249, 2384, 50, 197, "Input",ExpressionUUID->"a07f31db-aec4-48ab-8543-4e1142671606"],
Cell[426847, 11301, 530, 14, 74, "Input",ExpressionUUID->"2c4a7b19-af7f-4358-a1d3-f7a2979d7bea"],
Cell[427380, 11317, 3684, 88, 472, "Input",ExpressionUUID->"16caa552-6598-410d-ba87-765e2dce6b9c"],
Cell[431067, 11407, 2929, 70, 534, "Input",ExpressionUUID->"75040682-97c1-4628-806c-dbf5e8532d2d"]
}, Open  ]],
Cell[CellGroupData[{
Cell[434033, 11482, 247, 5, 79, "Subsection",ExpressionUUID->"5a588546-7642-4b4a-a22d-10a4d67eb317"],
Cell[434283, 11489, 856, 24, 135, "Input",ExpressionUUID->"1d7f6f0c-d109-437a-b885-48f48ce3e6c5"],
Cell[435142, 11515, 3702, 76, 381, "Input",ExpressionUUID->"2465533f-bf63-4b4f-8049-704ee99e5c40"],
Cell[438847, 11593, 466, 13, 44, "Input",ExpressionUUID->"c1c89adc-94dc-425d-b0f4-f481e765ae74"],
Cell[439316, 11608, 401, 11, 44, "Input",ExpressionUUID->"af90b59b-c26b-4cec-bbd3-0322834fd9cf"],
Cell[439720, 11621, 666, 20, 74, "Input",ExpressionUUID->"6c634ea0-8c58-4237-b540-6b03521b8b82"]
}, Open  ]],
Cell[CellGroupData[{
Cell[440423, 11646, 225, 4, 79, "Subsection",ExpressionUUID->"a04b9664-f07b-4a8c-841d-d09da67e476a"],
Cell[440651, 11652, 1127, 32, 74, "Input",ExpressionUUID->"f4c7a106-b313-403a-954a-2c407fd0f9c5"],
Cell[441781, 11686, 4372, 97, 472, "Input",ExpressionUUID->"96cc154d-52d8-45a7-8d78-ff6dc476ea97"],
Cell[446156, 11785, 4461, 99, 442, "Input",ExpressionUUID->"4ce1ef70-0780-49da-80ca-f889d24f7509"],
Cell[450620, 11886, 377, 10, 44, "Input",ExpressionUUID->"71d330e7-a44d-4380-8721-d68a163136a1"],
Cell[451000, 11898, 2654, 70, 197, "Input",ExpressionUUID->"98cba180-1db8-4872-9d5e-a24691ba7217"],
Cell[453657, 11970, 903, 26, 105, "Input",ExpressionUUID->"b05e036d-67e7-4f0e-8a2b-352e1134fc9c"]
}, Open  ]],
Cell[CellGroupData[{
Cell[454597, 12001, 214, 4, 79, "Subsection",ExpressionUUID->"f12f67cf-ebb5-4ea1-879f-03184a47f38d"],
Cell[454814, 12007, 1413, 35, 197, "Input",ExpressionUUID->"b7aae5d8-4cc8-4a04-bce1-f6b0796ffa8a"],
Cell[456230, 12044, 1671, 51, 116, "Text",ExpressionUUID->"63299a5d-acdb-4210-901b-46256bfbca9e"],
Cell[457904, 12097, 4380, 108, 319, "Input",ExpressionUUID->"2087c2f7-62ed-40bb-acda-7930141fa02b"],
Cell[462287, 12207, 267, 6, 83, "Text",ExpressionUUID->"7d73a9e1-1828-47e8-8a30-222006973db5"],
Cell[462557, 12215, 2581, 66, 381, "Input",ExpressionUUID->"d3f4ee6f-9202-437d-a7a9-b0d00dea5c96"],
Cell[465141, 12283, 3646, 83, 411, "Input",ExpressionUUID->"f4633e20-f5fe-4b46-b27a-f866df1baf6c"],
Cell[468790, 12368, 2481, 58, 319, "Input",ExpressionUUID->"bc71ac90-17b4-49e3-a9bb-8a8b7388f15b"],
Cell[471274, 12428, 468, 13, 44, "Input",ExpressionUUID->"eafc78cb-7428-48cf-9f8e-995d58171910"],
Cell[471745, 12443, 412, 12, 44, "Input",ExpressionUUID->"c4258cc0-acd4-40a7-b400-4899bad68389"],
Cell[472160, 12457, 759, 22, 74, "Input",ExpressionUUID->"c9a27b76-3da3-48cb-9a05-2dda4563d86d"],
Cell[472922, 12481, 401, 11, 44, "Input",ExpressionUUID->"51ab3548-b5df-4e61-9aae-dc775ec71b4b"],
Cell[473326, 12494, 809, 21, 44, "Input",ExpressionUUID->"8abb25cf-3010-4a9f-869b-b334e6210396"],
Cell[474138, 12517, 1122, 28, 74, "Input",ExpressionUUID->"39123789-8216-4f1c-8d71-7bf2c49c4982"],
Cell[475263, 12547, 1784, 52, 166, "Input",ExpressionUUID->"fff69478-954a-4a81-b589-62b989ee55bf"],
Cell[477050, 12601, 847, 21, 74, "Input",ExpressionUUID->"252ab897-05b6-43bb-88d1-f2e62ece7a0f"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[477946, 12628, 175, 3, 101, "Chapter",ExpressionUUID->"80de2ffe-b929-4949-b062-07b51bf0d7aa"],
Cell[CellGroupData[{
Cell[478146, 12635, 216, 4, 79, "Subsection",ExpressionUUID->"48ed025e-3fc3-44fe-a061-a4e8fdedfe02"],
Cell[478365, 12641, 289, 6, 44, "Input",ExpressionUUID->"b7d77c30-4037-4693-93f7-e0a3bad8ae19"],
Cell[478657, 12649, 248, 6, 44, "Input",ExpressionUUID->"50ff11c0-6aad-441c-a525-72477553e85e"],
Cell[478908, 12657, 3481, 94, 258, "Input",ExpressionUUID->"6ee8b4dc-a89d-4099-a607-8ada1c274028"],
Cell[482392, 12753, 617, 16, 74, "Input",ExpressionUUID->"e594ff3f-3622-42aa-bb78-730f153991d1"]
}, Open  ]],
Cell[CellGroupData[{
Cell[483046, 12774, 251, 5, 79, "Subsection",ExpressionUUID->"99c9035b-e3d4-48ce-8a80-0f882ac29ea9"],
Cell[483300, 12781, 171, 3, 50, "Text",ExpressionUUID->"5ab48c43-20d3-4948-adf5-c178da12b8a9"],
Cell[483474, 12786, 4411, 119, 350, "Input",ExpressionUUID->"c85762f5-31ec-4537-814f-e08cc2c6d9e6"],
Cell[487888, 12907, 936, 26, 166, "Input",ExpressionUUID->"580dfa6f-e0e3-4f46-a684-cc7003a52eb5"],
Cell[488827, 12935, 249, 6, 44, "Input",ExpressionUUID->"4c83828c-dbef-45e1-a604-61a24aba67bc"],
Cell[489079, 12943, 261, 4, 50, "Text",ExpressionUUID->"d57201b6-9f69-45d4-af01-208637a30cbb"],
Cell[489343, 12949, 2221, 54, 166, "Input",ExpressionUUID->"2fb661f8-0173-46a1-8625-63461d7c0ef8"],
Cell[491567, 13005, 210, 4, 50, "Text",ExpressionUUID->"b15740e9-d3fb-409b-bbc7-f28d0fbe9444"],
Cell[491780, 13011, 1018, 29, 105, "Input",ExpressionUUID->"8b05174f-6d0e-4669-879c-77a0dc881320"],
Cell[492801, 13042, 215, 4, 50, "Text",ExpressionUUID->"8cea4af7-81ac-4fe6-9558-a74b7e624a70"],
Cell[493019, 13048, 1391, 37, 135, "Input",ExpressionUUID->"e7548c29-0e48-498e-b16b-684285ebfa0b"],
Cell[494413, 13087, 163, 3, 50, "Text",ExpressionUUID->"dd9094f4-01b1-4d4e-ac24-1d7abcf69600"],
Cell[494579, 13092, 2220, 60, 166, "Input",ExpressionUUID->"9145a993-5e93-45bf-98a5-33ef10c80610"],
Cell[496802, 13154, 2048, 55, 166, "Input",ExpressionUUID->"7816dad5-fb51-4741-865d-d06653e3c21f"],
Cell[498853, 13211, 1425, 37, 105, "Input",ExpressionUUID->"72b98cb1-f589-474d-b8bf-b00aa3c7b0c6"],
Cell[500281, 13250, 1577, 38, 105, "Input",ExpressionUUID->"003f97ef-f206-449d-a734-b5b59981007c"],
Cell[501861, 13290, 3017, 87, 350, "Input",ExpressionUUID->"6c65c292-937e-49e1-8969-7e364b9ee17f"],
Cell[504881, 13379, 1440, 41, 197, "Input",ExpressionUUID->"c2ddc091-3d6a-4ceb-b0c2-654fee799c18"],
Cell[506324, 13422, 300, 8, 44, "Input",ExpressionUUID->"6b51f303-5954-4759-ae29-46d841a5f962"],
Cell[506627, 13432, 472, 13, 44, "Input",ExpressionUUID->"544413c9-14fc-42d6-a88e-db00612afa10"],
Cell[507102, 13447, 345, 9, 44, "Input",ExpressionUUID->"c684bb1a-83a6-41b2-9795-b7867cb6c945"],
Cell[507450, 13458, 331, 8, 44, "Input",ExpressionUUID->"58b2987f-b232-4e2a-837c-3900f338bcd7"],
Cell[CellGroupData[{
Cell[507806, 13470, 179, 3, 65, "Subsubsection",ExpressionUUID->"9957bb14-b67a-48c2-916f-fa5cb20b8a4e"],
Cell[507988, 13475, 2774, 65, 170, "Input",ExpressionUUID->"bcd9b7a5-d172-469c-a2e0-2c98af9d2768"],
Cell[510765, 13542, 190, 3, 50, "Text",ExpressionUUID->"0df35699-9007-4338-ada2-06a2dd551df4"],
Cell[510958, 13547, 1165, 33, 105, "Input",ExpressionUUID->"ca451291-75a3-4469-869c-44f2dd44c9e6"],
Cell[512126, 13582, 2024, 45, 96, "Input",ExpressionUUID->"8186ad87-950d-42bf-a966-a162f53527e1"],
Cell[514153, 13629, 1709, 48, 166, "Input",ExpressionUUID->"8c78da07-2ec8-4cb4-80fd-7c20575eefe1"],
Cell[515865, 13679, 2226, 47, 135, "Input",ExpressionUUID->"61f81918-c633-4619-9350-c7ed20a5af7e"],
Cell[518094, 13728, 1462, 25, 44, "Input",ExpressionUUID->"fb8fe767-740d-468a-b123-93c448626ba6"],
Cell[519559, 13755, 1459, 25, 44, "Input",ExpressionUUID->"7c834f57-aa9b-48c3-b208-636a53bd0084"],
Cell[521021, 13782, 1931, 41, 74, "Input",ExpressionUUID->"8f65e634-84c0-4138-a20b-ff325ffee3ed"],
Cell[522955, 13825, 1931, 41, 74, "Input",ExpressionUUID->"af3fa3ef-b33b-4abb-8666-792ff54681bc"],
Cell[524889, 13868, 1976, 37, 105, "Input",ExpressionUUID->"4ba66e87-6038-4aee-bb4e-cf9254753910"],
Cell[526868, 13907, 2305, 45, 135, "Input",ExpressionUUID->"27ccac50-1a92-4e9c-9c70-56fa187770d4"],
Cell[529176, 13954, 2089, 39, 74, "Input",ExpressionUUID->"a6b0a87d-de65-434d-8405-ee70b0322961"],
Cell[531268, 13995, 2347, 47, 135, "Input",ExpressionUUID->"3a18df6f-68da-4014-b63f-02373c133f00"],
Cell[533618, 14044, 1205, 33, 135, "Input",ExpressionUUID->"32ff34dd-2021-4c94-bca5-4d592462851d"],
Cell[534826, 14079, 1861, 32, 44, "Input",ExpressionUUID->"64f4b519-de68-4512-a71e-171a886056eb"],
Cell[536690, 14113, 2274, 41, 74, "Input",ExpressionUUID->"6d10b4f3-0533-4229-a708-793251f70557"],
Cell[538967, 14156, 783, 22, 74, "Input",ExpressionUUID->"585e6634-8a64-4757-97d6-91672681bcdb"],
Cell[539753, 14180, 1212, 22, 74, "Input",ExpressionUUID->"db43c34c-4f5f-45f6-9139-0f09439958db"],
Cell[540968, 14204, 836, 25, 74, "Input",ExpressionUUID->"6340996b-2d36-46e7-8ca5-554e029c808d"],
Cell[541807, 14231, 476, 11, 44, "Input",ExpressionUUID->"6ae51362-e675-45e4-8ef2-c1c3e9a65feb"],
Cell[542286, 14244, 406, 8, 44, "Input",ExpressionUUID->"e3c69d9b-00fd-4ef7-a762-b7aabdab1e4a"],
Cell[542695, 14254, 407, 10, 44, "Input",ExpressionUUID->"ca694b89-8970-4cd8-8254-9ed9a59df3f5"],
Cell[543105, 14266, 480, 14, 44, "Input",ExpressionUUID->"f1b19e18-8059-4069-b213-eec06bc1a8da"],
Cell[543588, 14282, 564, 16, 44, "Input",ExpressionUUID->"fda1585f-893a-407f-bcce-608b7488f9ca"],
Cell[544155, 14300, 389, 11, 44, "Input",ExpressionUUID->"fdc3bef1-4ef0-4536-957e-f0d94a7ead98"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[544593, 14317, 177, 3, 79, "Subsection",ExpressionUUID->"7a129ffc-6277-47de-aa48-ad5d1a30c19a"],
Cell[544773, 14322, 4103, 109, 319, "Input",ExpressionUUID->"13c02f3c-675a-4784-9114-eec7615eee9b"],
Cell[548879, 14433, 1009, 27, 166, "Input",ExpressionUUID->"06bbd894-0818-41e3-a608-db7adfb3ef53"],
Cell[549891, 14462, 157, 3, 50, "Text",ExpressionUUID->"d4e68108-f56c-4e6f-af83-3574a172d7b7"],
Cell[550051, 14467, 247, 6, 44, "Input",ExpressionUUID->"fba61bb5-baf3-4dd2-8656-a8c205e35f29"],
Cell[550301, 14475, 2874, 74, 258, "Input",ExpressionUUID->"6dcda9f9-17bc-469f-8ef1-505a3ae35662"],
Cell[553178, 14551, 2196, 61, 197, "Input",ExpressionUUID->"f0a9114a-8a03-40c7-ba0f-142aca8ede3e"],
Cell[555377, 14614, 1969, 55, 197, "Input",ExpressionUUID->"4a067d60-9531-482e-8c36-14691ef1104e"],
Cell[557349, 14671, 1741, 47, 166, "Input",ExpressionUUID->"1d836c73-e5fd-4d7c-9e0e-5960cfd3a5bd"],
Cell[559093, 14720, 1699, 44, 135, "Input",ExpressionUUID->"c88786d8-d8c9-42e5-87fa-4c6d3bc1c9c1"],
Cell[560795, 14766, 1042, 24, 74, "Input",ExpressionUUID->"a05b4906-7948-4d25-851e-1bef6894c532"],
Cell[561840, 14792, 1153, 26, 74, "Input",ExpressionUUID->"e2002ba0-9b44-4d86-a5dd-66fa6b10c0ce"],
Cell[562996, 14820, 3039, 87, 350, "Input",ExpressionUUID->"f5649b4a-bff2-4b89-a0b3-c6b9693d8e08"],
Cell[566038, 14909, 1440, 41, 197, "Input",ExpressionUUID->"4674842f-b332-472b-a41a-cc6ab21f7770"],
Cell[567481, 14952, 300, 8, 44, "Input",ExpressionUUID->"b6d24a2f-45ca-400c-a9ab-6fe14d3b4332"],
Cell[567784, 14962, 472, 13, 44, "Input",ExpressionUUID->"cc287492-09c7-4d0b-bdc9-a1886524178c"],
Cell[568259, 14977, 345, 9, 44, "Input",ExpressionUUID->"0d2dbf97-565c-4043-ab04-e0b1629a2c1a"],
Cell[568607, 14988, 331, 8, 44, "Input",ExpressionUUID->"33885bdf-8158-44a5-b95e-0860b826110f"],
Cell[568941, 14998, 352, 9, 44, "Input",ExpressionUUID->"babf4bee-cc57-4349-b032-00f0639b1d76"],
Cell[569296, 15009, 344, 8, 44, "Input",ExpressionUUID->"015d7dff-d914-4c5f-9412-f90ddc130b0e"],
Cell[569643, 15019, 184, 3, 44, "Input",ExpressionUUID->"42656ae1-6cd8-469a-9acf-531b7a3d6c56"],
Cell[CellGroupData[{
Cell[569852, 15026, 163, 3, 65, "Subsubsection",ExpressionUUID->"8d27c259-fff3-4dee-b636-6b4bc66e060c"],
Cell[570018, 15031, 1204, 39, 197, "Input",ExpressionUUID->"18b96d2f-6ba9-4004-8509-95e5c6e0c1ae"],
Cell[571225, 15072, 1212, 22, 74, "Input",ExpressionUUID->"1eb6b390-7cbc-47fc-8ca6-860e0cc40027"],
Cell[572440, 15096, 476, 11, 44, "Input",ExpressionUUID->"7923d557-d956-413f-ac4c-fd7e9fdbdbb9"],
Cell[572919, 15109, 356, 8, 44, "Input",ExpressionUUID->"cb8b1dba-9815-49f8-bdcf-1038de7a7f13"],
Cell[573278, 15119, 407, 10, 44, "Input",ExpressionUUID->"adbe37f6-8d45-4273-a92e-9dfae2de54e0"],
Cell[573688, 15131, 529, 15, 44, "Input",ExpressionUUID->"036b0532-ef37-4fc7-867a-b3cf05110d8e"],
Cell[574220, 15148, 1041, 27, 105, "Input",ExpressionUUID->"8882007d-ebad-4026-9a27-dbedf1b6d556"],
Cell[575264, 15177, 438, 12, 44, "Input",ExpressionUUID->"d457aa80-9076-4a89-9a91-8d09efc7d80f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[575739, 15194, 195, 3, 65, "Subsubsection",ExpressionUUID->"addc04f5-5249-476b-b9b8-7c081d5e48c5"],
Cell[575937, 15199, 1347, 35, 135, "Input",ExpressionUUID->"c5273151-c284-4dd0-8161-a2ff89116597"],
Cell[577287, 15236, 440, 12, 44, "Input",ExpressionUUID->"ec6fed44-b4a3-4eb6-9fbb-428dd7522fba"],
Cell[577730, 15250, 1176, 32, 135, "Input",ExpressionUUID->"6ec53343-d260-41ff-b9ff-d5edff8414e0"],
Cell[578909, 15284, 441, 12, 44, "Input",ExpressionUUID->"bfd92d82-8b5c-4a8b-a556-329e4559b36a"],
Cell[579353, 15298, 684, 19, 105, "Input",ExpressionUUID->"d5ad031c-3508-4266-8828-906f58daeb52"],
Cell[580040, 15319, 1298, 35, 166, "Input",ExpressionUUID->"6ea4de32-da1c-4e1d-b0bc-9efead36403b"],
Cell[581341, 15356, 469, 13, 44, "Input",ExpressionUUID->"7b0eae51-591f-441f-af2b-c59281667445"],
Cell[581813, 15371, 2522, 76, 381, "Input",ExpressionUUID->"37dfb135-f7cc-4bc2-a16a-bd5c6c713a67"],
Cell[584338, 15449, 1044, 27, 135, "Input",ExpressionUUID->"bf89f0ea-7304-4740-8ace-15a1eb2e9de4"],
Cell[585385, 15478, 440, 12, 44, "Input",ExpressionUUID->"091637e7-981c-4b68-a337-dba544e77208"],
Cell[585828, 15492, 438, 12, 44, "Input",ExpressionUUID->"f8131d4e-49fb-4f46-b409-c9a33bddcf4f"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[586327, 15511, 227, 4, 101, "Chapter",ExpressionUUID->"f53885c6-4c2b-48c0-bfdb-9434dd8b535c"],
Cell[586557, 15517, 243, 6, 50, "Text",ExpressionUUID->"b13adb52-4b05-4dab-a180-0e369b4cd13b"],
Cell[586803, 15525, 229, 4, 50, "Text",ExpressionUUID->"959ee570-0317-47c4-ac63-fd7193cbb0a6"],
Cell[587035, 15531, 4875, 131, 472, "Input",ExpressionUUID->"31a4f749-0f3d-4834-a310-07a0ad44c3fd"],
Cell[591913, 15664, 247, 6, 44, "Input",ExpressionUUID->"1c7d8b8a-fbaf-4316-a539-0948298c042d"],
Cell[592163, 15672, 1506, 41, 166, "Input",ExpressionUUID->"62617cba-d299-45d5-a67d-e0c9815b6321"],
Cell[593672, 15715, 1511, 41, 166, "Input",ExpressionUUID->"5c456f94-cab3-448a-909b-235a8a2d557a"],
Cell[595186, 15758, 1129, 31, 105, "Input",ExpressionUUID->"12244b28-2adb-4fcf-8295-4c34a5f321fe"],
Cell[596318, 15791, 4086, 113, 534, "Input",ExpressionUUID->"dc117aa0-cdf5-4f6f-87b9-69c7ee0c8aae"],
Cell[600407, 15906, 1050, 27, 105, "Input",ExpressionUUID->"65022bc8-5101-48cb-9a36-bb31f436583d"],
Cell[601460, 15935, 1880, 47, 258, "Input",ExpressionUUID->"f99b9324-3c64-4e4a-9577-806a11f83902"],
Cell[603343, 15984, 810, 21, 135, "Input",ExpressionUUID->"e2907790-e22a-40ce-a9b1-2492e85c1e56"],
Cell[604156, 16007, 343, 9, 44, "Input",ExpressionUUID->"114311a0-b4ef-4c8e-9fd3-4092cd20b0b3"],
Cell[604502, 16018, 1199, 28, 135, "Input",ExpressionUUID->"37f8d49a-f0cf-44cc-8327-1e105ec658ba"],
Cell[605704, 16048, 466, 13, 44, "Input",ExpressionUUID->"4a14bfd3-73db-4d20-bbb5-870d762067c8"],
Cell[606173, 16063, 440, 12, 44, "Input",ExpressionUUID->"48be7e39-0009-4e87-8bc8-ba69031b50d7"],
Cell[606616, 16077, 368, 9, 44, "Input",ExpressionUUID->"9a7df599-01c4-4cc3-9e17-88a4eec85c78"],
Cell[606987, 16088, 526, 16, 74, "Input",ExpressionUUID->"cf0063b9-30d7-4785-b6bc-dffcb529cedb"],
Cell[607516, 16106, 438, 11, 44, "Input",ExpressionUUID->"a885b061-a290-45d5-b79b-2af0309e0a47"],
Cell[607957, 16119, 510, 12, 74, "Input",ExpressionUUID->"77826675-6e7d-4eb9-b1b0-b9966ae534ea"],
Cell[608470, 16133, 549, 13, 74, "Input",ExpressionUUID->"7506030e-a2ef-462e-87c5-0897d423c458"],
Cell[609022, 16148, 546, 14, 74, "Input",ExpressionUUID->"6537087e-8720-4217-8c59-3c7ab058b769"]
}, Open  ]]
}, Open  ]]
}
]
*)

